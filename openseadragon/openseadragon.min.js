//! openseadragon 5.0.1
//! Built on 2025-07-08
//! Git commit: v3.0.0-1008-64734b9c-dirty
//! http://openseadragon.github.io
//! License: http://openseadragon.github.io/license/


function OpenSeadragon(e){return new OpenSeadragon.Viewer(e)}!function(r){r.version={versionStr:"5.0.1",major:parseInt("5",10),minor:parseInt("0",10),revision:parseInt("1",10)};var t={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object AsyncFunction]":"function","[object Promise]":"promise","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object","[object HTMLUnknownElement]":"dom-node","[object HTMLImageElement]":"image","[object HTMLCanvasElement]":"canvas","[object CanvasRenderingContext2D]":"context2d"},i=Object.prototype.toString,n=Object.prototype.hasOwnProperty;r.isFunction=function(e){return"function"===r.type(e)};r.isArray=Array.isArray||function(e){return"array"===r.type(e)};r.isWindow=function(e){return e&&"object"==typeof e&&"setInterval"in e};r.type=function(e){return null==e?String(e):t[i.call(e)]||"object"};r.isPlainObject=function(e){if(!e||"object"!==OpenSeadragon.type(e)||e.nodeType||r.isWindow(e))return!1;if(e.constructor&&!n.call(e,"constructor")&&!n.call(e.constructor.prototype,"isPrototypeOf"))return!1;var t;for(var i in e)t=i;return void 0===t||n.call(e,t)};r.isEmptyObject=function(e){for(var t in e)return!1;return!0};r.freezeObject=function(e){Object.freeze?r.freezeObject=Object.freeze:r.freezeObject=function(e){return e};return r.freezeObject(e)};r.supportsCanvas=(e=document.createElement("canvas"),!(!r.isFunction(e.getContext)||!e.getContext("2d")));var e;r.isCanvasTainted=function(e){var t=!1;try{e.getContext("2d").getImageData(0,0,1,1)}catch(e){t=!0}return t};r.supportsAddEventListener=!(!document.documentElement.addEventListener||!document.addEventListener);r.supportsRemoveEventListener=!(!document.documentElement.removeEventListener||!document.removeEventListener);r.supportsEventListenerOptions=function(){var t=0;if(r.supportsAddEventListener)try{var e={get capture(){t++;return!1},get once(){t++;return!1},get passive(){t++;return!1}};window.addEventListener("test",null,e);window.removeEventListener("test",null,e)}catch(e){t=0}return 3<=t}();r.supportsAsync=!0;r.getCurrentPixelDensityRatio=function(){if(r.supportsCanvas){var e=document.createElement("canvas").getContext("2d");var t=window.devicePixelRatio||1;e=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return Math.max(t,1)/e}return 1};r.pixelDensityRatio=r.getCurrentPixelDensityRatio()}(OpenSeadragon);!function(u){u.extend=function(){var e,t,i,r,n,o=arguments[0]||{},s=arguments.length,a=!1,l=1;if("boolean"==typeof o){a=o;o=arguments[1]||{};l=2}"object"==typeof o||OpenSeadragon.isFunction(o)||(o={});if(s===l){o=this;--l}for(;l<s;l++)if(null!==(e=arguments[l])||void 0!==e)for(t in e){var h=Object.getOwnPropertyDescriptor(e,t);if(void 0!==h){if(h.get||h.set)Object.defineProperty(o,t,h);else if(o!==(i=h.value))if(a&&i&&(OpenSeadragon.isPlainObject(i)||(r=OpenSeadragon.isArray(i)))){h=o[t];if(r){r=!1;n=h&&OpenSeadragon.isArray(h)?h:[]}else n=h&&OpenSeadragon.isPlainObject(h)?h:{};o[t]=OpenSeadragon.extend(a,n,i)}else void 0!==i&&(o[t]=i)}else u.console.warn('Could not copy inherited property "'+t+'".')}return o};u.extend(u,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},splitHashDataForPost:!1,callTileLoadedWithCachedData:!1,panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,loadDestinationTilesOnAnimation:!0,gestureSettingsMouse:{dragToPan:!0,scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,dblClickDragToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{dragToPan:!0,scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,dblClickDragToZoom:!1,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerDblClickDrag:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:function(){if("object"!=typeof navigator)return!1;var e=navigator.userAgent;return"string"==typeof e&&(-1!==e.indexOf("iPhone")||-1!==e.indexOf("iPad")||-1!==e.indexOf("iPod"))}(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,maxTilesPerFrame:1,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorElement:null,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,overlayPreserveContentDirection:!0,opacity:1,compositeOperation:null,drawer:["webgl","canvas","html"],drawerOptions:{webgl:{},canvas:{},html:{},custom:{}},preload:!1,imageSmoothingEnabled:!0,placeholderFillStyle:null,subPixelRoundingForTransparency:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,tileRetryMax:0,tileRetryDelay:2500,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"],silenceMultiImageWarnings:!1},delegate:function(t,i){return function(){var e=arguments;return i.apply(t,e=void 0===e?[]:e)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5,EDGE:6,CHROMEEDGE:7},SUBPIXEL_ROUNDING_OCCURRENCES:{NEVER:0,ONLY_AT_REST:1,ALWAYS:2},_viewers:new Map,getViewer:function(e){return u._viewers.get(this.getElement(e))},getElement:function(e){return e="string"==typeof e?document.getElementById(e):e},getElementPosition:function(e){var t,i,r=new u.Point;i=n(e=u.getElement(e),t="fixed"===u.getElementStyle(e).position);for(;i;){r.x+=e.offsetLeft;r.y+=e.offsetTop;t&&(r=r.plus(u.getPageScroll()));i=n(e=i,t="fixed"===u.getElementStyle(e).position)}return r},getElementOffset:function(e){var t,i=(e=u.getElement(e))&&e.ownerDocument,r={top:0,left:0};if(!i)return new u.Point;t=i.documentElement;void 0!==e.getBoundingClientRect&&(r=e.getBoundingClientRect());i=i===i.window?i:9===i.nodeType&&(i.defaultView||i.parentWindow);return new u.Point(r.left+(i.pageXOffset||t.scrollLeft)-(t.clientLeft||0),r.top+(i.pageYOffset||t.scrollTop)-(t.clientTop||0))},getElementSize:function(e){e=u.getElement(e);return new u.Point(e.clientWidth,e.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(e){return(e=u.getElement(e)).currentStyle}:function(e){e=u.getElement(e);return window.getComputedStyle(e,"")},getCssPropertyWithVendorPrefix:function(e){var a={};u.getCssPropertyWithVendorPrefix=function(e){if(void 0!==a[e])return a[e];var t=document.createElement("div").style;var i=null;if(void 0!==t[e])i=e;else{var r=["Webkit","Moz","MS","O","webkit","moz","ms","o"];var n=u.capitalizeFirstLetter(e);for(var o=0;o<r.length;o++){var s=r[o]+n;if(void 0!==t[s]){i=s;break}}}return a[e]=i};return u.getCssPropertyWithVendorPrefix(e)},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},positiveModulo:function(e,t){e%=t;e<0&&(e+=t);return e},pointInElement:function(e,t){e=u.getElement(e);var i=u.getElementOffset(e),e=u.getElementSize(e);return t.x>=i.x&&t.x<i.x+e.x&&t.y<i.y+e.y&&t.y>=i.y},getMousePosition:function(e){if("number"==typeof e.pageX)u.getMousePosition=function(e){var t=new u.Point;t.x=e.pageX;t.y=e.pageY;return t};else{if("number"!=typeof e.clientX)throw new Error("Unknown event mouse position, no known technique.");u.getMousePosition=function(e){var t=new u.Point;t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop;return t}}return u.getMousePosition(e)},getPageScroll:function(){var e=document.documentElement||{},t=document.body||{};if("number"==typeof window.pageXOffset)u.getPageScroll=function(){return new u.Point(window.pageXOffset,window.pageYOffset)};else if(t.scrollLeft||t.scrollTop)u.getPageScroll=function(){return new u.Point(document.body.scrollLeft,document.body.scrollTop)};else{if(!e.scrollLeft&&!e.scrollTop)return new u.Point(0,0);u.getPageScroll=function(){return new u.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)}}return u.getPageScroll()},setPageScroll:function(e){if(void 0!==window.scrollTo)u.setPageScroll=function(e){window.scrollTo(e.x,e.y)};else{var t=u.getPageScroll();if(t.x===e.x&&t.y===e.y)return;document.body.scrollLeft=e.x;document.body.scrollTop=e.y;var i=u.getPageScroll();if(i.x!==t.x&&i.y!==t.y){u.setPageScroll=function(e){document.body.scrollLeft=e.x;document.body.scrollTop=e.y};return}document.documentElement.scrollLeft=e.x;document.documentElement.scrollTop=e.y;if((i=u.getPageScroll()).x!==t.x&&i.y!==t.y){u.setPageScroll=function(e){document.documentElement.scrollLeft=e.x;document.documentElement.scrollTop=e.y};return}u.setPageScroll=function(e){}}u.setPageScroll(e)},getWindowSize:function(){var e=document.documentElement||{},t=document.body||{};if("number"==typeof window.innerWidth)u.getWindowSize=function(){return new u.Point(window.innerWidth,window.innerHeight)};else if(e.clientWidth||e.clientHeight)u.getWindowSize=function(){return new u.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else{if(!t.clientWidth&&!t.clientHeight)throw new Error("Unknown window size, no known technique.");u.getWindowSize=function(){return new u.Point(document.body.clientWidth,document.body.clientHeight)}}return u.getWindowSize()},makeCenteredNode:function(e){e=u.getElement(e);var t=[u.makeNeutralElement("div"),u.makeNeutralElement("div"),u.makeNeutralElement("div")];u.extend(t[0].style,{display:"table",height:"100%",width:"100%"});u.extend(t[1].style,{display:"table-row"});u.extend(t[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"});t[0].appendChild(t[1]);t[1].appendChild(t[2]);t[2].appendChild(e);return t[0]},makeNeutralElement:function(e){var t=document.createElement(e),e=t.style;e.background="transparent none";e.border="none";e.margin="0px";e.padding="0px";e.position="static";return t},now:function(){Date.now?u.now=Date.now:u.now=function(){return(new Date).getTime()};return u.now()},makeTransparentImage:function(e){var t=u.makeNeutralElement("img");t.src=e;return t},setElementOpacity:function(e,t,i){e=u.getElement(e);i&&!u.Browser.alpha&&(t=Math.round(t));if(u.Browser.opacity)e.style.opacity=t<1?t:"";else if(t<1){t=Math.round(100*t);e.style.filter="alpha(opacity="+t+")"}else e.style.filter=""},setElementTouchActionNone:function(e){void 0!==(e=u.getElement(e)).style.touchAction?e.style.touchAction="none":void 0!==e.style.msTouchAction&&(e.style.msTouchAction="none")},setElementPointerEvents:function(e,t){void 0!==(e=u.getElement(e)).style&&void 0!==e.style.pointerEvents&&(e.style.pointerEvents=t)},setElementPointerEventsNone:function(e){u.setElementPointerEvents(e,"none")},addClass:function(e,t){(e=u.getElement(e)).className?-1===(" "+e.className+" ").indexOf(" "+t+" ")&&(e.className+=" "+t):e.className=t},indexOf:function(e,t,i){Array.prototype.indexOf?this.indexOf=function(e,t,i){return e.indexOf(t,i)}:this.indexOf=function(e,t,i){var r,n,i=i||0;if(!e)throw new TypeError;if(0===(n=e.length)||n<=i)return-1;for(r=i=i<0?n-Math.abs(i):i;r<n;r++)if(e[r]===t)return r;return-1};return this.indexOf(e,t,i)},removeClass:function(e,t){var i,r,n=[];i=(e=u.getElement(e)).className.split(/\s+/);for(r=0;r<i.length;r++)i[r]&&i[r]!==t&&n.push(i[r]);e.className=n.join(" ")},normalizeEventListenerOptions:function(e){return void 0!==e?"boolean"==typeof e?u.supportsEventListenerOptions?{capture:e}:e:u.supportsEventListenerOptions?e:void 0!==e.capture&&e.capture:!!u.supportsEventListenerOptions&&{capture:!1}},addEvent:function(){if(u.supportsAddEventListener)return function(e,t,i,r){r=u.normalizeEventListenerOptions(r);(e=u.getElement(e)).addEventListener(t,i,r)};if(document.documentElement.attachEvent&&document.attachEvent)return function(e,t,i){(e=u.getElement(e)).attachEvent("on"+t,i)};throw new Error("No known event model.")}(),removeEvent:function(){if(u.supportsRemoveEventListener)return function(e,t,i,r){r=u.normalizeEventListenerOptions(r);(e=u.getElement(e)).removeEventListener(t,i,r)};if(document.documentElement.detachEvent&&document.detachEvent)return function(e,t,i){(e=u.getElement(e)).detachEvent("on"+t,i)};throw new Error("No known event model.")}(),cancelEvent:function(e){e.preventDefault()},eventIsCanceled:function(e){return e.defaultPrevented},stopEvent:function(e){e.stopPropagation()},getUrlParameter:function(e){e=a[e];return e||null},getUrlProtocol:function(e){e=e.match(/^([a-z]+:)\/\//i);return null===e?window.location.protocol:e[1].toLowerCase()},createAjaxRequest:function(){if(window.XMLHttpRequest){u.createAjaxRequest=function(){return new XMLHttpRequest};return new XMLHttpRequest}throw new Error("Browser doesn't support XMLHttpRequest.")},makeAjaxRequest:function(e,t,i){var r;var n;var o;var s;if(u.isPlainObject(e)){t=e.success;i=e.error;r=e.withCredentials;n=e.headers;o=e.responseType||null;s=e.postData||null;e=e.url}else u.console.warn("OpenSeadragon.makeAjaxRequest() deprecated usage!");var a=u.getUrlProtocol(e);var l=u.createAjaxRequest();if(!u.isFunction(t))throw new Error("makeAjaxRequest requires a success callback");l.onreadystatechange=function(){if(4===l.readyState){l.onreadystatechange=function(){};200<=l.status&&l.status<300||0===l.status&&"http:"!==a&&"https:"!==a?t(l):u.isFunction(i)?i(l):u.console.error("AJAX request returned %d: %s",l.status,e)}};var h=s?"POST":"GET";try{l.open(h,e,!0);o&&(l.responseType=o);if(n)for(var c in n)Object.prototype.hasOwnProperty.call(n,c)&&n[c]&&l.setRequestHeader(c,n[c]);r&&(l.withCredentials=!0);l.send(s)}catch(e){u.console.error("%s while making AJAX request: %s",e.name,e.message);l.onreadystatechange=function(){};u.isFunction(i)&&i(l,e)}return l},jsonp:function(e){var i,t=e.url,r=document.head||document.getElementsByTagName("head")[0]||document.documentElement,n=e.callbackName||"openseadragon"+u.now(),o=window[n],s=e.param||"callback",a=e.callback;t=t.replace(/(=)\?(&|$)|\?\?/i,"$1"+n+"$2");t+=(/\?/.test(t)?"&":"?")+s+"="+n;window[n]=function(e){if(o)window[n]=o;else try{delete window[n]}catch(e){}a&&u.isFunction(a)&&a(e)};i=document.createElement("script");void 0===e.async&&!1===e.async||(i.async="async");e.scriptCharset&&(i.charset=e.scriptCharset);i.src=t;i.onload=i.onreadystatechange=function(e,t){if(t||!i.readyState||/loaded|complete/.test(i.readyState)){i.onload=i.onreadystatechange=null;r&&i.parentNode&&r.removeChild(i);i=void 0}};r.insertBefore(i,r.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(e){if(!window.DOMParser)throw new Error("Browser doesn't support XML DOM.");u.parseXml=function(e){return(new DOMParser).parseFromString(e,"text/xml")};return u.parseXml(e)},parseJSON:function(e){u.parseJSON=window.JSON.parse;return u.parseJSON(e)},imageFormatSupported:function(e){return!!t[(e=e||"").toLowerCase()]},setImageFormatsSupported:function(e){u.extend(t,e)}});function e(e){}u.console=window.console||{log:e,debug:e,info:e,warn:e,error:e,assert:e};var t={avif:!0,bmp:!(u.Browser={vendor:u.BROWSERS.UNKNOWN,version:0,alpha:!0}),jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1,webp:!0},a={};!function(){var e=navigator.appVersion,t=navigator.userAgent;switch(navigator.appName){case"Microsoft Internet Explorer":if(window.attachEvent&&window.ActiveXObject){u.Browser.vendor=u.BROWSERS.IE;u.Browser.version=parseFloat(t.substring(t.indexOf("MSIE")+5,t.indexOf(";",t.indexOf("MSIE"))))}break;case"Netscape":if(window.addEventListener)if(0<=t.indexOf("Edge")){u.Browser.vendor=u.BROWSERS.EDGE;u.Browser.version=parseFloat(t.substring(t.indexOf("Edge")+5))}else if(0<=t.indexOf("Edg")){u.Browser.vendor=u.BROWSERS.CHROMEEDGE;u.Browser.version=parseFloat(t.substring(t.indexOf("Edg")+4))}else if(0<=t.indexOf("Firefox")){u.Browser.vendor=u.BROWSERS.FIREFOX;u.Browser.version=parseFloat(t.substring(t.indexOf("Firefox")+8))}else if(0<=t.indexOf("Safari")){u.Browser.vendor=0<=t.indexOf("Chrome")?u.BROWSERS.CHROME:u.BROWSERS.SAFARI;u.Browser.version=parseFloat(t.substring(t.substring(0,t.indexOf("Safari")).lastIndexOf("/")+1,t.indexOf("Safari")))}else if(null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(t)){u.Browser.vendor=u.BROWSERS.IE;u.Browser.version=parseFloat(RegExp.$1)}break;case"Opera":u.Browser.vendor=u.BROWSERS.OPERA;u.Browser.version=parseFloat(e)}var i,r,n=window.location.search.substring(1).split("&");for(r=0;r<n.length;r++)if(0<(s=(i=n[r]).indexOf("="))){var o=i.substring(0,s),s=i.substring(s+1);try{a[o]=decodeURIComponent(s)}catch(e){u.console.error("Ignoring malformed URL parameter: %s=%s",o,s)}}u.Browser.alpha=!(u.Browser.vendor===u.BROWSERS.CHROME&&u.Browser.version<2);u.Browser.opacity=!0;u.Browser.vendor===u.BROWSERS.IE&&u.console.error("Internet Explorer is not supported by OpenSeadragon")}();!function(e){var t=e.requestAnimationFrame||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame;var i=e.cancelAnimationFrame||e.mozCancelAnimationFrame||e.webkitCancelAnimationFrame||e.msCancelAnimationFrame;if(t&&i){u.requestAnimationFrame=function(){return t.apply(e,arguments)};u.cancelAnimationFrame=function(){return i.apply(e,arguments)}}else{var r,n=[],o=[],s=0;u.requestAnimationFrame=function(e){n.push([++s,e]);r=r||setInterval(function(){if(n.length){var e=u.now();var t=o;o=n;n=t;for(;o.length;)o.shift()[1](e)}else{clearInterval(r);r=void 0}},20);return s};u.cancelAnimationFrame=function(e){var t,i;for(t=0,i=n.length;t<i;t+=1)if(n[t][0]===e){n.splice(t,1);return}for(t=0,i=o.length;t<i;t+=1)if(o[t][0]===e){o.splice(t,1);return}}}}(window);function n(e,t){return t&&e!==document.body?document.body:e.offsetParent}u.Promise=window.Promise&&u.supportsAsync?window.Promise:class{constructor(e){this._error=!1;this.__value=void 0;try{e(e=>{for(;e instanceof u.Promise;)e=e._value;this._value=e},e=>{for(;e instanceof u.Promise;)e=e._value;this._value=e;this._error=!0})}catch(e){this._value=e;this._error=!0}}then(e){if(!this._error)try{this._value=e(this._value)}catch(e){this._value=e;this._error=!0}return this}catch(e){if(this._error)try{this._value=e(this._value);this._error=!1}catch(e){this._value=e;this._error=!0}return this}get _value(){return this.__value}set _value(e){e&&e.constructor===this.constructor&&(e=e._value);this.__value=e}static resolve(t){return new this(e=>e(t))}static reject(i){return new this((e,t)=>t(i))}static all(t){return new this(e=>e(t.map(e=>e())))}static race(t){return t.length<1?this.resolve():new this(e=>e(t[0]()))}}}(OpenSeadragon);!function(e,t){if("function"==typeof define&&define.amd)define([],function(){return t});else if("object"==typeof module&&module.exports)module.exports=t;else{(e=e||"object"==typeof window&&window)||t.console.error("OpenSeadragon must run in browser environment!");e.OpenSeadragon=t}}(this,OpenSeadragon);!function(e){e.Mat3=class y{constructor(e){this.values=e=e||[0,0,0,0,0,0,0,0,0]}static makeIdentity(){return new y([1,0,0,0,1,0,0,0,1])}static makeTranslation(e,t){return new y([1,0,0,0,1,0,e,t,1])}static makeRotation(e){var t=Math.cos(e);e=Math.sin(e);return new y([t,-e,0,e,t,0,0,0,1])}static makeScaling(e,t){return new y([e,0,0,0,t,0,0,0,1])}multiply(e){var t=this.values;var i=e.values;var r=t[0];var n=t[1];var o=t[2];var s=t[3];var a=t[4];var l=t[5];var h=t[6];var c=t[7];var u=t[8];var d=i[0];var p=i[1];var g=i[2];var m=i[3];var f=i[4];var v=i[5];e=i[6];t=i[7];i=i[8];return new y([d*r+p*s+g*h,d*n+p*a+g*c,d*o+p*l+g*u,m*r+f*s+v*h,m*n+f*a+v*c,m*o+f*l+v*u,e*r+t*s+i*h,e*n+t*a+i*c,e*o+t*l+i*u])}setValues(e,t,i,r,n,o,s,a,l){this.values[0]=e;this.values[1]=t;this.values[2]=i;this.values[3]=r;this.values[4]=n;this.values[5]=o;this.values[6]=s;this.values[7]=a;this.values[8]=l}scaleAndTranslate(e,t,i,r){var n=this.values;var o=n[0];var s=n[1];var a=n[2];var l=n[3];var h=n[4];n=n[5];return new y([e*o,e*s,e*a,t*l,t*h,t*n,i*o+r*l,i*s+r*h,i*a+r*n])}scaleAndTranslateSelf(e,t,i,r){const n=this.values;var o=n[0],s=n[1],a=n[2];var l=n[3],h=n[4],c=n[5];n[0]=e*o;n[1]=e*s;n[2]=e*a;n[3]=t*l;n[4]=t*h;n[5]=t*c;n[6]=i*o+r*l+n[6];n[7]=i*s+r*h+n[7];n[8]=i*a+r*c+n[8]}scaleAndTranslateOtherSetSelf(e){var t=e.values;const i=this.values;var r=i[0];var n=i[4];var o=i[6];e=i[7];i[0]=r*t[0];i[1]=r*t[1];i[2]=r*t[2];i[3]=n*t[3];i[4]=n*t[4];i[5]=n*t[5];i[6]=o*t[0]+e*t[3]+t[6];i[7]=o*t[1]+e*t[4]+t[7];i[8]=o*t[2]+e*t[5]+t[8];return this}}}(OpenSeadragon);!function(t){var e={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""};if(document.exitFullscreen){e.supportsFullScreen=!0;e.getFullScreenElement=function(){return document.fullscreenElement};e.requestFullScreen=function(e){return e.requestFullscreen().catch(function(e){t.console.error("Fullscreen request failed: ",e)})};e.exitFullScreen=function(){document.exitFullscreen().catch(function(e){t.console.error("Error while exiting fullscreen: ",e)})};e.fullScreenEventName="fullscreenchange";e.fullScreenErrorEventName="fullscreenerror"}else if(document.msExitFullscreen){e.supportsFullScreen=!0;e.getFullScreenElement=function(){return document.msFullscreenElement};e.requestFullScreen=function(e){return e.msRequestFullscreen()};e.exitFullScreen=function(){document.msExitFullscreen()};e.fullScreenEventName="MSFullscreenChange";e.fullScreenErrorEventName="MSFullscreenError"}else if(document.webkitExitFullscreen){e.supportsFullScreen=!0;e.getFullScreenElement=function(){return document.webkitFullscreenElement};e.requestFullScreen=function(e){return e.webkitRequestFullscreen()};e.exitFullScreen=function(){document.webkitExitFullscreen()};e.fullScreenEventName="webkitfullscreenchange";e.fullScreenErrorEventName="webkitfullscreenerror"}else if(document.webkitCancelFullScreen){e.supportsFullScreen=!0;e.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement};e.requestFullScreen=function(e){return e.webkitRequestFullScreen()};e.exitFullScreen=function(){document.webkitCancelFullScreen()};e.fullScreenEventName="webkitfullscreenchange";e.fullScreenErrorEventName="webkitfullscreenerror"}else if(document.mozCancelFullScreen){e.supportsFullScreen=!0;e.getFullScreenElement=function(){return document.mozFullScreenElement};e.requestFullScreen=function(e){return e.mozRequestFullScreen()};e.exitFullScreen=function(){document.mozCancelFullScreen()};e.fullScreenEventName="mozfullscreenchange";e.fullScreenErrorEventName="mozfullscreenerror"}e.isFullScreen=function(){return null!==e.getFullScreenElement()};e.cancelFullScreen=function(){t.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead.");e.exitFullScreen()};t.extend(t,e)}(OpenSeadragon);!function(h){h.EventSource=function(){this.events={};this._rejectedEventList={}};h.EventSource.prototype={addOnceHandler:function(t,i,e,r,n){const o=this;r=r||1;let s=0;function a(e){s++;s===r&&o.removeHandler(t,a);return i(e)}return this.addHandler(t,a,e,n)},addHandler:function(e,i,r,n){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,e)){h.console.error(`Error adding handler for ${e}. `+this._rejectedEventList[e]);return!1}let o=this.events[e];o||(this.events[e]=o=[]);if(i&&h.isFunction(i)){let e=o.length,t={handler:i,userData:r||null,priority:n||0};o[e]=t;for(;0<e&&o[e-1].priority<o[e].priority;){o[e]=o[e-1];o[e-1]=t;e--}}return!0},removeHandler:function(e,t){const i=this.events[e],r=[];if(i&&h.isArray(i)){for(let e=0;e<i.length;e++)i[e].handler!==t&&r.push(i[e]);this.events[e]=r}},numberOfHandlers:function(e){e=this.events[e];return e?e.length:0},removeAllHandlers:function(e){if(e)this.events[e]=[];else for(var t in this.events)this.events[t]=[]},getHandler:function(e){let n=this.events[e];if(!n||!n.length)return null;n=1===n.length?[n[0]]:Array.apply(null,n);return function(t,i){var r=n.length;for(let e=0;e<r;e++)if(n[e]){i.eventSource=t;i.userData=n[e].userData;n[e].handler(i)}}},getAwaitingHandler:function(e,a){let l=this.events[e];if(!l||!l.length)return null;l=1===l.length?[l[0]]:Array.apply(null,l);return function(o,s){return new h.Promise(r=>{const n=l.length;!function e(t){if(t>=n||!l[t]){r(a);return null}s.eventSource=o;s.userData=l[t].userData;let i=l[t].handler(s);i=i&&"promise"===h.type(i)?i:h.Promise.resolve();return i.then(()=>e(t+1))}(0)})}},raiseEvent:function(e,t){if(Object.prototype.hasOwnProperty.call(this._rejectedEventList,e)){h.console.error(`Error adding handler for ${e}. `+this._rejectedEventList[e]);return!1}const i=this.getHandler(e);i&&i(this,t||{});return!0},raiseEventAwaiting:function(e,t,i=null){const r=this.getAwaitingHandler(e,i);return r?r(this,t||{}):h.Promise.resolve(i)},rejectEventHandler(e,t=""){this._rejectedEventList[e]=t},allowEventHandler(e){delete this._rejectedEventList[e]}}}(OpenSeadragon);!function(c){var r=[];var u={};c.MouseTracker=function(e){r.push(this);var t=arguments;c.isPlainObject(e)||(e={element:t[0],clickTimeThreshold:t[1],clickDistThreshold:t[2]});this.hash=function(){let e=Date.now().toString(36)+Math.random().toString(36).substring(2);for(;e in u;)e=Date.now().toString(36)+Math.random().toString(36).substring(2);return e}();this.element=c.getElement(e.element);this.clickTimeThreshold=e.clickTimeThreshold||c.DEFAULT_SETTINGS.clickTimeThreshold;this.clickDistThreshold=e.clickDistThreshold||c.DEFAULT_SETTINGS.clickDistThreshold;this.dblClickTimeThreshold=e.dblClickTimeThreshold||c.DEFAULT_SETTINGS.dblClickTimeThreshold;this.dblClickDistThreshold=e.dblClickDistThreshold||c.DEFAULT_SETTINGS.dblClickDistThreshold;this.userData=e.userData||null;this.stopDelay=e.stopDelay||50;this.preProcessEventHandler=e.preProcessEventHandler||null;this.contextMenuHandler=e.contextMenuHandler||null;this.enterHandler=e.enterHandler||null;this.leaveHandler=e.leaveHandler||null;this.exitHandler=e.exitHandler||null;this.overHandler=e.overHandler||null;this.outHandler=e.outHandler||null;this.pressHandler=e.pressHandler||null;this.nonPrimaryPressHandler=e.nonPrimaryPressHandler||null;this.releaseHandler=e.releaseHandler||null;this.nonPrimaryReleaseHandler=e.nonPrimaryReleaseHandler||null;this.moveHandler=e.moveHandler||null;this.scrollHandler=e.scrollHandler||null;this.clickHandler=e.clickHandler||null;this.dblClickHandler=e.dblClickHandler||null;this.dragHandler=e.dragHandler||null;this.dragEndHandler=e.dragEndHandler||null;this.pinchHandler=e.pinchHandler||null;this.stopHandler=e.stopHandler||null;this.keyDownHandler=e.keyDownHandler||null;this.keyUpHandler=e.keyUpHandler||null;this.keyHandler=e.keyHandler||null;this.focusHandler=e.focusHandler||null;this.blurHandler=e.blurHandler||null;var i=this;u[this.hash]={click:function(e){!function(e,t){var i={originalEvent:t,eventType:"click",pointerType:"mouse",isEmulated:!1};O(e,i);i.preventDefault&&!i.defaultPrevented&&c.cancelEvent(t);i.stopPropagation&&c.stopEvent(t)}(i,e)},dblclick:function(e){!function(e,t){var i={originalEvent:t,eventType:"dblclick",pointerType:"mouse",isEmulated:!1};O(e,i);i.preventDefault&&!i.defaultPrevented&&c.cancelEvent(t);i.stopPropagation&&c.stopEvent(t)}(i,e)},keydown:function(e){!function(e,t){var i=null;var r={originalEvent:t,eventType:"keydown",pointerType:"",isEmulated:!1};O(e,r);if(e.keyDownHandler&&!r.preventGesture&&!r.defaultPrevented){i={eventSource:e,keyCode:t.keyCode||t.charCode,ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey,originalEvent:t,preventDefault:r.preventDefault||r.defaultPrevented,userData:e.userData};e.keyDownHandler(i)}(i&&i.preventDefault||r.preventDefault&&!r.defaultPrevented)&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}(i,e)},keyup:function(e){!function(e,t){var i=null;var r={originalEvent:t,eventType:"keyup",pointerType:"",isEmulated:!1};O(e,r);if(e.keyUpHandler&&!r.preventGesture&&!r.defaultPrevented){i={eventSource:e,keyCode:t.keyCode||t.charCode,ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey,originalEvent:t,preventDefault:r.preventDefault||r.defaultPrevented,userData:e.userData};e.keyUpHandler(i)}(i&&i.preventDefault||r.preventDefault&&!r.defaultPrevented)&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}(i,e)},keypress:function(e){!function(e,t){var i=null;var r={originalEvent:t,eventType:"keypress",pointerType:"",isEmulated:!1};O(e,r);if(e.keyHandler&&!r.preventGesture&&!r.defaultPrevented){i={eventSource:e,keyCode:t.keyCode||t.charCode,ctrl:t.ctrlKey,shift:t.shiftKey,alt:t.altKey,meta:t.metaKey,originalEvent:t,preventDefault:r.preventDefault||r.defaultPrevented,userData:e.userData};e.keyHandler(i)}(i&&i.preventDefault||r.preventDefault&&!r.defaultPrevented)&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}(i,e)},focus:function(e){!function(e,t){var i={originalEvent:t,eventType:"focus",pointerType:"",isEmulated:!1};O(e,i);e.focusHandler&&!i.preventGesture&&e.focusHandler({eventSource:e,originalEvent:t,userData:e.userData})}(i,e)},blur:function(e){!function(e,t){var i={originalEvent:t,eventType:"blur",pointerType:"",isEmulated:!1};O(e,i);e.blurHandler&&!i.preventGesture&&e.blurHandler({eventSource:e,originalEvent:t,userData:e.userData})}(i,e)},contextmenu:function(e){!function(e,t){var i=null;var r={originalEvent:t,eventType:"contextmenu",pointerType:"mouse",isEmulated:!1};O(e,r);if(e.contextMenuHandler&&!r.preventGesture&&!r.defaultPrevented){i={eventSource:e,position:w(y(t),e.element),originalEvent:r.originalEvent,preventDefault:r.preventDefault||r.defaultPrevented,userData:e.userData};e.contextMenuHandler(i)}(i&&i.preventDefault||r.preventDefault&&!r.defaultPrevented)&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}(i,e)},wheel:function(e){b(i,e,e)},mousewheel:function(e){x(i,e)},DOMMouseScroll:function(e){x(i,e)},MozMousePixelScroll:function(e){x(i,e)},losecapture:function(e){!function(e,t){var i={id:c.MouseTracker.mousePointerId,type:"mouse"};var r={originalEvent:t,eventType:"lostpointercapture",pointerType:"mouse",isEmulated:!1};O(e,r);t.target===e.element&&M(e,i,!1);r.stopPropagation&&c.stopEvent(t)}(i,e)},mouseenter:function(e){E(i,e)},mouseleave:function(e){S(i,e)},mouseover:function(e){C(i,e)},mouseout:function(e){P(i,e)},mousedown:function(e){R(i,e)},mouseup:function(e){D(i,e)},mousemove:function(e){L(i,e)},touchstart:function(e){!function(e,t){var i,r,n,o=t.changedTouches.length,s=e.getActivePointersListByType("touch");i=c.now();s.getLength()>t.touches.length-o&&c.console.warn("Tracked touch contact count doesn't match event.touches.length");var a={originalEvent:t,eventType:"pointerdown",pointerType:"touch",isEmulated:!1};O(e,a);for(r=0;r<o;r++){n={id:t.changedTouches[r].identifier,type:"touch",isPrimary:0===s.getLength(),currentPos:y(t.changedTouches[r]),currentTime:i};k(e,a,n);H(e,a,n,0);M(e,n,!0)}a.preventDefault&&!a.defaultPrevented&&c.cancelEvent(t);a.stopPropagation&&c.stopEvent(t)}(i,e)},touchend:function(e){!function(e,t){var i,r,n,o=t.changedTouches.length;i=c.now();var s={originalEvent:t,eventType:"pointerup",pointerType:"touch",isEmulated:!1};O(e,s);for(r=0;r<o;r++){n={id:t.changedTouches[r].identifier,type:"touch",currentPos:y(t.changedTouches[r]),currentTime:i};N(e,s,n,0);M(e,n,!1);z(e,s,n)}s.preventDefault&&!s.defaultPrevented&&c.cancelEvent(t);s.stopPropagation&&c.stopEvent(t)}(i,e)},touchmove:function(e){!function(e,t){var i,r,n,o=t.changedTouches.length;i=c.now();var s={originalEvent:t,eventType:"pointermove",pointerType:"touch",isEmulated:!1};O(e,s);for(r=0;r<o;r++){n={id:t.changedTouches[r].identifier,type:"touch",currentPos:y(t.changedTouches[r]),currentTime:i};U(e,s,n)}s.preventDefault&&!s.defaultPrevented&&c.cancelEvent(t);s.stopPropagation&&c.stopEvent(t)}(i,e)},touchcancel:function(e){!function(e,t){var i,r,n=t.changedTouches.length;var o={originalEvent:t,eventType:"pointercancel",pointerType:"touch",isEmulated:!1};O(e,o);for(i=0;i<n;i++){r={id:t.changedTouches[i].identifier,type:"touch"};G(e,0,r)}o.stopPropagation&&c.stopEvent(t)}(i,e)},gesturestart:function(e){!(e=e,c.eventIsCanceled(e)||e.preventDefault())},gesturechange:function(e){!(e=e,c.eventIsCanceled(e)||e.preventDefault())},gotpointercapture:function(e){!function(e,t){var i={originalEvent:t,eventType:"gotpointercapture",pointerType:f(t),isEmulated:!1};O(e,i);t.target===e.element&&M(e,{id:t.pointerId,type:f(t)},!0);i.stopPropagation&&c.stopEvent(t)}(i,e)},lostpointercapture:function(e){!function(e,t){var i={originalEvent:t,eventType:"lostpointercapture",pointerType:f(t),isEmulated:!1};O(e,i);t.target===e.element&&M(e,{id:t.pointerId,type:f(t)},!1);i.stopPropagation&&c.stopEvent(t)}(i,e)},pointerenter:function(e){E(i,e)},pointerleave:function(e){S(i,e)},pointerover:function(e){C(i,e)},pointerout:function(e){P(i,e)},pointerdown:function(e){R(i,e)},pointerup:function(e){D(i,e)},pointermove:function(e){L(i,e)},pointercancel:function(e){!function(e,t){var i={id:t.pointerId,type:f(t)};var r={originalEvent:t,eventType:"pointercancel",pointerType:i.type,isEmulated:!1};O(e,r);G(e,0,i);r.stopPropagation&&c.stopEvent(t)}(i,e)},pointerupcaptured:function(e){!function(e,t){e.getActivePointersListByType(f(t)).getById(t.pointerId)&&I(e,t);c.stopEvent(t)}(i,e)},pointermovecaptured:function(e){!function(e,t){e.getActivePointersListByType(f(t)).getById(t.pointerId)&&A(e,t);c.stopEvent(t)}(i,e)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null,sentDragEvent:!1};c.MouseTracker.havePointerEvents&&c.setElementPointerEvents(this.element,"auto");this.exitHandler&&c.console.error("MouseTracker.exitHandler is deprecated. Use MouseTracker.leaveHandler instead.");e.startDisabled||this.setTracking(!0)};c.MouseTracker.prototype={destroy:function(){var e;t(this);this.element=null;for(e=0;e<r.length;e++)if(r[e]===this){r.splice(e,1);break}u[this.hash]=null;delete u[this.hash]},isTracking:function(){return u[this.hash].tracking},setTracking:function(e){(e?function(e){var t,i,r=u[e.hash];if(!r.tracking){for(i=0;i<c.MouseTracker.subscribeEvents.length;i++){t=c.MouseTracker.subscribeEvents[i];c.addEvent(e.element,t,r[t],t===c.MouseTracker.wheelEventName&&{passive:!1,capture:!1})}n(e);r.tracking=!0}}:t)(this);return this},getActivePointersListByType:function(e){var t,i,r=u[this.hash],n=r?r.activePointersLists.length:0;for(t=0;t<n;t++)if(r.activePointersLists[t].type===e)return r.activePointersLists[t];i=new c.MouseTracker.GesturePointList(e);r&&r.activePointersLists.push(i);return i},getActivePointerCount:function(){var e,t=u[this.hash],i=t.activePointersLists.length,r=0;for(e=0;e<i;e++)r+=t.activePointersLists[e].getLength();return r},get hasGestureHandlers(){return!!(this.pressHandler||this.nonPrimaryPressHandler||this.releaseHandler||this.nonPrimaryReleaseHandler||this.clickHandler||this.dblClickHandler||this.dragHandler||this.dragEndHandler||this.pinchHandler)},get hasScrollHandler(){return!!this.scrollHandler},preProcessEventHandler:function(){},contextMenuHandler:function(){},enterHandler:function(){},leaveHandler:function(){},exitHandler:function(){},overHandler:function(){},outHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}};var o=function(){try{return window.self!==window.top}catch(e){return!0}}();function s(e){try{return e.addEventListener&&e.removeEventListener}catch(e){return}}c.MouseTracker.gesturePointVelocityTracker=(l=[],d=h=0,{addPoint:function(e,t){e=a(e,t);l.push({guid:e,gPoint:t,lastPos:t.currentPos});if(1===l.length){d=c.now();h=window.setInterval(i,50)}},removePoint:function(e,t){var i,r=a(e,t),n=l.length;for(i=0;i<n;i++)if(l[i].guid===r){l.splice(i,1);0===--n&&window.clearInterval(h);break}}});function a(e,t){return e.hash.toString()+t.type+t.id.toString()}function i(){var e,t,i,r,n,o=l.length,s=c.now();r=s-d;d=s;for(e=0;e<o;e++){(i=(t=l[e]).gPoint).direction=Math.atan2(i.currentPos.y-t.lastPos.y,i.currentPos.x-t.lastPos.x);n=t.lastPos.distanceTo(i.currentPos);t.lastPos=i.currentPos;i.speed=.75*(1e3*n/(1+r))+.25*i.speed}}var l,h,d;c.MouseTracker.captureElement=document;c.MouseTracker.wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";c.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur","contextmenu",c.MouseTracker.wheelEventName];"DOMMouseScroll"===c.MouseTracker.wheelEventName&&c.MouseTracker.subscribeEvents.push("MozMousePixelScroll");if(window.PointerEvent){c.MouseTracker.havePointerEvents=!0;c.MouseTracker.subscribeEvents.push("pointerenter","pointerleave","pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel");c.MouseTracker.havePointerCapture=(e=document.createElement("div"),c.isFunction(e.setPointerCapture)&&c.isFunction(e.releasePointerCapture));c.MouseTracker.havePointerCapture&&c.MouseTracker.subscribeEvents.push("gotpointercapture","lostpointercapture")}else{c.MouseTracker.havePointerEvents=!1;c.MouseTracker.subscribeEvents.push("mouseenter","mouseleave","mouseover","mouseout","mousedown","mouseup","mousemove");c.MouseTracker.mousePointerId="legacy-mouse";c.MouseTracker.havePointerCapture=(e=document.createElement("div"),c.isFunction(e.setCapture)&&c.isFunction(e.releaseCapture));c.MouseTracker.havePointerCapture&&c.MouseTracker.subscribeEvents.push("losecapture");"ontouchstart"in window&&c.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel");"ongesturestart"in window&&c.MouseTracker.subscribeEvents.push("gesturestart","gesturechange")}var e;c.MouseTracker.GesturePointList=function(e){this._gPoints=[];this.type=e;this.buttons=0;this.contacts=0;this.clicks=0;this.captureCount=0};c.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(e){return this._gPoints.push(e)},removeById:function(e){var t,i=this._gPoints.length;for(t=0;t<i;t++)if(this._gPoints[t].id===e){this._gPoints.splice(t,1);break}return this._gPoints.length},getByIndex:function(e){return e<this._gPoints.length?this._gPoints[e]:null},getById:function(e){var t,i=this._gPoints.length;for(t=0;t<i;t++)if(this._gPoints[t].id===e)return this._gPoints[t];return null},getPrimary:function(e){var t,i=this._gPoints.length;for(t=0;t<i;t++)if(this._gPoints[t].isPrimary)return this._gPoints[t];return null},addContact:function(){++this.contacts;if(1<this.contacts&&("mouse"===this.type||"pen"===this.type)){c.console.warn("GesturePointList.addContact() Implausible contacts value");this.contacts=1}},removeContact:function(){--this.contacts;this.contacts<0&&(this.contacts=0)}};function n(e){var t,i,r,n,o,s=u[e.hash],a=s.activePointersLists.length;for(t=0;t<a;t++)if(0<(r=s.activePointersLists[t]).getLength()){o=[];n=r.asArray();for(i=0;i<n.length;i++)o.push(n[i]);for(i=0;i<o.length;i++)B(e,r,o[i])}for(t=0;t<a;t++)s.activePointersLists.pop();s.sentDragEvent=!1}function t(e){var t,i,r=u[e.hash];if(r.tracking){for(i=0;i<c.MouseTracker.subscribeEvents.length;i++){t=c.MouseTracker.subscribeEvents[i];c.removeEvent(e.element,t,r[t],!1)}n(e);r.tracking=!1}}function p(e,t){e=u[e.hash];if("pointerevent"===t)return{upName:"pointerup",upHandler:e.pointerupcaptured,moveName:"pointermove",moveHandler:e.pointermovecaptured};if("mouse"===t)return{upName:"pointerup",upHandler:e.pointerupcaptured,moveName:"pointermove",moveHandler:e.pointermovecaptured};if("touch"===t)return{upName:"touchend",upHandler:e.touchendcaptured,moveName:"touchmove",moveHandler:e.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function g(e,t){var i;if(c.MouseTracker.havePointerCapture)if(c.MouseTracker.havePointerEvents){if(!(i=e.getActivePointersListByType(t.type).getById(t.id))||!i.captured)return;try{e.element.releasePointerCapture(t.id)}catch(e){}}else e.element.releaseCapture();else{i=p(e,c.MouseTracker.havePointerEvents?"pointerevent":t.type);o&&s(window.top)&&c.removeEvent(window.top,i.upName,i.upHandler,!0);c.removeEvent(c.MouseTracker.captureElement,i.moveName,i.moveHandler,!0);c.removeEvent(c.MouseTracker.captureElement,i.upName,i.upHandler,!0)}M(e,t,!1)}function m(e){return c.MouseTracker.havePointerEvents?e.pointerId:c.MouseTracker.mousePointerId}function f(e){return c.MouseTracker.havePointerEvents&&e.pointerType?e.pointerType:"mouse"}function v(e){return!c.MouseTracker.havePointerEvents||e.isPrimary}function y(e){return c.getMousePosition(e)}function _(e,t){return w(y(e),t)}function w(e,t){t=c.getElementOffset(t);return e.minus(t)}function T(e,t){return new c.Point((e.x+t.x)/2,(e.y+t.y)/2)}function x(e,t){var i={target:t.target||t.srcElement,type:"wheel",shiftKey:t.shiftKey||!1,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX||t.clientX,pageY:t.pageY||t.clientY,deltaMode:"MozMousePixelScroll"===t.type?0:1,deltaX:0,deltaZ:0};"mousewheel"===c.MouseTracker.wheelEventName?i.deltaY=-t.wheelDelta/c.DEFAULT_SETTINGS.pixelsPerWheelLine:i.deltaY=t.detail;b(e,i,t)}function b(e,t,i){var r,n;var o=null;r=t.deltaY?t.deltaY<0?1:-1:0;O(e,n={originalEvent:t,eventType:"wheel",pointerType:"mouse",isEmulated:t!==i});if(e.scrollHandler&&!n.preventGesture&&!n.defaultPrevented){o={eventSource:e,pointerType:"mouse",position:_(t,e.element),scroll:r,shift:t.shiftKey,isTouchEvent:!1,originalEvent:i,preventDefault:n.preventDefault||n.defaultPrevented,userData:e.userData};e.scrollHandler(o)}n.stopPropagation&&c.stopEvent(i);(o&&o.preventDefault||n.preventDefault&&!n.defaultPrevented)&&c.cancelEvent(i)}function E(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};t={originalEvent:t,eventType:"pointerenter",pointerType:i.type,isEmulated:!1};O(e,t);k(e,t,i)}function S(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};t={originalEvent:t,eventType:"pointerleave",pointerType:i.type,isEmulated:!1};O(e,t);z(e,t,i)}function C(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};var r={originalEvent:t,eventType:"pointerover",pointerType:i.type,isEmulated:!1};O(e,r);!function(e,t,i){var r,n;r=e.getActivePointersListByType(i.type);if(n=r.getById(i.id))i=n;else{i.captured=!1;i.insideElementPressed=!1}e.overHandler&&e.overHandler({eventSource:e,pointerType:i.type,position:w(i.currentPos,e.element),buttons:r.buttons,pointers:e.getActivePointerCount(),insideElementPressed:i.insideElementPressed,buttonDownAny:0!==r.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData})}(e,r,i);r.preventDefault&&!r.defaultPrevented&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}function P(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};var r={originalEvent:t,eventType:"pointerout",pointerType:i.type,isEmulated:!1};O(e,r);!function(e,t,i){var r,n;r=e.getActivePointersListByType(i.type);if(n=r.getById(i.id))i=n;else{i.captured=!1;i.insideElementPressed=!1}e.outHandler&&e.outHandler({eventSource:e,pointerType:i.type,position:i.currentPos&&w(i.currentPos,e.element),buttons:r.buttons,pointers:e.getActivePointerCount(),insideElementPressed:i.insideElementPressed,buttonDownAny:0!==r.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData})}(e,r,i);r.preventDefault&&!r.defaultPrevented&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}function R(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};var r=c.MouseTracker.havePointerEvents&&"touch"===i.type;var n={originalEvent:t,eventType:"pointerdown",pointerType:i.type,isEmulated:!1};O(e,n);H(e,n,i,t.button);n.preventDefault&&!n.defaultPrevented&&c.cancelEvent(t);n.stopPropagation&&c.stopEvent(t);n.shouldCapture&&(r?M(e,i,!0):function(e,t){var i;if(c.MouseTracker.havePointerCapture)if(c.MouseTracker.havePointerEvents)try{e.element.setPointerCapture(t.id)}catch(e){c.console.warn("setPointerCapture() called on invalid pointer ID");return}else e.element.setCapture(!0);else{i=p(e,c.MouseTracker.havePointerEvents?"pointerevent":t.type);o&&s(window.top)&&c.addEvent(window.top,i.upName,i.upHandler,!0);c.addEvent(c.MouseTracker.captureElement,i.upName,i.upHandler,!0);c.addEvent(c.MouseTracker.captureElement,i.moveName,i.moveHandler,!0)}M(e,t,!0)}(e,i))}function D(e,t){I(e,t)}function I(e,t){var i;var r={originalEvent:t,eventType:"pointerup",pointerType:(i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()}).type,isEmulated:!1};O(e,r);N(e,r,i,t.button);r.preventDefault&&!r.defaultPrevented&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t);r.shouldReleaseCapture&&(t.target===e.element?g(e,i):M(e,i,!1))}function L(e,t){A(e,t)}function A(e,t){var i={id:m(t),type:f(t),isPrimary:v(t),currentPos:y(t),currentTime:c.now()};var r={originalEvent:t,eventType:"pointermove",pointerType:i.type,isEmulated:!1};O(e,r);U(e,r,i);r.preventDefault&&!r.defaultPrevented&&c.cancelEvent(t);r.stopPropagation&&c.stopEvent(t)}function F(e,t){t.speed=0;t.direction=0;t.contactPos=t.currentPos;t.contactTime=t.currentTime;t.lastPos=t.currentPos;t.lastTime=t.currentTime;return e.add(t)}function B(e,t,i){var r;var n=t.getById(i.id);if(n){if(n.captured){c.console.warn("stopTrackingPointer() called on captured pointer");g(e,n)}t.removeContact();r=t.removeById(i.id)}else r=t.getLength();return r}function O(e,t){t.eventSource=e;t.eventPhase=t.originalEvent&&void 0!==t.originalEvent.eventPhase?t.originalEvent.eventPhase:0;t.defaultPrevented=c.eventIsCanceled(t.originalEvent);t.shouldCapture=!1;t.shouldReleaseCapture=!1;t.userData=e.userData;!function(e,t){switch(t.eventType){case"pointermove":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!1;t.preventGesture=!e.hasGestureHandlers;t.stopPropagation=!1;break;case"pointerover":case"pointerout":case"contextmenu":case"keydown":case"keyup":case"keypress":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!1;t.preventGesture=!1;t.stopPropagation=!1;break;case"pointerdown":case"pointerup":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!1;t.preventGesture=!e.hasGestureHandlers;t.stopPropagation=!1;break;case"wheel":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!1;t.preventGesture=!e.hasScrollHandler;t.stopPropagation=!1;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":t.isStoppable=!0;t.isCancelable=!1;t.preventDefault=!1;t.preventGesture=!1;t.stopPropagation=!1;break;case"click":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!!e.clickHandler;t.preventGesture=!1;t.stopPropagation=!1;break;case"dblclick":t.isStoppable=!0;t.isCancelable=!0;t.preventDefault=!!e.dblClickHandler;t.preventGesture=!1;t.stopPropagation=!1;break;default:t.isStoppable=!1;t.isCancelable=!1;t.preventDefault=!1;t.preventGesture=!1;t.stopPropagation=!1}}(e,t);e.preProcessEventHandler&&e.preProcessEventHandler(t)}function M(e,t,i){e=e.getActivePointersListByType(t.type);t=e.getById(t.id);if(t){if(i&&!t.captured){t.captured=!0;e.captureCount++}else if(!i&&t.captured){t.captured=!1;e.captureCount--;if(e.captureCount<0){e.captureCount=0;c.console.warn("updatePointerCaptured() - pointsList.captureCount went negative")}}}else c.console.warn("updatePointerCaptured() called on untracked pointer")}function k(e,t,i){var r,n=e.getActivePointersListByType(i.type);if(r=n.getById(i.id)){r.insideElement=!0;r.lastPos=r.currentPos;r.lastTime=r.currentTime;r.currentPos=i.currentPos;r.currentTime=i.currentTime;i=r}else{i.captured=!1;i.insideElementPressed=!1;i.insideElement=!0;F(n,i)}e.enterHandler&&e.enterHandler({eventSource:e,pointerType:i.type,position:w(i.currentPos,e.element),buttons:n.buttons,pointers:e.getActivePointerCount(),insideElementPressed:i.insideElementPressed,buttonDownAny:0!==n.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData})}function z(e,t,i){var r,n=e.getActivePointersListByType(i.type);if(r=n.getById(i.id)){if(r.captured){r.insideElement=!1;r.lastPos=r.currentPos;r.lastTime=r.currentTime;r.currentPos=i.currentPos;r.currentTime=i.currentTime}else B(e,n,r);i=r}else{i.captured=!1;i.insideElementPressed=!1}if(e.leaveHandler||e.exitHandler){t={eventSource:e,pointerType:i.type,position:i.currentPos&&w(i.currentPos,e.element),buttons:n.buttons,pointers:e.getActivePointerCount(),insideElementPressed:i.insideElementPressed,buttonDownAny:0!==n.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData};e.leaveHandler&&e.leaveHandler(t);e.exitHandler&&e.exitHandler(t)}}function H(e,t,i,r){var n,o=u[e.hash],s=e.getActivePointersListByType(i.type);void 0!==t.originalEvent.buttons?s.buttons=t.originalEvent.buttons:0===r?s.buttons|=1:1===r?s.buttons|=4:2===r?s.buttons|=2:3===r?s.buttons|=8:4===r?s.buttons|=16:5===r&&(s.buttons|=32);if(0===r){if(n=s.getById(i.id)){n.insideElementPressed=!0;n.insideElement=!0;n.originalTarget=t.originalEvent.target;n.contactPos=i.currentPos;n.contactTime=i.currentTime;n.lastPos=n.currentPos;n.lastTime=n.currentTime;n.currentPos=i.currentPos;n.currentTime=i.currentTime;i=n}else{i.captured=!1;i.insideElementPressed=!0;i.insideElement=!0;i.originalTarget=t.originalEvent.target;F(s,i)}s.addContact();if(t.preventGesture||t.defaultPrevented){t.shouldCapture=!1;t.shouldReleaseCapture=!1}else{t.shouldCapture=!0;t.shouldReleaseCapture=!1;t.preventDefault=!0;(e.dragHandler||e.dragEndHandler||e.pinchHandler)&&c.MouseTracker.gesturePointVelocityTracker.addPoint(e,i);if(1===s.contacts)e.pressHandler&&!t.preventGesture&&e.pressHandler({eventSource:e,pointerType:i.type,position:w(i.contactPos,e.element),buttons:s.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData});else if(2===s.contacts&&e.pinchHandler&&"touch"===i.type){o.pinchGPoints=s.asArray();o.lastPinchDist=o.currentPinchDist=o.pinchGPoints[0].currentPos.distanceTo(o.pinchGPoints[1].currentPos);o.lastPinchCenter=o.currentPinchCenter=T(o.pinchGPoints[0].currentPos,o.pinchGPoints[1].currentPos)}}}else{t.shouldCapture=!1;t.shouldReleaseCapture=!1;if(e.nonPrimaryPressHandler&&!t.preventGesture&&!t.defaultPrevented){t.preventDefault=!0;e.nonPrimaryPressHandler({eventSource:e,pointerType:i.type,position:w(i.currentPos,e.element),button:r,buttons:s.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData})}}}function N(e,t,i,r){var n,o,s,a=u[e.hash],l=e.getActivePointersListByType(i.type),h=!1;void 0!==t.originalEvent.buttons?l.buttons=t.originalEvent.buttons:0===r?l.buttons^=-2:1===r?l.buttons^=-5:2===r?l.buttons^=-3:3===r?l.buttons^=-9:4===r?l.buttons^=-17:5===r&&(l.buttons^=-33);t.shouldCapture=!1;if(0===r){if(o=l.getById(i.id)){l.removeContact();o.captured&&(h=!0);o.lastPos=o.currentPos;o.lastTime=o.currentTime;o.currentPos=i.currentPos;o.currentTime=i.currentTime;o.insideElement||B(e,l,o);n=o.currentPos;s=o.currentTime}else{i.captured=!1;i.insideElementPressed=!1;i.insideElement=!0;F(l,i);o=i}if(!t.preventGesture&&!t.defaultPrevented)if(h){t.shouldReleaseCapture=!0;t.preventDefault=!0;(e.dragHandler||e.dragEndHandler||e.pinchHandler)&&c.MouseTracker.gesturePointVelocityTracker.removePoint(e,o);if(0===l.contacts){e.releaseHandler&&n&&e.releaseHandler({eventSource:e,pointerType:o.type,position:w(n,e.element),buttons:l.buttons,insideElementPressed:o.insideElementPressed,insideElementReleased:o.insideElement,isTouchEvent:"touch"===o.type,originalEvent:t.originalEvent,userData:e.userData});e.dragEndHandler&&a.sentDragEvent&&e.dragEndHandler({eventSource:e,pointerType:o.type,position:w(o.currentPos,e.element),speed:o.speed,direction:o.direction,shift:t.originalEvent.shiftKey,isTouchEvent:"touch"===o.type,originalEvent:t.originalEvent,userData:e.userData});a.sentDragEvent=!1;if((e.clickHandler||e.dblClickHandler)&&o.insideElement){s=s-o.contactTime<=e.clickTimeThreshold&&o.contactPos.distanceTo(n)<=e.clickDistThreshold;e.clickHandler&&e.clickHandler({eventSource:e,pointerType:o.type,position:w(o.currentPos,e.element),quick:s,shift:t.originalEvent.shiftKey,isTouchEvent:"touch"===o.type,originalEvent:t.originalEvent,originalTarget:o.originalTarget,userData:e.userData});if(e.dblClickHandler&&s){l.clicks++;if(1===l.clicks){a.lastClickPos=n;a.dblClickTimeOut=setTimeout(function(){l.clicks=0},e.dblClickTimeThreshold)}else if(2===l.clicks){clearTimeout(a.dblClickTimeOut);l.clicks=0;a.lastClickPos.distanceTo(n)<=e.dblClickDistThreshold&&e.dblClickHandler({eventSource:e,pointerType:o.type,position:w(o.currentPos,e.element),shift:t.originalEvent.shiftKey,isTouchEvent:"touch"===o.type,originalEvent:t.originalEvent,userData:e.userData});a.lastClickPos=null}}}}else if(2===l.contacts&&e.pinchHandler&&"touch"===o.type){a.pinchGPoints=l.asArray();a.lastPinchDist=a.currentPinchDist=a.pinchGPoints[0].currentPos.distanceTo(a.pinchGPoints[1].currentPos);a.lastPinchCenter=a.currentPinchCenter=T(a.pinchGPoints[0].currentPos,a.pinchGPoints[1].currentPos)}}else{t.shouldReleaseCapture=!1;if(e.releaseHandler&&n){e.releaseHandler({eventSource:e,pointerType:o.type,position:w(n,e.element),buttons:l.buttons,insideElementPressed:o.insideElementPressed,insideElementReleased:o.insideElement,isTouchEvent:"touch"===o.type,originalEvent:t.originalEvent,userData:e.userData});t.preventDefault=!0}}}else{t.shouldReleaseCapture=!1;if(e.nonPrimaryReleaseHandler&&!t.preventGesture&&!t.defaultPrevented){t.preventDefault=!0;e.nonPrimaryReleaseHandler({eventSource:e,pointerType:i.type,position:w(i.currentPos,e.element),button:r,buttons:l.buttons,isTouchEvent:"touch"===i.type,originalEvent:t.originalEvent,userData:e.userData})}}}function U(r,n,o){var e,t,i=u[r.hash],s=r.getActivePointersListByType(o.type);void 0!==n.originalEvent.buttons&&(s.buttons=n.originalEvent.buttons);if(e=s.getById(o.id)){e.lastPos=e.currentPos;e.lastTime=e.currentTime;e.currentPos=o.currentPos;e.currentTime=o.currentTime;n.shouldCapture=!1;n.shouldReleaseCapture=!1;if(r.stopHandler&&"mouse"===o.type){clearTimeout(r.stopTimeOut);r.stopTimeOut=setTimeout(function(){e=r,t=n.originalEvent,i=o.type,e.stopHandler&&e.stopHandler({eventSource:e,pointerType:i,position:_(t,e.element),buttons:e.getActivePointersListByType(i).buttons,isTouchEvent:"touch"===i,originalEvent:t,userData:e.userData});var e,t,i},r.stopDelay)}if(0===s.contacts)r.moveHandler&&r.moveHandler({eventSource:r,pointerType:o.type,position:w(o.currentPos,r.element),buttons:s.buttons,isTouchEvent:"touch"===o.type,originalEvent:n.originalEvent,userData:r.userData});else if(1===s.contacts){if(r.moveHandler){e=s.asArray()[0];r.moveHandler({eventSource:r,pointerType:e.type,position:w(e.currentPos,r.element),buttons:s.buttons,isTouchEvent:"touch"===e.type,originalEvent:n.originalEvent,userData:r.userData})}if(r.dragHandler&&!n.preventGesture&&!n.defaultPrevented){t=(e=s.asArray()[0]).currentPos.minus(e.lastPos);r.dragHandler({eventSource:r,pointerType:e.type,position:w(e.currentPos,r.element),buttons:s.buttons,delta:t,speed:e.speed,direction:e.direction,shift:n.originalEvent.shiftKey,isTouchEvent:"touch"===e.type,originalEvent:n.originalEvent,userData:r.userData});n.preventDefault=!0;i.sentDragEvent=!0}}else if(2===s.contacts){if(r.moveHandler){e=s.asArray();r.moveHandler({eventSource:r,pointerType:e[0].type,position:w(T(e[0].currentPos,e[1].currentPos),r.element),buttons:s.buttons,isTouchEvent:"touch"===e[0].type,originalEvent:n.originalEvent,userData:r.userData})}if(r.pinchHandler&&"touch"===o.type&&!n.preventGesture&&!n.defaultPrevented&&(t=i.pinchGPoints[0].currentPos.distanceTo(i.pinchGPoints[1].currentPos))!==i.currentPinchDist){i.lastPinchDist=i.currentPinchDist;i.currentPinchDist=t;i.lastPinchCenter=i.currentPinchCenter;i.currentPinchCenter=T(i.pinchGPoints[0].currentPos,i.pinchGPoints[1].currentPos);r.pinchHandler({eventSource:r,pointerType:"touch",gesturePoints:i.pinchGPoints,lastCenter:w(i.lastPinchCenter,r.element),center:w(i.currentPinchCenter,r.element),lastDistance:i.lastPinchDist,distance:i.currentPinchDist,shift:n.originalEvent.shiftKey,originalEvent:n.originalEvent,userData:r.userData});n.preventDefault=!0}}}}function G(e,t,i){var r=e.getActivePointersListByType(i.type);(i=r.getById(i.id))&&B(e,r,i)}}(OpenSeadragon);!function(n){n.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5};n.Control=function(e,t,i){var r=e.parentNode;if("number"==typeof t){n.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013");t={anchor:t}}t.attachToViewer=void 0===t.attachToViewer||t.attachToViewer;this.autoFade=void 0===t.autoFade||t.autoFade;this.element=e;this.anchor=t.anchor;this.container=i;if(this.anchor===n.ControlAnchor.ABSOLUTE){this.wrapper=n.makeNeutralElement("div");this.wrapper.style.position="absolute";this.wrapper.style.top="number"==typeof t.top?t.top+"px":t.top;this.wrapper.style.left="number"==typeof t.left?t.left+"px":t.left;this.wrapper.style.height="number"==typeof t.height?t.height+"px":t.height;this.wrapper.style.width="number"==typeof t.width?t.width+"px":t.width;this.wrapper.style.margin="0px";this.wrapper.style.padding="0px";this.element.style.position="relative";this.element.style.top="0px";this.element.style.left="0px";this.element.style.height="100%";this.element.style.width="100%"}else{this.wrapper=n.makeNeutralElement("div");this.wrapper.style.display="inline-block";this.anchor===n.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")}this.wrapper.appendChild(this.element);t.attachToViewer?this.anchor===n.ControlAnchor.TOP_RIGHT||this.anchor===n.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):r.appendChild(this.wrapper)};n.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element);this.anchor!==n.ControlAnchor.NONE&&this.container.removeChild(this.wrapper)},isVisible:function(){return"none"!==this.wrapper.style.display},setVisible:function(e){this.wrapper.style.display=e?this.anchor===n.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(e){n.setElementOpacity(this.wrapper,e,!0)}}}(OpenSeadragon);!function(n){n.ControlDock=function(e){var t,i,r=["topleft","topright","bottomright","bottomleft"];n.extend(!0,this,{id:"controldock-"+n.now()+"-"+Math.floor(1e6*Math.random()),container:n.makeNeutralElement("div"),controls:[]},e);this.container.onsubmit=function(){return!1};if(this.element){this.element=n.getElement(this.element);this.element.appendChild(this.container);"static"===n.getElementStyle(this.element).position&&(this.element.style.position="relative");this.container.style.width="100%";this.container.style.height="100%"}for(i=0;i<r.length;i++){this.controls[t=r[i]]=n.makeNeutralElement("div");this.controls[t].style.position="absolute";t.match("left")&&(this.controls[t].style.left="0px");t.match("right")&&(this.controls[t].style.right="0px");t.match("top")&&(this.controls[t].style.top="0px");t.match("bottom")&&(this.controls[t].style.bottom="0px")}this.container.appendChild(this.controls.topleft);this.container.appendChild(this.controls.topright);this.container.appendChild(this.controls.bottomright);this.container.appendChild(this.controls.bottomleft)};n.ControlDock.prototype={addControl:function(e,t){var i=null;if(!(0<=r(this,e=n.getElement(e)))){switch(t.anchor){case n.ControlAnchor.TOP_RIGHT:i=this.controls.topright;e.style.position="relative";e.style.paddingRight="0px";e.style.paddingTop="0px";break;case n.ControlAnchor.BOTTOM_RIGHT:i=this.controls.bottomright;e.style.position="relative";e.style.paddingRight="0px";e.style.paddingBottom="0px";break;case n.ControlAnchor.BOTTOM_LEFT:i=this.controls.bottomleft;e.style.position="relative";e.style.paddingLeft="0px";e.style.paddingBottom="0px";break;case n.ControlAnchor.TOP_LEFT:i=this.controls.topleft;e.style.position="relative";e.style.paddingLeft="0px";e.style.paddingTop="0px";break;case n.ControlAnchor.ABSOLUTE:i=this.container;e.style.margin="0px";e.style.padding="0px";break;default:case n.ControlAnchor.NONE:i=this.container;e.style.margin="0px";e.style.padding="0px"}this.controls.push(new n.Control(e,t,i));e.style.display="inline-block"}},removeControl:function(e){e=r(this,e=n.getElement(e));if(0<=e){this.controls[e].destroy();this.controls.splice(e,1)}return this},clearControls:function(){for(;0<this.controls.length;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var e;for(e=this.controls.length-1;0<=e;e--)if(this.controls[e].isVisible())return!0;return!1},setControlsEnabled:function(e){var t;for(t=this.controls.length-1;0<=t;t--)this.controls[t].setVisible(e);return this}};function r(e,t){var i,r=e.controls;for(i=r.length-1;0<=i;i--)if(r[i].element===t)return i;return-1}}(OpenSeadragon);!function(e){e.Placement=e.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(OpenSeadragon);!function(m){var c={};var s=1;m.Viewer=function(i){var e,t=arguments,r=this;if((i=!m.isPlainObject(i)?{id:t[0],xmlPath:1<t.length?t[1]:void 0,prefixUrl:2<t.length?t[2]:void 0,controls:3<t.length?t[3]:void 0,overlays:4<t.length?t[4]:void 0}:i).config){m.extend(!0,i,i.config);delete i.config}i.drawerOptions=Object.assign({},["useCanvas"].reduce((e,t)=>{e[t]=i[t];delete i[t];return e},{}),i.drawerOptions);m.extend(!0,this,{id:i.id,hash:i.hash||s++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttonGroup:null,profiler:null},m.DEFAULT_SETTINGS,i);if(void 0===this.hash)throw new Error("A hash must be defined, either by specifying options.id or options.hash.");void 0!==c[this.hash]&&m.console.warn("Hash "+this.hash+" has already been used.");c[this.hash]={fsBoundsDelta:new m.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,needsResize:!1,forceResize:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null,lastClickTime:null,draggingToZoom:!1};this._sequenceIndex=0;this._firstOpen=!0;this._updateRequestId=null;this._loadQueue=[];this.currentOverlays=[];this._updatePixelDensityRatioBind=null;this._lastScrollTime=m.now();this._fullyLoaded=!1;m.EventSource.call(this);this.addHandler("open-failed",function(e){e=m.getString("Errors.OpenFailed",e.eventSource,e.message);r._showMessage(e)});m.ControlDock.call(this,i);this.xmlPath&&(this.tileSources=[this.xmlPath]);this.element=this.element||document.getElementById(this.id);this.canvas=m.makeNeutralElement("div");this.canvas.className="openseadragon-canvas";if(!document.querySelector("style[data-openseadragon-mobile-css]")){t=document.createElement("style");t.setAttribute("data-openseadragon-mobile-css","true");t.textContent="@media (hover: none) {    .openseadragon-canvas:focus {        outline: none !important;    }}";document.head.appendChild(t)}!function(e){e.width="100%";e.height="100%";e.overflow="hidden";e.position="absolute";e.top="0px";e.left="0px"}(this.canvas.style);m.setElementTouchActionNone(this.canvas);""!==i.tabIndex&&(this.canvas.tabIndex=void 0===i.tabIndex?0:i.tabIndex);this.container.className="openseadragon-container";!function(e){e.width="100%";e.height="100%";e.position="relative";e.overflow="hidden";e.left="0px";e.top="0px";e.textAlign="left"}(this.container.style);m.setElementTouchActionNone(this.container);this.container.insertBefore(this.canvas,this.container.firstChild);this.element.appendChild(this.container);this.bodyWidth=document.body.style.width;this.bodyHeight=document.body.style.height;this.bodyOverflow=document.body.style.overflow;this.docOverflow=document.documentElement.style.overflow;this.innerTracker=new m.MouseTracker({userData:"Viewer.innerTracker",element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,contextMenuHandler:m.delegate(this,d),keyDownHandler:m.delegate(this,p),keyHandler:m.delegate(this,g),clickHandler:m.delegate(this,y),dblClickHandler:m.delegate(this,_),dragHandler:m.delegate(this,w),dragEndHandler:m.delegate(this,T),enterHandler:m.delegate(this,x),leaveHandler:m.delegate(this,b),pressHandler:m.delegate(this,E),releaseHandler:m.delegate(this,S),nonPrimaryPressHandler:m.delegate(this,C),nonPrimaryReleaseHandler:m.delegate(this,P),scrollHandler:m.delegate(this,L),pinchHandler:m.delegate(this,R),focusHandler:m.delegate(this,D),blurHandler:m.delegate(this,I)});this.outerTracker=new m.MouseTracker({userData:"Viewer.outerTracker",element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:m.delegate(this,A),leaveHandler:m.delegate(this,F)});this.toolbar&&(this.toolbar=new m.ControlDock({element:this.toolbar}));this.bindStandardControls();c[this.hash].prevContainerSize=a(this.container);if(window.ResizeObserver){this._autoResizePolling=!1;this._resizeObserver=new ResizeObserver(function(){c[r.hash].needsResize=!0});this._resizeObserver.observe(this.container,{})}else this._autoResizePolling=!0;this.world=new m.World({viewer:this});this.world.addHandler("add-item",function(e){r.source=r.world.getItemAt(0).source;c[r.hash].forceRedraw=!0;r._updateRequestId||(r._updateRequestId=l(r,B));e=e.item;function t(){var e=r._areAllFullyLoaded();if(e!==r._fullyLoaded){r._fullyLoaded=e;r.raiseEvent("fully-loaded-change",{fullyLoaded:e})}}e._fullyLoadedHandlerForViewer=t;e.addHandler("fully-loaded-change",t)});this.world.addHandler("remove-item",function(e){e=e.item;if(e._fullyLoadedHandlerForViewer){e.removeHandler("fully-loaded-change",e._fullyLoadedHandlerForViewer);delete e._fullyLoadedHandlerForViewer}r.world.getItemCount()?r.source=r.world.getItemAt(0).source:r.source=null;c[r.hash].forceRedraw=!0});this.world.addHandler("metrics-change",function(e){r.viewport&&r.viewport._setContentBounds(r.world.getHomeBounds(),r.world.getContentFactor())});this.world.addHandler("item-index-change",function(e){r.source=r.world.getItemAt(0).source});this.viewport=new m.Viewport({containerSize:c[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,overlayPreserveContentDirection:this.overlayPreserveContentDirection,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins,silenceMultiImageWarnings:this.silenceMultiImageWarnings});this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor());this.imageLoader=new m.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:i.timeout,tileRetryMax:this.tileRetryMax,tileRetryDelay:this.tileRetryDelay});this.tileCache=new m.TileCache({viewer:this,maxImageCacheCount:this.maxImageCacheCount});if(Object.prototype.hasOwnProperty.call(this.drawerOptions,"useCanvas")){m.console.error('useCanvas is deprecated, use the "drawer" option to indicate preferred drawer(s)');this.drawerOptions.useCanvas||(this.drawer=m.HTMLDrawer);delete this.drawerOptions.useCanvas}let n=Array.isArray(this.drawer)?this.drawer:[this.drawer];if(0===n.length){n=[m.DEFAULT_SETTINGS.drawer].flat();m.console.warn("No valid drawers were selected. Using the default value.")}this.drawer=null;for(const o of n)if(this.requestDrawer(o,{mainDrawer:!0,redrawImmediately:!1}))break;if(!this.drawer){m.console.error("No drawer could be created!");throw"Error with creating the selected drawer(s)"}this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled);this.overlaysContainer=m.makeNeutralElement("div");this.canvas.appendChild(this.overlaysContainer);if(!this.drawer.canRotate()){if(this.rotateLeft){e=this.buttonGroup.buttons.indexOf(this.rotateLeft);this.buttonGroup.buttons.splice(e,1);this.buttonGroup.element.removeChild(this.rotateLeft.element)}if(this.rotateRight){e=this.buttonGroup.buttons.indexOf(this.rotateRight);this.buttonGroup.buttons.splice(e,1);this.buttonGroup.element.removeChild(this.rotateRight.element)}}this._addUpdatePixelDensityRatioEvent();this.showNavigator&&(this.navigator=new m.Navigator({element:this.navigatorElement,id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy,animationTime:this.animationTime,drawer:this.drawer.getType(),loadTilesWithAjax:this.loadTilesWithAjax,ajaxHeaders:this.ajaxHeaders,ajaxWithCredentials:this.ajaxWithCredentials}));this.sequenceMode&&this.bindSequenceControls();this.tileSources&&this.open(this.tileSources);for(e=0;e<this.customControls.length;e++)this.addControl(this.customControls[e].id,{anchor:this.customControls[e].anchor});m.requestAnimationFrame(function(){u(r)});m._viewers.set(this.element,this)};m.extend(m.Viewer.prototype,m.EventSource.prototype,m.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},_areAllFullyLoaded:function(){var e=this.world.getItemCount();for(var t=0;t<e;t++)if(!this.world.getItemAt(t).getFullyLoaded())return!1;return!0},getFullyLoaded:function(){return this._fullyLoaded},whenFullyLoaded:function(e){this.getFullyLoaded()?setTimeout(e,1):this.addOnceHandler("fully-loaded-change",function(){e()})},openDzi:function(e){m.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead.");return this.open(e)},openTileSource:function(e){m.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead.");return this.open(e)},get buttons(){m.console.warn("Viewer.buttons is deprecated; Please use Viewer.buttonGroup");return this.buttonGroup},open:function(i,e){var n=this;this.close();if(!i)return this;if(this.sequenceMode&&m.isArray(i)){if(this.referenceStrip){this.referenceStrip.destroy();this.referenceStrip=null}void 0===e||isNaN(e)||(this.initialPage=e);this.tileSources=i;this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage));if(this.tileSources.length){this.open(this.tileSources[this._sequenceIndex]);this.showReferenceStrip&&this.addReferenceStrip()}this._updateSequenceButtons(this._sequenceIndex);return this}if(!(i=!m.isArray(i)?[i]:i).length)return this;this._opening=!0;var r=i.length;var o=0;var s=0;var a;var l=function(){if(o+s===r)if(o){if(n._firstOpen||!n.preserveViewport){n.viewport.goHome(!0);n.viewport.update()}n._firstOpen=!1;var e=i[0];e.tileSource&&(e=e.tileSource);if(n.overlays&&!n.preserveOverlays)for(var t=0;t<n.overlays.length;t++)n.currentOverlays[t]=h(n,n.overlays[t]);n._drawOverlays();n._opening=!1;n.raiseEvent("open",{source:e})}else{n._opening=!1;n.raiseEvent("open-failed",a)}};for(var t=0;t<i.length;t++)!function(i){if(void 0!==(i=!m.isPlainObject(i)||!i.tileSource?{tileSource:i}:i).index){m.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead");delete i.index}void 0===i.collectionImmediately&&(i.collectionImmediately=!0);var r=i.success;i.success=function(e){o++;if(i.tileSource.overlays)for(var t=0;t<i.tileSource.overlays.length;t++)n.addOverlay(i.tileSource.overlays[t]);r&&r(e);l()};var t=i.error;i.error=function(e){s++;a=a||e;t&&t(e);l()};n.addTiledImage(i)}(i[t]);return this},requestInvalidate:function(e=!0){if(!c[this.hash])return m.Promise.resolve();var t=m.now();var i=this.world.requestInvalidate(e,t);if(!this.navigator)return i;t=this.navigator.world.requestInvalidate(e,t);return m.Promise.all([i,t])},close:function(){if(!c[this.hash])return this;this._opening=!1;this.navigator&&this.navigator.close();if(!this.preserveOverlays){this.clearOverlays();this.overlaysContainer.innerHTML=""}c[this.hash].animating=!1;this.world.removeAll();this.tileCache.clear();this.imageLoader.clear();this.raiseEvent("close");return this},destroy:function(){if(c[this.hash]){this.raiseEvent("before-destroy");this._removeUpdatePixelDensityRatioEvent();this.close();this.clearOverlays();this.overlaysContainer.innerHTML="";this._resizeObserver&&this._resizeObserver.disconnect();if(this.referenceStrip){this.referenceStrip.destroy();this.referenceStrip=null}if(null!==this._updateRequestId){m.cancelAnimationFrame(this._updateRequestId);this._updateRequestId=null}this.drawer&&this.drawer.destroy();if(this.navigator){this.navigator.destroy();c[this.navigator.hash]=null;delete c[this.navigator.hash];this.navigator=null}if(this.buttonGroup)this.buttonGroup.destroy();else if(this.customButtons)for(;this.customButtons.length;)this.customButtons.pop().destroy();this.paging&&this.paging.destroy();this.container&&this.container.parentNode===this.element&&this.element.removeChild(this.container);this.container.onsubmit=null;this.clearControls();this.innerTracker&&this.innerTracker.destroy();this.outerTracker&&this.outerTracker.destroy();c[this.hash]=null;delete c[this.hash];this.canvas=null;this.container=null;m._viewers.delete(this.element);this.element=null;this.raiseEvent("destroy");this.removeAllHandlers()}},requestDrawer(e,t){var i=(t=m.extend(!0,{mainDrawer:!0,redrawImmediately:!0,drawerOptions:null},t)).mainDrawer;var r=t.redrawImmediately;t=t.drawerOptions;const n=this.drawer;let o=null;if(e&&e.prototype instanceof m.DrawerBase){o=e;e="custom"}else"string"==typeof e&&(o=m.determineDrawer(e));o||m.console.warn("Unsupported drawer %s! Drawer must be an existing string type, or a class that extends OpenSeadragon.DrawerBase.",e);if(o&&o.isSupported()){n&&i&&n.destroy();e=new o({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor,options:t||this.drawerOptions[e]});if(i){this.drawer=e;r&&this.forceRedraw()}return e}return!1},isMouseNavEnabled:function(){return this.innerTracker.tracking},setMouseNavEnabled:function(e){this.innerTracker.setTracking(e);this.outerTracker.setTracking(e);this.raiseEvent("mouse-enabled",{enabled:e});return this},areControlsEnabled:function(){var e,t=this.controls.length;for(e=0;e<this.controls.length;e++)t=t&&this.controls[e].isVisible();return t},setControlsEnabled:function(e){(e?r:u)(this);this.raiseEvent("controls-enabled",{enabled:e});return this},setDebugMode:function(e){for(var t=0;t<this.world.getItemCount();t++)this.world.getItemAt(t).debugMode=e;this.debugMode=e;this.forceRedraw()},setAjaxHeaders:function(e,t){if(m.isPlainObject(e=null===e?{}:e)){void 0===t&&(t=!0);this.ajaxHeaders=e;if(t){for(var i=0;i<this.world.getItemCount();i++)this.world.getItemAt(i)._updateAjaxHeaders(!0);this.navigator&&this.navigator.setAjaxHeaders(this.ajaxHeaders,!0);if(this.referenceStrip&&this.referenceStrip.miniViewers)for(var r in this.referenceStrip.miniViewers)this.referenceStrip.miniViewers[r].setAjaxHeaders(this.ajaxHeaders,!0)}}else m.console.error("[Viewer.setAjaxHeaders] Ignoring invalid headers, must be a plain object")},addButton:function(e){this.buttonGroup.addButton(e)},isFullPage:function(){return c[this.hash]&&c[this.hash].fullPage},setFullPage:function(e){var t,i,r=document.body,n=r.style,o=document.documentElement.style,s=this;if(e===this.isFullPage())return this;var a={fullPage:e,preventDefaultAction:!1};this.raiseEvent("pre-full-page",a);if(a.preventDefaultAction)return this;if(e&&this.element){this.elementSize=m.getElementSize(this.element);this.pageScroll=m.getPageScroll();this.elementMargin=this.element.style.margin;this.element.style.margin="0";this.elementPadding=this.element.style.padding;this.element.style.padding="0";this.bodyMargin=n.margin;this.docMargin=o.margin;n.margin="0";o.margin="0";this.bodyPadding=n.padding;this.docPadding=o.padding;n.padding="0";o.padding="0";this.bodyWidth=n.width;this.docWidth=o.width;n.width="100%";o.width="100%";this.bodyHeight=n.height;this.docHeight=o.height;n.height="100%";o.height="100%";this.bodyDisplay=n.display;n.display="block";this.previousBody=[];c[this.hash].prevElementParent=this.element.parentNode;c[this.hash].prevNextSibling=this.element.nextSibling;c[this.hash].prevElementWidth=this.element.style.width;c[this.hash].prevElementHeight=this.element.style.height;t=r.childNodes.length;for(i=0;i<t;i++){this.previousBody.push(r.childNodes[0]);r.removeChild(r.childNodes[0])}if(this.toolbar&&this.toolbar.element){this.toolbar.parentNode=this.toolbar.element.parentNode;this.toolbar.nextSibling=this.toolbar.element.nextSibling;r.appendChild(this.toolbar.element);m.addClass(this.toolbar.element,"fullpage")}m.addClass(this.element,"fullpage");r.appendChild(this.element);this.element.style.height="100vh";this.element.style.width="100vw";this.toolbar&&this.toolbar.element&&(this.element.style.height=m.getElementSize(this.element).y-m.getElementSize(this.toolbar.element).y+"px");c[this.hash].fullPage=!0;m.delegate(this,A)({})}else{this.element.style.margin=this.elementMargin;this.element.style.padding=this.elementPadding;n.margin=this.bodyMargin;o.margin=this.docMargin;n.padding=this.bodyPadding;o.padding=this.docPadding;n.width=this.bodyWidth;o.width=this.docWidth;n.height=this.bodyHeight;o.height=this.docHeight;n.display=this.bodyDisplay;r.removeChild(this.element);t=this.previousBody.length;for(i=0;i<t;i++)r.appendChild(this.previousBody.shift());m.removeClass(this.element,"fullpage");c[this.hash].prevElementParent.insertBefore(this.element,c[this.hash].prevNextSibling);if(this.toolbar&&this.toolbar.element){r.removeChild(this.toolbar.element);m.removeClass(this.toolbar.element,"fullpage");this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling);delete this.toolbar.parentNode;delete this.toolbar.nextSibling}this.element.style.width=c[this.hash].prevElementWidth;this.element.style.height=c[this.hash].prevElementHeight;var l=0;var h=function(){m.setPageScroll(s.pageScroll);var e=m.getPageScroll();++l<10&&(e.x!==s.pageScroll.x||e.y!==s.pageScroll.y)&&m.requestAnimationFrame(h)};m.requestAnimationFrame(h);c[this.hash].fullPage=!1;m.delegate(this,F)({})}this.navigator&&this.viewport&&this.navigator.update(this.viewport);this.raiseEvent("full-page",{fullPage:e});return this},setFullScreen:function(e){var t=this;if(!m.supportsFullScreen)return this.setFullPage(e);if(m.isFullScreen()===e)return this;var i={fullScreen:e,preventDefaultAction:!1};this.raiseEvent("pre-full-screen",i);if(i.preventDefaultAction)return this;if(e){this.setFullPage(!0);if(!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width;this.fullPageStyleHeight=this.element.style.height;this.element.style.width="100%";this.element.style.height="100%";var r=function(){var e=m.isFullScreen();if(!e){m.removeEvent(document,m.fullScreenEventName,r);m.removeEvent(document,m.fullScreenErrorEventName,r);t.setFullPage(!1);if(t.isFullPage()){t.element.style.width=t.fullPageStyleWidth;t.element.style.height=t.fullPageStyleHeight}}t.navigator&&t.viewport&&setTimeout(function(){t.navigator.update(t.viewport)});t.raiseEvent("full-screen",{fullScreen:e})};m.addEvent(document,m.fullScreenEventName,r);m.addEvent(document,m.fullScreenErrorEventName,r);m.requestFullScreen(document.body)}else m.exitFullScreen();return this},isVisible:function(){return"hidden"!==this.container.style.visibility},isFullScreen:function(){return m.isFullScreen()&&this.isFullPage()},setVisible:function(e){this.container.style.visibility=e?"":"hidden";this.raiseEvent("visible",{visible:e});return this},addTiledImage:function(i){m.console.assert(i,"[Viewer.addTiledImage] options is required");m.console.assert(i.tileSource,"[Viewer.addTiledImage] options.tileSource is required");m.console.assert(!i.replace||-1<i.index&&i.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var n=this;i.replace&&(i.replaceItem=n.world.getItemAt(i.index));this._hideMessage();void 0===i.placeholderFillStyle&&(i.placeholderFillStyle=this.placeholderFillStyle);void 0===i.opacity&&(i.opacity=this.opacity);void 0===i.preload&&(i.preload=this.preload);void 0===i.compositeOperation&&(i.compositeOperation=this.compositeOperation);void 0===i.crossOriginPolicy&&(i.crossOriginPolicy=(void 0!==i.tileSource.crossOriginPolicy?i.tileSource:this).crossOriginPolicy);void 0===i.ajaxWithCredentials&&(i.ajaxWithCredentials=this.ajaxWithCredentials);void 0===i.loadTilesWithAjax&&(i.loadTilesWithAjax=this.loadTilesWithAjax);m.isPlainObject(i.ajaxHeaders)||(i.ajaxHeaders={});var r={options:i};function t(e){for(var t=0;t<n._loadQueue.length;t++)if(n._loadQueue[t]===r){n._loadQueue.splice(t,1);break}0===n._loadQueue.length&&o(r);n.raiseEvent("add-item-failed",e);i.error&&i.error(e)}function o(e){if(n.collectionMode){n.world.arrange({immediately:e.options.collectionImmediately,rows:n.collectionRows,columns:n.collectionColumns,layout:n.collectionLayout,tileSize:n.collectionTileSize,tileMargin:n.collectionTileMargin});n.world.setAutoRefigureSizes(!0)}}if(m.isArray(i.tileSource))setTimeout(function(){t({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:i.tileSource,options:i})});else{this._loadQueue.push(r);!function(i,r,n,o,s){var a=i;if("string"===m.type(r))if(r.match(/^\s*<.*>\s*$/))r=m.parseXml(r);else if(r.match(/^\s*[{[].*[}\]]\s*$/))try{var e=m.parseJSON(r);r=e}catch(e){}function l(e,t){if(e.ready)o(e);else{e.addHandler("ready",function(){o(e)});e.addHandler("open-failed",function(e){s({message:e.message,source:t})})}}setTimeout(function(){if("string"===m.type(r))(r=new m.TileSource({url:r,crossOriginPolicy:(void 0!==n.crossOriginPolicy?n:i).crossOriginPolicy,ajaxWithCredentials:i.ajaxWithCredentials,ajaxHeaders:n.ajaxHeaders||i.ajaxHeaders,splitHashDataForPost:i.splitHashDataForPost,success:function(e){o(e.tileSource)}})).addHandler("open-failed",function(e){s(e)});else if(m.isPlainObject(r)||r.nodeType){void 0!==r.crossOriginPolicy||void 0===n.crossOriginPolicy&&void 0===i.crossOriginPolicy||(r.crossOriginPolicy=(void 0!==n.crossOriginPolicy?n:i).crossOriginPolicy);void 0===r.ajaxWithCredentials&&(r.ajaxWithCredentials=i.ajaxWithCredentials);if(m.isFunction(r.getTileUrl)){var e=new m.TileSource(r);e.getTileUrl=r.getTileUrl;o(e)}else{var t=m.TileSource.determineType(a,r);if(t){e=t.prototype.configure.apply(a,[r]);l(new t(e),r)}else s({message:"Unable to load TileSource",source:r})}}else l(r,r)})}(this,i.tileSource,i,function(e){r.tileSource=e;s()},function(e){e.options=i;t(e);s()})}function s(){var e,t;for(;n._loadQueue.length&&(e=n._loadQueue[0]).tileSource;){n._loadQueue.splice(0,1);if(e.options.replace){const r=e.options.replaceItem;var i=n.world.getIndexOfItem(r);-1!==i&&(e.options.index=i);!r._zombieCache&&r.source.equals(e.tileSource)&&r.allowZombieCache(!0);n.world.removeItem(r)}t=new m.TiledImage({viewer:n,source:e.tileSource,viewport:n.viewport,drawer:n.drawer,tileCache:n.tileCache,imageLoader:n.imageLoader,x:e.options.x,y:e.options.y,width:e.options.width,height:e.options.height,fitBounds:e.options.fitBounds,fitBoundsPlacement:e.options.fitBoundsPlacement,clip:e.options.clip,placeholderFillStyle:e.options.placeholderFillStyle,opacity:e.options.opacity,preload:e.options.preload,degrees:e.options.degrees,flipped:e.options.flipped,compositeOperation:e.options.compositeOperation,springStiffness:n.springStiffness,animationTime:n.animationTime,minZoomImageRatio:n.minZoomImageRatio,wrapHorizontal:n.wrapHorizontal,wrapVertical:n.wrapVertical,maxTilesPerFrame:n.maxTilesPerFrame,loadDestinationTilesOnAnimation:n.loadDestinationTilesOnAnimation,immediateRender:n.immediateRender,blendTime:n.blendTime,alwaysBlend:n.alwaysBlend,minPixelRatio:n.minPixelRatio,smoothTileEdgesMinZoom:n.smoothTileEdgesMinZoom,iOSDevice:n.iOSDevice,crossOriginPolicy:e.options.crossOriginPolicy,ajaxWithCredentials:e.options.ajaxWithCredentials,loadTilesWithAjax:e.options.loadTilesWithAjax,ajaxHeaders:e.options.ajaxHeaders,debugMode:n.debugMode,subPixelRoundingForTransparency:n.subPixelRoundingForTransparency,callTileLoadedWithCachedData:n.callTileLoadedWithCachedData});n.collectionMode&&n.world.setAutoRefigureSizes(!1);if(n.navigator){i=m.extend({},e.options,{replace:!1,originalTiledImage:t,tileSource:e.tileSource});n.navigator.addTiledImage(i)}n.world.addItem(t,{index:e.options.index});0===n._loadQueue.length&&o(e);1!==n.world.getItemCount()||n.preserveViewport||n.viewport.goHome(!0);e.options.success&&e.options.success({item:t});n.drawer.tiledImageCreated(t)}}},addSimpleImage:function(e){m.console.assert(e,"[Viewer.addSimpleImage] options is required");m.console.assert(e.url,"[Viewer.addSimpleImage] options.url is required");e=m.extend({},e,{tileSource:{type:"image",url:e.url}});delete e.url;this.addTiledImage(e)},addLayer:function(t){var i=this;m.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var e=m.extend({},t,{success:function(e){i.raiseEvent("add-layer",{options:t,drawer:e.item})},error:function(e){i.raiseEvent("add-layer-failed",e)}});this.addTiledImage(e);return this},getLayerAtLevel:function(e){m.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead.");return this.world.getItemAt(e)},getLevelOfLayer:function(e){m.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead.");return this.world.getIndexOfItem(e)},getLayersCount:function(){m.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead.");return this.world.getItemCount()},setLayerLevel:function(e,t){m.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead.");return this.world.setItemIndex(e,t)},removeLayer:function(e){m.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead.");return this.world.removeItem(e)},forceRedraw:function(){c[this.hash].forceRedraw=!0;return this},forceResize:function(){c[this.hash].needsResize=!0;c[this.hash].forceResize=!0},bindSequenceControls:function(){var e=m.delegate(this,f),t=m.delegate(this,v),i=m.delegate(this,this.goToNextPage),r=m.delegate(this,this.goToPreviousPage),n=this.navImages,o=!0;if(this.showSequenceControl){(this.previousButton||this.nextButton)&&(o=!1);this.previousButton=new m.Button({element:this.previousButton?m.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.PreviousPage"),srcRest:O(this.prefixUrl,n.previous.REST),srcGroup:O(this.prefixUrl,n.previous.GROUP),srcHover:O(this.prefixUrl,n.previous.HOVER),srcDown:O(this.prefixUrl,n.previous.DOWN),onRelease:r,onFocus:e,onBlur:t});this.nextButton=new m.Button({element:this.nextButton?m.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.NextPage"),srcRest:O(this.prefixUrl,n.next.REST),srcGroup:O(this.prefixUrl,n.next.GROUP),srcHover:O(this.prefixUrl,n.next.HOVER),srcDown:O(this.prefixUrl,n.next.DOWN),onRelease:i,onFocus:e,onBlur:t});this.navPrevNextWrap||this.previousButton.disable();this.tileSources&&this.tileSources.length||this.nextButton.disable();if(o){this.paging=new m.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold});this.pagingControl=this.paging.element;this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:m.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||m.ControlAnchor.TOP_LEFT})}}return this},bindStandardControls:function(){var e=m.delegate(this,this.startZoomInAction),t=m.delegate(this,this.endZoomAction),i=m.delegate(this,this.singleZoomInAction),r=m.delegate(this,this.startZoomOutAction),n=m.delegate(this,this.singleZoomOutAction),o=m.delegate(this,k),s=m.delegate(this,z),a=m.delegate(this,H),l=m.delegate(this,N),h=m.delegate(this,U),c=m.delegate(this,f),u=m.delegate(this,v),d=this.navImages,p=[],g=!0;if(this.showNavigationControl){(this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(g=!1);if(this.showZoomControl){p.push(this.zoomInButton=new m.Button({element:this.zoomInButton?m.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.ZoomIn"),srcRest:O(this.prefixUrl,d.zoomIn.REST),srcGroup:O(this.prefixUrl,d.zoomIn.GROUP),srcHover:O(this.prefixUrl,d.zoomIn.HOVER),srcDown:O(this.prefixUrl,d.zoomIn.DOWN),onPress:e,onRelease:t,onClick:i,onEnter:e,onExit:t,onFocus:c,onBlur:u}));p.push(this.zoomOutButton=new m.Button({element:this.zoomOutButton?m.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.ZoomOut"),srcRest:O(this.prefixUrl,d.zoomOut.REST),srcGroup:O(this.prefixUrl,d.zoomOut.GROUP),srcHover:O(this.prefixUrl,d.zoomOut.HOVER),srcDown:O(this.prefixUrl,d.zoomOut.DOWN),onPress:r,onRelease:t,onClick:n,onEnter:r,onExit:t,onFocus:c,onBlur:u}))}this.showHomeControl&&p.push(this.homeButton=new m.Button({element:this.homeButton?m.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.Home"),srcRest:O(this.prefixUrl,d.home.REST),srcGroup:O(this.prefixUrl,d.home.GROUP),srcHover:O(this.prefixUrl,d.home.HOVER),srcDown:O(this.prefixUrl,d.home.DOWN),onRelease:o,onFocus:c,onBlur:u}));this.showFullPageControl&&p.push(this.fullPageButton=new m.Button({element:this.fullPageButton?m.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.FullPage"),srcRest:O(this.prefixUrl,d.fullpage.REST),srcGroup:O(this.prefixUrl,d.fullpage.GROUP),srcHover:O(this.prefixUrl,d.fullpage.HOVER),srcDown:O(this.prefixUrl,d.fullpage.DOWN),onRelease:s,onFocus:c,onBlur:u}));if(this.showRotationControl){p.push(this.rotateLeftButton=new m.Button({element:this.rotateLeftButton?m.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.RotateLeft"),srcRest:O(this.prefixUrl,d.rotateleft.REST),srcGroup:O(this.prefixUrl,d.rotateleft.GROUP),srcHover:O(this.prefixUrl,d.rotateleft.HOVER),srcDown:O(this.prefixUrl,d.rotateleft.DOWN),onRelease:a,onFocus:c,onBlur:u}));p.push(this.rotateRightButton=new m.Button({element:this.rotateRightButton?m.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.RotateRight"),srcRest:O(this.prefixUrl,d.rotateright.REST),srcGroup:O(this.prefixUrl,d.rotateright.GROUP),srcHover:O(this.prefixUrl,d.rotateright.HOVER),srcDown:O(this.prefixUrl,d.rotateright.DOWN),onRelease:l,onFocus:c,onBlur:u}))}this.showFlipControl&&p.push(this.flipButton=new m.Button({element:this.flipButton?m.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:m.getString("Tooltips.Flip"),srcRest:O(this.prefixUrl,d.flip.REST),srcGroup:O(this.prefixUrl,d.flip.GROUP),srcHover:O(this.prefixUrl,d.flip.HOVER),srcDown:O(this.prefixUrl,d.flip.DOWN),onRelease:h,onFocus:c,onBlur:u}));if(g){this.buttonGroup=new m.ButtonGroup({buttons:p,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold});this.navControl=this.buttonGroup.element;this.addHandler("open",m.delegate(this,M));(this.toolbar||this).addControl(this.navControl,{anchor:this.navigationControlAnchor||m.ControlAnchor.TOP_LEFT})}else this.customButtons=p}return this},currentPage:function(){return this._sequenceIndex},goToPage:function(e){if(this.tileSources&&0<=e&&e<this.tileSources.length){this._sequenceIndex=e;this._updateSequenceButtons(e);this.open(this.tileSources[e]);this.referenceStrip&&this.referenceStrip.setFocus(e);this.raiseEvent("page",{page:e})}return this},addOverlay:function(e,t,i,r){i=m.isPlainObject(e)?e:{element:e,location:t,placement:i,onDraw:r};e=m.getElement(i.element);if(0<=n(this.currentOverlays,e))return this;r=h(this,i);this.currentOverlays.push(r);r.drawHTML(this.overlaysContainer,this.viewport);this.raiseEvent("add-overlay",{element:e,location:i.location,placement:i.placement});return this},updateOverlay:function(e,t,i){var r;e=m.getElement(e);if(0<=(r=n(this.currentOverlays,e))){this.currentOverlays[r].update(t,i);c[this.hash].forceRedraw=!0;this.raiseEvent("update-overlay",{element:e,location:t,placement:i})}return this},removeOverlay:function(e){var t;e=m.getElement(e);if(0<=(t=n(this.currentOverlays,e))){this.currentOverlays[t].destroy();this.currentOverlays.splice(t,1);c[this.hash].forceRedraw=!0;this.raiseEvent("remove-overlay",{element:e})}return this},clearOverlays:function(){for(;0<this.currentOverlays.length;)this.currentOverlays.pop().destroy();c[this.hash].forceRedraw=!0;this.raiseEvent("clear-overlay",{});return this},getOverlayById:function(e){e=m.getElement(e);return 0<=(e=n(this.currentOverlays,e))?this.currentOverlays[e]:null},_updateSequenceButtons:function(e){this.nextButton&&(this.tileSources&&this.tileSources.length-1!==e?this.nextButton.enable():this.navPrevNextWrap||this.nextButton.disable());this.previousButton&&(0<e?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(e){this._hideMessage();var t=m.makeNeutralElement("div");t.appendChild(document.createTextNode(e));this.messageDiv=m.makeCenteredNode(t);m.addClass(this.messageDiv,"openseadragon-message");this.container.appendChild(this.messageDiv)},_hideMessage:function(){var e=this.messageDiv;if(e){e.parentNode.removeChild(e);delete this.messageDiv}},gestureSettingsByDeviceType:function(e){switch(e){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var e,t=this.currentOverlays.length;for(e=0;e<t;e++)this.currentOverlays[e].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1;if(this.referenceStrip){this.referenceStrip.destroy();this.referenceStrip=null}},addReferenceStrip:function(){this.showReferenceStrip=!0;if(this.sequenceMode){if(!this.referenceStrip&&this.tileSources.length&&1<this.tileSources.length){this.referenceStrip=new m.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,viewer:this});this.referenceStrip.setFocus(this._sequenceIndex)}}else m.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')},_addUpdatePixelDensityRatioEvent:function(){this._updatePixelDensityRatioBind=this._updatePixelDensityRatio.bind(this);m.addEvent(window,"resize",this._updatePixelDensityRatioBind)},_removeUpdatePixelDensityRatioEvent:function(){m.removeEvent(window,"resize",this._updatePixelDensityRatioBind)},_updatePixelDensityRatio:function(){var e=m.pixelDensityRatio;var t=m.getCurrentPixelDensityRatio();if(e!==t){m.pixelDensityRatio=t;this.forceResize()}},goToPreviousPage:function(){var e=this._sequenceIndex-1;this.navPrevNextWrap&&e<0&&(e+=this.tileSources.length);this.goToPage(e)},goToNextPage:function(){var e=this._sequenceIndex+1;this.navPrevNextWrap&&e>=this.tileSources.length&&(e=0);this.goToPage(e)},isAnimating:function(){return c[this.hash].animating},startZoomInAction:function(){c[this.hash].lastZoomTime=m.now();c[this.hash].zoomFactor=this.zoomPerSecond;c[this.hash].zooming=!0;i(this)},startZoomOutAction:function(){c[this.hash].lastZoomTime=m.now();c[this.hash].zoomFactor=1/this.zoomPerSecond;c[this.hash].zooming=!0;i(this)},endZoomAction:function(){c[this.hash].zooming=!1},singleZoomInAction:function(){if(this.viewport){c[this.hash].zooming=!1;this.viewport.zoomBy(+this.zoomPerClick);this.viewport.applyConstraints()}},singleZoomOutAction:function(){if(this.viewport){c[this.hash].zooming=!1;this.viewport.zoomBy(1/this.zoomPerClick);this.viewport.applyConstraints()}}});function a(e){e=m.getElement(e);return new m.Point(0===e.clientWidth?1:e.clientWidth,0===e.clientHeight?1:e.clientHeight)}function h(e,t){if(t instanceof m.Overlay)return t;var i=null;if(t.element)i=m.getElement(t.element);else{var r=t.id||"openseadragon-overlay-"+Math.floor(1e7*Math.random());(i=m.getElement(t.id))||((i=document.createElement("a")).href="#/overlay/"+r);i.id=r;m.addClass(i,t.className||"openseadragon-overlay")}var n=t.location;var o=t.width;var s=t.height;if(!n){r=t.x;var a=t.y;if(void 0!==t.px){e=e.viewport.imageToViewportRectangle(new m.Rect(t.px,t.py,o||0,s||0));r=e.x;a=e.y;o=void 0!==o?e.width:void 0;s=void 0!==s?e.height:void 0}n=new m.Point(r,a)}a=t.placement;a&&"string"===m.type(a)&&(a=m.Placement[t.placement.toUpperCase()]);return new m.Overlay({element:i,location:n,placement:a,onDraw:t.onDraw,checkResize:t.checkResize,width:o,height:s,rotationMode:t.rotationMode})}function n(e,t){var i;for(i=e.length-1;0<=i;i--)if(e[i].element===t)return i;return-1}function l(e,t){return m.requestAnimationFrame(function(){t(e)})}function o(e){m.requestAnimationFrame(function(){!function(e){var t,i,r;if(e.controlsShouldFade){t=m.now();t=t-e.controlsFadeBeginTime;i=1-t/e.controlsFadeLength;i=Math.min(1,i);i=Math.max(0,i);for(r=e.controls.length-1;0<=r;r--)e.controls[r].autoFade&&e.controls[r].setOpacity(i);0<i&&o(e)}}(e)})}function u(e){if(e.autoHideControls){e.controlsShouldFade=!0;e.controlsFadeBeginTime=m.now()+e.controlsFadeDelay;window.setTimeout(function(){o(e)},e.controlsFadeDelay)}}function r(e){var t;e.controlsShouldFade=!1;for(t=e.controls.length-1;0<=t;t--)e.controls[t].setOpacity(1)}function f(){r(this)}function v(){u(this)}function d(e){var t={tracker:e.eventSource,position:e.position,originalEvent:e.originalEvent,preventDefault:e.preventDefault};this.raiseEvent("canvas-contextmenu",t);e.preventDefault=t.preventDefault}function p(e){var t={originalEvent:e.originalEvent,preventDefaultAction:!1,preventVerticalPan:e.preventVerticalPan||!this.panVertical,preventHorizontalPan:e.preventHorizontalPan||!this.panHorizontal};this.raiseEvent("canvas-key",t);if(t.preventDefaultAction||e.ctrl||e.alt||e.meta)e.preventDefault=!1;else switch(e.keyCode){case 38:if(!t.preventVerticalPan){e.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(0,-this.pixelsPerArrowPress)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 40:if(!t.preventVerticalPan){e.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(0,this.pixelsPerArrowPress)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 37:if(!t.preventHorizontalPan){this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(-this.pixelsPerArrowPress,0)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 39:if(!t.preventHorizontalPan){this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(this.pixelsPerArrowPress,0)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 187:this.viewport.zoomBy(1.1);this.viewport.applyConstraints();e.preventDefault=!0;break;case 189:this.viewport.zoomBy(.9);this.viewport.applyConstraints();e.preventDefault=!0;break;case 48:this.viewport.goHome();this.viewport.applyConstraints();e.preventDefault=!0;break;case 87:if(!t.preventVerticalPan){e.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(0,-40)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 83:if(!t.preventVerticalPan){e.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(0,40)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 65:if(!t.preventHorizontalPan){this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(-40,0)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 68:if(!t.preventHorizontalPan){this.viewport.panBy(this.viewport.deltaPointsFromPixels(new m.Point(40,0)));this.viewport.applyConstraints()}e.preventDefault=!0;break;case 82:e.shift?this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.flipped?this.viewport.setRotation(this.viewport.getRotation()-this.rotationIncrement):this.viewport.setRotation(this.viewport.getRotation()+this.rotationIncrement);this.viewport.applyConstraints();e.preventDefault=!0;break;case 70:this.viewport.toggleFlip();e.preventDefault=!0;break;case 74:this.goToPreviousPage();break;case 75:this.goToNextPage();break;default:e.preventDefault=!1}}function g(e){e={originalEvent:e.originalEvent};this.raiseEvent("canvas-key-press",e)}function y(e){document.activeElement===this.canvas||this.canvas.focus();this.viewport.flipped&&(e.position.x=this.viewport.getContainerSize().x-e.position.x);var t={tracker:e.eventSource,position:e.position,quick:e.quick,shift:e.shift,originalEvent:e.originalEvent,originalTarget:e.originalTarget,preventDefaultAction:!1};this.raiseEvent("canvas-click",t);if(!t.preventDefaultAction&&this.viewport&&e.quick){if(!0===(t=this.gestureSettingsByDeviceType(e.pointerType)).clickToZoom){this.viewport.zoomBy(e.shift?1/this.zoomPerClick:this.zoomPerClick,t.zoomToRefPoint?this.viewport.pointFromPixel(e.position,!0):null);this.viewport.applyConstraints()}if(t.dblClickDragToZoom)if(!0===c[this.hash].draggingToZoom){c[this.hash].lastClickTime=null;c[this.hash].draggingToZoom=!1}else c[this.hash].lastClickTime=m.now()}}function _(e){var t;var i={tracker:e.eventSource,position:e.position,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-double-click",i);if(!i.preventDefaultAction&&this.viewport&&(t=this.gestureSettingsByDeviceType(e.pointerType)).dblClickToZoom){this.viewport.zoomBy(e.shift?1/this.zoomPerClick:this.zoomPerClick,t.zoomToRefPoint?this.viewport.pointFromPixel(e.position,!0):null);this.viewport.applyConstraints()}}function w(e){var t;var i={tracker:e.eventSource,pointerType:e.pointerType,position:e.position,delta:e.delta,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-drag",i);t=this.gestureSettingsByDeviceType(e.pointerType);if(!i.preventDefaultAction&&this.viewport)if(t.dblClickDragToZoom&&c[this.hash].draggingToZoom){var r=Math.pow(this.zoomPerDblClickDrag,e.delta.y/50);this.viewport.zoomBy(r)}else if(t.dragToPan&&!c[this.hash].draggingToZoom){this.panHorizontal||(e.delta.x=0);this.panVertical||(e.delta.y=0);this.viewport.flipped&&(e.delta.x=-e.delta.x);if(this.constrainDuringPan){i=this.viewport.deltaPointsFromPixels(e.delta.negate());this.viewport.centerSpringX.target.value+=i.x;this.viewport.centerSpringY.target.value+=i.y;r=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=i.x;this.viewport.centerSpringY.target.value-=i.y;r.xConstrained&&(e.delta.x=0);r.yConstrained&&(e.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(e.delta.negate()),t.flickEnabled&&!this.constrainDuringPan)}}function T(e){var t;var i={tracker:e.eventSource,pointerType:e.pointerType,position:e.position,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.raiseEvent("canvas-drag-end",i);t=this.gestureSettingsByDeviceType(e.pointerType);if(!i.preventDefaultAction&&this.viewport){if(!c[this.hash].draggingToZoom&&t.dragToPan&&t.flickEnabled&&e.speed>=t.flickMinSpeed){var r=0;this.panHorizontal&&(r=t.flickMomentum*e.speed*Math.cos(e.direction));i=0;this.panVertical&&(i=t.flickMomentum*e.speed*Math.sin(e.direction));e=this.viewport.pixelFromPoint(this.viewport.getCenter(!0));i=this.viewport.pointFromPixel(new m.Point(e.x-r,e.y-i));this.viewport.panTo(i,!1)}this.viewport.applyConstraints()}t.dblClickDragToZoom&&!0===c[this.hash].draggingToZoom&&(c[this.hash].draggingToZoom=!1)}function x(e){this.raiseEvent("canvas-enter",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function b(e){this.raiseEvent("canvas-exit",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function E(e){this.raiseEvent("canvas-press",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,insideElementPressed:e.insideElementPressed,insideElementReleased:e.insideElementReleased,originalEvent:e.originalEvent});if(this.gestureSettingsByDeviceType(e.pointerType).dblClickDragToZoom){var t=c[this.hash].lastClickTime;e=m.now();if(null!==t){e-t<this.dblClickTimeThreshold&&(c[this.hash].draggingToZoom=!0);c[this.hash].lastClickTime=null}}}function S(e){this.raiseEvent("canvas-release",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,insideElementPressed:e.insideElementPressed,insideElementReleased:e.insideElementReleased,originalEvent:e.originalEvent})}function C(e){this.raiseEvent("canvas-nonprimary-press",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function P(e){this.raiseEvent("canvas-nonprimary-release",{tracker:e.eventSource,position:e.position,pointerType:e.pointerType,button:e.button,buttons:e.buttons,originalEvent:e.originalEvent})}function R(e){var t,i;var r={tracker:e.eventSource,pointerType:e.pointerType,gesturePoints:e.gesturePoints,lastCenter:e.lastCenter,center:e.center,lastDistance:e.lastDistance,distance:e.distance,shift:e.shift,originalEvent:e.originalEvent,preventDefaultPanAction:!1,preventDefaultZoomAction:!1,preventDefaultRotateAction:!1};this.raiseEvent("canvas-pinch",r);if(this.viewport){if((n=this.gestureSettingsByDeviceType(e.pointerType)).pinchToZoom&&(!r.preventDefaultPanAction||!r.preventDefaultZoomAction)){t=this.viewport.pointFromPixel(e.center,!0);if(n.zoomToRefPoint&&!r.preventDefaultPanAction){i=this.viewport.pointFromPixel(e.lastCenter,!0).minus(t);this.panHorizontal||(i.x=0);this.panVertical||(i.y=0);this.viewport.panBy(i,!0)}r.preventDefaultZoomAction||this.viewport.zoomBy(e.distance/e.lastDistance,t,!0);this.viewport.applyConstraints()}if(n.pinchRotate&&!r.preventDefaultRotateAction){var n=Math.atan2(e.gesturePoints[0].currentPos.y-e.gesturePoints[1].currentPos.y,e.gesturePoints[0].currentPos.x-e.gesturePoints[1].currentPos.x);r=Math.atan2(e.gesturePoints[0].lastPos.y-e.gesturePoints[1].lastPos.y,e.gesturePoints[0].lastPos.x-e.gesturePoints[1].lastPos.x);t=this.viewport.pointFromPixel(e.center,!0);this.viewport.rotateTo(this.viewport.getRotation(!0)+(n-r)*(180/Math.PI),t,!0)}}}function D(e){this.raiseEvent("canvas-focus",{tracker:e.eventSource,originalEvent:e.originalEvent})}function I(e){this.raiseEvent("canvas-blur",{tracker:e.eventSource,originalEvent:e.originalEvent})}function L(e){var t,i,r;if((r=m.now())-this._lastScrollTime>this.minScrollDeltaTime){this._lastScrollTime=r;t={tracker:e.eventSource,position:e.position,scroll:e.scroll,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1,preventDefault:!0};this.raiseEvent("canvas-scroll",t);if(!t.preventDefaultAction&&this.viewport){this.viewport.flipped&&(e.position.x=this.viewport.getContainerSize().x-e.position.x);if((i=this.gestureSettingsByDeviceType(e.pointerType)).scrollToZoom){r=Math.pow(this.zoomPerScroll,e.scroll);this.viewport.zoomBy(r,i.zoomToRefPoint?this.viewport.pointFromPixel(e.position,!0):null);this.viewport.applyConstraints()}}e.preventDefault=t.preventDefault}else e.preventDefault=!0}function A(e){c[this.hash].mouseInside=!0;r(this);this.raiseEvent("container-enter",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function F(e){if(e.pointers<1){c[this.hash].mouseInside=!1;c[this.hash].animating||u(this)}this.raiseEvent("container-exit",{tracker:e.eventSource,pointerType:e.pointerType,position:e.position,buttons:e.buttons,pointers:e.pointers,insideElementPressed:e.insideElementPressed,buttonDownAny:e.buttonDownAny,originalEvent:e.originalEvent})}function B(e){!function(e){if(!e._opening&&c[e.hash]){if(e.autoResize||c[e.hash].forceResize){if(e._autoResizePolling){i=a(e.container);var t=c[e.hash].prevContainerSize;i.equals(t)||(c[e.hash].needsResize=!0)}c[e.hash].needsResize&&function(e,t){var i=e.viewport;var r=i.getZoom();var n=i.getCenter();i.resize(t,e.preserveImageSizeOnResize);i.panTo(n,!0);var o;if(e.preserveImageSizeOnResize)o=c[e.hash].prevContainerSize.x/t.x;else{var s=new m.Point(0,0);n=new m.Point(c[e.hash].prevContainerSize.x,c[e.hash].prevContainerSize.y).distanceTo(s);s=new m.Point(t.x,t.y).distanceTo(s);o=s/n*c[e.hash].prevContainerSize.x/t.x}i.zoomTo(r*o,null,!0);c[e.hash].prevContainerSize=t;c[e.hash].forceRedraw=!0;c[e.hash].needsResize=!1;c[e.hash].forceResize=!1}(e,i||a(e.container))}t=e.viewport.update();var i=e.world.update(t)||t;t&&e.raiseEvent("viewport-change");e.referenceStrip&&(i=e.referenceStrip.update(e.viewport)||i);t=c[e.hash].animating;if(!t&&i){e.raiseEvent("animation-start");r(e)}t=t&&!i;t&&(c[e.hash].animating=!1);if(i||t||c[e.hash].forceRedraw||e.world.needsDraw()){!function(e){e.imageLoader.clear();e.world.draw();e.raiseEvent("update-viewport",{})}(e);e._drawOverlays();e.navigator&&e.navigator.update(e.viewport);c[e.hash].forceRedraw=!1;i&&e.raiseEvent("animation")}if(t){e.raiseEvent("animation-finish");c[e.hash].mouseInside||u(e)}c[e.hash].animating=i}}(e);e.isOpen()?e._updateRequestId=l(e,B):e._updateRequestId=!1}function O(e,t){return e?e+t:t}function i(e){m.requestAnimationFrame(m.delegate(e,t))}function t(){var e,t;if(c[this.hash].zooming&&this.viewport){t=(e=m.now())-c[this.hash].lastZoomTime;t=Math.pow(c[this.hash].zoomFactor,t/1e3);this.viewport.zoomBy(t);this.viewport.applyConstraints();c[this.hash].lastZoomTime=e;i(this)}}function M(){if(this.buttonGroup){this.buttonGroup.emulateEnter();this.buttonGroup.emulateLeave()}}function k(){this.viewport&&this.viewport.goHome()}function z(){this.isFullPage()&&!m.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage());this.buttonGroup&&this.buttonGroup.emulateLeave();this.fullPageButton.element.focus();this.viewport&&this.viewport.applyConstraints()}function H(){if(this.viewport){var e=this.viewport.getRotation();this.viewport.flipped?e+=this.rotationIncrement:e-=this.rotationIncrement;this.viewport.setRotation(e)}}function N(){if(this.viewport){var e=this.viewport.getRotation();this.viewport.flipped?e-=this.rotationIncrement:e+=this.rotationIncrement;this.viewport.setRotation(e)}}function U(){this.viewport.toggleFlip()}m.determineDrawer=function(e){for(var t in OpenSeadragon){const i=OpenSeadragon[t],r=i.prototype;if(r&&r instanceof OpenSeadragon.DrawerBase&&m.isFunction(r.getType)&&r.getType.call(i)===e)return i}return null}}(OpenSeadragon);!function(o){o.Navigator=function(i){var e,t=i.viewer,r=this;if(i.element||i.id){if(i.element){i.id&&o.console.warn("Given option.id for Navigator was ignored since option.element was provided and is being used instead.");i.element.id?i.id=i.element.id:i.id="navigator-"+o.now();this.element=i.element}else this.element=document.getElementById(i.id);i.controlOptions={anchor:o.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}}else{i.id="navigator-"+o.now();this.element=o.makeNeutralElement("div");i.controlOptions={anchor:o.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:i.autoFade};if(i.position)if("BOTTOM_RIGHT"===i.position)i.controlOptions.anchor=o.ControlAnchor.BOTTOM_RIGHT;else if("BOTTOM_LEFT"===i.position)i.controlOptions.anchor=o.ControlAnchor.BOTTOM_LEFT;else if("TOP_RIGHT"===i.position)i.controlOptions.anchor=o.ControlAnchor.TOP_RIGHT;else if("TOP_LEFT"===i.position)i.controlOptions.anchor=o.ControlAnchor.TOP_LEFT;else if("ABSOLUTE"===i.position){i.controlOptions.anchor=o.ControlAnchor.ABSOLUTE;i.controlOptions.top=i.top;i.controlOptions.left=i.left;i.controlOptions.height=i.height;i.controlOptions.width=i.width}}this.element.id=i.id;this.element.className+=" navigator";(i=o.extend(!0,{sizeRatio:o.DEFAULT_SETTINGS.navigatorSizeRatio},i,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:i.animationTime,autoResize:!1,minZoomImageRatio:1,background:i.background,opacity:i.opacity,borderColor:i.borderColor,displayRegionColor:i.displayRegionColor})).minPixelRatio=this.minPixelRatio=t.minPixelRatio;o.setElementTouchActionNone(this.element);this.borderWidth=2;this.fudge=new o.Point(1,1);this.totalBorderWidths=new o.Point(2*this.borderWidth,2*this.borderWidth).minus(this.fudge);i.controlOptions.anchor!==o.ControlAnchor.NONE&&function(e,t){e.margin="0px";e.border=t+"px solid "+i.borderColor;e.padding="0px";e.background=i.background;e.opacity=i.opacity;e.overflow="hidden"}(this.element.style,this.borderWidth);this.displayRegion=o.makeNeutralElement("div");this.displayRegion.id=this.element.id+"-displayregion";this.displayRegion.className="displayregion";!function(e,t){e.position="relative";e.top="0px";e.left="0px";e.fontSize="0px";e.overflow="hidden";e.border=t+"px solid "+i.displayRegionColor;e.margin="0px";e.padding="0px";e.background="transparent";e.float="left";e.cssFloat="left";e.zIndex=999999999;e.cursor="default";e.boxSizing="content-box"}(this.displayRegion.style,this.borderWidth);o.setElementPointerEventsNone(this.displayRegion);o.setElementTouchActionNone(this.displayRegion);this.displayRegionContainer=o.makeNeutralElement("div");this.displayRegionContainer.id=this.element.id+"-displayregioncontainer";this.displayRegionContainer.className="displayregioncontainer";this.displayRegionContainer.style.width="100%";this.displayRegionContainer.style.height="100%";o.setElementPointerEventsNone(this.displayRegionContainer);o.setElementTouchActionNone(this.displayRegionContainer);t.addControl(this.element,i.controlOptions);this._resizeWithViewer=i.controlOptions.anchor!==o.ControlAnchor.ABSOLUTE&&i.controlOptions.anchor!==o.ControlAnchor.NONE;if(i.width&&i.height){this.setWidth(i.width);this.setHeight(i.height)}else if(this._resizeWithViewer){e=o.getElementSize(t.element);this.element.style.height=Math.round(e.y*i.sizeRatio)+"px";this.element.style.width=Math.round(e.x*i.sizeRatio)+"px";this.oldViewerSize=e;e=o.getElementSize(this.element);this.elementArea=e.x*e.y}this.oldContainerSize=new o.Point(0,0);o.Viewer.apply(this,[i]);this.displayRegionContainer.appendChild(this.displayRegion);this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer);function n(e,t){c(r.displayRegionContainer,e);c(r.displayRegion,-e);r.viewport.setRotation(e,t)}if(i.navigatorRotate){n(i.viewer.viewport?i.viewer.viewport.getRotation():i.viewer.degrees||0,!0);i.viewer.addHandler("rotate",function(e){n(e.degrees,e.immediately)})}this.innerTracker.destroy();this.innerTracker=new o.MouseTracker({userData:"Navigator.innerTracker",element:this.element,dragHandler:o.delegate(this,a),clickHandler:o.delegate(this,s),releaseHandler:o.delegate(this,l),scrollHandler:o.delegate(this,h),preProcessEventHandler:function(e){"wheel"===e.eventType&&(e.preventDefault=!0)}});this.outerTracker.userData="Navigator.outerTracker";o.setElementPointerEventsNone(this.canvas);o.setElementPointerEventsNone(this.container);this.addHandler("reset-size",function(){r.viewport&&r.viewport.goHome(!0)});t.world.addHandler("item-index-change",function(t){window.setTimeout(function(){var e=r.world.getItemAt(t.previousIndex);r.world.setItemIndex(e,t.newIndex)},1)});t.world.addHandler("remove-item",function(e){e=e.item;e=r._getMatchingItem(e);e&&r.world.removeItem(e)});this.update(t.viewport)};o.extend(o.Navigator.prototype,o.EventSource.prototype,o.Viewer.prototype,{updateSize:function(){if(this.viewport){var e=new o.Point(0===this.container.clientWidth?1:this.container.clientWidth,0===this.container.clientHeight?1:this.container.clientHeight);if(!e.equals(this.oldContainerSize)){this.viewport.resize(e,!0);this.viewport.goHome(!0);this.oldContainerSize=e;this.world.update();this.world.draw();this.update(this.viewer.viewport)}}},setWidth:function(e){this.width=e;this.element.style.width="number"==typeof e?e+"px":e;this._resizeWithViewer=!1;this.updateSize()},setHeight:function(e){this.height=e;this.element.style.height="number"==typeof e?e+"px":e;this._resizeWithViewer=!1;this.updateSize()},setFlip:function(e){this.viewport.setFlip(e);this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)");return this},setDisplayTransform:function(e){i(this.canvas,e);i(this.element,e)},update:function(e){var t,i;e=e||this.viewer.viewport;t=o.getElementSize(this.viewer.element);if(this._resizeWithViewer&&t.x&&t.y&&!t.equals(this.oldViewerSize)){this.oldViewerSize=t;if(this.maintainSizeRatio||!this.elementArea){i=t.x*this.sizeRatio;n=t.y*this.sizeRatio}else{i=Math.sqrt(this.elementArea*(t.x/t.y));n=this.elementArea/i}this.element.style.width=Math.round(i)+"px";this.element.style.height=Math.round(n)+"px";this.elementArea||(this.elementArea=i*n);this.updateSize()}if(e&&this.viewport){i=e.getBoundsNoRotate(!0);n=this.viewport.pixelFromPointNoRotate(i.getTopLeft(),!1);i=this.viewport.pixelFromPointNoRotate(i.getBottomRight(),!1).minus(this.totalBorderWidths);if(!this.navigatorRotate){var r=e.getRotation(!0);c(this.displayRegion,-r)}e=this.displayRegion.style;e.display=this.world.getItemCount()?"block":"none";e.top=n.y.toFixed(2)+"px";e.left=n.x.toFixed(2)+"px";r=i.x-n.x;var n=i.y-n.y;e.width=Math.round(Math.max(r,0))+"px";e.height=Math.round(Math.max(n,0))+"px"}},addTiledImage:function(e){var r=this;var n=e.originalTiledImage;delete e.original;e=o.extend({},e,{success:function(e){var t=e.item;t._originalForNavigator=n;r._matchBounds(t,n,!0);r._matchOpacity(t,n);r._matchCompositeOperation(t,n);function i(){r._matchBounds(t,n)}n.addHandler("bounds-change",i);n.addHandler("clip-change",i);n.addHandler("opacity-change",function(){r._matchOpacity(t,n)});n.addHandler("composite-operation-change",function(){r._matchCompositeOperation(t,n)})}});return o.Viewer.prototype.addTiledImage.apply(this,[e])},destroy:function(){return o.Viewer.prototype.destroy.apply(this)},_getMatchingItem:function(e){var t=this.world.getItemCount();var i;for(var r=0;r<t;r++)if((i=this.world.getItemAt(r))._originalForNavigator===e)return i;return null},_matchBounds:function(e,t,i){var r=t.getBoundsNoRotate();e.setPosition(r.getTopLeft(),i);e.setWidth(r.width,i);e.setRotation(t.getRotation(),i);e.setClip(t.getClip());e.setFlip(t.getFlip())},_matchOpacity:function(e,t){e.setOpacity(t.opacity)},_matchCompositeOperation:function(e,t){e.setCompositeOperation(t.compositeOperation)}});function s(e){var t={tracker:e.eventSource,position:e.position,quick:e.quick,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-click",t);if(!t.preventDefaultAction&&e.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(e.position.x=this.viewport.getContainerSize().x-e.position.x);e=this.viewport.pointFromPixel(e.position);this.panVertical?this.panHorizontal||(e.x=this.viewer.viewport.getCenter(!0).x):e.y=this.viewer.viewport.getCenter(!0).y;this.viewer.viewport.panTo(e);this.viewer.viewport.applyConstraints()}}function a(e){var t={tracker:e.eventSource,position:e.position,delta:e.delta,speed:e.speed,direction:e.direction,shift:e.shift,originalEvent:e.originalEvent,preventDefaultAction:!1};this.viewer.raiseEvent("navigator-drag",t);if(!t.preventDefaultAction&&this.viewer.viewport){this.panHorizontal||(e.delta.x=0);this.panVertical||(e.delta.y=0);this.viewer.viewport.flipped&&(e.delta.x=-e.delta.x);this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(e.delta));this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints()}}function l(e){e.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function h(e){var t={tracker:e.eventSource,position:e.position,scroll:e.scroll,shift:e.shift,originalEvent:e.originalEvent,preventDefault:e.preventDefault};this.viewer.raiseEvent("navigator-scroll",t);e.preventDefault=t.preventDefault}function c(e,t){i(e,"rotate("+t+"deg)")}function i(e,t){e.style.webkitTransform=t;e.style.mozTransform=t;e.style.msTransform=t;e.style.oTransform=t;e.style.transform=t}}(OpenSeadragon);!function(s){var a={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};s.extend(s,{getString:function(e){var t,i=e.split("."),r=null,n=arguments,o=a;for(t=0;t<i.length-1;t++)o=o[i[t]]||{};if("string"!=typeof(r=o[i[t]])){s.console.error("Untranslated source string:",e);r=""}return r.replace(/\{\d+\}/g,function(e){e=parseInt(e.match(/\d+/),10)+1;return e<n.length?n[e]:""})},setString:function(e,t){var i,r=e.split("."),n=a;for(i=0;i<r.length-1;i++){n[r[i]]||(n[r[i]]={});n=n[r[i]]}n[r[i]]=t}})}(OpenSeadragon);!function(o){o.Point=function(e,t){this.x="number"==typeof e?e:0;this.y="number"==typeof t?t:0};o.Point.prototype={clone:function(){return new o.Point(this.x,this.y)},plus:function(e){return new o.Point(this.x+e.x,this.y+e.y)},minus:function(e){return new o.Point(this.x-e.x,this.y-e.y)},times:function(e){return new o.Point(this.x*e,this.y*e)},divide:function(e){return new o.Point(this.x/e,this.y/e)},negate:function(){return new o.Point(-this.x,-this.y)},distanceTo:function(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))},squaredDistanceTo:function(e){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)},apply:function(e){return new o.Point(e(this.x),e(this.y))},equals:function(e){return e instanceof o.Point&&this.x===e.x&&this.y===e.y},rotate:function(e,t){t=t||new o.Point(0,0);var i;var r;if(e%90==0)switch(o.positiveModulo(e,360)){case 0:i=1;r=0;break;case 90:i=0;r=1;break;case 180:i=-1;r=0;break;case 270:i=0;r=-1}else{var n=e*Math.PI/180;i=Math.cos(n);r=Math.sin(n)}n=i*(this.x-t.x)-r*(this.y-t.y)+t.x;t=r*(this.x-t.x)+i*(this.y-t.y)+t.y;return new o.Point(n,t)},toString:function(){return"("+Math.round(100*this.x)/100+","+Math.round(100*this.y)/100+")"}}}(OpenSeadragon);!function(h){h.TileSource=function(e,t,i,r,n,o){var s=this;var a,l=arguments;l=h.isPlainObject(e)?e:{width:l[0],height:l[1],tileSize:l[2],tileOverlap:l[3],minLevel:l[4],maxLevel:l[5]};h.EventSource.call(this);h.extend(!0,this,l);if(!this.success)for(a=0;a<arguments.length;a++)if(h.isFunction(arguments[a])){this.success=arguments[a];break}this.success&&this.addHandler("ready",function(e){s.success(e)});"string"===h.type(e)&&(this.url=e);if(this.url){this.aspectRatio=1;this.dimensions=new h.Point(10,10);this._tileWidth=0;this._tileHeight=0;this.tileOverlap=0;this.minLevel=0;this.maxLevel=0;this.ready=!1;this.getImageInfo(this.url)}else{this.ready=!0;this.aspectRatio=l.width&&l.height?l.width/l.height:1;this.dimensions=new h.Point(l.width,l.height);if(this.tileSize){this._tileWidth=this._tileHeight=this.tileSize;delete this.tileSize}else{if(this.tileWidth){this._tileWidth=this.tileWidth;delete this.tileWidth}else this._tileWidth=0;if(this.tileHeight){this._tileHeight=this.tileHeight;delete this.tileHeight}else this._tileHeight=0}this.tileOverlap=l.tileOverlap||0;this.minLevel=l.minLevel||0;this.maxLevel=void 0!==l.maxLevel&&null!==l.maxLevel?l.maxLevel:l.width&&l.height?Math.ceil(Math.log(Math.max(l.width,l.height))/Math.log(2)):0;this.success&&h.isFunction(this.success)&&this.success(this)}};h.TileSource.prototype={getTileSize:function(e){h.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead");return this._tileWidth},getTileWidth:function(e){return this._tileWidth||this.getTileSize(e)},getTileHeight:function(e){return this._tileHeight||this.getTileSize(e)},setMaxLevel:function(e){this.maxLevel=e;this._memoizeLevelScale()},getLevelScale:function(e){this._memoizeLevelScale();return this.getLevelScale(e)},_memoizeLevelScale:function(){var e,t={};for(e=0;e<=this.maxLevel;e++)t[e]=1/Math.pow(2,this.maxLevel-e);this.getLevelScale=function(e){return t[e]}},getNumTiles:function(e){var t=this.getLevelScale(e),i=Math.ceil(t*this.dimensions.x/this.getTileWidth(e)),e=Math.ceil(t*this.dimensions.y/this.getTileHeight(e));return new h.Point(i,e)},getPixelRatio:function(e){var t=this.dimensions.times(this.getLevelScale(e)),e=1/t.x*h.pixelDensityRatio,t=1/t.y*h.pixelDensityRatio;return new h.Point(e,t)},getClosestLevel:function(){var e,t;for(e=this.minLevel+1;e<=this.maxLevel&&!(1<(t=this.getNumTiles(e)).x||1<t.y);e++);return e-1},getTileAtPoint:function(e,t){var i=0<=t.x&&t.x<=1&&0<=t.y&&t.y<=1/this.aspectRatio;h.console.assert(i,"[TileSource.getTileAtPoint] must be called with a valid point.");var r=this.dimensions.x*this.getLevelScale(e);i=t.x*r;r=t.y*r;i=Math.floor(i/this.getTileWidth(e));r=Math.floor(r/this.getTileHeight(e));1<=t.x&&(i=this.getNumTiles(e).x-1);t.y>=1/this.aspectRatio-1e-15&&(r=this.getNumTiles(e).y-1);return new h.Point(i,r)},getTileBounds:function(e,t,i,r){var n=this.dimensions.times(this.getLevelScale(e)),o=this.getTileWidth(e),s=this.getTileHeight(e),a=0===t?0:o*t-this.tileOverlap,e=0===i?0:s*i-this.tileOverlap,t=o+(0===t?1:2)*this.tileOverlap,s=s+(0===i?1:2)*this.tileOverlap,i=1/n.x;t=Math.min(t,n.x-a);s=Math.min(s,n.y-e);return r?new h.Rect(0,0,t,s):new h.Rect(a*i,e*i,t*i,s*i)},getImageInfo:function(r){var t,i,e,n,o,s=this;r&&-1<(o=(n=(e=r.split("/"))[e.length-1]).lastIndexOf("."))&&(e[e.length-1]=n.slice(0,o));var a=null;if(this.splitHashDataForPost){var l=r.indexOf("#");if(-1!==l){a=r.substring(l+1);r=r.substr(0,l)}}t=function(e){"string"==typeof e&&(e=h.parseXml(e));var t=h.TileSource.determineType(s,e,r);if(t){void 0===(i=t.prototype.configure.apply(s,[e,r,a])).ajaxWithCredentials&&(i.ajaxWithCredentials=s.ajaxWithCredentials);i=new t(i);s.ready=!0;s.raiseEvent("ready",{tileSource:i})}else s.raiseEvent("open-failed",{message:"Unable to load TileSource",source:r})};if(r.match(/\.js$/)){l=r.split("/").pop().replace(".js","");h.jsonp({url:r,async:!1,callbackName:l,callback:t})}else h.makeAjaxRequest({url:r,postData:a,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(e){e=function(t){var e,i,r=t.responseText,n=t.status;{if(!t)throw new Error(h.getString("Errors.Security"));if(200!==t.status&&0!==t.status){n=t.status;e=404===n?"Not Found":t.statusText;throw new Error(h.getString("Errors.Status",n,e))}}if(r.match(/^\s*<.*/))try{i=t.responseXML&&t.responseXML.documentElement?t.responseXML:h.parseXml(r)}catch(e){i=t.responseText}else if(r.match(/\s*[{[].*/))try{i=h.parseJSON(r)}catch(e){i=r}else i=r;return i}(e);t(e)},error:function(e,t){var i;try{i="HTTP "+e.status+" attempting to load TileSource: "+r}catch(e){i=(void 0!==t&&t.toString?t.toString():"Unknown error")+" attempting to load TileSource: "+r}h.console.error(i);s.raiseEvent("open-failed",{message:i,source:r,postData:a})}})},supports:function(e,t){return!1},equals:function(e){return!1},configure:function(e,t,i){throw new Error("Method not implemented.")},destroy:function(e){},getTileUrl:function(e,t,i){throw new Error("Method not implemented.")},getTilePostData:function(e,t,i){return null},getTileAjaxHeaders:function(e,t,i){return{}},getTileHashKey:function(e,t,i,r,n,o){function s(e){return n?e+"+"+JSON.stringify(n):e}return s("string"!=typeof r?e+"/"+t+"_"+i:r)},tileExists:function(e,t,i){var r=this.getNumTiles(e);return e>=this.minLevel&&e<=this.maxLevel&&0<=t&&0<=i&&t<r.x&&i<r.y},hasTransparency:function(e,t,i,r){return t.match(".png")},downloadTileStart:function(t){const i=t.userData,o=new Image;i.image=o;i.request=null;function s(e){if(!e&&o){o.onload=o.onerror=o.onabort=null;t.finish(o,i.request,"image")}else t.fail(e||"[downloadTileStart] Image load failed: undefined Image instance.",i.request)}o.onload=function(){s()};o.onabort=o.onerror=function(){s("[downloadTileStart] Image load aborted.")};if(t.loadWithAjax)i.request=h.makeAjaxRequest({url:t.src,withCredentials:t.ajaxWithCredentials,headers:t.ajaxHeaders,responseType:"arraybuffer",postData:t.postData,success:function(t){var i;try{i=new window.Blob([t.response])}catch(e){const r=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if("TypeError"===e.name&&r){const n=new r;n.append(t.response);i=n.getBlob()}}0===i.size?s("[downloadTileStart] Empty image response."):o.src=(window.URL||window.webkitURL).createObjectURL(i)},error:function(e){s("[downloadTileStart] Image load aborted - XHR error")}});else{!1!==t.crossOriginPolicy&&(o.crossOrigin=t.crossOriginPolicy);o.src=t.src}},downloadTileAbort:function(e){e.userData.request&&e.userData.request.abort();var t=e.userData.image;e.userData.image&&(t.onload=t.onerror=t.onabort=null)},createTileCache:function(e,t,i){h.console.error("[TileSource.createTileCache] has been deprecated. Use cache API of a tile instead.")},destroyTileCache:function(e){h.console.error("[TileSource.destroyTileCache] has been deprecated. Use cache API of a tile instead.")},getTileCacheData:function(e){h.console.error("[TileSource.getTileCacheData] has been deprecated. Use cache API of a tile instead.");return e.getDataAs(void 0,!1)},getTileCacheDataAsImage:function(e){h.console.error("[TileSource.getTileCacheDataAsImage] has been deprecated. Use cache API of a tile instead.");return e.getImage()},getTileCacheDataAsContext2D:function(e){h.console.error("[TileSource.getTileCacheDataAsContext2D] has been deprecated. Use cache API of a tile instead.");return e.getRenderedContext()}};h.extend(!0,h.TileSource.prototype,h.EventSource.prototype);h.TileSource.determineType=function(e,t,i){for(var r in OpenSeadragon)if(r.match(/.+TileSource$/)&&h.isFunction(OpenSeadragon[r])&&h.isFunction(OpenSeadragon[r].prototype.supports)&&OpenSeadragon[r].prototype.supports.call(e,t,i))return OpenSeadragon[r];h.console.error("No TileSource was able to open %s %s",i,t);return null}}(OpenSeadragon);!function(p){p.DziTileSource=function(e,t,i,r,n,o,s,a,l){var h,c,u,d;d=p.isPlainObject(e)?e:{width:e,height:t,tileSize:i,tileOverlap:r,tilesUrl:n,fileFormat:o,displayRects:s,minLevel:a,maxLevel:l};this._levelRects={};this.tilesUrl=d.tilesUrl;this.fileFormat=d.fileFormat;this.displayRects=d.displayRects;if(this.displayRects)for(h=this.displayRects.length-1;0<=h;h--)for(u=(c=this.displayRects[h]).minLevel;u<=c.maxLevel;u++){this._levelRects[u]||(this._levelRects[u]=[]);this._levelRects[u].push(c)}p.TileSource.apply(this,[d])};p.extend(p.DziTileSource.prototype,p.TileSource.prototype,{supports:function(e,t){var i;e.Image?i=e.Image.xmlns:e.documentElement&&("Image"!==e.documentElement.localName&&"Image"!==e.documentElement.tagName||(i=e.documentElement.namespaceURI));return-1!==(i=(i||"").toLowerCase()).indexOf("schemas.microsoft.com/deepzoom/2008")||-1!==i.indexOf("schemas.microsoft.com/deepzoom/2009")},configure:function(e,t,i){e=(p.isPlainObject(e)?u:function(e,t){if(!t||!t.documentElement)throw new Error(p.getString("Errors.Xml"));var i,r,n,o,s,a=t.documentElement,l=a.localName||a.tagName,h=t.documentElement.namespaceURI,t=null,c=[];if("Image"===l)try{void 0===(o=a.getElementsByTagName("Size")[0])&&(o=a.getElementsByTagNameNS(h,"Size")[0]);t={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:a.getAttribute("Url"),Format:a.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(a.getAttribute("Overlap"),10),TileSize:parseInt(a.getAttribute("TileSize"),10),Size:{Height:parseInt(o.getAttribute("Height"),10),Width:parseInt(o.getAttribute("Width"),10)}}};if(!p.imageFormatSupported(t.Image.Format))throw new Error(p.getString("Errors.ImageFormat",t.Image.Format.toUpperCase()));void 0===(i=a.getElementsByTagName("DisplayRect"))&&(i=a.getElementsByTagNameNS(h,"DisplayRect")[0]);for(s=0;s<i.length;s++){r=i[s];void 0===(n=r.getElementsByTagName("Rect")[0])&&(n=r.getElementsByTagNameNS(h,"Rect")[0]);c.push({Rect:{X:parseInt(n.getAttribute("X"),10),Y:parseInt(n.getAttribute("Y"),10),Width:parseInt(n.getAttribute("Width"),10),Height:parseInt(n.getAttribute("Height"),10),MinLevel:parseInt(r.getAttribute("MinLevel"),10),MaxLevel:parseInt(r.getAttribute("MaxLevel"),10)}})}c.length&&(t.Image.DisplayRect=c);return u(0,t)}catch(e){throw e instanceof Error?e:new Error(p.getString("Errors.Dzi"))}else{if("Collection"===l)throw new Error(p.getString("Errors.Dzc"));if("Error"===l){a=a.getElementsByTagName("Message")[0].firstChild.nodeValue;throw new Error(a)}}throw new Error(p.getString("Errors.Dzi"))})(this,e);if(t&&!e.tilesUrl){e.tilesUrl=t.replace(/([^/]+?)(\.(dzi|xml|js)?(\?[^/]*)?)?\/?$/,"$1_files/");-1!==t.search(/\.(dzi|xml|js)\?/)?e.queryParams=t.match(/\?.*/):e.queryParams=""}return e},getTileUrl:function(e,t,i){return[this.tilesUrl,e,"/",t,"_",i,".",this.fileFormat,this.queryParams].join("")},equals:function(e){return this.tilesUrl===e.tilesUrl},tileExists:function(e,t,i){var r,n,o,s,a,l,h=this._levelRects[e];if(this.minLevel&&e<this.minLevel||this.maxLevel&&e>this.maxLevel)return!1;if(!h||!h.length)return!0;for(l=h.length-1;0<=l;l--)if(!(e<(r=h[l]).minLevel||e>r.maxLevel)){a=this.getLevelScale(e);n=r.x*a;o=r.y*a;s=n+r.width*a;a=o+r.height*a;n=Math.floor(n/this._tileWidth);o=Math.floor(o/this._tileWidth);s=Math.ceil(s/this._tileWidth);a=Math.ceil(a/this._tileWidth);if(n<=t&&t<s&&o<=i&&i<a)return!0}return!1}});function u(e,t){var i,r,n=t.Image,o=n.Url,s=n.Format,a=n.Size,l=n.DisplayRect||[],h=parseInt(a.Width,10),c=parseInt(a.Height,10),a=parseInt(n.TileSize,10),n=parseInt(n.Overlap,10),u=[];for(r=0;r<l.length;r++){i=l[r].Rect;u.push(new p.DisplayRect(parseInt(i.X,10),parseInt(i.Y,10),parseInt(i.Width,10),parseInt(i.Height,10),parseInt(i.MinLevel,10),parseInt(i.MaxLevel,10)))}return p.extend(!0,{width:h,height:c,tileSize:a,tileOverlap:n,minLevel:null,maxLevel:null,tilesUrl:o,fileFormat:s,displayRects:u},t)}}(OpenSeadragon);!function(g){g.IIIFTileSource=function(e){g.extend(!0,this,e);this._id=this["@id"]||this.id||this.identifier||null;if(!(this.height&&this.width&&this._id))throw new Error("IIIF required parameters (width, height, or id) not provided.");e.tileSizePerScaleFactor={};this.tileFormat=this.tileFormat||"jpg";this.version=e.version;this.isLevel0=m(e);if(this.tile_width&&this.tile_height){e.tileWidth=this.tile_width;e.tileHeight=this.tile_height}else if(this.tile_width)e.tileSize=this.tile_width;else if(this.tile_height)e.tileSize=this.tile_height;else if(this.tiles)if(1===this.tiles.length){e.tileWidth=this.tiles[0].width;e.tileHeight=this.tiles[0].height||this.tiles[0].width;this.scale_factors=this.tiles[0].scaleFactors}else{this.scale_factors=[];for(var t=0;t<this.tiles.length;t++)for(var i=0;i<this.tiles[t].scaleFactors.length;i++){var r=this.tiles[t].scaleFactors[i];this.scale_factors.push(r);e.tileSizePerScaleFactor[r]={width:this.tiles[t].width,height:this.tiles[t].height||this.tiles[t].width}}}else if(f(e)){var n=Math.min(this.height,this.width),o=[256,512,1024],s=[];for(var a=0;a<o.length;a++)o[a]<=n&&s.push(o[a]);0<s.length?e.tileSize=Math.max.apply(null,s):e.tileSize=n}else if(this.sizes&&0<this.sizes.length){this.emulateLegacyImagePyramid=!0;e.levels=v(this);g.extend(!0,e,{width:e.levels[e.levels.length-1].width,height:e.levels[e.levels.length-1].height,tileSize:Math.max(e.height,e.width),tileOverlap:0,minLevel:0,maxLevel:e.levels.length-1});this.levels=e.levels}else g.console.error("Nothing in the info.json to construct image pyramids from");if(!e.maxLevel&&!this.emulateLegacyImagePyramid)if(this.scale_factors){var l=Math.max.apply(null,this.scale_factors);e.maxLevel=Math.round(Math.log(l)*Math.LOG2E)}else e.maxLevel=Number(Math.round(Math.log(Math.max(this.width,this.height),2)));if(this.sizes){var h=this.sizes.length;var c=this.sizes.slice().sort((e,t)=>e.width-t.width);if(c[h-1].width<this.width&&c[h-1].height<this.height){c.push({width:this.width,height:this.height});h++}if(h===e.maxLevel+1){var u=1;if(this.scale_factors&&this.scale_factors.length===h)for(var d=0;d<h;d++){var p=this.scale_factors[h-d-1];if(Math.round(this.width/c[d].width)!==p||Math.round(this.height/c[d].height)!==p){u=0;break}}1===u&&(this.levelSizes=c)}}g.TileSource.apply(this,[e])};g.extend(g.IIIFTileSource.prototype,g.TileSource.prototype,{supports:function(e,t){return!(!e.protocol||"http://iiif.io/api/image"!==e.protocol)||(!(!e["@context"]||"http://library.stanford.edu/iiif/image-api/1.1/context.json"!==e["@context"]&&"http://iiif.io/api/image/1/context.json"!==e["@context"])||(!(!e.profile||0!==e.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html"))||(!!(e.identifier&&e.width&&e.height)||!(!e.documentElement||"info"!==e.documentElement.tagName||"http://library.stanford.edu/iiif/image-api/ns/"!==e.documentElement.namespaceURI))))},configure:function(e,t,i){if(g.isPlainObject(e)){if(e["@context"]){var r=e["@context"];if(Array.isArray(r))for(var n=0;n<r.length;n++)if("string"==typeof r[n]&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(r[n])||"http://library.stanford.edu/iiif/image-api/1.1/context.json"===r[n])){r=r[n];break}switch(r){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":e.version=1;break;case"http://iiif.io/api/image/2/context.json":e.version=2;break;case"http://iiif.io/api/image/3/context.json":e.version=3;break;default:g.console.error("Data has a @context property which contains no known IIIF context URI.")}}else{e["@context"]="http://iiif.io/api/image/1.0/context.json";e["@id"]=t.replace("/info.json","");e.version=1}if(e.preferredFormats)for(var o=0;o<e.preferredFormats.length;o++)if(g.imageFormatSupported(e.preferredFormats[o])){e.tileFormat=e.preferredFormats[o];break}return e}var s=function(e){if(!e||!e.documentElement)throw new Error(g.getString("Errors.Xml"));var t=e.documentElement,i=t.tagName,e=null;if("info"===i)try{!function e(t,i,r){var n,o;if(3===t.nodeType&&r){(o=t.nodeValue.trim()).match(/^\d*$/)&&(o=Number(o));if(i[r]){g.isArray(i[r])||(i[r]=[i[r]]);i[r].push(o)}else i[r]=o}else if(1===t.nodeType)for(n=0;n<t.childNodes.length;n++)e(t.childNodes[n],i,t.nodeName)}(t,e={});return e}catch(e){throw e instanceof Error?e:new Error(g.getString("Errors.IIIF"))}throw new Error(g.getString("Errors.IIIF"))}(e);s["@context"]="http://iiif.io/api/image/1.0/context.json";s["@id"]=t.replace("/info.xml","");s.version=1;return s},getTileWidth:function(e){if(this.emulateLegacyImagePyramid)return g.TileSource.prototype.getTileWidth.call(this,e);e=Math.pow(2,this.maxLevel-e);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[e]?this.tileSizePerScaleFactor[e].width:this._tileWidth},getTileHeight:function(e){if(this.emulateLegacyImagePyramid)return g.TileSource.prototype.getTileHeight.call(this,e);e=Math.pow(2,this.maxLevel-e);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[e]?this.tileSizePerScaleFactor[e].height:this._tileHeight},getLevelScale:function(e){if(this.emulateLegacyImagePyramid){var t=NaN;return t=0<this.levels.length&&e>=this.minLevel&&e<=this.maxLevel?this.levels[e].width/this.levels[this.maxLevel].width:t}return g.TileSource.prototype.getLevelScale.call(this,e)},getNumTiles:function(e){if(this.emulateLegacyImagePyramid)return this.getLevelScale(e)?new g.Point(1,1):new g.Point(0,0);if(this.levelSizes){var t=this.levelSizes[e];var i=Math.ceil(t.width/this.getTileWidth(e)),t=Math.ceil(t.height/this.getTileHeight(e));return new g.Point(i,t)}return g.TileSource.prototype.getNumTiles.call(this,e)},getTileAtPoint:function(e,t){if(this.emulateLegacyImagePyramid)return new g.Point(0,0);if(this.levelSizes){var i=0<=t.x&&t.x<=1&&0<=t.y&&t.y<=1/this.aspectRatio;g.console.assert(i,"[TileSource.getTileAtPoint] must be called with a valid point.");var r=this.levelSizes[e].width;i=t.x*r;r=t.y*r;i=Math.floor(i/this.getTileWidth(e));r=Math.floor(r/this.getTileHeight(e));1<=t.x&&(i=this.getNumTiles(e).x-1);t.y>=1/this.aspectRatio-1e-15&&(r=this.getNumTiles(e).y-1);return new g.Point(i,r)}return g.TileSource.prototype.getTileAtPoint.call(this,e,t)},getTileUrl:function(e,t,i){if(this.emulateLegacyImagePyramid){var r=null;return r=0<this.levels.length&&e>=this.minLevel&&e<=this.maxLevel?this.levels[e].url:r}var n,o,s,a,l,h,c,u,d=Math.pow(.5,this.maxLevel-e);if(this.levelSizes){n=this.levelSizes[e].width;o=this.levelSizes[e].height}else{n=Math.ceil(this.width*d);o=Math.ceil(this.height*d)}c=this.getTileWidth(e);u=this.getTileHeight(e);a=Math.round(c/d);l=Math.round(u/d);r=1===this.version?"native."+this.tileFormat:"default."+this.tileFormat;if(n<c&&o<u){h=2===this.version&&n===this.width?"full":3===this.version&&n===this.width&&o===this.height?"max":3===this.version?n+","+o:n+",";s="full"}else{e=t*a;d=i*l;a=Math.min(a,this.width-e);l=Math.min(l,this.height-d);s=0===t&&0===i&&a===this.width&&l===this.height?"full":[e,d,a,l].join(",");c=Math.min(c,n-t*c);u=Math.min(u,o-i*u);h=2===this.version&&c===this.width?"full":3===this.version&&c===this.width&&u===this.height?"max":this.isLevel0&&this.version<3?c+",":c+","+u}return[this._id,s,h,"0",r].join("/")},equals:function(e){return this._id===e._id},__testonly__:{canBeTiled:f,constructLevels:v}});function m(e){e=Array.isArray(e.profile)?e.profile[0]:e.profile;return-1!==["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"].indexOf(e)}function f(e){var t=m(e);var i=!1;2===e.version&&1<e.profile.length&&e.profile[1].supports&&(i=-1!==e.profile[1].supports.indexOf("sizeByW"));3===e.version&&e.extraFeatures&&(i=-1!==e.extraFeatures.indexOf("sizeByWh"));return!t||i}function v(e){var t=[];for(var i=0;i<e.sizes.length;i++)t.push({url:e._id+"/full/"+e.sizes[i].width+","+(3===e.version?e.sizes[i].height:"")+"/0/default."+e.tileFormat,width:e.sizes[i].width,height:e.sizes[i].height});return t.sort(function(e,t){return e.width-t.width})}}(OpenSeadragon);!function(l){l.IIPTileSource=function(e){l.EventSource.call(this);if(e&&e.iipsrv&&e.image){l.extend(this,e);this.aspectRatio=1;this.dimensions=new l.Point(10,10);this._tileWidth=0;this._tileHeight=0;this.tileOverlap=0;this.minLevel=0;this.maxLevel=0;this.ready=!1;e=this.getMetadataUrl();this.getImageInfo(e)}};l.extend(l.IIPTileSource.prototype,l.TileSource.prototype,{getMetadataUrl:function(){return this.iipsrv+"?FIF="+this.image+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number&obj=Resolutions"},supports:function(e,t){return e&&"iipsrv"in e&&"image"in e},parseIIP:function(e){var t=e.split("Max-size:");if(!t[1])throw new Error("No Max-size returned");var i=t[1].split(" ");this.width=parseInt(i[0],10);this.height=parseInt(i[1],10);this.dimensions=new l.Point(this.width,this.height);this.aspectRatio=this.width/this.height;if(!(t=e.split("Tile-size:"))[1])throw new Error("No Tile-size returned");i=t[1].split(" ");this._tileWidth=parseInt(i[0],10);this._tileHeight=parseInt(i[1],10);t=e.split("Resolution-number:");var r=parseInt(t[1],10);this.minLevel=0;this.maxLevel=r-1;this.tileOverlap=0;var n=(i=(t=e.split("Resolutions:"))[1].split(",")).length;this.levelSizes=new Array(n);for(var o=0;o<n;o++){var s=i[o].split(" ");var a=parseInt(s[0],10);s=parseInt(s[1],10);this.levelSizes[o]={width:a,height:s}}},getImageInfo:function(r){var n=this;l.makeAjaxRequest({url:r,type:"GET",async:!1,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(t){try{OpenSeadragon.IIPTileSource.prototype.parseIIP.call(n,t.responseText);n.ready=!0;n.raiseEvent("ready",{tileSource:n})}catch(e){t="IIPTileSource: Error parsing IIP metadata: "+e.message;n.raiseEvent("open-failed",{message:t,source:r})}},error:function(e,t){var i="IIPTileSource: Unable to get IIP metadata from "+r;l.console.error(i);n.raiseEvent("open-failed",{message:i,source:r})}})},configure:function(e,t,i){return e},getNumTiles:function(e){var t=this.levelSizes[e];e=Math.ceil(t.width/this._tileWidth),t=Math.ceil(t.height/this._tileHeight);return new l.Point(e,t)},getTileUrl:function(e,t,i){var r=this.levelSizes[e];var n=Math.ceil(r.width/this._tileWidth);var o=this.iipsrv+"?FIF="+this.image+"&";if(this.transform){this.transform.stack&&(o+="SDS="+this.transform.stack+"&");this.transform.contrast&&(o+="CNT="+this.transform.contrast+"&");this.transform.gamma&&(o+="GAM="+this.transform.gamma+"&");this.transform.invert&&!0===this.transform.invert&&(o+="INV&");this.transform.color&&(o+="COL="+this.transform.color+"&");this.transform.twist&&(o+="CTW="+this.transform.twist+"&");this.transform.convolution&&(o+="CNV="+this.transform.convolution+"&");this.transform.quality&&(o+="QLT="+this.transform.quality+"&");this.transform.colormap&&(o+="CMP="+this.transform.colormap+"&");this.transform.minmax&&(o+="MINMAX="+this.transform.minmax+"&");this.transform.hillshade&&(o+="SHD="+this.transform.hillshade+"&")}r="JTL";"png"===this.format?r="PTL":"webp"===this.format?r="WTL":"avif"===this.format&&(r="ATL");return o+r+"="+e+","+(i*n+t)}});l.extend(!0,l.IIPTileSource.prototype,l.EventSource.prototype)}(OpenSeadragon);!function(s){s.OsmTileSource=function(e,t,i,r,n){var o;if(!(o=s.isPlainObject(e)?e:{width:e,height:t,tileSize:i,tileOverlap:r,tilesUrl:n}).width||!o.height){o.width=65572864;o.height=65572864}if(!o.tileSize){o.tileSize=256;o.tileOverlap=0}o.tilesUrl||(o.tilesUrl="http://tile.openstreetmap.org/");o.minLevel=8;s.TileSource.apply(this,[o])};s.extend(s.OsmTileSource.prototype,s.TileSource.prototype,{supports:function(e,t){return e.type&&"openstreetmaps"===e.type},configure:function(e,t,i){return e},getTileUrl:function(e,t,i){return this.tilesUrl+(e-8)+"/"+t+"/"+i+".png"},equals:function(e){return this.tilesUrl===e.tilesUrl}})}(OpenSeadragon);!function(h){h.TmsTileSource=function(e,t,i,r,n){var o;o=h.isPlainObject(e)?e:{width:e,height:t,tileSize:i,tileOverlap:r,tilesUrl:n};var s,a=256*Math.ceil(o.width/256),l=256*Math.ceil(o.height/256);s=l<a?a/256:l/256;o.maxLevel=Math.ceil(Math.log(s)/Math.log(2))-1;o.tileSize=256;o.width=a;o.height=l;h.TileSource.apply(this,[o])};h.extend(h.TmsTileSource.prototype,h.TileSource.prototype,{supports:function(e,t){return e.type&&"tiledmapservice"===e.type},configure:function(e,t,i){return e},getTileUrl:function(e,t,i){var r=this.getNumTiles(e).y-1;return this.tilesUrl+e+"/"+t+"/"+(r-i)+".png"},equals:function(e){return this.tilesUrl===e.tilesUrl}})}(OpenSeadragon);!function(i){i.ZoomifyTileSource=function(e){void 0===e.tileSize&&(e.tileSize=256);if(void 0===e.fileFormat){e.fileFormat="jpg";this.fileFormat=e.fileFormat}var t={x:e.width,y:e.height};e.imageSizes=[{x:e.width,y:e.height}];e.gridSize=[this._getGridSize(e.width,e.height,e.tileSize)];for(;parseInt(t.x,10)>e.tileSize||parseInt(t.y,10)>e.tileSize;){t.x=Math.floor(t.x/2);t.y=Math.floor(t.y/2);e.imageSizes.push({x:t.x,y:t.y});e.gridSize.push(this._getGridSize(t.x,t.y,e.tileSize))}e.imageSizes.reverse();e.gridSize.reverse();e.minLevel=0;e.maxLevel=e.gridSize.length-1;i.TileSource.apply(this,[e])};i.extend(i.ZoomifyTileSource.prototype,i.TileSource.prototype,{_getGridSize:function(e,t,i){return{x:Math.ceil(e/i),y:Math.ceil(t/i)}},_calculateAbsoluteTileNumber:function(e,t,i){var r=0;var n={};for(var o=0;o<e;o++)r+=(n=this.gridSize[o]).x*n.y;return r+=(n=this.gridSize[e]).x*i+t},supports:function(e,t){return e.type&&"zoomifytileservice"===e.type},configure:function(e,t,i){return e},getTileUrl:function(e,t,i){var r=this._calculateAbsoluteTileNumber(e,t,i);r=Math.floor(r/256);return this.tilesUrl+"TileGroup"+r+"/"+e+"-"+t+"-"+i+"."+this.fileFormat},equals:function(e){return this.tilesUrl===e.tilesUrl}})}(OpenSeadragon);!function(a){a.LegacyTileSource=function(e){var t,i,r;(t=a.isArray(e)?{type:"legacy-image-pyramid",levels:e}:t).levels=function(e){var t,i,r=[];for(i=0;i<e.length;i++)(t=e[i]).height&&t.width&&t.url?r.push({url:t.url,width:Number(t.width),height:Number(t.height)}):a.console.error("Unsupported image format: %s",t.url||"<no URL>");return r.sort(function(e,t){return e.height-t.height})}(t.levels);if(0<t.levels.length){i=t.levels[t.levels.length-1].width;r=t.levels[t.levels.length-1].height}else{r=i=0;a.console.error("No supported image formats found")}a.extend(!0,t,{width:i,height:r,tileSize:Math.max(r,i),tileOverlap:0,minLevel:0,maxLevel:0<t.levels.length?t.levels.length-1:0});a.TileSource.apply(this,[t]);this.levels=t.levels};a.extend(a.LegacyTileSource.prototype,a.TileSource.prototype,{supports:function(e,t){return e.type&&"legacy-image-pyramid"===e.type||e.documentElement&&"legacy-image-pyramid"===e.documentElement.getAttribute("type")},configure:function(e,t,i){return a.isPlainObject(e)?e.levels:function(e){if(!e||!e.documentElement)throw new Error(a.getString("Errors.Xml"));var t,i,r=e.documentElement,n=r.tagName,o=null,s=[];if("image"===n)try{o={type:r.getAttribute("type"),levels:[]};s=r.getElementsByTagName("level");for(i=0;i<s.length;i++){t=s[i];o.levels.push({url:t.getAttribute("url"),width:parseInt(t.getAttribute("width"),10),height:parseInt(t.getAttribute("height"),10)})}return o.levels}catch(e){throw e instanceof Error?e:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if("collection"===n)throw new Error("Legacy Image Pyramid Collections not yet supported.");if("error"===n)throw new Error("Error: "+e)}throw new Error("Unknown element "+n)}(e)},getLevelScale:function(e){var t=NaN;return t=0<this.levels.length&&e>=this.minLevel&&e<=this.maxLevel?this.levels[e].width/this.levels[this.maxLevel].width:t},getNumTiles:function(e){return this.getLevelScale(e)?new a.Point(1,1):new a.Point(0,0)},getTileUrl:function(e,t,i){var r=null;return r=0<this.levels.length&&e>=this.minLevel&&e<=this.maxLevel?this.levels[e].url:r},equals:function(t){if(!t.levels||t.levels.length!==this.levels.length)return!1;for(let e=this.minLevel;e<=this.maxLevel;e++)if(this.levels[e].url!==t.levels[e].url)return!1;return!0}})}(OpenSeadragon);!function(n){n.ImageTileSource=class extends n.TileSource{constructor(e){super(n.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1},e))}supports(e,t){return e.type&&"image"===e.type}configure(e,t,i){return e}getImageInfo(e){const t=new Image,i=this;this.crossOriginPolicy&&(t.crossOrigin=this.crossOriginPolicy);this.ajaxWithCredentials&&(t.useCredentials=this.ajaxWithCredentials);n.addEvent(t,"load",function(){i.width=t.naturalWidth;i.height=t.naturalHeight;i.aspectRatio=i.width/i.height;i.dimensions=new n.Point(i.width,i.height);i._tileWidth=i.width;i._tileHeight=i.height;i.tileOverlap=0;i.minLevel=0;i.image=t;i.levels=i._buildLevels(t);i.maxLevel=i.levels.length-1;i.ready=!0;i.raiseEvent("ready",{tileSource:i})});n.addEvent(t,"error",function(){i.image=null;i.raiseEvent("open-failed",{message:"Error loading image at "+e,source:e})});t.src=e}getLevelScale(e){let t=NaN;e>=this.minLevel&&e<=this.maxLevel&&(t=this.levels[e].width/this.levels[this.maxLevel].width);return t}getNumTiles(e){return this.getLevelScale(e)?new n.Point(1,1):new n.Point(0,0)}getTileUrl(e,t,i){return e===this.maxLevel?this.url:this.url+`?l=${e}&x=${t}&y=`+i}equals(e){return this.url===e.url}getTilePostData(e,t,i){return{level:e,x:t,y:i}}getContext2D(e,t,i){n.console.error("Using [TiledImage.getContext2D] (for plain images only) is deprecated. Use overridden downloadTileStart (https://openseadragon.github.io/examples/advanced-data-model/) instead.");return this._createContext2D()}downloadTileStart(e){var t=e.postData;if(t.level!==this.maxLevel)if(t.level>=this.minLevel&&t.level<=this.maxLevel){var i=this.levels[t.level];i=this._createContext2D(this.image,i.width,i.height);e.finish(i,null,"context2d")}else e.fail(`Invalid level ${t.level} for plain image source. Did you forget to set buildPyramid=true?`);else e.finish(this.image,null,"image")}downloadTileAbort(e){}_buildLevels(e){const t=[{url:e.src,width:e.naturalWidth,height:e.naturalHeight}];if(!this.buildPyramid||!n.supportsCanvas||!this.useCanvas)return t;let i=e.naturalWidth,r=e.naturalHeight;for(;2<=i&&2<=r;){i=Math.floor(i/2);r=Math.floor(r/2);t.push({width:i,height:r})}return t.reverse()}_createContext2D(e,t,i){const r=document.createElement("canvas"),n=r.getContext("2d");r.width=t;r.height=i;n.drawImage(e,0,0,t,i);return n}}}(OpenSeadragon);!function(n){n.TileSourceCollection=function(e,t,i,r){n.console.error("TileSourceCollection is deprecated; use World instead")}}(OpenSeadragon);!function(o){o.PriorityQueue=class{constructor(e=void 0){this.nodes_=[];e&&this.insertAll(e)}insert(e,t){this.insertNode(new Node(e,t))}insertNode(e){const t=this.nodes_;e.index=t.length;t.push(e);this.moveUp_(e.index)}insertAll(e){let t,i;if(!(e instanceof o.PriorityQueue))throw"insertAll supports only OpenSeadragon.PriorityQueue object!";t=e.getKeys();i=e.getValues();if(this.getCount()<=0){const r=this.nodes_;for(let e=0;e<t.length;e++){const n=new Node(t[e],i[e]);n.index=r.length;r.push(n)}}else for(let e=0;e<t.length;e++)this.insert(t[e],i[e])}remove(){const e=this.nodes_;var t=e.length;const i=e[0];if(!(t<=0)){if(1==t)e.length=0;else{e[0]=e.pop();e[0]&&(e[0].index=0);this.moveDown_(0)}i&&delete i.index;return i}}peek(){var e=this.nodes_;if(0!=e.length)return e[0].value}peekKey(){return this.nodes_[0]&&this.nodes_[0].key}decreaseKey(e,t){if(void 0===e.index){e.key=t;this.insertNode(e)}else{e.key=t;this.moveUp_(e.index)}}moveDown_(e){const t=this.nodes_;var i=t.length;const r=t[e];for(;e<i>>1;){var n=this.getLeftChildIndex_(e);var o=this.getRightChildIndex_(e);n=o<i&&t[o].key<t[n].key?o:n;if(t[n].key>r.key)break;t[e]=t[n];t[e].index=e;e=n}t[e]=r;r&&(r.index=e)}moveUp_(e){const t=this.nodes_;const i=t[e];for(;0<e;){var r=this.getParentIndex_(e);if(!(t[r].key>i.key))break;t[e]=t[r];t[e].index=e;e=r}t[e]=i;i&&(i.index=e)}getLeftChildIndex_(e){return 2*e+1}getRightChildIndex_(e){return 2*e+2}getParentIndex_(e){return e-1>>1}getValues(){var t=this.nodes_;const i=[];var r=t.length;for(let e=0;e<r;e++)i.push(t[e].value);return i}getKeys(){var t=this.nodes_;const i=[];var r=t.length;for(let e=0;e<r;e++)i.push(t[e].key);return i}containsValue(t){return this.nodes_.some(e=>e.value==t)}containsKey(t){return this.nodes_.some(e=>e.value==t)}clone(){return new o.PriorityQueue(this)}getCount(){return this.nodes_.length}isEmpty(){return 0===this.nodes_.length}clear(){this.nodes_.length=0}};o.PriorityQueue.Node=class{constructor(e,t){this.key=e;this.value=t;this.index=0}clone(){return new Node(this.key,this.value)}}}(OpenSeadragon);!function(u){class e{constructor(){this.adjacencyList={};this.vertices={}}addVertex(e){if(this.vertices[e])return!1;this.vertices[e]=new u.PriorityQueue.Node(0,e);this.adjacencyList[e]=[];return!0}addEdge(e,t,i,r){i<0&&u.console.error("WeightedGraph: negative weights will make for invalid shortest path computation!");const n=this.adjacencyList[e],o=n.findIndex(e=>e.target===this.vertices[t]),s={target:this.vertices[t],origin:this.vertices[e],weight:i,transform:r};if(o<0){this.adjacencyList[e].push(s);return!0}this.adjacencyList[e][o]=s;return!1}dijkstra(e,t){let i=[];if(e===t)return{path:i,cost:0};const r=new OpenSeadragon.PriorityQueue;let n;for(var o in this.vertices){o=this.vertices[o];if(o.value===e){o.key=0;r.insertNode(o)}else{o.key=1/0;delete o.index}o._previous=null}for(;0<r.getCount();){n=r.remove();if(n.value===t)break;var s=this.adjacencyList[n.value];for(var a in s){var l=s[a];a=n.key+l.weight;let e=l.target;if(a<e.key){e._previous=n;r.decreaseKey(e,a)}}}if(n&&n._previous&&n.value===t){var h=n.key;for(;n._previous;){const c=n.value,u=n._previous,d=u.value;i.push(this.adjacencyList[d].find(e=>e.target.value===c));n=u}return{path:i.reverse(),cost:h}}}}u.DataTypeConvertor=class{constructor(){this.graph=new e;this.destructors={};this.copyings={};const i=(e,r)=>new u.Promise((e,t)=>{if(!u.supportsAsync)throw"Not supported in sync mode!";const i=new Image;i.onerror=i.onabort=t;i.onload=()=>e(i);i.src=r});const r=(e,t)=>{const i=document.createElement("canvas");i.width=t.width;i.height=t.height;const r=i.getContext("2d",{willReadFrequently:!0});r.drawImage(t,0,0);return r};this.learn("context2d","webImageUrl",(e,t)=>t.canvas.toDataURL(),1,2);this.learn("image","webImageUrl",(e,t)=>t.url);this.learn("image","context2d",r,1,1);this.learn("url","image",i,1,1);this.learn("image","image",(e,t)=>i(0,t.src),1,1);this.learn("url","url",(e,t)=>t,0,1);this.learn("context2d","context2d",(e,t)=>r(0,t.canvas));this.learnDestroy("context2d",e=>{e.canvas.width=0;e.canvas.height=0})}guessType(e){if(Array.isArray(e)){const r=[];for(var t of e)if(void 0!==t&&null!==t){t=this.guessType(t);r.includes(t)||r.push(t)}r.sort();return`Array [${r.join(",")}]`}const i=u.type(e);return"dom-node"===i?i.nodeName.toLowerCase():"object"===i&&u.isFunction(e.getType)?e.getType():i}learn(e,t,i,r=0,n=1){u.console.assert(0<=r&&r<=7,"[DataTypeConvertor] Conversion costPower must be between <0, 7>.");u.console.assert(u.isFunction(i),"[DataTypeConvertor:learn] Callback must be a valid function!");if(e===t)this.copyings[t]=i;else{r++;n=Math.min(Math.max(n,1),15);this.graph.addVertex(e);this.graph.addVertex(t);this.graph.addEdge(e,t,10*r^5+n,i);this._known={}}}learnDestroy(e,t){this.destructors[e]=t}convert(s,e,t,...i){const a=this.getConversionPath(t,i);if(!a){u.console.error(`[OpenSeadragon.convertor.convert] Conversion ${t} ---> ${i} cannot be done!`);return u.Promise.resolve()}const l=a.length,h=this;const c=(e,t,i=!0)=>{if(t>=l)return u.Promise.resolve(e);let r=a[t];var n=r.transform(s,e);if(void 0===n){u.console.error("[OpenSeadragon.convertor.convert] data mid result undefined value (while converting using %s)",r);return u.Promise.resolve()}i&&h.destroy(e,r.origin.value);const o="promise"===u.type(n)?n:u.Promise.resolve(n);return o.then(e=>c(e,t+1))};return c(e,0,!1)}copy(e,t,i){const r=this.copyings[i];if(r){t=r(e,t);return"promise"===u.type(t)?t:u.Promise.resolve(t)}u.console.warn("[OpenSeadragon.convertor.copy] is not supported with type %s",i);return u.Promise.resolve(void 0)}destroy(e,t){const i=this.destructors[t];if(i){e=i(e);return"promise"===u.type(e)?e:u.Promise.resolve(e)}}getConversionPath(e,t){let i,r;let n=this._known[e];n||(this._known[e]=n={});if(Array.isArray(t)){u.console.assert(0<t.length,"[getConversionPath] conversion 'to' type must be defined.");let e=1/0;r=t[0];for(const s of t){var o=n[s];if(o&&e>o.cost){i=o;e=o.cost;r=s}}}else{u.console.assert("string"==typeof t,"[getConversionPath] conversion 'to' type must be defined.");i=n[t];r=t}if(!i){i=this.graph.dijkstra(e,r);this._known[e][r]=i}return i?i.path:void 0}getKnownTypes(){return Object.keys(this.graph.vertices)}existsType(e){return!!this.graph.vertices[e]}};u.convertor=new u.DataTypeConvertor}(OpenSeadragon);!function(i){i.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3};i.Button=function(e){var t=this;i.EventSource.call(this);i.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:i.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:i.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null,userData:null},e);this.element=e.element||i.makeNeutralElement("div");if(!e.element){this.imgRest=i.makeTransparentImage(this.srcRest);this.imgGroup=i.makeTransparentImage(this.srcGroup);this.imgHover=i.makeTransparentImage(this.srcHover);this.imgDown=i.makeTransparentImage(this.srcDown);this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip;i.setElementPointerEventsNone(this.imgRest);i.setElementPointerEventsNone(this.imgGroup);i.setElementPointerEventsNone(this.imgHover);i.setElementPointerEventsNone(this.imgDown);this.element.style.position="relative";i.setElementTouchActionNone(this.element);this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute";this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px";this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px";this.imgHover.style.visibility=this.imgDown.style.visibility="hidden";this.element.appendChild(this.imgRest);this.element.appendChild(this.imgGroup);this.element.appendChild(this.imgHover);this.element.appendChild(this.imgDown)}this.addHandler("press",this.onPress);this.addHandler("release",this.onRelease);this.addHandler("click",this.onClick);this.addHandler("enter",this.onEnter);this.addHandler("exit",this.onExit);this.addHandler("focus",this.onFocus);this.addHandler("blur",this.onBlur);this.currentState=i.ButtonState.GROUP;this.fadeBeginTime=null;this.shouldFade=!1;this.element.style.display="inline-block";this.element.style.position="relative";this.element.title=this.tooltip;this.tracker=new i.MouseTracker({userData:"Button.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(e){if(e.insideElementPressed){n(t,i.ButtonState.DOWN);t.raiseEvent("enter",{originalEvent:e.originalEvent})}else e.buttonDownAny||n(t,i.ButtonState.HOVER)},focusHandler:function(e){t.tracker.enterHandler(e);t.raiseEvent("focus",{originalEvent:e.originalEvent})},leaveHandler:function(e){o(t,i.ButtonState.GROUP);e.insideElementPressed&&t.raiseEvent("exit",{originalEvent:e.originalEvent})},blurHandler:function(e){t.tracker.leaveHandler(e);t.raiseEvent("blur",{originalEvent:e.originalEvent})},pressHandler:function(e){n(t,i.ButtonState.DOWN);t.raiseEvent("press",{originalEvent:e.originalEvent})},releaseHandler:function(e){if(e.insideElementPressed&&e.insideElementReleased){o(t,i.ButtonState.HOVER);t.raiseEvent("release",{originalEvent:e.originalEvent})}else e.insideElementPressed?o(t,i.ButtonState.GROUP):n(t,i.ButtonState.HOVER)},clickHandler:function(e){e.quick&&t.raiseEvent("click",{originalEvent:e.originalEvent})},keyHandler:function(e){if(13===e.keyCode){t.raiseEvent("click",{originalEvent:e.originalEvent});t.raiseEvent("release",{originalEvent:e.originalEvent});e.preventDefault=!0}else e.preventDefault=!1}});o(this,i.ButtonState.REST)};i.extend(i.Button.prototype,i.EventSource.prototype,{notifyGroupEnter:function(){n(this,i.ButtonState.GROUP)},notifyGroupExit:function(){o(this,i.ButtonState.REST)},disable:function(){this.notifyGroupExit();this.element.disabled=!0;this.tracker.setTracking(!1);i.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1;this.tracker.setTracking(!0);i.setElementOpacity(this.element,1,!0);this.notifyGroupEnter()},destroy:function(){if(this.imgRest){this.element.removeChild(this.imgRest);this.imgRest=null}if(this.imgGroup){this.element.removeChild(this.imgGroup);this.imgGroup=null}if(this.imgHover){this.element.removeChild(this.imgHover);this.imgHover=null}if(this.imgDown){this.element.removeChild(this.imgDown);this.imgDown=null}this.removeAllHandlers();this.tracker.destroy();this.element=null}});function r(e){i.requestAnimationFrame(function(){!function(e){var t;if(e.shouldFade){t=i.now();t=t-e.fadeBeginTime;t=1-t/e.fadeLength;t=Math.min(1,t);t=Math.max(0,t);e.imgGroup&&i.setElementOpacity(e.imgGroup,t,!0);0<t&&r(e)}}(e)})}function n(e,t){if(!e.element.disabled){if(t>=i.ButtonState.GROUP&&e.currentState===i.ButtonState.REST){!function(e){e.shouldFade=!1;e.imgGroup&&i.setElementOpacity(e.imgGroup,1,!0)}(e);e.currentState=i.ButtonState.GROUP}if(t>=i.ButtonState.HOVER&&e.currentState===i.ButtonState.GROUP){e.imgHover&&(e.imgHover.style.visibility="");e.currentState=i.ButtonState.HOVER}if(t>=i.ButtonState.DOWN&&e.currentState===i.ButtonState.HOVER){e.imgDown&&(e.imgDown.style.visibility="");e.currentState=i.ButtonState.DOWN}}}function o(e,t){if(!e.element.disabled){if(t<=i.ButtonState.HOVER&&e.currentState===i.ButtonState.DOWN){e.imgDown&&(e.imgDown.style.visibility="hidden");e.currentState=i.ButtonState.HOVER}if(t<=i.ButtonState.GROUP&&e.currentState===i.ButtonState.HOVER){e.imgHover&&(e.imgHover.style.visibility="hidden");e.currentState=i.ButtonState.GROUP}if(t<=i.ButtonState.REST&&e.currentState===i.ButtonState.GROUP){!function(e){e.shouldFade=!0;e.fadeBeginTime=i.now()+e.fadeDelay;window.setTimeout(function(){r(e)},e.fadeDelay)}(e);e.currentState=i.ButtonState.REST}}}}(OpenSeadragon);!function(n){n.ButtonGroup=function(e){n.extend(!0,this,{buttons:[],clickTimeThreshold:n.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:n.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},e);var t,i=this.buttons.concat([]),r=this;this.element=e.element||n.makeNeutralElement("div");if(!e.group){this.element.style.display="inline-block";for(t=0;t<i.length;t++)this.element.appendChild(i[t].element)}n.setElementTouchActionNone(this.element);this.tracker=new n.MouseTracker({userData:"ButtonGroup.tracker",element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(e){var t;for(t=0;t<r.buttons.length;t++)r.buttons[t].notifyGroupEnter()},leaveHandler:function(e){var t;if(!e.insideElementPressed)for(t=0;t<r.buttons.length;t++)r.buttons[t].notifyGroupExit()}})};n.ButtonGroup.prototype={addButton:function(e){this.buttons.push(e);this.element.appendChild(e.element)},emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateLeave:function(){this.tracker.leaveHandler({eventSource:this.tracker})},destroy:function(){for(;this.buttons.length;){var e=this.buttons.pop();this.element.removeChild(e.element);e.destroy()}this.tracker.destroy();this.element=null}}}(OpenSeadragon);!function(f){f.Rect=function(e,t,i,r,n){this.x="number"==typeof e?e:0;this.y="number"==typeof t?t:0;this.width="number"==typeof i?i:0;this.height="number"==typeof r?r:0;this.degrees="number"==typeof n?n:0;this.degrees=f.positiveModulo(this.degrees,360);var o,s;if(270<=this.degrees){o=this.getTopRight();this.x=o.x;this.y=o.y;s=this.height;this.height=this.width;this.width=s;this.degrees-=270}else if(180<=this.degrees){o=this.getBottomRight();this.x=o.x;this.y=o.y;this.degrees-=180}else if(90<=this.degrees){o=this.getBottomLeft();this.x=o.x;this.y=o.y;s=this.height;this.height=this.width;this.width=s;this.degrees-=90}};f.Rect.fromSummits=function(e,t,i){var r=e.distanceTo(t);var n=e.distanceTo(i);i=t.minus(e);t=Math.atan(i.y/i.x);i.x<0?t+=Math.PI:i.y<0&&(t+=2*Math.PI);return new f.Rect(e.x,e.y,r,n,t/Math.PI*180)};f.Rect.prototype={clone:function(){return new f.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new f.Point(this.x,this.y)},getBottomRight:function(){return new f.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new f.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new f.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new f.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new f.Point(this.width,this.height)},equals:function(e){return e instanceof f.Rect&&this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height&&this.degrees===e.degrees},times:function(e){return new f.Rect(this.x*e,this.y*e,this.width*e,this.height*e,this.degrees)},translate:function(e){return new f.Rect(this.x+e.x,this.y+e.y,this.width,this.height,this.degrees)},union:function(e){var t=this.getBoundingBox();var i=e.getBoundingBox();var r=Math.min(t.x,i.x);var n=Math.min(t.y,i.y);e=Math.max(t.x+t.width,i.x+i.width);i=Math.max(t.y+t.height,i.y+i.height);return new f.Rect(r,n,e-r,i-n)},intersection:function(e){var s=1e-10;var t=[];var i=this.getTopLeft();e.containsPoint(i,s)&&t.push(i);i=this.getTopRight();e.containsPoint(i,s)&&t.push(i);i=this.getBottomLeft();e.containsPoint(i,s)&&t.push(i);i=this.getBottomRight();e.containsPoint(i,s)&&t.push(i);i=e.getTopLeft();this.containsPoint(i,s)&&t.push(i);i=e.getTopRight();this.containsPoint(i,s)&&t.push(i);i=e.getBottomLeft();this.containsPoint(i,s)&&t.push(i);i=e.getBottomRight();this.containsPoint(i,s)&&t.push(i);var r=this._getSegments();var n=e._getSegments();for(var o=0;o<r.length;o++){var a=r[o];for(var l=0;l<n.length;l++){var h=n[l];h=function(e,t,i,r){var n=t.minus(e);var o=r.minus(i);t=-o.x*n.y+n.x*o.y;if(0==t)return null;r=(n.x*(e.y-i.y)-n.y*(e.x-i.x))/t;t=(o.x*(e.y-i.y)-o.y*(e.x-i.x))/t;if(-s<=r&&r<=1-s&&-s<=t&&t<=1-s)return new f.Point(e.x+t*n.x,e.y+t*n.y);return null}(a[0],a[1],h[0],h[1]);h&&t.push(h)}}if(0===t.length)return null;var c=t[0].x;var u=t[0].x;var d=t[0].y;var p=t[0].y;for(var g=1;g<t.length;g++){var m=t[g];m.x<c&&(c=m.x);m.x>u&&(u=m.x);m.y<d&&(d=m.y);m.y>p&&(p=m.y)}return new f.Rect(c,d,u-c,p-d)},_getSegments:function(){var e=this.getTopLeft();var t=this.getTopRight();var i=this.getBottomLeft();var r=this.getBottomRight();return[[e,t],[t,r],[r,i],[i,e]]},rotate:function(e,t){if(0===(e=f.positiveModulo(e,360)))return this.clone();t=t||this.getCenter();var i=this.getTopLeft().rotate(e,t);e=this.getTopRight().rotate(e,t).minus(i);e=e.apply(function(e){return Math.abs(e)<1e-15?0:e});t=Math.atan(e.y/e.x);e.x<0?t+=Math.PI:e.y<0&&(t+=2*Math.PI);return new f.Rect(i.x,i.y,this.width,this.height,t/Math.PI*180)},getBoundingBox:function(){if(0===this.degrees)return this.clone();var e=this.getTopLeft();var t=this.getTopRight();var i=this.getBottomLeft();var r=this.getBottomRight();var n=Math.min(e.x,t.x,i.x,r.x);var o=Math.max(e.x,t.x,i.x,r.x);var s=Math.min(e.y,t.y,i.y,r.y);r=Math.max(e.y,t.y,i.y,r.y);return new f.Rect(n,s,o-n,r-s)},getIntegerBoundingBox:function(){var e=this.getBoundingBox();var t=Math.floor(e.x);var i=Math.floor(e.y);var r=Math.ceil(e.width+e.x-t);e=Math.ceil(e.height+e.y-i);return new f.Rect(t,i,r,e)},containsPoint:function(e,t){t=t||0;var i=this.getTopLeft();var r=this.getTopRight();var n=this.getBottomLeft();var o=r.minus(i);var s=n.minus(i);return(e.x-i.x)*o.x+(e.y-i.y)*o.y>=-t&&(e.x-r.x)*o.x+(e.y-r.y)*o.y<=t&&(e.x-i.x)*s.x+(e.y-i.y)*s.y>=-t&&(e.x-n.x)*s.x+(e.y-n.y)*s.y<=t},toString:function(){return"["+Math.round(100*this.x)/100+", "+Math.round(100*this.y)/100+", "+Math.round(100*this.width)/100+"x"+Math.round(100*this.height)/100+", "+Math.round(100*this.degrees)/100+"deg]"}}}(OpenSeadragon);!function(h){var s={};h.ReferenceStrip=function(e){var t,i,r,n=e.viewer,o=h.getElementSize(n.element);if(!e.id){e.id="referencestrip-"+h.now();this.element=h.makeNeutralElement("div");this.element.id=e.id;this.element.className="referencestrip"}e=h.extend(!0,{sizeRatio:h.DEFAULT_SETTINGS.referenceStripSizeRatio,position:h.DEFAULT_SETTINGS.referenceStripPosition,scroll:h.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:h.DEFAULT_SETTINGS.clickTimeThreshold},e,{element:this.element});h.extend(this,e);s[this.id]={animating:!1};this.minPixelRatio=this.viewer.minPixelRatio;this.element.tabIndex=0;(i=this.element.style).marginTop="0px";i.marginRight="0px";i.marginBottom="0px";i.marginLeft="0px";i.left="0px";i.bottom="0px";i.border="0px";i.background="#000";i.position="relative";h.setElementTouchActionNone(this.element);h.setElementOpacity(this.element,.8);this.viewer=n;this.tracker=new h.MouseTracker({userData:"ReferenceStrip.tracker",element:this.element,clickHandler:h.delegate(this,a),dragHandler:h.delegate(this,l),scrollHandler:h.delegate(this,c),enterHandler:h.delegate(this,d),leaveHandler:h.delegate(this,p),keyDownHandler:h.delegate(this,g),keyHandler:h.delegate(this,m),preProcessEventHandler:function(e){"wheel"===e.eventType&&(e.preventDefault=!0)}});if(e.width&&e.height){this.element.style.width=e.width+"px";this.element.style.height=e.height+"px";n.addControl(this.element,{anchor:h.ControlAnchor.BOTTOM_LEFT})}else if("horizontal"===e.scroll){this.element.style.width=o.x*e.sizeRatio*n.tileSources.length+12*n.tileSources.length+"px";this.element.style.height=o.y*e.sizeRatio+"px";n.addControl(this.element,{anchor:h.ControlAnchor.BOTTOM_LEFT})}else{this.element.style.height=o.y*e.sizeRatio*n.tileSources.length+12*n.tileSources.length+"px";this.element.style.width=o.x*e.sizeRatio+"px";n.addControl(this.element,{anchor:h.ControlAnchor.TOP_LEFT})}this.panelWidth=o.x*this.sizeRatio+8;this.panelHeight=o.y*this.sizeRatio+8;this.panels=[];this.miniViewers={};for(r=0;r<n.tileSources.length;r++){(t=h.makeNeutralElement("div")).id=this.element.id+"-"+r;t.style.width=this.panelWidth+"px";t.style.height=this.panelHeight+"px";t.style.display="inline";t.style.float="left";t.style.cssFloat="left";t.style.padding="2px";h.setElementTouchActionNone(t);h.setElementPointerEventsNone(t);this.element.appendChild(t);t.activePanel=!1;this.panels.push(t)}u(this,"vertical"===this.scroll?o.y:o.x,0);this.setFocus(0)};h.ReferenceStrip.prototype={setFocus:function(e){var t,i=this.element.querySelector("#"+this.element.id+"-"+e),r=h.getElementSize(this.viewer.canvas),n=Number(this.element.style.width.replace("px","")),o=Number(this.element.style.height.replace("px","")),s=-Number(this.element.style.marginLeft.replace("px","")),a=-Number(this.element.style.marginTop.replace("px",""));if(this.currentSelected!==i){this.currentSelected&&(this.currentSelected.style.background="#000");this.currentSelected=i;this.currentSelected.style.background="#999";if("horizontal"===this.scroll){if((t=Number(e)*(this.panelWidth+3))>s+r.x-this.panelWidth){t=Math.min(t,n-r.x);this.element.style.marginLeft=-t+"px";u(this,r.x,-t)}else if(t<s){t=Math.max(0,t-r.x/2);this.element.style.marginLeft=-t+"px";u(this,r.x,-t)}}else if((t=Number(e)*(this.panelHeight+3))>a+r.y-this.panelHeight){t=Math.min(t,o-r.y);this.element.style.marginTop=-t+"px";u(this,r.y,-t)}else if(t<a){t=Math.max(0,t-r.y/2);this.element.style.marginTop=-t+"px";u(this,r.y,-t)}this.currentPage=e;d.call(this,{eventSource:this.tracker})}},update:function(){return!!s[this.id].animating},destroy:function(){if(this.miniViewers)for(var e in this.miniViewers)this.miniViewers[e].destroy();this.tracker.destroy();this.element&&this.viewer.removeControl(this.element)}};function a(e){if(e.quick){e="horizontal"===this.scroll?Math.floor(e.position.x/(this.panelWidth+4)):Math.floor(e.position.y/this.panelHeight);this.viewer.goToPage(e)}this.element.focus()}function l(e){this.dragging=!0;if(this.element){var t=Number(this.element.style.marginLeft.replace("px","")),i=Number(this.element.style.marginTop.replace("px","")),r=Number(this.element.style.width.replace("px","")),n=Number(this.element.style.height.replace("px","")),o=h.getElementSize(this.viewer.canvas);if("horizontal"===this.scroll){if(0<-e.delta.x){if(t>-(r-o.x)){this.element.style.marginLeft=t+2*e.delta.x+"px";u(this,o.x,t+2*e.delta.x)}}else if(-e.delta.x<0&&t<0){this.element.style.marginLeft=t+2*e.delta.x+"px";u(this,o.x,t+2*e.delta.x)}}else if(0<-e.delta.y){if(i>-(n-o.y)){this.element.style.marginTop=i+2*e.delta.y+"px";u(this,o.y,i+2*e.delta.y)}}else if(-e.delta.y<0&&i<0){this.element.style.marginTop=i+2*e.delta.y+"px";u(this,o.y,i+2*e.delta.y)}}}function c(e){if(this.element){var t=Number(this.element.style.marginLeft.replace("px","")),i=Number(this.element.style.marginTop.replace("px","")),r=Number(this.element.style.width.replace("px","")),n=Number(this.element.style.height.replace("px","")),o=h.getElementSize(this.viewer.canvas);if("horizontal"===this.scroll){if(0<e.scroll){if(t>-(r-o.x)){this.element.style.marginLeft=t-60*e.scroll+"px";u(this,o.x,t-60*e.scroll)}}else if(e.scroll<0&&t<0){this.element.style.marginLeft=t-60*e.scroll+"px";u(this,o.x,t-60*e.scroll)}}else if(e.scroll<0){if(i>o.y-n){this.element.style.marginTop=i+60*e.scroll+"px";u(this,o.y,i+60*e.scroll)}}else if(0<e.scroll&&i<0){this.element.style.marginTop=i+60*e.scroll+"px";u(this,o.y,i+60*e.scroll)}e.preventDefault=!0}}function u(e,t,i){var r,n,o,s,a;r="horizontal"===e.scroll?e.panelWidth:e.panelHeight;n=Math.ceil(t/r)+5;for(s=n=(n=(o=Math.ceil((Math.abs(i)+t)/r)+1)-n)<0?0:n;s<o&&s<e.panels.length;s++)if(!(a=e.panels[s]).activePanel){var l=e.viewer.tileSources[s];l=l.referenceStripThumbnailUrl?{type:"image",url:l.referenceStripThumbnailUrl}:l;l=new h.Viewer({id:a.id,tileSources:[l],element:a,navigatorSizeRatio:e.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:e.viewer.loadTilesWithAjax,ajaxHeaders:e.viewer.ajaxHeaders,drawer:"canvas"});h.setElementPointerEventsNone(l.canvas);h.setElementPointerEventsNone(l.container);l.innerTracker.setTracking(!1);l.outerTracker.setTracking(!1);e.miniViewers[a.id]=l;a.activePanel=!0}}function d(e){e=e.eventSource.element;"horizontal"===this.scroll?e.style.marginBottom="0px":e.style.marginLeft="0px"}function p(e){e=e.eventSource.element;"horizontal"===this.scroll?e.style.marginBottom="-"+h.getElementSize(e).y/2+"px":e.style.marginLeft="-"+h.getElementSize(e).x/2+"px"}function g(e){if(e.ctrl||e.alt||e.meta)e.preventDefault=!1;else switch(e.keyCode){case 38:c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null});e.preventDefault=!0;break;case 40:case 37:c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null});e.preventDefault=!0;break;case 39:c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null});e.preventDefault=!0;break;default:e.preventDefault=!1}}function m(e){if(e.ctrl||e.alt||e.meta)e.preventDefault=!1;else switch(e.keyCode){case 61:c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null});e.preventDefault=!0;break;case 45:c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null});e.preventDefault=!0;break;case 48:case 119:case 87:c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null});e.preventDefault=!0;break;case 115:case 83:case 97:c.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null});e.preventDefault=!0;break;case 100:c.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null});e.preventDefault=!0;break;default:e.preventDefault=!1}}}(OpenSeadragon);!function(s){s.DisplayRect=function(e,t,i,r,n,o){s.Rect.apply(this,[e,t,i,r]);this.minLevel=n;this.maxLevel=o};s.extend(s.DisplayRect.prototype,s.Rect.prototype)}(OpenSeadragon);!function(n){n.Spring=function(e){var t=arguments;"object"!=typeof e&&(e={initial:t.length&&"number"==typeof t[0]?t[0]:void 0,springStiffness:1<t.length?t[1].springStiffness:5,animationTime:1<t.length?t[1].animationTime:1.5});n.console.assert("number"==typeof e.springStiffness&&0!==e.springStiffness,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number");n.console.assert("number"==typeof e.animationTime&&0<=e.animationTime,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0");if(e.exponential){this._exponential=!0;delete e.exponential}n.extend(!0,this,e);this.current={value:"number"==typeof this.initial?this.initial:this._exponential?0:1,time:n.now()};n.console.assert(!this._exponential||0!==this.current.value,"[OpenSeadragon.Spring] value must be non-zero for exponential springs");this.start={value:this.current.value,time:this.current.time};this.target={value:this.current.value,time:this.current.time};if(this._exponential){this.start._logValue=Math.log(this.start.value);this.target._logValue=Math.log(this.target.value);this.current._logValue=Math.log(this.current.value)}};n.Spring.prototype={resetTo:function(e){n.console.assert(!this._exponential||0!==e,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs");this.start.value=this.target.value=this.current.value=e;this.start.time=this.target.time=this.current.time=n.now();if(this._exponential){this.start._logValue=Math.log(this.start.value);this.target._logValue=Math.log(this.target.value);this.current._logValue=Math.log(this.current.value)}},springTo:function(e){n.console.assert(!this._exponential||0!==e,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs");this.start.value=this.current.value;this.start.time=this.current.time;this.target.value=e;this.target.time=this.start.time+1e3*this.animationTime;if(this._exponential){this.start._logValue=Math.log(this.start.value);this.target._logValue=Math.log(this.target.value)}},shiftBy:function(e){this.start.value+=e;this.target.value+=e;if(this._exponential){n.console.assert(0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs");this.start._logValue=Math.log(this.start.value);this.target._logValue=Math.log(this.target.value)}},setExponential:function(e){this._exponential=e;if(this._exponential){n.console.assert(0!==this.current.value&&0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs");this.start._logValue=Math.log(this.start.value);this.target._logValue=Math.log(this.target.value);this.current._logValue=Math.log(this.current.value)}},update:function(){this.current.time=n.now();let e,t;if(this._exponential){e=this.start._logValue;t=this.target._logValue}else{e=this.start.value;t=this.target.value}if(this.current.time>=this.target.time)this.current.value=this.target.value;else{i=e+(t-e)*(i=this.springStiffness,r=(this.current.time-this.start.time)/(this.target.time-this.start.time),(1-Math.exp(i*-r))/(1-Math.exp(-i)));this._exponential?this.current.value=Math.exp(i):this.current.value=i}var i,r;return this.current.value!==this.target.value},isAtTargetValue:function(){return this.current.value===this.target.value}}}(OpenSeadragon);!function(o){o.ImageJob=function(e){o.extend(!0,this,{timeout:o.DEFAULT_SETTINGS.timeout,jobId:null,tries:0},e);this.data=null;this.userData={};this.errorMsg=null};o.ImageJob.prototype={start:function(){this.tries++;var e=this;var t=this.abort;this.jobId=window.setTimeout(function(){e.fail("Image load exceeded timeout ("+e.timeout+" ms)",null)},this.timeout);this.abort=function(){e.source.downloadTileAbort(e);"function"==typeof t&&t()};this.source.downloadTileStart(this)},finish:function(e,t,i){if(this.jobId)if(null!=e&&!1!==e){this.data=e;this.request=t;this.errorMsg=null;this.dataType=i;this.jobId&&window.clearTimeout(this.jobId);this.callback(this)}else this.fail(i||"[downloadTileStart->finish()] Retrieved data is invalid!",t)},fail:function(e,t){this.data=null;this.request=t;this.errorMsg=e;this.dataType=null;if(this.jobId){window.clearTimeout(this.jobId);this.jobId=null}this.callback(this)}};o.ImageLoader=function(e){o.extend(!0,this,{jobLimit:o.DEFAULT_SETTINGS.imageLoaderLimit,timeout:o.DEFAULT_SETTINGS.timeout,jobQueue:[],failedTiles:[],jobsInProgress:0},e)};o.ImageLoader.prototype={addJob:function(t){if(!t.source){o.console.error("ImageLoader.prototype.addJob() requires [options.source]. TileSource since new API defines how images are fetched. Creating a dummy TileSource.");var e=o.TileSource.prototype;t.source={downloadTileStart:e.downloadTileStart,downloadTileAbort:e.downloadTileAbort}}const i=this,r={src:t.src,tile:t.tile||{},source:t.source,loadWithAjax:t.loadWithAjax,ajaxHeaders:t.loadWithAjax?t.ajaxHeaders:null,crossOriginPolicy:t.crossOriginPolicy,ajaxWithCredentials:t.ajaxWithCredentials,postData:t.postData,callback:e=>function(e,t,i){t.errorMsg&&null===t.data&&t.tries<1+e.tileRetryMax&&e.failedTiles.push(t);let r;e.jobsInProgress--;if(e.canAcceptNewJob()&&0<e.jobQueue.length){r=e.jobQueue.shift();r.start();e.jobsInProgress++}if(0<e.tileRetryMax&&0===e.jobQueue.length&&e.canAcceptNewJob()&&0<e.failedTiles.length){r=e.failedTiles.shift();setTimeout(function(){r.start()},e.tileRetryDelay);e.jobsInProgress++}i(t.data,t.errorMsg,t.request,t.dataType)}(i,e,t.callback),abort:t.abort,timeout:this.timeout},n=new o.ImageJob(r);if(!this.jobLimit||this.jobsInProgress<this.jobLimit){n.start();this.jobsInProgress++;return!0}this.jobQueue.push(n);return!1},canAcceptNewJob(){return!this.jobLimit||this.jobsInProgress<this.jobLimit},clear:function(){for(var e=0;e<this.jobQueue.length;e++){var t=this.jobQueue[e];"function"==typeof t.abort&&t.abort()}this.jobQueue=[]}}}(OpenSeadragon);!function(d){d.Tile=function(e,t,i,r,n,o,s,a,l,h,c,u){this.level=e;this.x=t;this.y=i;this.bounds=r;this.positionedBounds=new OpenSeadragon.Rect(r.x,r.y,r.width,r.height);this.sourceBounds=h;this.exists=n;this._url=o;this.postData=c;s&&(this.context2D=s);this.loadWithAjax=a;this.ajaxHeaders=l;if(void 0===u){d.console.warn("Tile constructor needs 'cacheKey' variable: creation tile cache in Tile class is deprecated. TileSource.prototype.getTileHashKey will be used.");u=d.TileSource.prototype.getTileHashKey(e,t,i,o,l,c)}this._cKey=u||"";this._ocKey=u||"";this.loaded=!1;this.loading=!1;this.position=null;this.size=null;this.flipped=!1;this.blendStart=null;this.opacity=null;this.squaredDistance=null;this.visibility=null;this.hasTransparency=!1;this.beingDrawn=!1;this.lastTouchTime=0;this.isRightMost=!1;this.isBottomMost=!1;this.tiledImage=null;this._caches={};this.processing=!1;this.processingPromise=d.Promise.resolve()};d.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},get cacheKey(){return this._cKey},set cacheKey(e){if(e!==this.cacheKey){this.getCache(e)||d.console.warn("[Tile.cacheKey] should not be set manually. Use addCache() with setAsMain=true.");this._updateMainCacheKey(e)}},set originalCacheKey(e){throw"Original Cache Key cannot be managed manually!"},get originalCacheKey(){return this._ocKey},get image(){d.console.error("[Tile.image] property has been deprecated. Use [Tile.getData] instead.");return this.getImage()},get url(){d.console.error("[Tile.url] property has been deprecated. Use [Tile.getUrl] instead.");return this.getUrl()},get element(){d.console.error("Tile::element property is deprecated. Use cache API instead. Moreover, this property might be unstable.");var e=this.getCache();if(!e||!e.loaded)return null;if(e.type===OpenSeadragon.HTMLDrawer.canvasCacheType&&e.type===OpenSeadragon.HTMLDrawer.imageCacheType)return e.data.element;d.console.error("Access to HtmlDrawer property via Tile instance: HTMLDrawer must be used!");return null},get imgElement(){d.console.error("Tile::imgElement property is deprecated. Use cache API instead. Moreover, this property might be unstable.");var e=this.getCache();if(!e||!e.loaded)return null;if(e.type===OpenSeadragon.HTMLDrawer.canvasCacheType&&e.type===OpenSeadragon.HTMLDrawer.imageCacheType)return e.data.imgElement;d.console.error("Access to HtmlDrawer property via Tile instance: HTMLDrawer must be used!");return null},get style(){d.console.error("Tile::style property is deprecated. Use cache API instead. Moreover, this property might be unstable.");var e=this.getCache();if(!e||!e.loaded)return null;if(e.type===OpenSeadragon.HTMLDrawer.canvasCacheType&&e.type===OpenSeadragon.HTMLDrawer.imageCacheType)return e.data.style;d.console.error("Access to HtmlDrawer property via Tile instance: HTMLDrawer must be used!");return null},getImage:function(){d.console.error("[Tile.getImage] property has been deprecated. Use 'tile-invalidated' routine event instead.");const e=this.getCache(this.cacheKey);if(e){e.transformTo("image");return e.data}},getUrl:function(){return"function"==typeof this._url?this._url():this._url},getCanvasContext:function(){d.console.error("[Tile.getCanvasContext] property has been deprecated. Use 'tile-invalidated' routine event instead.");const e=this.getCache(this.cacheKey);if(e){e.transformTo("context2d");return e.data}},get context2D(){d.console.error("[Tile.context2D] property has been deprecated. Use 'tile-invalidated' routine event instead.");return this.getCanvasContext()},set context2D(e){d.console.error("[Tile.context2D] property has been deprecated. Use 'tile-invalidated' routine event instead.");this._caches[this.cacheKey]&&this.removeCache(this.cacheKey);this.addCache(this.cacheKey,e,"context2d",!0,!1)},get cacheImageRecord(){d.console.error("[Tile.cacheImageRecord] property has been deprecated. Use Tile::getCache.");return this.getCache(this.cacheKey)},set cacheImageRecord(t){d.console.error("[Tile.cacheImageRecord] property has been deprecated. Use Tile::addCache.");this._caches[this.cacheKey]&&this.removeCache(this.cacheKey);t&&(t.loaded?this.addCache(this.cacheKey,t.data,t.type,!0,!1):t.await().then(e=>this.addCache(this.cacheKey,e,t.type,!0,!1)))},buildDistinctMainCacheKey:function(){return this.cacheKey===this.originalCacheKey?"mod://"+this.originalCacheKey:this.cacheKey},getCache:function(e=this._cKey){const t=this._caches[e];t&&t.withTileReference(this);return t},addCache:function(e,t,i=void 0,r=!1,n=!0){const o=this.tiledImage;if(!o)return null;if(!i){if(!this.__typeWarningReported){d.console.warn(this,"[Tile.addCache] called without type specification. Automated deduction is potentially unsafe: prefer specification of data type explicitly.");this.__typeWarningReported=!0}"function"==typeof t&&d.console.error("[TileCache.cacheTile] options.data as a callback requires type argument! Current is "+i);i=d.convertor.guessType(t)}var s=e===this.cacheKey;if(n&&(s||r)){n=o.viewer.drawer.getSupportedDataFormats();const l=d.convertor.getConversionPath(i,n);d.console.assert(l,"[Tile.addCache] data was set for the default tile cache we are unable"+`to render. Make sure OpenSeadragon.convertor was taught to convert ${i} to (one of): `+l.toString())}i=o._tileCache.cacheTile({data:t,dataType:i,tile:this,cacheKey:e,cutoff:o.source.getClosestLevel()});const a=this._caches[e];if(a!==i){this._caches[e]=i;if(a){a.removeTile(this);o._tileCache.safeUnloadCache(a)}}!s&&r&&this._updateMainCacheKey(e);return i},setCache(e,t,i=!1,r=!0){const n=this.tiledImage;if(!n)return null;var o=e===this.cacheKey;if(r){d.console.assert(t instanceof d.CacheRecord,"[Tile.setCache] cache must be a CacheRecord object!");if(o||i){r=n.viewer.drawer.getSupportedDataFormats();const a=d.convertor.getConversionPath(t.type,r);d.console.assert(a,"[Tile.setCache] data was set for the default tile cache we are unable"+`to render. Make sure OpenSeadragon.convertor was taught to convert ${t.type} to (one of): `+a.toString())}}const s=this._caches[e];if(s!==t){(this._caches[e]=t).addTile(this);if(s){s.removeTile(this);n._tileCache.safeUnloadCache(s)}}!o&&i&&this._updateMainCacheKey(e);return t},_updateMainCacheKey:function(e){let t=this._caches[this._cKey];t&&t.destroyInternalCache();this._cKey=e},getCacheSize:function(){return Object.values(this._caches).length},removeCache:function(e,t=!0){var i=this._caches[e];if(i){var r=this.cacheKey,n=this.originalCacheKey,o=r===n;if(o||n!==e){if(r===e){if(o||!this._caches[n]){d.console.warn("[Tile.removeCache] trying to remove the only cache that can be used to draw the tile!","If you want to remove the main cache, first set different cache as main with tile.addCache()");return}this._updateMainCacheKey(n)}this.tiledImage._tileCache.unloadCacheForTile(this,e,t,!1)&&delete this._caches[e];return i}d.console.warn("[Tile.removeCache] original data must not be manually deleted: other parts of the code might rely on it!","If you want the tile not to preserve the original data, toggle of data perseverance in tile.setData().")}else this.tiledImage._tileCache.unloadCacheForTile(this,e,t,!0)},getScaleForEdgeSmoothing:function(){d.console.warn("[Tile.getScaleForEdgeSmoothing] is deprecated, the following error is the consequence:");var e=this.getCanvasContext();if(e)return e.canvas.width/(this.size.x*d.pixelDensityRatio);d.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString());return 1},getTranslationForEdgeSmoothing:function(e,t,i){var r=Math.max(1,Math.ceil((i.x-t.x)/2));t=Math.max(1,Math.ceil((i.y-t.y)/2));return new d.Point(r,t).minus(this.position.times(d.pixelDensityRatio).times(e||1).apply(function(e){return e%1}))},reflectCacheRenamed:function(e,t){var i=this._caches[e];if(i){e===this._ocKey&&(this._ocKey=t);e===this._cKey&&(this._cKey=t);this._caches[t]=i;delete this._caches[e]}},equals(e){return this._ocKey===e._ocKey},unload:function(e=!1){this.loaded&&this.tiledImage._tileCache.unloadTile(this,e)},_unload:function(){this.tiledImage=null;this._caches={};this._cacheSize=0;this.loaded=!1;this.loading=!1;this._cKey=this._ocKey}}}(OpenSeadragon);!function(l){l.OverlayPlacement=l.Placement;l.OverlayRotationMode=l.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3});l.Overlay=function(e,t,i){i=l.isPlainObject(e)?e:{element:e,location:t,placement:i};this.elementWrapper=document.createElement("div");this.element=i.element;this.elementWrapper.appendChild(this.element);this.element.id&&(this.elementWrapper.id="overlay-wrapper-"+this.element.id);this.elementWrapper.classList.add("openseadragon-overlay-wrapper");this.style=this.elementWrapper.style;this._init(i)};l.Overlay.prototype={_init:function(e){this.location=e.location;this.placement=void 0===e.placement?l.Placement.TOP_LEFT:e.placement;this.onDraw=e.onDraw;this.checkResize=void 0===e.checkResize||e.checkResize;this.width=void 0===e.width?null:e.width;this.height=void 0===e.height?null:e.height;this.rotationMode=e.rotationMode||l.OverlayRotationMode.EXACT;if(this.location instanceof l.Rect){this.width=this.location.width;this.height=this.location.height;this.location=this.location.getTopLeft();this.placement=l.Placement.TOP_LEFT}this.scales=null!==this.width&&null!==this.height;this.bounds=new l.Rect(this.location.x,this.location.y,this.width,this.height);this.position=this.location},adjust:function(e,t){var i=l.Placement.properties[this.placement];if(i){i.isHorizontallyCentered?e.x-=t.x/2:i.isRight&&(e.x-=t.x);i.isVerticallyCentered?e.y-=t.y/2:i.isBottom&&(e.y-=t.y)}},destroy:function(){var e=this.elementWrapper;var t=this.style;if(e.parentNode){e.parentNode.removeChild(e);if(e.prevElementParent){t.display="none";document.body.appendChild(e)}}this.onDraw=null;t.top="";t.left="";t.position="";null!==this.width&&(t.width="");null!==this.height&&(t.height="");var i=l.getCssPropertyWithVendorPrefix("transformOrigin");e=l.getCssPropertyWithVendorPrefix("transform");if(i&&e){t[i]="";t[e]=""}},drawHTML:function(e,t){var i=this.elementWrapper;if(i.parentNode!==e){i.prevElementParent=i.parentNode;i.prevNextSibling=i.nextSibling;e.appendChild(i);this.style.position="absolute";this.size=l.getElementSize(this.elementWrapper)}var r=this._getOverlayPositionAndSize(t);var n=r.position;var o=this.size=r.size;var s="";t.overlayPreserveContentDirection&&(s=t.flipped?" scaleX(-1)":" scaleX(1)");var a=t.flipped?-r.rotate:r.rotate;e=t.flipped?" scaleX(-1)":"";if(this.onDraw)this.onDraw(n,o,this.element);else{i=this.style;r=this.element.style;r.display="block";i.left=n.x+"px";i.top=n.y+"px";null!==this.width&&(r.width=o.x+"px");null!==this.height&&(r.height=o.y+"px");n=l.getCssPropertyWithVendorPrefix("transformOrigin");o=l.getCssPropertyWithVendorPrefix("transform");if(n&&o)if(a&&!t.flipped){r[o]="";i[n]=this._getTransformOrigin();i[o]="rotate("+a+"deg)"}else if(!a&&t.flipped){r[o]=s;i[n]=this._getTransformOrigin();i[o]=e}else if(a&&t.flipped){r[o]=s;i[n]=this._getTransformOrigin();i[o]="rotate("+a+"deg)"+e}else{r[o]="";i[n]="";i[o]=""}i.display="flex"}},_getOverlayPositionAndSize:function(e){var t=e.pixelFromPoint(this.location,!0);var i=this._getSizeInPixels(e);this.adjust(t,i);var r=0;if(e.getRotation(!0)&&this.rotationMode!==l.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===l.OverlayRotationMode.BOUNDING_BOX&&null!==this.width&&null!==this.height){var n=new l.Rect(t.x,t.y,i.x,i.y);n=this._getBoundingBox(n,e.getRotation(!0));t=n.getTopLeft();i=n.getSize()}else r=e.getRotation(!0);e.flipped&&(t.x=e.getContainerSize().x-t.x);return{position:t,size:i,rotate:r}},_getSizeInPixels:function(e){var t=this.size.x;var i=this.size.y;if(null!==this.width||null!==this.height){var r=e.deltaPixelsFromPointsNoRotate(new l.Point(this.width||0,this.height||0),!0);null!==this.width&&(t=r.x);null!==this.height&&(i=r.y)}if(this.checkResize&&(null===this.width||null===this.height)){r=this.size=l.getElementSize(this.elementWrapper);null===this.width&&(t=r.x);null===this.height&&(i=r.y)}return new l.Point(t,i)},_getBoundingBox:function(e,t){var i=this._getPlacementPoint(e);return e.rotate(t,i).getBoundingBox()},_getPlacementPoint:function(e){var t=new l.Point(e.x,e.y);var i=l.Placement.properties[this.placement];if(i){i.isHorizontallyCentered?t.x+=e.width/2:i.isRight&&(t.x+=e.width);i.isVerticallyCentered?t.y+=e.height/2:i.isBottom&&(t.y+=e.height)}return t},_getTransformOrigin:function(){var e="";var t=l.Placement.properties[this.placement];if(!t)return e;t.isLeft?e="left":t.isRight&&(e="right");t.isTop?e+=" top":t.isBottom&&(e+=" bottom");return e},update:function(e,t){t=l.isPlainObject(e)?e:{location:e,placement:t};this._init({location:t.location||this.location,placement:(void 0!==t.placement?t:this).placement,onDraw:t.onDraw||this.onDraw,checkResize:t.checkResize||this.checkResize,width:(void 0!==t.width?t:this).width,height:(void 0!==t.height?t:this).height,rotationMode:t.rotationMode||this.rotationMode})},getBounds:function(e){l.console.assert(e,"A viewport must now be passed to Overlay.getBounds.");var t=this.width;var i=this.height;if(null===t||null===i){var r=e.deltaPointsFromPixelsNoRotate(this.size,!0);null===t&&(t=r.x);null===i&&(i=r.y)}r=this.location.clone();this.adjust(r,new l.Point(t,i));return this._adjustBoundsForRotation(e,new l.Rect(r.x,r.y,t,i))},_adjustBoundsForRotation:function(e,t){if(!e||0===e.getRotation(!0)||this.rotationMode===l.OverlayRotationMode.EXACT)return t;if(this.rotationMode!==l.OverlayRotationMode.BOUNDING_BOX)return t.rotate(-e.getRotation(!0),this._getPlacementPoint(t));if(null===this.width||null===this.height)return t;t=this._getOverlayPositionAndSize(e);return e.viewerElementToViewportRectangle(new l.Rect(t.position.x,t.position.y,t.size.x,t.size.y))}}}(OpenSeadragon);!function(r){const i=r;i.DrawerBase=class{constructor(e){r.console.assert(e.viewer,"[Drawer] options.viewer is required");r.console.assert(e.viewport,"[Drawer] options.viewport is required");r.console.assert(e.element,"[Drawer] options.element is required");this._id=this.getType()+r.now();this.viewer=e.viewer;this.viewport=e.viewport;this.debugGridColor="string"==typeof e.debugGridColor?[e.debugGridColor]:e.debugGridColor||r.DEFAULT_SETTINGS.debugGridColor;this.options=r.extend({},this.defaultOptions,e.options);this.container=r.getElement(e.element);this._renderingTarget=this._createDrawingElement();this.canvas.style.width="100%";this.canvas.style.height="100%";this.canvas.style.position="absolute";this.canvas.style.left="0";r.setElementOpacity(this.canvas,this.viewer.opacity,!0);r.setElementPointerEventsNone(this.canvas);r.setElementTouchActionNone(this.canvas);this.container.style.textAlign="left";this.container.appendChild(this.canvas);this._checkInterfaceImplementation();this.setInternalCacheNeedsRefresh()}get defaultOptions(){return{usePrivateCache:!1,preloadCache:!0}}get canvas(){return this._renderingTarget}get element(){r.console.error("Drawer.element is deprecated. Use Drawer.container instead.");return this.container}tiledImageCreated(){}getId(){return this._id}getType(){r.console.error("Drawer.getType must be implemented by child class")}getRequiredDataFormats(){return this.getSupportedDataFormats()}getSupportedDataFormats(){throw"Drawer.getSupportedDataFormats must define its supported rendering data types!"}getDataToDraw(e){const t=e.getCache(e.cacheKey);if(t){var i=t.getDataForRendering(this,e);return i&&i.data}r.console.warn("Attempt to draw tile %s when not cached!",e)}static isSupported(){r.console.error("Drawer.isSupported must be implemented by child class")}_createDrawingElement(){r.console.error("Drawer._createDrawingElement must be implemented by child class");return null}draw(e){r.console.error("Drawer.draw must be implemented by child class")}canRotate(){r.console.error("Drawer.canRotate must be implemented by child class")}destroy(){r.console.error("Drawer.destroy must be implemented by child class")}destroyInternalCache(){this.viewer.tileCache.clearDrawerInternalCache(this)}minimumOverlapRequired(e){return!1}setImageSmoothingEnabled(e){r.console.error("Drawer.setImageSmoothingEnabled must be implemented by child class")}drawDebuggingRect(e){r.console.warn("[drawer].drawDebuggingRect is not implemented by this drawer")}clear(){r.console.warn("[drawer].clear() is deprecated. The drawer is responsible for clearing itself as needed before drawing tiles.")}internalCacheCreate(e,t){}internalCacheFree(e){}setInternalCacheNeedsRefresh(){this._dataNeedsRefresh=r.now()}_checkInterfaceImplementation(){if(this._createDrawingElement===r.DrawerBase.prototype._createDrawingElement)throw new Error("[drawer]._createDrawingElement must be implemented by child class");if(this.draw===r.DrawerBase.prototype.draw)throw new Error("[drawer].draw must be implemented by child class");if(this.canRotate===r.DrawerBase.prototype.canRotate)throw new Error("[drawer].canRotate must be implemented by child class");if(this.destroy===r.DrawerBase.prototype.destroy)throw new Error("[drawer].destroy must be implemented by child class");if(this.setImageSmoothingEnabled===r.DrawerBase.prototype.setImageSmoothingEnabled)throw new Error("[drawer].setImageSmoothingEnabled must be implemented by child class")}viewportToDrawerRectangle(e){var t=this.viewport.pixelFromPointNoRotate(e.getTopLeft(),!0);e=this.viewport.deltaPixelsFromPointsNoRotate(e.getSize(),!0);return new r.Rect(t.x*r.pixelDensityRatio,t.y*r.pixelDensityRatio,e.x*r.pixelDensityRatio,e.y*r.pixelDensityRatio)}viewportCoordToDrawerCoord(e){e=this.viewport.pixelFromPointNoRotate(e,!0);return new r.Point(e.x*r.pixelDensityRatio,e.y*r.pixelDensityRatio)}_calculateCanvasSize(){var e=r.pixelDensityRatio;var t=this.viewport.getContainerSize();return new i.Point(Math.round(t.x*e),Math.round(t.y*e))}_raiseTiledImageDrawnEvent(e,t){this.viewer&&this.viewer.raiseEvent("tiled-image-drawn",{tiledImage:e,tiles:t})}_raiseDrawerErrorEvent(e,t){this.viewer&&this.viewer.raiseEvent("drawer-error",{tiledImage:e,drawer:this,error:t})}}}(OpenSeadragon);!function(o){var e=o;class r extends e.DrawerBase{constructor(e){super(e);this.viewer.rejectEventHandler("tile-drawing","The HTMLDrawer does not raise the tile-drawing event");this.viewer.allowEventHandler("tile-drawn");function i(e,t){var i=o.makeNeutralElement("div");const r=t.cloneNode();r.style.msInterpolationMode="nearest-neighbor";r.style.width="100%";r.style.height="100%";const n=i.style;n.position="absolute";return{element:i,imgElement:r,style:n,data:t}}o.convertor.learn("context2d",r.canvasCacheType,(e,t)=>i(0,t.canvas),1,1);o.convertor.learn("image",r.imageCacheType,i,1,1);o.convertor.learn(r.canvasCacheType,"context2d",(e,t)=>t.data.getContext("2d"),1,3);o.convertor.learn(r.imageCacheType,"image",(e,t)=>t.data,1,3);function t(e){e.imgElement&&e.imgElement.parentNode&&e.imgElement.parentNode.removeChild(e.imgElement);e.element&&e.element.parentNode&&e.element.parentNode.removeChild(e.element)}o.convertor.learnDestroy(r.canvasCacheType,t);o.convertor.learnDestroy(r.imageCacheType,t)}static get imageCacheType(){return"htmlDrawer[image]"}static get canvasCacheType(){return"htmlDrawer[canvas]"}static isSupported(){return!0}getType(){return"html"}getSupportedDataFormats(){return[r.imageCacheType,r.canvasCacheType]}minimumOverlapRequired(e){return!0}_createDrawingElement(){return o.makeNeutralElement("div")}draw(e){var t=this;this._prepareNewFrame();e.forEach(function(e){0!==e.opacity&&t._drawTiles(e)})}canRotate(){return!1}destroy(){this.container.removeChild(this.canvas)}setImageSmoothingEnabled(){}_prepareNewFrame(){this.canvas.innerHTML=""}_drawTiles(e){var t=e.getTilesToDraw().map(e=>e.tile);if(0!==e.opacity&&(0!==t.length||e.placeholderFillStyle))for(var i=t.length-1;0<=i;i--){var r=t[i];this._drawTile(r);this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:e,tile:r})}}_drawTile(e){o.console.assert(e,"[Drawer._drawTile] tile is required");let t=this.canvas;if(e.loaded){const i=this.getDataToDraw(e);if(i){i.element.parentNode!==t&&t.appendChild(i.element);i.imgElement.parentNode!==i.element&&i.element.appendChild(i.imgElement);i.style.top=e.position.y+"px";i.style.left=e.position.x+"px";i.style.height=e.size.y+"px";i.style.width=e.size.x+"px";e.flipped&&(i.style.transform="scaleX(-1)");o.setElementOpacity(i.element,e.opacity)}}else o.console.warn("Attempting to draw tile %s when it's not yet loaded.",e.toString())}}o.HTMLDrawer=r}(OpenSeadragon);!function(d){var e=d;class t extends e.DrawerBase{constructor(e){super(e);this.context=this.canvas.getContext("2d");this.sketchCanvas=null;this.sketchContext=null;this._imageSmoothingEnabled=!0;this.viewer.allowEventHandler("tile-drawn");this.viewer.allowEventHandler("tile-drawing")}static isSupported(){return d.supportsCanvas}getType(){return"canvas"}getSupportedDataFormats(){return["context2d"]}_createDrawingElement(){let e=d.makeNeutralElement("canvas");var t=this._calculateCanvasSize();e.width=t.x;e.height=t.y;return e}draw(e){this._prepareNewFrame();this.viewer.viewport.getFlip()!==this._viewportFlipped&&this._flip();for(const t of e)0!==t.opacity&&this._drawTiles(t)}canRotate(){return!0}destroy(){this.canvas.width=1;this.canvas.height=1;this.sketchCanvas=null;this.sketchContext=null;this.container.removeChild(this.canvas)}minimumOverlapRequired(e){return!0}setImageSmoothingEnabled(e){this._imageSmoothingEnabled=!!e;this._updateImageSmoothingEnabled(this.context);this.viewer.forceRedraw()}drawDebuggingRect(e){var t=this.context;t.save();t.lineWidth=2*d.pixelDensityRatio;t.strokeStyle=this.debugGridColor[0];t.fillStyle=this.debugGridColor[0];t.strokeRect(e.x*d.pixelDensityRatio,e.y*d.pixelDensityRatio,e.width*d.pixelDensityRatio,e.height*d.pixelDensityRatio);t.restore()}get _viewportFlipped(){return this.context.getTransform().a<0}_raiseTileDrawingEvent(e,t,i,r){this.viewer.raiseEvent("tile-drawing",{tiledImage:e,context:t,tile:i,rendered:r})}_prepareNewFrame(){var e=this._calculateCanvasSize();if(this.canvas.width!==e.x||this.canvas.height!==e.y){this.canvas.width=e.x;this.canvas.height=e.y;this._updateImageSmoothingEnabled(this.context);if(null!==this.sketchCanvas){e=this._calculateSketchCanvasSize();this.sketchCanvas.width=e.x;this.sketchCanvas.height=e.y;this._updateImageSmoothingEnabled(this.sketchContext)}}this._clear()}_clear(e,t){e=this._getContext(e);if(t)e.clearRect(t.x,t.y,t.width,t.height);else{t=e.canvas;e.clearRect(0,0,t.width,t.height)}}_drawTiles(a){var l=a.getTilesToDraw().map(e=>e.tile);if(0!==a.opacity&&(0!==l.length||a.placeholderFillStyle)){let t=l[0];let i;t&&(i=a.opacity<1||a.compositeOperation&&"source-over"!==a.compositeOperation||!a._isBottomItem()&&a.source.hasTransparency(null,t.getUrl(),t.ajaxHeaders,t.postData));let r;let n;var h=this.viewport.getZoom(!0);h=a.viewportToImageZoom(h);if(1<l.length&&h>a.smoothTileEdgesMinZoom&&!a.iOSDevice&&a.getRotation(!0)%360==0){i=!0;h=t.length&&this.getDataToDraw(t);r=h?h.canvas.width/(t.size.x*d.pixelDensityRatio):1;n=t.getTranslationForEdgeSmoothing(r,this._getCanvasSize(!1),this._getCanvasSize(!0))}let e;if(i){if(!r){e=this.viewport.viewportToViewerElementRectangle(a.getClippedBounds(!0)).getIntegerBoundingBox();e=e.times(d.pixelDensityRatio)}this._clear(!0,e)}r||this._setRotations(a,i);let o=!1;if(a._clip){this._saveContext(i);let e=a.imageToViewportRectangle(a._clip,!0);e=e.rotate(-a.getRotation(!0),a._getRotationPoint(!0));let t=this.viewportToDrawerRectangle(e);r&&(t=t.times(r));n&&(t=t.translate(n));this._setClip(t,i);o=!0}if(a._croppingPolygons){const u=this;o||this._saveContext(i);try{var c=a._croppingPolygons.map(function(e){return e.map(function(e){e=a.imageToViewportCoordinates(e.x,e.y,!0).rotate(-a.getRotation(!0),a._getRotationPoint(!0));let t=u.viewportCoordToDrawerCoord(e);r&&(t=t.times(r));n&&(t=t.plus(n));return t})});this._clipWithPolygons(c,i)}catch(e){d.console.error(e)}o=!0}a._hasOpaqueTile=!1;if(a.placeholderFillStyle&&!1===a._hasOpaqueTile){let e=this.viewportToDrawerRectangle(a.getBoundsNoRotate(!0));r&&(e=e.times(r));n&&(e=e.translate(n));let t=null;t="function"==typeof a.placeholderFillStyle?a.placeholderFillStyle(a,this.context):a.placeholderFillStyle;this._drawRectangle(e,t,i)}c=function(e){if("number"==typeof e)return m(e);if(!e||!d.Browser)return p;var t=e[d.Browser.vendor];g(t)&&(t=e["*"]);return m(t)}(a.subPixelRoundingForTransparency);let s=!1;c===d.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS?s=!0:c===d.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&(s=!(this.viewer&&this.viewer.isAnimating()));for(let e=0;e<l.length;e++){t=l[e];this._drawTile(t,a,i,r,n,s,a.source);this.viewer&&this.viewer.raiseEvent("tile-drawn",{tiledImage:a,tile:t})}o&&this._restoreContext(i);if(!r){a.getRotation(!0)%360!=0&&this._restoreRotationChanges(i);this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges(i)}if(i){r&&this._setRotations(a);this.blendSketch({opacity:a.opacity,scale:r,translate:n,compositeOperation:a.compositeOperation,bounds:e});if(r){a.getRotation(!0)%360!=0&&this._restoreRotationChanges(!1);this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges(!1)}}this._drawDebugInfo(a,l);this._raiseTiledImageDrawnEvent(a,l)}}_drawDebugInfo(e,t){if(e.debugMode)for(var i=t.length-1;0<=i;i--){var r=t[i];try{this._drawDebugInfoOnTile(r,t.length,i,e)}catch(e){d.console.error(e)}}}_clipWithPolygons(e,t){var i=this._getContext(t);i.beginPath();for(const o of e)for(var[r,n]of o.entries())i[0===r?"moveTo":"lineTo"](n.x,n.y);i.clip()}_drawTile(n,o,s,a,l,h,e){d.console.assert(n,"[Drawer._drawTile] tile is required");d.console.assert(o,"[Drawer._drawTile] drawingHandler is required");if(n.loaded){var c=this.getDataToDraw(n);if(c){const u=this._getContext(s);a=a||1;let e=n.position.times(d.pixelDensityRatio),t=n.size.times(d.pixelDensityRatio);u.save();if("number"==typeof a&&1!==a){e=e.times(a);t=t.times(a)}l instanceof d.Point&&(e=e.plus(l));if(1===u.globalAlpha&&n.hasTransparency){if(h){e.x=Math.round(e.x);e.y=Math.round(e.y);t.x=Math.round(t.x);t.y=Math.round(t.y)}u.clearRect(e.x,e.y,t.x,t.y)}this._raiseTileDrawingEvent(o,u,n,c);let i,r;if(n.sourceBounds){i=Math.min(n.sourceBounds.width,c.canvas.width);r=Math.min(n.sourceBounds.height,c.canvas.height)}else{i=c.canvas.width;r=c.canvas.height}u.translate(e.x+t.x/2,0);n.flipped&&u.scale(-1,1);u.drawImage(c.canvas,0,0,i,r,-t.x/2,e.y,t.x,t.y);u.restore()}}else d.console.warn("Attempting to draw tile %s when it's not yet loaded.",n.toString())}_getContext(e){var t=this.context;if(e){if(null===this.sketchCanvas){this.sketchCanvas=document.createElement("canvas");e=this._calculateSketchCanvasSize();this.sketchCanvas.width=e.x;this.sketchCanvas.height=e.y;this.sketchContext=this.sketchCanvas.getContext("2d");if(0===this.viewport.getRotation()){var i=this;this.viewer.addHandler("rotate",function e(){if(0!==i.viewport.getRotation()){i.viewer.removeHandler("rotate",e);var t=i._calculateSketchCanvasSize();i.sketchCanvas.width=t.x;i.sketchCanvas.height=t.y}})}this._updateImageSmoothingEnabled(this.sketchContext)}t=this.sketchContext}return t}_saveContext(e){this._getContext(e).save()}_restoreContext(e){this._getContext(e).restore()}_setClip(e,t){t=this._getContext(t);t.beginPath();t.rect(e.x,e.y,e.width,e.height);t.clip()}_drawRectangle(e,t,i){i=this._getContext(i);i.save();i.fillStyle=t;i.fillRect(e.x,e.y,e.width,e.height);i.restore()}blendSketch(e,t,i,r){var n=e;e=(n=!d.isPlainObject(n)?{opacity:e,scale:t,translate:i,compositeOperation:r}:n).opacity;r=n.compositeOperation;var o=n.bounds;this.context.save();this.context.globalAlpha=e;r&&(this.context.globalCompositeOperation=r);if(o){if(o.x<0){o.width+=o.x;o.x=0}o.x+o.width>this.canvas.width&&(o.width=this.canvas.width-o.x);if(o.y<0){o.height+=o.y;o.y=0}o.y+o.height>this.canvas.height&&(o.height=this.canvas.height-o.y);this.context.drawImage(this.sketchCanvas,o.x,o.y,o.width,o.height,o.x,o.y,o.width,o.height)}else{t=n.scale||1;e=(i=n.translate)instanceof d.Point?i:new d.Point(0,0);r=0;o=0;if(i){n=this.sketchCanvas.width-this.canvas.width;i=this.sketchCanvas.height-this.canvas.height;r=Math.round(n/2);o=Math.round(i/2)}this.context.drawImage(this.sketchCanvas,e.x-r*t,e.y-o*t,(this.canvas.width+2*r)*t,(this.canvas.height+2*o)*t,-r,-o,this.canvas.width+2*r,this.canvas.height+2*o)}this.context.restore()}_drawDebugInfoOnTile(e,t,i,r){var n=this.viewer.world.getIndexOfItem(r)%this.debugGridColor.length;var o=this.context;o.save();o.lineWidth=2*d.pixelDensityRatio;o.font="small-caps bold "+13*d.pixelDensityRatio+"px arial";o.strokeStyle=this.debugGridColor[n];o.fillStyle=this.debugGridColor[n];this._setRotations(r);this._viewportFlipped&&this._flip({point:e.position.plus(e.size.divide(2))});o.strokeRect(e.position.x*d.pixelDensityRatio,e.position.y*d.pixelDensityRatio,e.size.x*d.pixelDensityRatio,e.size.y*d.pixelDensityRatio);var s=(e.position.x+e.size.x/2)*d.pixelDensityRatio;var a=(e.position.y+e.size.y/2)*d.pixelDensityRatio;o.translate(s,a);n=this.viewport.getRotation(!0);o.rotate(Math.PI/180*-n);o.translate(-s,-a);if(0===e.x&&0===e.y){o.fillText("Zoom: "+this.viewport.getZoom(),e.position.x*d.pixelDensityRatio,(e.position.y-30)*d.pixelDensityRatio);o.fillText("Pan: "+this.viewport.getBounds().toString(),e.position.x*d.pixelDensityRatio,(e.position.y-20)*d.pixelDensityRatio)}o.fillText("Level: "+e.level,(e.position.x+10)*d.pixelDensityRatio,(e.position.y+20)*d.pixelDensityRatio);o.fillText("Column: "+e.x,(e.position.x+10)*d.pixelDensityRatio,(e.position.y+30)*d.pixelDensityRatio);o.fillText("Row: "+e.y,(e.position.x+10)*d.pixelDensityRatio,(e.position.y+40)*d.pixelDensityRatio);o.fillText("Order: "+i+" of "+t,(e.position.x+10)*d.pixelDensityRatio,(e.position.y+50)*d.pixelDensityRatio);o.fillText("Size: "+e.size.toString(),(e.position.x+10)*d.pixelDensityRatio,(e.position.y+60)*d.pixelDensityRatio);o.fillText("Position: "+e.position.toString(),(e.position.x+10)*d.pixelDensityRatio,(e.position.y+70)*d.pixelDensityRatio);this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges();r.getRotation(!0)%360!=0&&this._restoreRotationChanges();o.restore()}_updateImageSmoothingEnabled(e){e.msImageSmoothingEnabled=this._imageSmoothingEnabled;e.imageSmoothingEnabled=this._imageSmoothingEnabled}_getCanvasSize(e){e=this._getContext(e).canvas;return new d.Point(e.width,e.height)}_getCanvasCenter(){return new d.Point(this.canvas.width/2,this.canvas.height/2)}_setRotations(e,t=!1){var i=!1;if(this.viewport.getRotation(!0)%360!=0){this._offsetForRotation({degrees:this.viewport.getRotation(!0),useSketch:t,saveContext:i});i=!1}e.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:e.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0),useSketch:t,saveContext:i})}_offsetForRotation(e){var t=e.point?e.point.times(d.pixelDensityRatio):this._getCanvasCenter();var i=this._getContext(e.useSketch);i.save();i.translate(t.x,t.y);i.rotate(Math.PI/180*e.degrees);i.translate(-t.x,-t.y)}_flip(e){var t=(e=e||{}).point?e.point.times(d.pixelDensityRatio):this._getCanvasCenter();e=this._getContext(e.useSketch);e.translate(t.x,0);e.scale(-1,1);e.translate(-t.x,0)}_restoreRotationChanges(e){this._getContext(e).restore()}_calculateCanvasSize(){var e=d.pixelDensityRatio;var t=this.viewport.getContainerSize();return{x:Math.round(t.x*e),y:Math.round(t.y*e)}}_calculateSketchCanvasSize(){var e=this._calculateCanvasSize();if(0===this.viewport.getRotation())return e;e=Math.ceil(Math.sqrt(e.x*e.x+e.y*e.y));return{x:e,y:e}}}d.CanvasDrawer=t;var p=d.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER;function g(e){return e!==d.SUBPIXEL_ROUNDING_OCCURRENCES.ALWAYS&&e!==d.SUBPIXEL_ROUNDING_OCCURRENCES.ONLY_AT_REST&&e!==d.SUBPIXEL_ROUNDING_OCCURRENCES.NEVER}function m(e){return g(e)?p:e}}(OpenSeadragon);!function(w){const a=w;a.WebGLDrawer=class extends a.DrawerBase{constructor(e){super(e);this._destroyed=!1;this._gl=null;this._firstPass=null;this._secondPass=null;this._glFrameBuffer=null;this._renderToTexture=null;this._outputCanvas=null;this._outputContext=null;this._clippingCanvas=null;this._clippingContext=null;this._renderingCanvas=null;this._backupCanvasDrawer=null;this._imageSmoothingEnabled=!0;this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event");this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event");this._setupCanvases();this._setupRenderer();this._supportedFormats=["context2d","image"];this.context=this._outputContext}get defaultOptions(){return{usePrivateCache:!0,preloadCache:!1}}getSupportedDataFormats(){return this._supportedFormats}destroy(){if(!this._destroyed){let t=this._gl;var i=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<i;++e){t.activeTexture(t.TEXTURE0+e);t.bindTexture(t.TEXTURE_2D,null);t.bindTexture(t.TEXTURE_CUBE_MAP,null)}t.bindBuffer(t.ARRAY_BUFFER,null);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);t.bindRenderbuffer(t.RENDERBUFFER,null);t.bindFramebuffer(t.FRAMEBUFFER,null);t.deleteBuffer(this._secondPass.bufferOutputPosition);t.deleteFramebuffer(this._glFrameBuffer);this._renderingCanvas.width=this._renderingCanvas.height=1;this._clippingCanvas.width=this._clippingCanvas.height=1;this._outputCanvas.width=this._outputCanvas.height=1;this._renderingCanvas=null;this._clippingCanvas=this._clippingContext=null;this._outputCanvas=this._outputContext=null;let e=t.getExtension("WEBGL_lose_context");e&&e.loseContext();this._gl=null;if(this._backupCanvasDrawer){this._backupCanvasDrawer.destroy();this._backupCanvasDrawer=null}this.container.removeChild(this.canvas);this.viewer.drawer===this&&(this.viewer.drawer=null);this.destroyInternalCache();this._destroyed=!0}}canRotate(){return!0}static isSupported(){let e=document.createElement("canvas");let t=w.isFunction(e.getContext)&&e.getContext("webgl");let i=t&&t.getExtension("WEBGL_lose_context");i&&i.loseContext();return!!t}getType(){return"webgl"}minimumOverlapRequired(e){return e.isTainted()}_createDrawingElement(){let e=w.makeNeutralElement("canvas");var t=this._calculateCanvasSize();e.width=t.x;e.height=t.y;return e}_getBackupCanvasDrawer(){if(!this._backupCanvasDrawer){this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1});this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden");this._backupCanvasDrawer.getSupportedDataFormats=()=>this._supportedFormats;this._backupCanvasDrawer.getDataToDraw=this.getDataToDraw.bind(this)}return this._backupCanvasDrawer}draw(e){let v=this._gl;var t=this.viewport.getBoundsNoRotateWithMargins(!0);let i=t,r=new a.Point(t.x+t.width/2,t.y+t.height/2),n=this.viewport.getRotation(!0)*Math.PI/180;var o=this.viewport.flipped?-1:1;t=w.Mat3.makeTranslation(-r.x,-r.y);let s=w.Mat3.makeScaling(2/i.width*o,-2/i.height);o=w.Mat3.makeRotation(-n);let y=s.multiply(o).multiply(t);v.bindFramebuffer(v.FRAMEBUFFER,null);v.clear(v.COLOR_BUFFER_BIT);this._outputContext.clearRect(0,0,this._outputCanvas.width,this._outputCanvas.height);let _=!1;e.forEach((n,e)=>{if(n.isTainted()){if(_){this._outputContext.drawImage(this._renderingCanvas,0,0);v.bindFramebuffer(v.FRAMEBUFFER,null);v.clear(v.COLOR_BUFFER_BIT);_=!1}const t=this._getBackupCanvasDrawer();t.draw([n]);this._outputContext.drawImage(t.canvas,0,0)}else{let r=n.getTilesToDraw();n.placeholderFillStyle&&!1===n._hasOpaqueTile&&this._drawPlaceholder(n);if(0!==r.length&&0!==n.getOpacity()){var o=r[0];var s=n.compositeOperation||this.viewer.compositeOperation||n._clip||n._croppingPolygons||n.debugMode;var a=s||n.opacity<1||o.tile.hasTransparency;if(s){_&&this._outputContext.drawImage(this._renderingCanvas,0,0);v.bindFramebuffer(v.FRAMEBUFFER,null);v.clear(v.COLOR_BUFFER_BIT)}v.useProgram(this._firstPass.shaderProgram);if(a){v.bindFramebuffer(v.FRAMEBUFFER,this._glFrameBuffer);v.clear(v.COLOR_BUFFER_BIT)}else v.bindFramebuffer(v.FRAMEBUFFER,null);let t=y;var l=n.getRotation(!0);if(l%360!=0){o=w.Mat3.makeRotation(-l*Math.PI/180);l=n.getBoundsNoRotate(!0).getCenter();let e=w.Mat3.makeTranslation(l.x,l.y);l=w.Mat3.makeTranslation(-l.x,-l.y);l=e.multiply(o).multiply(l);t=y.multiply(l)}var h=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);if(h<=0)throw new Error(`WegGL error: bad value for gl parameter MAX_TEXTURE_IMAGE_UNITS (${h}). This could happen
                        if too many contexts have been created and not released, or there is another problem with the graphics card.`);var c=new Float32Array(12*h);var u=new Array(h);let i=new Array(h);var d=new Array(h);for(let e=0;e<r.length;e++){var p=r[e].tile;var g=e%h;var m=1+g;var f=this.getDataToDraw(p);f&&f.texture&&this._getTileData(p,n,f,t,g,c,u,i,d);if(m===h||e===r.length-1){for(let e=0;e<=m;e++){v.activeTexture(v.TEXTURE0+e);v.bindTexture(v.TEXTURE_2D,u[e])}v.bindBuffer(v.ARRAY_BUFFER,this._firstPass.bufferTexturePosition);v.bufferData(v.ARRAY_BUFFER,c,v.DYNAMIC_DRAW);i.forEach((e,t)=>{v.uniformMatrix3fv(this._firstPass.uTransformMatrices[t],!1,e)});v.uniform1fv(this._firstPass.uOpacities,new Float32Array(d));v.bindBuffer(v.ARRAY_BUFFER,this._firstPass.bufferOutputPosition);v.vertexAttribPointer(this._firstPass.aOutputPosition,2,v.FLOAT,!1,0,0);v.bindBuffer(v.ARRAY_BUFFER,this._firstPass.bufferTexturePosition);v.vertexAttribPointer(this._firstPass.aTexturePosition,2,v.FLOAT,!1,0,0);v.bindBuffer(v.ARRAY_BUFFER,this._firstPass.bufferIndex);v.vertexAttribPointer(this._firstPass.aIndex,1,v.FLOAT,!1,0,0);v.drawArrays(v.TRIANGLES,0,6*m)}}if(a){v.useProgram(this._secondPass.shaderProgram);v.bindFramebuffer(v.FRAMEBUFFER,null);v.activeTexture(v.TEXTURE0);v.bindTexture(v.TEXTURE_2D,this._renderToTexture);this._gl.uniform1f(this._secondPass.uOpacityMultiplier,n.opacity);v.bindBuffer(v.ARRAY_BUFFER,this._secondPass.bufferTexturePosition);v.vertexAttribPointer(this._secondPass.aTexturePosition,2,v.FLOAT,!1,0,0);v.bindBuffer(v.ARRAY_BUFFER,this._secondPass.bufferOutputPosition);v.vertexAttribPointer(this._secondPass.aOutputPosition,2,v.FLOAT,!1,0,0);v.drawArrays(v.TRIANGLES,0,6)}_=!0;if(s){this._applyContext2dPipeline(n,r,e);_=!1;v.bindFramebuffer(v.FRAMEBUFFER,null);v.clear(v.COLOR_BUFFER_BIT)}0===e&&this._raiseTiledImageDrawnEvent(n,r.map(e=>e.tile))}}});_&&this._outputContext.drawImage(this._renderingCanvas,0,0)}setImageSmoothingEnabled(e){if(this._imageSmoothingEnabled!==e){this._imageSmoothingEnabled=e;this.setInternalCacheNeedsRefresh();this.viewer.forceRedraw()}}drawDebuggingRect(e){let t=this._outputContext;t.save();t.lineWidth=2*w.pixelDensityRatio;t.strokeStyle=this.debugGridColor[0];t.fillStyle=this.debugGridColor[0];t.strokeRect(e.x*w.pixelDensityRatio,e.y*w.pixelDensityRatio,e.width*w.pixelDensityRatio,e.height*w.pixelDensityRatio);t.restore()}_getTextureDataFromTile(e){return e.getCanvasContext().canvas}_applyContext2dPipeline(e,t,i){this._outputContext.save();this._outputContext.globalCompositeOperation=0===i?null:e.compositeOperation||this.viewer.compositeOperation;if(e._croppingPolygons||e._clip){this._renderToClippingCanvas(e);this._outputContext.drawImage(this._clippingCanvas,0,0)}else this._outputContext.drawImage(this._renderingCanvas,0,0);this._outputContext.restore();if(e.debugMode){i=this.viewer.viewport.getFlip();i&&this._flip();this._drawDebugInfo(t,e,i);i&&this._flip()}}_getTileData(e,t,i,r,n,o,s,a,l){var h=i.texture;var c=i.position;o.set(c,12*n);i=this._calculateOverlapFraction(e,t);o=e.positionedBounds.width*i.x;c=e.positionedBounds.height*i.y;t=e.positionedBounds.x+(0===e.x?0:o);i=e.positionedBounds.y+(0===e.y?0:c);o=e.positionedBounds.x+e.positionedBounds.width-(e.isRightMost?0:o);c=e.positionedBounds.y+e.positionedBounds.height-(e.isBottomMost?0:c);let u=new w.Mat3([o-t,0,0,0,c-i,0,t,i,1]);if(e.flipped){let e=w.Mat3.makeTranslation(.5,0);i=w.Mat3.makeTranslation(-.5,0);i=e.multiply(w.Mat3.makeScaling(-1,1)).multiply(i);u=u.multiply(i)}r=r.multiply(u);l[n]=e.opacity;s[n]=h;a[n]=r.values}_textureFilter(){return this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST}_setupRenderer(){let e=this._gl;e||w.console.error("_setupCanvases must be called before _setupRenderer");this._unitQuad=this._makeQuadVertexBuffer(0,1,0,1);this._makeFirstPassShaderProgram();this._makeSecondPassShaderProgram();this._renderToTexture=e.createTexture();e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this._renderToTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this._renderingCanvas.width,this._renderingCanvas.height,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._textureFilter());e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);this._glFrameBuffer=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,this._glFrameBuffer);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._renderToTexture,0);e.enable(e.BLEND);e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)}_makeFirstPassShaderProgram(){let t=this._glNumTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);var e=`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;
            attribute float a_index;

            ${[...Array(t).keys()].map(e=>`uniform mat3 u_matrix_${e};`).join("\n")} // create a uniform mat3 for each potential tile to draw

            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {

                mat3 transform_matrix; // value will be set by the if/elses in makeConditional()

                ${[...Array(t).keys()].map(e=>`${0<e?"else ":""}if(int(a_index) == ${e}) { transform_matrix = u_matrix_${e}; }`).join("\n")}

                gl_Position = vec4(transform_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
                v_image_index = a_index;
            }
            `;var i=`
            precision mediump float;

            // our textures
            uniform sampler2D u_images[${t}];
            // our opacities
            uniform float u_opacities[${t}];

            // the varyings passed in from the vertex shader.
            varying vec2 v_texture_position;
            varying float v_image_index;

            void main() {
                // can't index directly with a variable, need to use a loop iterator hack
                for(int i = 0; i < ${t}; ++i){
                    if(i == int(v_image_index)){
                        gl_FragColor = texture2D(u_images[i], v_texture_position) * u_opacities[i];
                    }
                }
            }
            `;let r=this._gl;let n=this.constructor.initShaderProgram(r,e,i);r.useProgram(n);this._firstPass={shaderProgram:n,aOutputPosition:r.getAttribLocation(n,"a_output_position"),aTexturePosition:r.getAttribLocation(n,"a_texture_position"),aIndex:r.getAttribLocation(n,"a_index"),uTransformMatrices:[...Array(this._glNumTextures).keys()].map(e=>r.getUniformLocation(n,"u_matrix_"+e)),uImages:r.getUniformLocation(n,"u_images"),uOpacities:r.getUniformLocation(n,"u_opacities"),bufferOutputPosition:r.createBuffer(),bufferTexturePosition:r.createBuffer(),bufferIndex:r.createBuffer()};r.uniform1iv(this._firstPass.uImages,[...Array(t).keys()]);let o=new Float32Array(12*t);for(let e=0;e<t;++e)o.set(Float32Array.from(this._unitQuad),12*e);r.bindBuffer(r.ARRAY_BUFFER,this._firstPass.bufferOutputPosition);r.bufferData(r.ARRAY_BUFFER,o,r.STATIC_DRAW);r.enableVertexAttribArray(this._firstPass.aOutputPosition);r.bindBuffer(r.ARRAY_BUFFER,this._firstPass.bufferTexturePosition);r.enableVertexAttribArray(this._firstPass.aTexturePosition);r.bindBuffer(r.ARRAY_BUFFER,this._firstPass.bufferIndex);i=[...Array(this._glNumTextures).keys()].map(e=>Array(6).fill(e)).flat();r.bufferData(r.ARRAY_BUFFER,new Float32Array(i),r.STATIC_DRAW);r.enableVertexAttribArray(this._firstPass.aIndex)}_makeSecondPassShaderProgram(){let e=this._gl;var t=this.constructor.initShaderProgram(e,`
            attribute vec2 a_output_position;
            attribute vec2 a_texture_position;

            uniform mat3 u_matrix;

            varying vec2 v_texture_position;

            void main() {
                gl_Position = vec4(u_matrix * vec3(a_output_position, 1), 1);

                v_texture_position = a_texture_position;
            }
            `,`
            precision mediump float;

            // our texture
            uniform sampler2D u_image;

            // the texCoords passed in from the vertex shader.
            varying vec2 v_texture_position;

            // the opacity multiplier for the image
            uniform float u_opacity_multiplier;

            void main() {
                gl_FragColor = texture2D(u_image, v_texture_position);
                gl_FragColor *= u_opacity_multiplier;
            }
            `);e.useProgram(t);this._secondPass={shaderProgram:t,aOutputPosition:e.getAttribLocation(t,"a_output_position"),aTexturePosition:e.getAttribLocation(t,"a_texture_position"),uMatrix:e.getUniformLocation(t,"u_matrix"),uImage:e.getUniformLocation(t,"u_image"),uOpacityMultiplier:e.getUniformLocation(t,"u_opacity_multiplier"),bufferOutputPosition:e.createBuffer(),bufferTexturePosition:e.createBuffer()};e.bindBuffer(e.ARRAY_BUFFER,this._secondPass.bufferOutputPosition);e.bufferData(e.ARRAY_BUFFER,this._unitQuad,e.STATIC_DRAW);e.enableVertexAttribArray(this._secondPass.aOutputPosition);e.bindBuffer(e.ARRAY_BUFFER,this._secondPass.bufferTexturePosition);e.bufferData(e.ARRAY_BUFFER,this._unitQuad,e.DYNAMIC_DRAW);e.enableVertexAttribArray(this._secondPass.aTexturePosition);t=w.Mat3.makeScaling(2,2).multiply(w.Mat3.makeTranslation(-.5,-.5));e.uniformMatrix3fv(this._secondPass.uMatrix,!1,t.values)}_resizeRenderer(){let e=this._gl;var t=this._renderingCanvas.width;var i=this._renderingCanvas.height;e.viewport(0,0,t,i);e.deleteTexture(this._renderToTexture);this._renderToTexture=e.createTexture();e.activeTexture(e.TEXTURE0);e.bindTexture(e.TEXTURE_2D,this._renderToTexture);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this._textureFilter());e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.bindFramebuffer(e.FRAMEBUFFER,this._glFrameBuffer);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._renderToTexture,0)}_setupCanvases(){let t=this;this._outputCanvas=this.canvas;this._outputContext=this._outputCanvas.getContext("2d");this._renderingCanvas=document.createElement("canvas");this._clippingCanvas=document.createElement("canvas");this._clippingContext=this._clippingCanvas.getContext("2d");this._renderingCanvas.width=this._clippingCanvas.width=this._outputCanvas.width;this._renderingCanvas.height=this._clippingCanvas.height=this._outputCanvas.height;this._gl=this._renderingCanvas.getContext("webgl");this._resizeHandler=function(){if(t._outputCanvas!==t.viewer.drawer.canvas){t._outputCanvas.style.width=t.viewer.drawer.canvas.clientWidth+"px";t._outputCanvas.style.height=t.viewer.drawer.canvas.clientHeight+"px"}var e=t._calculateCanvasSize();if(t._outputCanvas.width!==e.x||t._outputCanvas.height!==e.y){t._outputCanvas.width=e.x;t._outputCanvas.height=e.y}t._renderingCanvas.style.width=t._outputCanvas.clientWidth+"px";t._renderingCanvas.style.height=t._outputCanvas.clientHeight+"px";t._renderingCanvas.width=t._clippingCanvas.width=t._outputCanvas.width;t._renderingCanvas.height=t._clippingCanvas.height=t._outputCanvas.height;t._resizeRenderer()};this.viewer.addHandler("resize",this._resizeHandler)}internalCacheCreate(i,r){let n=r.tiledImage;let o=this._gl;var s;let a;let l=i.data;if(!n.isTainted())if(l instanceof CanvasRenderingContext2D&&w.isCanvasTainted(l.canvas)){n.setTainted(!0);w.console.warn("WebGL cannot be used to draw this TiledImage because it has tainted data. Does crossOriginPolicy need to be set?");this._raiseDrawerErrorEvent(n,"Tainted data cannot be used by the WebGLDrawer. Falling back to CanvasDrawer for this TiledImage.");this.setInternalCacheNeedsRefresh()}else{let e,t;if(r.sourceBounds){e=Math.min(r.sourceBounds.width,l.width)/l.width;t=Math.min(r.sourceBounds.height,l.height)/l.height}else{e=1;t=1}s=o.createTexture();if(0<n.source.tileOverlap){var h=this._calculateOverlapFraction(r,n);var c=(0===r.x?0:h.x)*e;var u=(0===r.y?0:h.y)*t;i=(r.isRightMost?1:1-h.x)*e;h=(r.isBottomMost?1:1-h.y)*t;a=this._makeQuadVertexBuffer(c,i,u,h)}else a=1===e&&1===t?this._unitQuad:this._makeQuadVertexBuffer(0,e,0,t);o.activeTexture(o.TEXTURE0);o.bindTexture(o.TEXTURE_2D,s);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,this._textureFilter());o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,this._textureFilter());try{o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,l);return{texture:s,position:a}}catch(e){n.setTainted(!0);w.console.error("Error uploading image data to WebGL. Falling back to canvas renderer.",e);this._raiseDrawerErrorEvent(n,"Unknown error when uploading texture. Falling back to CanvasDrawer for this TiledImage.");this.setInternalCacheNeedsRefresh()}}if(l instanceof Image){const e=document.createElement("canvas");e.width=l.width;e.height=l.height;const t=e.getContext("2d",{willReadFrequently:!0});t.drawImage(l,0,0);l=t}if(l instanceof CanvasRenderingContext2D)return l;w.console.error("Unsupported data used for WebGL Drawer - probably a bug!");return{}}internalCacheFree(e){if(e&&e.texture){this._gl.deleteTexture(e.texture);e.texture=null}}_makeQuadVertexBuffer(e,t,i,r){return new Float32Array([e,r,t,r,e,i,e,i,t,r,t,i])}_calculateOverlapFraction(e,t){var i=t.source.tileOverlap;var r=e.sourceBounds.width;t=e.sourceBounds.height;return{x:i/(r+((0===e.x?0:i)+(e.isRightMost?0:i))),y:i/(t+((0===e.y?0:i)+(e.isBottomMost?0:i)))}}_setClip(){}_renderToClippingCanvas(t){this._clippingContext.clearRect(0,0,this._clippingCanvas.width,this._clippingCanvas.height);this._clippingContext.save();if(this.viewer.viewport.getFlip()){var e=new w.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(e.x,0);this._clippingContext.scale(-1,1);this._clippingContext.translate(-e.x,0)}if(t._clip){const i=[{x:t._clip.x,y:t._clip.y},{x:t._clip.x+t._clip.width,y:t._clip.y},{x:t._clip.x+t._clip.width,y:t._clip.y+t._clip.height},{x:t._clip.x,y:t._clip.y+t._clip.height}];let e=i.map(e=>{e=t.imageToViewportCoordinates(e.x,e.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(e)});this._clippingContext.beginPath();e.forEach((e,t)=>{this._clippingContext[0===t?"moveTo":"lineTo"](e.x,e.y)});this._clippingContext.clip();this._setClip()}if(t._croppingPolygons){let e=t._croppingPolygons.map(e=>e.map(e=>{e=t.imageToViewportCoordinates(e.x,e.y,!0).rotate(this.viewer.viewport.getRotation(!0),this.viewer.viewport.getCenter(!0));return this.viewportCoordToDrawerCoord(e)}));this._clippingContext.beginPath();e.forEach(e=>{e.forEach((e,t)=>{this._clippingContext[0===t?"moveTo":"lineTo"](e.x,e.y)})});this._clippingContext.clip()}if(this.viewer.viewport.getFlip()){e=new w.Point(this.canvas.width/2,this.canvas.height/2);this._clippingContext.translate(e.x,0);this._clippingContext.scale(-1,1);this._clippingContext.translate(-e.x,0)}this._clippingContext.drawImage(this._renderingCanvas,0,0);this._clippingContext.restore()}_setRotations(e){var t=!1;if(this.viewport.getRotation(!0)%360!=0){this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:t});t=!1}e.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:e.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0),saveContext:t})}_offsetForRotation(e){var t=e.point?e.point.times(w.pixelDensityRatio):this._getCanvasCenter();var i=this._outputContext;i.save();i.translate(t.x,t.y);i.rotate(Math.PI/180*e.degrees);i.translate(-t.x,-t.y)}_flip(e){var t=(e=e||{}).point?e.point.times(w.pixelDensityRatio):this._getCanvasCenter();e=this._outputContext;e.translate(t.x,0);e.scale(-1,1);e.translate(-t.x,0)}_drawDebugInfo(e,t,i){for(var r=e.length-1;0<=r;r--){var n=e[r].tile;try{this._drawDebugInfoOnTile(n,e.length,r,t,i)}catch(e){w.console.error(e)}}}_drawDebugInfoOnTile(e,t,i,r,n){var o=this.viewer.world.getIndexOfItem(r)%this.debugGridColor.length;var s=this.context;s.save();s.lineWidth=2*w.pixelDensityRatio;s.font="small-caps bold "+13*w.pixelDensityRatio+"px arial";s.strokeStyle=this.debugGridColor[o];s.fillStyle=this.debugGridColor[o];this._setRotations(r);n&&this._flip({point:e.position.plus(e.size.divide(2))});s.strokeRect(e.position.x*w.pixelDensityRatio,e.position.y*w.pixelDensityRatio,e.size.x*w.pixelDensityRatio,e.size.y*w.pixelDensityRatio);var a=(e.position.x+e.size.x/2)*w.pixelDensityRatio;o=(e.position.y+e.size.y/2)*w.pixelDensityRatio;s.translate(a,o);n=this.viewport.getRotation(!0);s.rotate(Math.PI/180*-n);s.translate(-a,-o);if(0===e.x&&0===e.y){s.fillText("Zoom: "+this.viewport.getZoom(),e.position.x*w.pixelDensityRatio,(e.position.y-30)*w.pixelDensityRatio);s.fillText("Pan: "+this.viewport.getBounds().toString(),e.position.x*w.pixelDensityRatio,(e.position.y-20)*w.pixelDensityRatio)}s.fillText("Level: "+e.level,(e.position.x+10)*w.pixelDensityRatio,(e.position.y+20)*w.pixelDensityRatio);s.fillText("Column: "+e.x,(e.position.x+10)*w.pixelDensityRatio,(e.position.y+30)*w.pixelDensityRatio);s.fillText("Row: "+e.y,(e.position.x+10)*w.pixelDensityRatio,(e.position.y+40)*w.pixelDensityRatio);s.fillText("Order: "+i+" of "+t,(e.position.x+10)*w.pixelDensityRatio,(e.position.y+50)*w.pixelDensityRatio);s.fillText("Size: "+e.size.toString(),(e.position.x+10)*w.pixelDensityRatio,(e.position.y+60)*w.pixelDensityRatio);s.fillText("Position: "+e.position.toString(),(e.position.x+10)*w.pixelDensityRatio,(e.position.y+70)*w.pixelDensityRatio);this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges();r.getRotation(!0)%360!=0&&this._restoreRotationChanges();s.restore()}_drawPlaceholder(e){var t=e.getBounds(!0);var i=this.viewportToDrawerRectangle(e.getBounds(!0));const r=this._outputContext;let n;n="function"==typeof e.placeholderFillStyle?e.placeholderFillStyle(e,r):e.placeholderFillStyle;this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)});r.fillStyle=n;r.translate(i.x,i.y);r.rotate(Math.PI/180*t.degrees);r.translate(-i.x,-i.y);r.fillRect(i.x,i.y,i.width,i.height);this._restoreRotationChanges()}_getCanvasCenter(){return new w.Point(this.canvas.width/2,this.canvas.height/2)}_restoreRotationChanges(){this._outputContext.restore()}static initShaderProgram(e,t,i){function r(e,t,i){t=e.createShader(t);e.shaderSource(t,i);e.compileShader(t);if(e.getShaderParameter(t,e.COMPILE_STATUS))return t;w.console.error("An error occurred compiling the shaders: "+e.getShaderInfoLog(t));e.deleteShader(t);return null}var n=r(e,e.VERTEX_SHADER,t);t=r(e,e.FRAGMENT_SHADER,i);i=e.createProgram();e.attachShader(i,n);e.attachShader(i,t);e.linkProgram(i);if(e.getProgramParameter(i,e.LINK_STATUS))return i;w.console.error("Unable to initialize the shader program: "+e.getProgramInfoLog(i));return null}}}(OpenSeadragon);!function(h){h.Viewport=function(e){var t=arguments;if((e=t.length&&t[0]instanceof h.Point?{containerSize:t[0],contentSize:t[1],config:t[2]}:e).config){h.extend(!0,e,e.config);delete e.config}this._margins=h.extend({left:0,top:0,right:0,bottom:0},e.margins||{});delete e.margins;e.initialDegrees=e.degrees;delete e.degrees;h.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,rotationPivot:null,viewer:null,springStiffness:h.DEFAULT_SETTINGS.springStiffness,animationTime:h.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:h.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:h.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:h.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:h.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:h.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:h.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:h.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:h.DEFAULT_SETTINGS.maxZoomLevel,initialDegrees:h.DEFAULT_SETTINGS.degrees,flipped:h.DEFAULT_SETTINGS.flipped,homeFillsViewer:h.DEFAULT_SETTINGS.homeFillsViewer,silenceMultiImageWarnings:h.DEFAULT_SETTINGS.silenceMultiImageWarnings},e);this._updateContainerInnerSize();this.centerSpringX=new h.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime});this.centerSpringY=new h.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime});this.zoomSpring=new h.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime});this.degreesSpring=new h.Spring({initial:e.initialDegrees,springStiffness:this.springStiffness,animationTime:this.animationTime});this._oldCenterX=this.centerSpringX.current.value;this._oldCenterY=this.centerSpringY.current.value;this._oldZoom=this.zoomSpring.current.value;this._oldDegrees=this.degreesSpring.current.value;this._setContentBounds(new h.Rect(0,0,1,1),1);this.goHome(!0);this.update()};h.Viewport.prototype={get degrees(){h.console.warn("Accessing [Viewport.degrees] is deprecated. Use viewport.getRotation instead.");return this.getRotation()},set degrees(e){h.console.warn("Setting [Viewport.degrees] is deprecated. Use viewport.rotateTo, viewport.rotateBy, or viewport.setRotation instead.");this.rotateTo(e)},resetContentSize:function(e){h.console.assert(e,"[Viewport.resetContentSize] contentSize is required");h.console.assert(e instanceof h.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point");h.console.assert(0<e.x,"[Viewport.resetContentSize] contentSize.x must be greater than 0");h.console.assert(0<e.y,"[Viewport.resetContentSize] contentSize.y must be greater than 0");this._setContentBounds(new h.Rect(0,0,1,e.y/e.x),e.x);return this},setHomeBounds:function(e,t){h.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually.");this._setContentBounds(e,t)},_setContentBounds:function(e,t){h.console.assert(e,"[Viewport._setContentBounds] bounds is required");h.console.assert(e instanceof h.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect");h.console.assert(0<e.width,"[Viewport._setContentBounds] bounds.width must be greater than 0");h.console.assert(0<e.height,"[Viewport._setContentBounds] bounds.height must be greater than 0");this._contentBoundsNoRotate=e.clone();this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(t);this._contentBounds=e.rotate(this.getRotation()).getBoundingBox();this._contentSize=this._contentBounds.getSize().times(t);this._contentAspectRatio=this._contentSize.x/this._contentSize.y;this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor:t,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var e=this._contentAspectRatio/this.getAspectRatio();return(this.homeFillsViewer?1<=e?e:1:1<=e?1:e)/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var e=this._contentBounds.getCenter();var t=1/this.getHomeZoom();var i=t/this.getAspectRatio();return new h.Rect(e.x-t/2,e.y-i/2,t,i)},goHome:function(e){this.viewer&&this.viewer.raiseEvent("home",{immediately:e});return this.fitBounds(this.getHomeBounds(),e)},getMinZoom:function(){var e=this.getHomeZoom();return this.minZoomLevel||this.minZoomImageRatio*e},getMaxZoom:function(){var e=this.maxZoomLevel;if(!e){e=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x;e/=this._contentBounds.width}return Math.max(e,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new h.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return h.extend({},this._margins)},setMargins:function(e){h.console.assert("object"===h.type(e),"[Viewport.setMargins] margins must be an object");this._margins=h.extend({left:0,top:0,right:0,bottom:0},e);this._updateContainerInnerSize();this.viewer&&this.viewer.forceRedraw()},getBounds:function(e){return this.getBoundsNoRotate(e).rotate(-this.getRotation(e))},getBoundsNoRotate:function(e){var t=this.getCenter(e);var i=1/this.getZoom(e);e=i/this.getAspectRatio();return new h.Rect(t.x-i/2,t.y-e/2,i,e)},getBoundsWithMargins:function(e){return this.getBoundsNoRotateWithMargins(e).rotate(-this.getRotation(e),this.getCenter(e))},getBoundsNoRotateWithMargins:function(e){var t=this.getBoundsNoRotate(e);e=this._containerInnerSize.x*this.getZoom(e);t.x-=this._margins.left/e;t.y-=this._margins.top/e;t.width+=(this._margins.left+this._margins.right)/e;t.height+=(this._margins.top+this._margins.bottom)/e;return t},getCenter:function(e){var t,i,r,n=new h.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),o=new h.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);if(e)return n;if(!this.zoomPoint)return o;t=this.pixelFromPoint(this.zoomPoint,!0);e=(i=1/(r=this.getZoom()))/this.getAspectRatio();e=new h.Rect(n.x-i/2,n.y-e/2,i,e);r=this._pixelFromPoint(this.zoomPoint,e).minus(t).rotate(-this.getRotation(!0)).divide(this._containerInnerSize.x*r);return o.plus(r)},getZoom:function(e){return(e?this.zoomSpring.current:this.zoomSpring.target).value},_applyZoomConstraints:function(e){return Math.max(Math.min(e,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(e){var t=this.viewportToViewerElementRectangle(e).getBoundingBox();var i=this.viewportToViewerElementRectangle(this._contentBoundsNoRotate).getBoundingBox();var r=!1;var n=!1;if(!this.wrapHorizontal){var o=t.x+t.width;var s=i.x+i.width;var a;a=t.width>i.width?this.visibilityRatio*i.width:this.visibilityRatio*t.width;o=i.x-o+a;s=s-t.x-a;if(a>i.width){t.x+=(o+s)/2;r=!0}else if(s<0){t.x+=s;r=!0}else if(0<o){t.x+=o;r=!0}}if(!this.wrapVertical){var l=t.y+t.height;s=i.y+i.height;o=t.height>i.height?this.visibilityRatio*i.height:this.visibilityRatio*t.height;l=i.y-l+o;s=s-t.y-o;if(o>i.height){t.y+=(l+s)/2;n=!0}else if(s<0){t.y+=s;n=!0}else if(0<l){t.y+=l;n=!0}}l=r||n;e=l?this.viewerElementToViewportRectangle(t):e.clone();e.xConstrained=r;e.yConstrained=n;e.constraintApplied=l;return e},_raiseConstraintsEvent:function(e){this.viewer&&this.viewer.raiseEvent("constrain",{immediately:e})},applyConstraints:function(e){var t=this.getZoom();var i=this._applyZoomConstraints(t);t!==i&&this.zoomTo(i,this.zoomPoint,e);i=this.getConstrainedBounds(!1);if(i.constraintApplied){this.fitBounds(i,e);this._raiseConstraintsEvent(e)}return this},ensureVisible:function(e){return this.applyConstraints(e)},_fitBounds:function(e,t){var i=(t=t||{}).immediately||!1;var r=t.constraints||!1;var n=this.getAspectRatio();var o=e.getCenter();var s=new h.Rect(e.x,e.y,e.width,e.height,e.degrees+this.getRotation()).getBoundingBox();s.getAspectRatio()>=n?s.height=s.width/n:s.width=s.height*n;s.x=o.x-s.width/2;s.y=o.y-s.height/2;var a=1/s.width;if(i){this.panTo(o,!0);this.zoomTo(a,null,!0);r&&this.applyConstraints(!0);return this}var l=this.getCenter(!0);t=this.getZoom(!0);this.panTo(l,!0);this.zoomTo(t,null,!0);e=this.getBounds();n=this.getZoom();if(0===n||Math.abs(a/n-1)<1e-8){this.zoomTo(a,null,!0);this.panTo(o,i);r&&this.applyConstraints(!1);return this}if(r){this.panTo(o,!1);a=this._applyZoomConstraints(a);this.zoomTo(a,null,!1);o=this.getConstrainedBounds();this.panTo(l,!0);this.zoomTo(t,null,!0);this.fitBounds(o)}else{n=s.rotate(-this.getRotation()).getTopLeft().times(a).minus(e.getTopLeft().times(n)).divide(a-n);this.zoomTo(a,n,i)}return this},fitBounds:function(e,t){return this._fitBounds(e,{immediately:t,constraints:!1})},fitBoundsWithConstraints:function(e,t){return this._fitBounds(e,{immediately:t,constraints:!0})},fitVertically:function(e){var t=new h.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(t,e)},fitHorizontally:function(e){var t=new h.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(t,e)},getConstrainedBounds:function(e){e=this.getBounds(e);return this._applyBoundaryConstraints(e)},panBy:function(e,t){var i=new h.Point;if(t){i.x=this.centerSpringX.current.value;i.y=this.centerSpringY.current.value}else{i.x=this.centerSpringX.target.value;i.y=this.centerSpringY.target.value}return this.panTo(i.plus(e),t)},panTo:function(e,t){if(t){this.centerSpringX.resetTo(e.x);this.centerSpringY.resetTo(e.y)}else{this.centerSpringX.springTo(e.x);this.centerSpringY.springTo(e.y)}this.viewer&&this.viewer.raiseEvent("pan",{center:e,immediately:t});return this},zoomBy:function(e,t,i){return this.zoomTo(this.zoomSpring.target.value*e,t,i)},zoomTo:function(e,t,i){var r=this;this.zoomPoint=t instanceof h.Point&&!isNaN(t.x)&&!isNaN(t.y)?t:null;i?this._adjustCenterSpringsForZoomPoint(function(){r.zoomSpring.resetTo(e)}):this.zoomSpring.springTo(e);this.viewer&&this.viewer.raiseEvent("zoom",{zoom:e,refPoint:t,immediately:i});return this},setRotation:function(e,t){return this.rotateTo(e,null,t)},getRotation:function(e){return(e?this.degreesSpring.current:this.degreesSpring.target).value},setRotationWithPivot:function(e,t,i){return this.rotateTo(e,t,i)},rotateTo:function(e,t,i){if(!this.viewer||!this.viewer.drawer.canRotate())return this;if(this.degreesSpring.target.value===e&&this.degreesSpring.isAtTargetValue())return this;this.rotationPivot=t instanceof h.Point&&!isNaN(t.x)&&!isNaN(t.y)?t:null;if(i)if(this.rotationPivot){if(!(e-this._oldDegrees)){this.rotationPivot=null;return this}this._rotateAboutPivot(e)}else this.degreesSpring.resetTo(e);else{var r=h.positiveModulo(this.degreesSpring.current.value,360);var n=h.positiveModulo(e,360);t=n-r;180<t?n-=360:t<-180&&(n+=360);this.degreesSpring.resetTo(e+(r-n));this.degreesSpring.springTo(e)}this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor());this.viewer.forceRedraw();this.viewer.raiseEvent("rotate",{degrees:e,immediately:!!i,pivot:this.rotationPivot||this.getCenter()});return this},rotateBy:function(e,t,i){return this.rotateTo(this.degreesSpring.target.value+e,t,i)},resize:function(e,t){var i,r=this.getBoundsNoRotate(),n=r;this.containerSize.x=e.x;this.containerSize.y=e.y;this._updateContainerInnerSize();if(t){i=e.x/this.containerSize.x;n.width=r.width*i;n.height=n.width/this.getAspectRatio()}this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize:e,maintain:t});n=this.fitBounds(n,!0);this.viewer&&this.viewer.raiseEvent("after-resize",{newContainerSize:e,maintain:t});return n},_updateContainerInnerSize:function(){this._containerInnerSize=new h.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var e=this;this._adjustCenterSpringsForZoomPoint(function(){e.zoomSpring.update()});this.degreesSpring.isAtTargetValue()&&(this.rotationPivot=null);this.centerSpringX.update();this.centerSpringY.update();this.rotationPivot?this._rotateAboutPivot(!0):this.degreesSpring.update();var t=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom||this.degreesSpring.current.value!==this._oldDegrees;this._oldCenterX=this.centerSpringX.current.value;this._oldCenterY=this.centerSpringY.current.value;this._oldZoom=this.zoomSpring.current.value;this._oldDegrees=this.degreesSpring.current.value;return t||!this.zoomSpring.isAtTargetValue()||!this.centerSpringX.isAtTargetValue()||!this.centerSpringY.isAtTargetValue()||!this.degreesSpring.isAtTargetValue()},_rotateAboutPivot:function(e){var t=!0===e;var i=this.rotationPivot.minus(this.getCenter());this.centerSpringX.shiftBy(i.x);this.centerSpringY.shiftBy(i.y);t?this.degreesSpring.update():this.degreesSpring.resetTo(e);e=this.degreesSpring.current.value-this._oldDegrees;e=i.rotate(-1*e).times(-1);this.centerSpringX.shiftBy(e.x);this.centerSpringY.shiftBy(e.y)},_adjustCenterSpringsForZoomPoint:function(e){if(this.zoomPoint){var t=this.pixelFromPoint(this.zoomPoint,!0);e();t=this.pixelFromPoint(this.zoomPoint,!0).minus(t);t=this.deltaPointsFromPixels(t,!0);this.centerSpringX.shiftBy(t.x);this.centerSpringY.shiftBy(t.y);this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else e()},deltaPixelsFromPointsNoRotate:function(e,t){return e.times(this._containerInnerSize.x*this.getZoom(t))},deltaPixelsFromPoints:function(e,t){return this.deltaPixelsFromPointsNoRotate(e.rotate(this.getRotation(t)),t)},deltaPointsFromPixelsNoRotate:function(e,t){return e.divide(this._containerInnerSize.x*this.getZoom(t))},deltaPointsFromPixels:function(e,t){return this.deltaPointsFromPixelsNoRotate(e,t).rotate(-this.getRotation(t))},pixelFromPointNoRotate:function(e,t){return this._pixelFromPointNoRotate(e,this.getBoundsNoRotate(t))},pixelFromPoint:function(e,t){return this._pixelFromPoint(e,this.getBoundsNoRotate(t))},_pixelFromPointNoRotate:function(e,t){return e.minus(t.getTopLeft()).times(this._containerInnerSize.x/t.width).plus(new h.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(e,t){return this._pixelFromPointNoRotate(e.rotate(this.getRotation(!0),this.getCenter(!0)),t)},pointFromPixelNoRotate:function(e,t){t=this.getBoundsNoRotate(t);return e.minus(new h.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/t.width).plus(t.getTopLeft())},pointFromPixel:function(e,t){return this.pointFromPixelNoRotate(e,t).rotate(-this.getRotation(t),this.getCenter(t))},_viewportToImageDelta:function(e,t){var i=this._contentBoundsNoRotate.width;return new h.Point(e*this._contentSizeNoRotate.x/i,t*this._contentSizeNoRotate.x/i)},viewportToImageCoordinates:function(e,t){if(e instanceof h.Point)return this.viewportToImageCoordinates(e.x,e.y);if(this.viewer){var i=this.viewer.world.getItemCount();if(1<i)this.silenceMultiImageWarnings||h.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(1===i)return this.viewer.world.getItemAt(0).viewportToImageCoordinates(e,t,!0)}return this._viewportToImageDelta(e-this._contentBoundsNoRotate.x,t-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(e,t){var i=this._contentBoundsNoRotate.width;return new h.Point(e/this._contentSizeNoRotate.x*i,t/this._contentSizeNoRotate.x*i)},imageToViewportCoordinates:function(e,t){if(e instanceof h.Point)return this.imageToViewportCoordinates(e.x,e.y);if(this.viewer){var i=this.viewer.world.getItemCount();if(1<i)this.silenceMultiImageWarnings||h.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(1===i)return this.viewer.world.getItemAt(0).imageToViewportCoordinates(e,t,!0)}t=this._imageToViewportDelta(e,t);t.x+=this._contentBoundsNoRotate.x;t.y+=this._contentBoundsNoRotate.y;return t},imageToViewportRectangle:function(e,t,i,r){var n=e;n instanceof h.Rect||(n=new h.Rect(e,t,i,r));if(this.viewer){var o=this.viewer.world.getItemCount();if(1<o)this.silenceMultiImageWarnings||h.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(1===o)return this.viewer.world.getItemAt(0).imageToViewportRectangle(e,t,i,r,!0)}i=this.imageToViewportCoordinates(n.x,n.y);r=this._imageToViewportDelta(n.width,n.height);return new h.Rect(i.x,i.y,r.x,r.y,n.degrees)},viewportToImageRectangle:function(e,t,i,r){var n=e;n instanceof h.Rect||(n=new h.Rect(e,t,i,r));if(this.viewer){var o=this.viewer.world.getItemCount();if(1<o)this.silenceMultiImageWarnings||h.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(1===o)return this.viewer.world.getItemAt(0).viewportToImageRectangle(e,t,i,r,!0)}i=this.viewportToImageCoordinates(n.x,n.y);r=this._viewportToImageDelta(n.width,n.height);return new h.Rect(i.x,i.y,r.x,r.y,n.degrees)},viewerElementToImageCoordinates:function(e){e=this.pointFromPixel(e,!0);return this.viewportToImageCoordinates(e)},imageToViewerElementCoordinates:function(e){e=this.imageToViewportCoordinates(e);return this.pixelFromPoint(e,!0)},windowToImageCoordinates:function(e){h.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");e=e.minus(h.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(e)},imageToWindowCoordinates:function(e){h.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer.");return this.imageToViewerElementCoordinates(e).plus(h.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(e){return this.pointFromPixel(e,!0)},viewportToViewerElementCoordinates:function(e){return this.pixelFromPoint(e,!0)},viewerElementToViewportRectangle:function(e){return h.Rect.fromSummits(this.pointFromPixel(e.getTopLeft(),!0),this.pointFromPixel(e.getTopRight(),!0),this.pointFromPixel(e.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(e){return h.Rect.fromSummits(this.pixelFromPoint(e.getTopLeft(),!0),this.pixelFromPoint(e.getTopRight(),!0),this.pixelFromPoint(e.getBottomLeft(),!0))},windowToViewportCoordinates:function(e){h.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");e=e.minus(h.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(e)},viewportToWindowCoordinates:function(e){h.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer.");return this.viewportToViewerElementCoordinates(e).plus(h.getElementPosition(this.viewer.element))},viewportToImageZoom:function(e){if(this.viewer){var t=this.viewer.world.getItemCount();if(1<t)this.silenceMultiImageWarnings||h.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(1===t)return this.viewer.world.getItemAt(0).viewportToImageZoom(e)}t=this._contentSizeNoRotate.x;return e*(this._containerInnerSize.x/t*this._contentBoundsNoRotate.width)},imageToViewportZoom:function(e){if(this.viewer){var t=this.viewer.world.getItemCount();if(1<t)this.silenceMultiImageWarnings||h.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image. Instead, use [TiledImage.imageToViewportZoom] for the specific image of interest");else if(1===t)return this.viewer.world.getItemAt(0).imageToViewportZoom(e)}return e*(this._contentSizeNoRotate.x/this._containerInnerSize.x/this._contentBoundsNoRotate.width)},toggleFlip:function(){this.setFlip(!this.getFlip());return this},getFlip:function(){return this.flipped},setFlip:function(e){if(this.flipped===e)return this;this.flipped=e;this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip());this.viewer.forceRedraw();this.viewer.raiseEvent("flip",{flipped:e});return this},getMaxZoomPixelRatio:function(){return this.maxZoomPixelRatio},setMaxZoomPixelRatio:function(e,t=!0,i=!1){h.console.assert(!isNaN(e),"[Viewport.setMaxZoomPixelRatio] ratio must be a number");if(!isNaN(e)){this.maxZoomPixelRatio=e;t&&this.getZoom()>this.getMaxZoom()&&this.applyConstraints(i)}}}}(OpenSeadragon);!function(f){f.TiledImage=function(e){this._initialized=!1;f.console.assert(e.tileCache,"[TiledImage] options.tileCache is required");f.console.assert(e.drawer,"[TiledImage] options.drawer is required");f.console.assert(e.viewer,"[TiledImage] options.viewer is required");f.console.assert(e.imageLoader,"[TiledImage] options.imageLoader is required");f.console.assert(e.source,"[TiledImage] options.source is required");f.console.assert(!e.clip||e.clip instanceof f.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present");f.EventSource.call(this);this._tileCache=e.tileCache;delete e.tileCache;this._drawer=e.drawer;delete e.drawer;this._imageLoader=e.imageLoader;delete e.imageLoader;e.clip instanceof f.Rect&&(this._clip=e.clip.clone());delete e.clip;var t=e.x||0;delete e.x;var i=e.y||0;delete e.y;this.normHeight=e.source.dimensions.y/e.source.dimensions.x;this.contentAspectX=e.source.dimensions.x/e.source.dimensions.y;var r=1;if(e.width){r=e.width;delete e.width;if(e.height){f.console.error("specifying both width and height to a tiledImage is not supported");delete e.height}}else if(e.height){r=e.height/this.normHeight;delete e.height}var n=e.fitBounds;delete e.fitBounds;var o=e.fitBoundsPlacement||OpenSeadragon.Placement.CENTER;delete e.fitBoundsPlacement;var s=e.degrees||0;delete e.degrees;var a=e.ajaxHeaders;delete e.ajaxHeaders;f.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_needsDraw:!0,_needsUpdate:!0,_hasOpaqueTile:!1,_tilesLoading:0,_zombieCache:!1,_tilesToDraw:[],_lastDrawn:[],_isBlending:!1,_wasBlending:!1,_isTainted:!1,springStiffness:f.DEFAULT_SETTINGS.springStiffness,animationTime:f.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:f.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:f.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:f.DEFAULT_SETTINGS.wrapVertical,immediateRender:f.DEFAULT_SETTINGS.immediateRender,loadDestinationTilesOnAnimation:f.DEFAULT_SETTINGS.loadDestinationTilesOnAnimation,blendTime:f.DEFAULT_SETTINGS.blendTime,alwaysBlend:f.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:f.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:f.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:f.DEFAULT_SETTINGS.iOSDevice,debugMode:f.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:f.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:f.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:f.DEFAULT_SETTINGS.placeholderFillStyle,opacity:f.DEFAULT_SETTINGS.opacity,preload:f.DEFAULT_SETTINGS.preload,compositeOperation:f.DEFAULT_SETTINGS.compositeOperation,subPixelRoundingForTransparency:f.DEFAULT_SETTINGS.subPixelRoundingForTransparency,maxTilesPerFrame:f.DEFAULT_SETTINGS.maxTilesPerFrame,_currentMaxTilesPerFrame:10*(e.maxTilesPerFrame||f.DEFAULT_SETTINGS.maxTilesPerFrame)},e);this._preload=this.preload;delete this.preload;this._fullyLoaded=!1;this._xSpring=new f.Spring({initial:t,springStiffness:this.springStiffness,animationTime:this.animationTime});this._ySpring=new f.Spring({initial:i,springStiffness:this.springStiffness,animationTime:this.animationTime});this._scaleSpring=new f.Spring({initial:r,springStiffness:this.springStiffness,animationTime:this.animationTime});this._degreesSpring=new f.Spring({initial:s,springStiffness:this.springStiffness,animationTime:this.animationTime});this._updateForScale();n&&this.fitBounds(n,o,!0);this._ownAjaxHeaders={};this.setAjaxHeaders(a,!1);this._initialized=!0};f.extend(f.TiledImage.prototype,f.EventSource.prototype,{needsDraw:function(){return this._needsDraw},redraw:function(){this._needsDraw=!0},getFullyLoaded:function(){return this._fullyLoaded},whenFullyLoaded:function(e){this.getFullyLoaded()?setTimeout(e,1):this.addOnceHandler("fully-loaded-change",function(){e()})},_setFullyLoaded:function(e){if(e!==this._fullyLoaded){this._fullyLoaded=e;this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded})}},requestInvalidate:function(e=!0,t=!1,i=f.now()){t=t?this._lastDrawn.map(e=>e.tile):this._tileCache.getLoadedTilesFor(this);return this.viewer.world.requestTileInvalidateEvent(t,i,e)},reset:function(){this._tileCache.clearTilesFor(this);this._currentMaxTilesPerFrame=10*this.maxTilesPerFrame;this.lastResetTime=f.now();this._needsDraw=!0;this._fullyLoaded=!1},update:function(e){var t=this._xSpring.update();var i=this._ySpring.update();var r=this._scaleSpring.update();var n=this._degreesSpring.update();n=t||i||r||n||this._needsUpdate;if(n||e||!this._fullyLoaded){e=this._updateLevelsForViewport();this._setFullyLoaded(e)}this._needsUpdate=!1;if(n){this._updateForScale();this._raiseBoundsChange();return this._needsDraw=!0}return!1},setDrawn:function(){this._needsDraw=this._isBlending||this._wasBlending||0<this.opacity&&this._lastDrawn.length<1;return this._needsDraw},setTainted(e){this._isTainted=e},isTainted(){return this._isTainted},destroy:function(){this.reset();this.source.destroy(this.viewer)},getBounds:function(e){return this.getBoundsNoRotate(e).rotate(this.getRotation(e),this._getRotationPoint(e))},getBoundsNoRotate:function(e){return e?new f.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new f.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){f.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead");return this.getBounds()},getClippedBounds:function(e){var t=this.getBoundsNoRotate(e);if(this._clip){var i=(e?this._worldWidthCurrent:this._worldWidthTarget)/this.source.dimensions.x;i=this._clip.times(i);t=new f.Rect(t.x+i.x,t.y+i.y,i.width,i.height)}return t.rotate(this.getRotation(e),this._getRotationPoint(e))},getTileBounds:function(e,t,i){var r=this.source.getNumTiles(e);var n=(r.x+t%r.x)%r.x;var o=(r.y+i%r.y)%r.y;e=this.source.getTileBounds(e,n,o);this.getFlip()&&(e.x=Math.max(0,1-e.x-e.width));e.x+=(t-n)/r.x;e.y+=this._worldHeightCurrent/this._worldWidthCurrent*((i-o)/r.y);return e},getContentSize:function(){return new f.Point(this.source.dimensions.x,this.source.dimensions.y)},getSizeInWindowCoordinates:function(){var e=this.imageToWindowCoordinates(new f.Point(0,0));var t=this.imageToWindowCoordinates(this.getContentSize());return new f.Point(t.x-e.x,t.y-e.y)},_viewportToImageDelta:function(e,t,i){i=(i?this._scaleSpring.current:this._scaleSpring.target).value;return new f.Point(e*(this.source.dimensions.x/i),t*(this.source.dimensions.y*this.contentAspectX/i))},viewportToImageCoordinates:function(e,t,i){var r;if(e instanceof f.Point){i=t;r=e}else r=new f.Point(e,t);r=r.rotate(-this.getRotation(i),this._getRotationPoint(i));return i?this._viewportToImageDelta(r.x-this._xSpring.current.value,r.y-this._ySpring.current.value):this._viewportToImageDelta(r.x-this._xSpring.target.value,r.y-this._ySpring.target.value)},_imageToViewportDelta:function(e,t,i){i=(i?this._scaleSpring.current:this._scaleSpring.target).value;return new f.Point(e/this.source.dimensions.x*i,t/this.source.dimensions.y/this.contentAspectX*i)},imageToViewportCoordinates:function(e,t,i){if(e instanceof f.Point){i=t;t=e.y;e=e.x}t=this._imageToViewportDelta(e,t,i);if(i){t.x+=this._xSpring.current.value;t.y+=this._ySpring.current.value}else{t.x+=this._xSpring.target.value;t.y+=this._ySpring.target.value}return t.rotate(this.getRotation(i),this._getRotationPoint(i))},imageToViewportRectangle:function(e,t,i,r,n){var o=e;o instanceof f.Rect?n=t:o=new f.Rect(e,t,i,r);i=this.imageToViewportCoordinates(o.getTopLeft(),n);r=this._imageToViewportDelta(o.width,o.height,n);return new f.Rect(i.x,i.y,r.x,r.y,o.degrees+this.getRotation(n))},viewportToImageRectangle:function(e,t,i,r,n){var o=e;e instanceof f.Rect?n=t:o=new f.Rect(e,t,i,r);i=this.viewportToImageCoordinates(o.getTopLeft(),n);r=this._viewportToImageDelta(o.width,o.height,n);return new f.Rect(i.x,i.y,r.x,r.y,o.degrees-this.getRotation(n))},viewerElementToImageCoordinates:function(e){e=this.viewport.pointFromPixel(e,!0);return this.viewportToImageCoordinates(e)},imageToViewerElementCoordinates:function(e){e=this.imageToViewportCoordinates(e);return this.viewport.pixelFromPoint(e,!0)},windowToImageCoordinates:function(e){e=e.minus(OpenSeadragon.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(e)},imageToWindowCoordinates:function(e){return this.imageToViewerElementCoordinates(e).plus(OpenSeadragon.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(e){var t=this._scaleSpring.current.value;e=e.rotate(-this.getRotation(!0),this._getRotationPoint(!0));return new f.Rect((e.x-this._xSpring.current.value)/t,(e.y-this._ySpring.current.value)/t,e.width/t,e.height/t,e.degrees)},viewportToImageZoom:function(e){return this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x*e},imageToViewportZoom:function(e){return e/(this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x)},setPosition:function(e,t){var i=this._xSpring.target.value===e.x&&this._ySpring.target.value===e.y;if(t){if(i&&this._xSpring.current.value===e.x&&this._ySpring.current.value===e.y)return;this._xSpring.resetTo(e.x);this._ySpring.resetTo(e.y);this._needsDraw=!0;this._needsUpdate=!0}else{if(i)return;this._xSpring.springTo(e.x);this._ySpring.springTo(e.y);this._needsDraw=!0;this._needsUpdate=!0}i||this._raiseBoundsChange()},setWidth:function(e,t){this._setScale(e,t)},setHeight:function(e,t){this._setScale(e/this.normHeight,t)},setCroppingPolygons:function(e){var t=function(e){return e instanceof f.Point||"number"==typeof e.x&&"number"==typeof e.y};try{if(!f.isArray(e))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=e.map(function(e){return e.map(function(e){try{if(t(e))return{x:e.x,y:e.y};throw new Error}catch(e){throw new Error("A Provided cropping polygon point is not supported")}})});this._needsDraw=!0}catch(e){f.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported");f.console.error(e);this.resetCroppingPolygons()}},resetCroppingPolygons:function(){this._croppingPolygons=null;this._needsDraw=!0},fitBounds:function(e,t,i){t=t||f.Placement.CENTER;var r=f.Placement.properties[t];var n=this.contentAspectX;var o=0;var s=0;var a=1;t=1;if(this._clip){n=this._clip.getAspectRatio();a=this._clip.width/this.source.dimensions.x;t=this._clip.height/this.source.dimensions.y;if(e.getAspectRatio()>n){o=this._clip.x/this._clip.height*e.height;s=this._clip.y/this._clip.height*e.height}else{o=this._clip.x/this._clip.width*e.width;s=this._clip.y/this._clip.width*e.width}}if(e.getAspectRatio()>n){var l=e.height/t;t=0;r.isHorizontallyCentered?t=(e.width-e.height*n)/2:r.isRight&&(t=e.width-e.height*n);this.setPosition(new f.Point(e.x-o+t,e.y-s),i);this.setHeight(l,i)}else{l=e.width/a;a=0;r.isVerticallyCentered?a=(e.height-e.width/n)/2:r.isBottom&&(a=e.height-e.width/n);this.setPosition(new f.Point(e.x-o,e.y-s+a),i);this.setWidth(l,i)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(e){f.console.assert(!e||e instanceof f.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null");e instanceof f.Rect?this._clip=e.clone():this._clip=null;this._needsUpdate=!0;this._needsDraw=!0;this.raiseEvent("clip-change")},getFlip:function(){return this.flipped},setFlip:function(e){this.flipped=e},get flipped(){return this._flipped},set flipped(e){var t=this._flipped!==!!e;this._flipped=!!e;if(t&&this._initialized){this.update(!0);this._needsDraw=!0;this._raiseBoundsChange()}},get wrapHorizontal(){return this._wrapHorizontal},set wrapHorizontal(e){var t=this._wrapHorizontal!==!!e;this._wrapHorizontal=!!e;if(this._initialized&&t){this.update(!0);this._needsDraw=!0}},get wrapVertical(){return this._wrapVertical},set wrapVertical(e){var t=this._wrapVertical!==!!e;this._wrapVertical=!!e;if(this._initialized&&t){this.update(!0);this._needsDraw=!0}},get debugMode(){return this._debugMode},set debugMode(e){this._debugMode=!!e;this._needsDraw=!0},getOpacity:function(){return this.opacity},setOpacity:function(e){this.opacity=e},get opacity(){return this._opacity},set opacity(e){if(e!==this.opacity){this._opacity=e;this._needsDraw=!0;this._needsUpdate=!0;this.raiseEvent("opacity-change",{opacity:this.opacity})}},getPreload:function(){return this._preload},setPreload:function(e){this._preload=!!e;this._needsDraw=!0},getRotation:function(e){return(e?this._degreesSpring.current:this._degreesSpring.target).value},setRotation:function(e,t){if(this._degreesSpring.target.value!==e||!this._degreesSpring.isAtTargetValue()){t?this._degreesSpring.resetTo(e):this._degreesSpring.springTo(e);this._needsDraw=!0;this._needsUpdate=!0;this._raiseBoundsChange()}},getDrawArea:function(){if(0===this._opacity&&!this._preload)return!1;var e=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var t=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));e=e.intersection(t)}return e},getLoadArea:function(){var e=this._viewportToTiledImageRectangle(this.viewport.getBoundsWithMargins(!1));if(!this.wrapHorizontal&&!this.wrapVertical){var t=this._viewportToTiledImageRectangle(this.getClippedBounds(!1));e=e.intersection(t)}return e},getTilesToDraw:function(){let e=this._tilesToDraw.flat();this._updateTilesInViewport(e);e=this._tilesToDraw.flat();e.forEach(e=>{e.tile.beingDrawn=!0});this._lastDrawn=e;return e},_getRotationPoint:function(e){return this.getBoundsNoRotate(e).getCenter()},get compositeOperation(){return this._compositeOperation},set compositeOperation(e){if(e!==this._compositeOperation){this._compositeOperation=e;this._needsDraw=!0;this.raiseEvent("composite-operation-change",{compositeOperation:this._compositeOperation})}},getCompositeOperation:function(){return this._compositeOperation},setCompositeOperation:function(e){this.compositeOperation=e},setAjaxHeaders:function(e,t){if(f.isPlainObject(e=null===e?{}:e)){this._ownAjaxHeaders=e;this._updateAjaxHeaders(t)}else f.console.error("[TiledImage.setAjaxHeaders] Ignoring invalid headers, must be a plain object")},_updateAjaxHeaders:function(e){void 0===e&&(e=!0);f.isPlainObject(this.viewer.ajaxHeaders)?this.ajaxHeaders=f.extend({},this.viewer.ajaxHeaders,this._ownAjaxHeaders):this.ajaxHeaders=this._ownAjaxHeaders;if(e){var t,i;for(var r in this.tilesMatrix){t=this.source.getNumTiles(r);for(var n in this.tilesMatrix[r]){i=(t.x+n%t.x)%t.x;for(var o in this.tilesMatrix[r][n]){s=(t.y+o%t.y)%t.y;(o=this.tilesMatrix[r][n][o]).loadWithAjax=this.loadTilesWithAjax;if(o.loadWithAjax){var s=this.source.getTileAjaxHeaders(r,i,s);o.ajaxHeaders=f.extend({},this.ajaxHeaders,s)}else o.ajaxHeaders=null}}}for(var a=0;a<this._imageLoader.jobQueue.length;a++){var l=this._imageLoader.jobQueue[a];l.loadWithAjax=l.tile.loadWithAjax;l.ajaxHeaders=l.tile.loadWithAjax?l.tile.ajaxHeaders:null}}},allowZombieCache:function(e){this._zombieCache=e},_setScale:function(e,t){var i=this._scaleSpring.target.value===e;if(t){if(i&&this._scaleSpring.current.value===e)return;this._scaleSpring.resetTo(e);this._updateForScale();this._needsDraw=!0;this._needsUpdate=!0}else{if(i)return;this._scaleSpring.springTo(e);this._updateForScale();this._needsDraw=!0;this._needsUpdate=!0}i||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value;this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value;this._worldWidthCurrent=this._scaleSpring.current.value;this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var e=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2)));var t=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value;t=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(t/this.minPixelRatio)/Math.log(2))));t=Math.max(t,this.source.minLevel||0);return{lowestLevel:Math.min(e,t),highestLevel:t}},_updateLevelsForViewport:function(){var i=this._getLevelsInterval();var r=i.lowestLevel;i=i.highestLevel;var t=[];var n=this.getDrawArea();var o=n;this.loadDestinationTilesOnAnimation&&(o=this.getLoadArea());var s=f.now();this._lastDrawn.forEach(e=>{e.tile.beingDrawn=!1});this._tilesToDraw=[];this._tilesLoading=0;this.loadingCoverage={};if(!n){this._needsDraw=!1;return this._fullyLoaded}var a=new Array(i-r+1);for(let e=0,t=i;t>=r;t--,e++)a[e]=t;for(let e=i+1;e<=this.source.maxLevel;e++){var l=this.tilesMatrix[e]&&this.tilesMatrix[e][0]&&this.tilesMatrix[e][0][0];if(l&&l.isBottomMost&&l.isRightMost&&l.loaded){a.push(e);break}}let h=!1;for(let e=0;e<a.length;e++){var c=a[e];var u=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(c),!0).x*this._scaleSpring.current.value;if(e===a.length-1||u>=this.minPixelRatio)h=!0;else if(!h)continue;var d=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(c),!1).x*this._scaleSpring.current.value;var p=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value;p=this.immediateRender?1:p;u=Math.min(1,(u-.5)/.5);d=p/Math.abs(p-d);d=this._updateLevel(c,u,d,n,o,s,t);t=d.bestTiles;d=d.updatedTiles.filter(e=>e.loaded);u=function(t,i,r){return function(e){return{tile:e,level:t,levelOpacity:i,currentTime:r}}}(c,u,s);this._tilesToDraw[c]=d.map(u);if(this._providesCoverage(this.coverage,c))break}if(t&&0<t.length){for(var e of t)e&&this._loadTile(e,s);return!(this._needsDraw=!0)}return 0===this._tilesLoading},_updateTilesInViewport:function(i){let r=f.now();let n=this;this._tilesLoading=0;this._wasBlending=this._isBlending;this._isBlending=!1;this.loadingCoverage={};let o=i.length?i[0].level:0;if(this.getDrawArea()){let t=0;for(let e=0;e<i.length;e++){var s=i[e];!function(e){var t=e.tile;if(t&&t.loaded){e=n._blendTile(t,t.x,t.y,e.level,e.levelOpacity,r,o);n._isBlending=n._isBlending||e;n._needsDraw=n._needsDraw||e||n._wasBlending}}(s);this._providesCoverage(this.coverage,s.level)&&(t=Math.max(t,s.level))}if(0<t)for(var e in this._tilesToDraw)e<t&&delete this._tilesToDraw[e]}},_blendTile:function(e,t,i,r,n,o,s){let a=1e3*this.blendTime,l,h;e.blendStart||(e.blendStart=o);l=o-e.blendStart;h=a?Math.min(1,l/a):1;if(r===s){h=1;l=a}this.alwaysBlend&&(h*=n);e.opacity=h;if(1===h){this._setCoverage(this.coverage,r,t,i,!0);this._hasOpaqueTile=!0}return l<a},_updateLevel:function(e,t,i,r,n,o,s){var a=r.getBoundingBox().getTopLeft();var l=r.getBoundingBox().getBottomRight();this.viewer&&this.viewer.raiseEvent("update-level",{tiledImage:this,havedrawn:!0,level:e,opacity:t,visibility:i,drawArea:r,topleft:a,bottomright:l,currenttime:o,best:s});r=this._updateDrawArea(e,i,r,o);return{bestTiles:s=n?this._updateLoadArea(e,n,o,s):s,updatedTiles:r}},_visitTiles:function(e,t,i){var r=t.getBoundingBox().getTopLeft();var n=t.getBoundingBox().getBottomRight();n=this._getCornerTiles(e,r,n);var o=n.topLeft;var s=n.bottomRight;var a=this.source.getNumTiles(e);if(this.getFlip()){s.x+=1;this.wrapHorizontal||(s.x=Math.min(s.x,a.x-1))}var l=Math.max(0,(s.x-o.x)*(s.y-o.y));for(var h=o.x;h<=s.x;h++)for(var c=o.y;c<=s.y;c++){if(this.getFlip()){var u=(a.x+h%a.x)%a.x;u=h+a.x-u-u-1}else u=h;null!==t.intersection(this.getTileBounds(e,u,c))&&i(this,u,c,l)}},_updateDrawArea:function(n,o,e,s){var a=this.source.getNumTiles(n);var l=this.viewport.pixelFromPoint(this.viewport.getCenter());this._resetCoverage(this.coverage,n);var h=null;var c=0;this._visitTiles(n,e,function(e,t,i,r){(h=h||new Array(r))[c]=e._updateTile(t,i,n,o,l,a,s);c+=1});return h||[]},_updateLoadArea:function(n,e,o,s){this._resetCoverage(this.loadingCoverage,n);var a=this.source.getNumTiles(n);this._visitTiles(n,e,function(e,t,i,r){s=e._considerTileForLoad(t,i,n,a,o,s)});return s},_positionTile:function(e,t,i,r,n){var o=e.bounds.getTopLeft();o.x*=this._scaleSpring.current.value;o.y*=this._scaleSpring.current.value;o.x+=this._xSpring.current.value;o.y+=this._ySpring.current.value;var s=e.bounds.getSize();s.x*=this._scaleSpring.current.value;s.y*=this._scaleSpring.current.value;e.positionedBounds.x=o.x;e.positionedBounds.y=o.y;e.positionedBounds.width=s.x;e.positionedBounds.height=s.y;var a=i.pixelFromPointNoRotate(o,!0),l=i.pixelFromPointNoRotate(o,!1),o=i.deltaPixelsFromPointsNoRotate(s,!0),s=i.deltaPixelsFromPointsNoRotate(s,!1),s=l.plus(s.divide(2)),s=r.squaredDistanceTo(s);if(this.viewer.drawer.minimumOverlapRequired(this)){t||(o=o.plus(new f.Point(1,1)));e.isRightMost&&this.wrapHorizontal&&(o.x+=.75);e.isBottomMost&&this.wrapVertical&&(o.y+=.75)}e.position=a;e.size=o;e.squaredDistance=s;e.visibility=n},_updateTile:function(e,t,i,r,n,o,s){o=this._getTile(e,t,i,s,o);this.viewer&&this.viewer.raiseEvent("update-tile",{tiledImage:this,tile:o});this._setCoverage(this.coverage,i,e,t,!1);if(!o.exists)return o;o.loaded&&1===o.opacity&&this._setCoverage(this.coverage,i,e,t,!0);this._positionTile(o,this.source.tileOverlap,this.viewport,n,r);return o},_considerTileForLoad:function(e,t,i,r,n,o){n=this._getTile(e,t,i,n,r);r=n.loaded||n.loading||this._isCovered(this.loadingCoverage,i,e,t);this._setCoverage(this.loadingCoverage,i,e,t,r);if(!n.exists)return o;n.loaded||n.loading||!this._tryFindTileCacheRecord(n)||(r=!0);if(n.loading)this._tilesLoading++;else if(!r){o=this._compareTiles(o,n,this._currentMaxTilesPerFrame);this._currentMaxTilesPerFrame>this.maxTilesPerFrame&&(this._currentMaxTilesPerFrame=Math.max(Math.ceil(this.maxTilesPerFrame/2),this.maxTilesPerFrame))}return o},_getCornerTiles:function(e,t,i){var r;var n;if(this.wrapHorizontal){r=f.positiveModulo(t.x,1);n=f.positiveModulo(i.x,1)}else{r=Math.max(0,t.x);n=Math.min(1,i.x)}var o=1/this.source.aspectRatio;if(this.wrapVertical){s=f.positiveModulo(t.y,o);a=f.positiveModulo(i.y,o)}else{s=Math.max(0,t.y);a=Math.min(o,i.y)}var s=this.source.getTileAtPoint(e,new f.Point(r,s));var a=this.source.getTileAtPoint(e,new f.Point(n,a));e=this.source.getNumTiles(e);if(this.wrapHorizontal){s.x+=e.x*Math.floor(t.x);a.x+=e.x*Math.floor(i.x)}if(this.wrapVertical){s.y+=e.y*Math.floor(t.y/o);a.y+=e.y*Math.floor(i.y/o)}return{topLeft:s,bottomRight:a}},_tryFindTileCacheRecord:function(e){var t=this._tileCache.getCacheRecord(e.originalCacheKey);if(!t)return!1;e.loading=!0;this._setTileLoaded(e,t.data,null,null,t.type);return!0},_getTile:function(e,t,i,r,n){var o,s,a,l,h,c,u,d,p=this.tilesMatrix,g=this.source;p[i]||(p[i]={});p[i][e]||(p[i][e]={});if(!p[i][e][t]||!p[i][e][t].flipped!=!this.flipped){o=(n.x+e%n.x)%n.x;s=(n.y+t%n.y)%n.y;a=this.getTileBounds(i,e,t);l=g.getTileBounds(i,o,s,!0);h=g.tileExists(i,o,s);c=g.getTileUrl(i,o,s);d=g.getTilePostData(i,o,s);if(this.loadTilesWithAjax){u=g.getTileAjaxHeaders(i,o,s);f.isPlainObject(this.ajaxHeaders)&&(u=f.extend({},this.ajaxHeaders,u))}else u=null;d=new f.Tile(i,e,t,a,h,c,void 0,this.loadTilesWithAjax,u,l,d,g.getTileHashKey(i,o,s,c,u,d));this.getFlip()?0==o&&(d.isRightMost=!0):o==n.x-1&&(d.isRightMost=!0);s==n.y-1&&(d.isBottomMost=!0);d.flipped=this.flipped;p[i][e][t]=d}(d=p[i][e][t]).lastTouchTime=r;return d},_loadTile:function(n,o){var s=this;n.loading=!0;(n.tiledImage=this)._imageLoader.addJob({src:n.getUrl(),tile:n,source:this.source,postData:n.postData,loadWithAjax:n.loadWithAjax,ajaxHeaders:n.ajaxHeaders,crossOriginPolicy:this.crossOriginPolicy,ajaxWithCredentials:this.ajaxWithCredentials,callback:function(e,t,i,r){s._onTileLoad(n,o,e,t,i,r)},abort:function(){n.loading=!1}})||this.viewer.raiseEvent("job-queue-full",{tile:n,tiledImage:this,time:o})},_onTileLoad:function(e,t,i,r,n,o){if(null!=i){e.exists=!0;if(t<this.lastResetTime){f.console.warn("Ignoring tile %s loaded before reset: %s",e,e.getUrl());e.loading=!1}else this._setTileLoaded(e,i,null,n,o)}else{f.console.error("Tile %s failed to load: %s - error: %s",e,e.getUrl(),r);this.viewer.raiseEvent("tile-load-failed",{tile:e,tiledImage:this,time:t,message:r,tileRequest:n});e.loading=!1;e.exists=!1}},_setTileLoaded:function(i,t,e,r,n){i.tiledImage=this;let o=!1;i.addCache(i.cacheKey,()=>{o=!0;return t},n,!1,!1);let s=null,a=0,l=!1;const h=this,c=f.now();function u(){a--;if(!(0<a)){l=!0;i.hasTransparency=i.hasTransparency||h.source.hasTransparency(void 0,i.getUrl(),i.ajaxHeaders,i.postData);i.loading=!1;i.loaded=!0;h.redraw();s(i)}}function d(){l&&f.console.error("Event 'tile-loaded' argument getCompletionCallback must be called synchronously. Its return value should be called asynchronously.");a++;return u}function p(){var e=d();h.viewer.raiseEventAwaiting("tile-loaded",{tile:i,tiledImage:h,tileRequest:r,promise:new f.Promise(e=>{s=e}),get image(){f.console.error("[tile-loaded] event 'image' has been deprecated. Use 'tile-invalidated' event to modify data instead.");return t},get data(){f.console.error("[tile-loaded] event 'data' has been deprecated. Use 'tile-invalidated' event to modify data instead.");return t},getCompletionCallback:function(){f.console.error("[tile-loaded] getCompletionCallback is deprecated: it introduces race conditions: use async event handlers instead, execution order is deducted by addHandler(...) priority argument.");return d()}}).catch(()=>{f.console.error("[tile-loaded] event finished with failure: there might be a problem with a plugin you are using.")}).then(e)}if(o)h.viewer.world.requestTileInvalidateEvent([i],c,!1,!0).then(p);else{for(var g of i.getCache(i.originalCacheKey)._tiles){if(g.cacheKey!==i.cacheKey){var m=g.getCache();i.setCache(g.cacheKey,m,!0,!1);break}if(g.processing){g.processingPromise.then(e=>{var t=e.getCache();i.setCache(e.cacheKey,t,!0,!1);p()});return}}p()}},_compareTiles:function(e,t,i){if(!e)return[t];e.push(t);this._sortTiles(e);e.length>i&&e.pop();return e},_sortTiles:function(e){e.sort(function(e,t){return null===e?1:null===t?-1:e.visibility===t.visibility?e.squaredDistance-t.squaredDistance:t.visibility-e.visibility})},_providesCoverage:function(e,t,i,r){var n,o,s,a;if(!e[t])return!1;if(void 0!==i&&void 0!==r)return void 0===e[t][i]||void 0===e[t][i][r]||!0===e[t][i][r];for(s in n=e[t])if(Object.prototype.hasOwnProperty.call(n,s))for(a in o=n[s])if(Object.prototype.hasOwnProperty.call(o,a)&&!o[a])return!1;return!0},_isCovered:function(e,t,i,r){return void 0===i||void 0===r?this._providesCoverage(e,t+1):this._providesCoverage(e,t+1,2*i,2*r)&&this._providesCoverage(e,t+1,2*i,2*r+1)&&this._providesCoverage(e,t+1,2*i+1,2*r)&&this._providesCoverage(e,t+1,2*i+1,2*r+1)},_setCoverage:function(e,t,i,r,n){if(e[t]){e[t][i]||(e[t][i]={});e[t][i][r]=n}else f.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",t)},_resetCoverage:function(e,t){e[t]={}}})}(OpenSeadragon);!function(c){const n=Symbol("DRAWER_INTERNAL_CACHE");c.CacheRecord=class{constructor(){this.revive()}get data(){return this._data}get type(){return this._type}await(){return this._promise||c.Promise.resolve(this._data)}getImage(){c.console.error("[CacheRecord.getImage] options.image is deprecated. Moreover, it might not work correctly as the cache system performs conversion asynchronously in case the type needs to be converted.");this.transformTo("image");return this.data}getRenderedContext(){c.console.error("[CacheRecord.getRenderedContext] options.getRenderedContext  is deprecated. Moreover, it might not work correctly as the cache system performs conversion asynchronously in case the type needs to be converted.");this.transformTo("context2d");return this.data}setDataAs(e,t){c.console.assert(null!=e,"[CacheRecord.setDataAs] needs valid data to set!");if(this._conversionJobQueue){let i=null;var r=new c.Promise((e,t)=>{i=e});this._conversionJobQueue.push(()=>i(this._overwriteData(e,t)));return r}return this._overwriteData(e,t)}getDataAs(t=void 0,i=!0){return this.loaded?t===this._type?i?c.convertor.copy(this._tRef,this._data,t||this._type):this._promise:this._transformDataIfNeeded(this._tRef,this._data,t||this._type,i)||this._promise:this._promise.then(e=>this._transformDataIfNeeded(this._tRef,e,t||this._type,i)||e)}_transformDataIfNeeded(e,t,i,r){if(this._destroyed)return c.Promise.resolve();let n;i!==this._type?n=c.convertor.convert(e,t,this._type,i):r&&(n=c.convertor.copy(e,t,i));return!!n&&n.then(e=>{if(!this._destroyed)return e;c.convertor.destroy(e,i)})}getDataForRendering(e,t){var i=e.options.usePrivateCache;if(this.loaded)if(this._destroyed){c.console.error("Attempt to draw tile with destroyed main cache!");t._unload()}else{const r=e.getSupportedDataFormats();if(r.includes(this.type)){if(!i)return this;if(!e.options.preloadCache)return this.prepareInternalCacheSync(e);i=this._getInternalCacheRef(e);if(i&&i.loaded)return i;c.console.error("Attempt to draw tile with internal cache non-ready state!")}else{c.console.error("Attempt to draw tile with unsupported target drawer type!");this.prepareForRendering(e)}}else c.console.error("Attempt to draw tile when not loaded main cache!")}prepareForRendering(t){const e=t.getRequiredDataFormats();if(!this.loaded)return this.await().then(e=>this.prepareForRendering(t));let i;i=e.includes(this.type)?this.await():this.transformTo(e);return t.options.usePrivateCache&&t.options.preloadCache?i.then(e=>this.prepareInternalCacheAsync(t)):i}prepareInternalCacheAsync(t){let e=this._getInternalCacheRef(t);if(this._checkInternalCacheUpToDate(e,t))return e.await();e&&!e.loaded&&e.await().then(()=>e.destroy());c.console.assert(this._tRef,"Data Create called from invalidation routine needs tile reference!");var i=t.internalCacheCreate(this,this._tRef);c.console.assert(void 0!==i,"[DrawerBase.internalCacheCreate] must return a value if usePrivateCache is enabled!");var r=t.getId();e=this[n][r]=new c.InternalCacheRecord(i,r,e=>t.internalCacheFree(e));return e.await()}prepareInternalCacheSync(t){let e=this._getInternalCacheRef(t);if(this._checkInternalCacheUpToDate(e,t))return e;e&&e.destroy();c.console.assert(this._tRef,"Data Create called from drawing loop needs tile reference!");var i=t.internalCacheCreate(this,this._tRef);c.console.assert(void 0!==i,"[DrawerBase.internalCacheCreate] must return a value if usePrivateCache is enabled!");var r=t.getId();e=this[n][r]=new c.InternalCacheRecord(i,r,e=>t.internalCacheFree(e));return e}_getInternalCacheRef(t){if(t.options.usePrivateCache){let e=this[n];e=e||(this[n]={});return e[t.getId()]}c.console.error("[CacheRecord.prepareInternalCacheSync] must not be called when usePrivateCache is false.")}_checkInternalCacheUpToDate(e,t){return e&&e.loaded&&e.tstamp>=t._dataNeedsRefresh}transformTo(e=this._type){if(!this.loaded){this._conversionJobQueue=this._conversionJobQueue||[];let i=null;var t=new c.Promise((e,t)=>{i=e});this._conversionJobQueue.push(()=>{if(!this._destroyed)if("string"==typeof e&&e!==this._type||Array.isArray(e)&&!e.includes(this._type)){this._convert(this._type,e);this._promise.then(e=>i(e))}else this._promise.then(e=>{this._checkAwaitsConvert();return i(e)})});return t}("string"==typeof e&&e!==this._type||Array.isArray(e)&&!e.includes(this._type))&&this._convert(this._type,e);return this._promise}destroyInternalCache(e=void 0){const t=this[n];if(t)if(e){const r=t[e];if(r){r.destroy();delete t[e]}}else{for(var i in t)t[i].destroy();delete this[n]}}withTileReference(e){this._tRef=e;return this}toString(){const e=this._tRef||this._tiles.length&&this._tiles[0];return e?`Cache ${this.type} [used e.g. by ${e.toString()}]`:"Orphan cache!"}revive(){c.console.assert(!this.loaded&&!this._type,"[CacheRecord::revive] must not be called when loaded!");this._tiles=[];this._data=null;this._type=null;this.loaded=!1;this._promise=null;this._destroyed=!1}destroy(){if(!this._destroyed){delete this._conversionJobQueue;this._destroyed=!0;if(this.loaded)this._destroySelfUnsafe(this._data,this._type);else if(this._promise){const t=this._type;this._promise.then(e=>this._destroySelfUnsafe(e,t))}}}_destroySelfUnsafe(e,t){c.convertor.destroy(e,t);this.destroyInternalCache();if(this._destroyed){this.loaded=!1;this._tiles=null;this._data=null;this._type=null;this._tRef=null;this._promise=null}}addTile(e,t,i){if(!this._destroyed){c.console.assert(e,"[CacheRecord.addTile] tile is required");if(null!=t&&this._tiles.length<1){"function"==typeof t&&(t=t());if(this.type&&this._promise)t instanceof c.Promise?this._promise=t.then(e=>{this._overwriteData(e,i)}):this._overwriteData(t,i);else{if(t instanceof c.Promise){this._promise=t.then(e=>{this._data=e;this.loaded=!0;return e});this._data=null}else{this._promise=c.Promise.resolve(t);this._data=t;this.loaded=!0}this._type=i}this._tiles.push(e)}else{t=this._tiles.includes(e);!t&&this.type&&this._promise?this._tiles.push(e):t||c.console.warn("Tile %s caching attempt without data argument on uninitialized cache entry!",e)}}}removeTile(t){if(this._destroyed)return!1;for(let e=0;e<this._tiles.length;e++)if(this._tiles[e]===t){this._tiles.splice(e,1);this._tRef===t&&(this._tRef=this._tiles[e-1]);return!0}c.console.warn("[CacheRecord.removeTile] trying to remove unknown tile",t);return!1}getTileCount(){return this._tiles?this._tiles.length:0}_checkAwaitsConvert(){this._conversionJobQueue&&!this._destroyed&&setTimeout(()=>{if(this._conversionJobQueue&&!this._destroyed){const e=this._conversionJobQueue[0];this._conversionJobQueue.splice(0,1);0===this._conversionJobQueue.length&&delete this._conversionJobQueue;e()}})}_triggerNeedsDraw(){0<this._tiles.length&&this._tiles[0].tiledImage.viewer.forceRedraw()}_overwriteData(i,r){if(this._destroyed){c.convertor.destroy(i,r);return c.Promise.resolve()}if(this.loaded){if(this._data===i&&this._type===r)return this._promise;c.convertor.destroy(this._data,this._type);this._type=r;this._data=i;this._promise=c.Promise.resolve(i);const t=this[n];if(t)for(var e in t)t[e].setDataAs(i,r);this._triggerNeedsDraw();return this._promise}return this._promise.then(()=>{if(this._data===i&&this._type===r)return this._data;c.convertor.destroy(this._data,this._type);this._type=r;this._data=i;this._promise=c.Promise.resolve(i);const e=this[n];if(e)for(var t in e)e[t].setDataAs(i,r);this._triggerNeedsDraw();return this._data})}_convert(e,t){const o=c.convertor,s=o.getConversionPath(e,t);if(s){const i=this._data,a=s.length,l=this,h=(e,t)=>{if(t>=a){l._data=e;l.loaded=!0;l._checkAwaitsConvert();return c.Promise.resolve(e)}let i=s[t];var r=i.transform(l._tRef,e);if(void 0===r){l.loaded=!1;throw`[CacheRecord._convert] data mid result undefined value (while converting using ${i}})`}o.destroy(e,i.origin.value);const n="promise"===c.type(r)?r:c.Promise.resolve(r);return n.then(e=>h(e,t+1))};this.loaded=!1;this._data=void 0;this._type=s[a-1].target.value;this._promise=h(i,0)}else c.console.error(`[CacheRecord._convert] Conversion ${e} ---> ${t} cannot be done!`)}};c.InternalCacheRecord=class{constructor(e,t,i){this.tstamp=c.now();this._ondestroy=i;this._type=t;if(e instanceof c.Promise)(this._promise=e).then(e=>{this.loaded=!0;this._data=e});else{this._promise=null;this.loaded=!0;this._data=e}}get data(){return this._data}get type(){return this._type}await(){return this._promise||c.Promise.resolve(this._data)}withTileReference(e){this._temporaryTileRef=e;return this}destroy(){if(this.loaded){this._ondestroy&&this._ondestroy(this._data);this._data=null;this.loaded=!1}}};c.TileCache=class{constructor(e){this._maxCacheItemCount=(e=e||{}).maxImageCacheCount||c.DEFAULT_SETTINGS.maxImageCacheCount;this._tilesLoaded=[];this._zombiesLoaded=[];this._zombiesLoadedCount=0;this._cachesLoaded=[];this._cachesLoadedCount=0}numTilesLoaded(){return this._tilesLoaded.length}numCachesLoaded(){return this._zombiesLoadedCount+this._cachesLoadedCount}cacheTile(e){c.console.assert(e,"[TileCache.cacheTile] options is required");var t=e.tile;c.console.assert(t,"[TileCache.cacheTile] options.tile is required");c.console.assert(t.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required");if(e.image instanceof Image){c.console.warn("[TileCache.cacheTile] options.image is deprecated!");e.data=e.image;e.dataType="image"}var i=e.cacheKey||t.cacheKey;let r=this._cachesLoaded[i];if(!r){if(void 0===e.data){c.console.error("[TileCache.cacheTile] options.image was renamed to options.data. '.image' attribute has been deprecated and will be removed in the future.");e.data=e.image}r=this._zombiesLoaded[i];if(r){if(r._destroyed)r.revive();else{"function"==typeof data&&e.data();delete e.data}delete this._zombiesLoaded[i];this._zombiesLoadedCount--;this._cachesLoaded[i]=r;this._cachesLoadedCount++}else{var n=void 0!==e.data&&null!==e.data&&!1!==e.data;c.console.assert(n,"[TileCache.cacheTile] options.data is required to create an CacheRecord");r=this._cachesLoaded[i]=new c.CacheRecord;this._cachesLoadedCount++}}if(!e.dataType){c.console.error("[TileCache.cacheTile] options.dataType is newly required. For easier use of the cache system, use the tile instance API.");"function"==typeof e.data&&c.console.error("[TileCache.cacheTile] options.dataType is mandatory  when data item is a callback!");e.dataType=c.convertor.guessType(e.data)}r.addTile(t,e.data,e.dataType);this._freeOldRecordRoutine(t,e.cutoff||0);return r}renameCache(e){var t=e.newCacheKey,i=e.oldCacheKey;let r=this._cachesLoaded[i];if(r){if(this._cachesLoaded[t]){c.console.error("Cannot rename cache %s to %s: the target cache is occupied!",i,t);return null}this._cachesLoaded[t]=r;delete this._cachesLoaded[i]}else{r=this._zombiesLoaded[i];c.console.assert(r,"[TileCache.renameCache] oldCacheKey must reference existing cache!");if(this._zombiesLoaded[t]){c.console.error("Cannot rename zombie cache %s to %s: the target cache is occupied!",i,t);return null}this._zombiesLoaded[t]=r;delete this._zombiesLoaded[i]}for(var n of r._tiles)n.reflectCacheRenamed(i,t);return r}cloneCache(i){const r=i.tile;var e=i.copyTargetKey;const n=this._cachesLoaded[e]||this._zombiesLoaded[e];c.console.assert(n,"[TileCache.cloneCache] attempt to clone non-existent cache %s!",e);c.console.assert(!this._cachesLoaded[i.newCacheKey],"[TileCache.cloneCache] attempt to copy clone to existing cache %s!",i.newCacheKey);e=i.desiredType||void 0;return n.getDataAs(e,!0).then(e=>{let t=this._cachesLoaded[i.newCacheKey]=new c.CacheRecord;t.addTile(r,e,n.type);this._cachesLoadedCount++;this._freeOldRecordRoutine(r,i.cutoff||0);return t})}injectCache(e){const t=e.targetKey,i=e.tile;if(e.tileAllowNotLoaded||i.loaded||i.loading){var r=this._cachesLoaded[t];if(r)for(var n of[...r._tiles])this.unloadCacheForTile(n,t,!0,!1);this._cachesLoaded[t]&&c.console.error("The inject routine should've freed cache!");var o=e.cache;this._cachesLoaded[t]=o;for(var s of i.getCache(i.originalCacheKey)._tiles)s.setCache(t,o,e.setAsMainCache,!1)}else c.console.warn("Attempt to inject cache on tile in invalid state: this is probably a bug!")}replaceCache(e){const t=e.victimKey,i=e.consumerKey,r=this._cachesLoaded[t],n=e.tile;if(r&&(e.tileAllowNotLoaded||n.loaded||n.loading)){var o=this._cachesLoaded[i];if(o)for(var s of[...o._tiles])this.unloadCacheForTile(s,i,!0,!1);this._cachesLoaded[i]&&c.console.error("The consume routine should've freed cache!");var a=this.renameCache({oldCacheKey:t,newCacheKey:i});if(a)for(var l of n.getCache(n.originalCacheKey)._tiles)l.setCache(i,a,e.setAsMainCache,!1)}else c.console.warn("Attempt to consume cache on tile in invalid state: this is probably a bug!")}restoreTilesThatShareOriginalCache(e,t,i){for(var r of t._tiles)if(r.cacheKey!==r.originalCacheKey){this.unloadCacheForTile(r,r.cacheKey,i,!0);delete r._caches[r.cacheKey];r.cacheKey=r.originalCacheKey}}_freeOldRecordRoutine(e,i){let r=this._tilesLoaded.length,n=-1;if(this._cachesLoadedCount+this._zombiesLoadedCount>this._maxCacheItemCount)if(0<this._zombiesLoadedCount)for(var t in this._zombiesLoaded){this._zombiesLoaded[t].destroy();delete this._zombiesLoaded[t];this._zombiesLoadedCount--;break}else{let t=null;var o,s,a,l,h;for(let e=this._tilesLoaded.length-1;0<=e;e--)if(!((o=this._tilesLoaded[e]).level<=i||o.beingDrawn||o.loading||o.processing))if(t){l=o.lastTouchTime;s=t.lastTouchTime;h=o.level;a=t.level;if(l<s||l===s&&a<h){t=o;n=e}}else{t=o;n=e}if(t&&0<=n){this._unloadTile(t,!0);r=n}}0===e.getCacheSize()?this._tilesLoaded[r]=e:0<=n&&this._tilesLoaded.splice(r,1)}clearTilesFor(t){c.console.assert(t,"[TileCache.clearTilesFor] tiledImage is required");var i;let r=this._cachesLoadedCount+this._zombiesLoadedCount>this._maxCacheItemCount;if(t._zombieCache&&r&&0<this._zombiesLoadedCount){for(var e in this._zombiesLoaded){this._zombiesLoaded[e].destroy();delete this._zombiesLoaded[e]}this._zombiesLoadedCount=0;r=this._cachesLoadedCount>this._maxCacheItemCount}for(let e=this._tilesLoaded.length-1;0<=e;e--)(i=this._tilesLoaded[e]).tiledImage===t&&(i.loaded?i.tiledImage===t&&this._unloadTile(i,!t._zombieCache||r,e):this._tilesLoaded.splice(e,1))}clear(e=0){for(var t in this._zombiesLoaded)this._zombiesLoaded[t].destroy();for(var i in this._tilesLoaded)this._unloadTile(i,!0,void 0);this._tilesLoaded=[];this._zombiesLoaded=[];this._zombiesLoadedCount=0;this._cachesLoaded=[];this._cachesLoadedCount=0}clearDrawerInternalCache(e){var t=e.getId();for(var i of this._zombiesLoaded)i&&i.destroyInternalCache(t);for(var r of this._cachesLoaded)r&&r.destroyInternalCache(t)}getLoadedTilesFor(t){return t?this._tilesLoaded.filter(e=>e.tiledImage===t):[...this._tilesLoaded]}getCacheRecord(e){c.console.assert(e,"[TileCache.getCacheRecord] cacheKey is required");return this._cachesLoaded[e]||this._zombiesLoaded[e]}safeUnloadCache(e){if(e&&!e._destroyed&&e.getTileCount()<1){for(var t in this._zombiesLoaded){const i=this._zombiesLoaded[t];if(i===e){delete this._zombiesLoaded[t];i.destroy();return}}c.console.error("Attempt to delete an orphan cache that is not in zombie list: this could be a bug!",e);e.destroy()}}unloadCacheForTile(e,t,i,r){const n=this._cachesLoaded[t];if(n){if(n.removeTile(e)){if(!n.getTileCount()){if(i)n.destroy();else{this._zombiesLoaded[t]=n;this._zombiesLoadedCount++}delete this._cachesLoaded[t];this._cachesLoadedCount--}return!0}c.console.error("[TileCache.unloadCacheForTile] System tried to delete tile from cache it does not belong to! This could mean a bug in the cache system.");return!1}r||c.console.warn("[TileCache.unloadCacheForTile] Attempting to delete missing cache!");return!1}unloadTile(t,e=!1){if(t.loaded){var i=this._tilesLoaded.findIndex(e=>e===t);this._unloadTile(t,e,i)}else c.console.warn("Attempt to unload already unloaded tile.")}_unloadTile(e,t,i){c.console.assert(e,"[TileCache._unloadTile] tile is required");for(var r in e._caches)this.unloadCacheForTile(e,r,t,!1);void 0!==i&&this._tilesLoaded.splice(i,1);if(e.loaded){const n=e.tiledImage;e._unload();n.viewer.raiseEvent("tile-unloaded",{tile:e,tiledImage:n,destroyed:t})}}}}(OpenSeadragon);!function(g){g.World=function(e){var t=this;g.console.assert(e.viewer,"[World] options.viewer is required");g.EventSource.call(this);this.viewer=e.viewer;this._items=[];this._needsDraw=!1;this._autoRefigureSizes=!0;this._needsSizesFigured=!1;this._delegatedFigureSizes=function(e){t._autoRefigureSizes?t._figureSizes():t._needsSizesFigured=!0};this._figureSizes()};g.extend(g.World.prototype,g.EventSource.prototype,{addItem:function(e,t){g.console.assert(e,"[World.addItem] item is required");g.console.assert(e instanceof g.TiledImage,"[World.addItem] only TiledImages supported at this time");if(void 0!==(t=t||{}).index){t=Math.max(0,Math.min(this._items.length,t.index));this._items.splice(t,0,e)}else this._items.push(e);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0;this._needsDraw=!0;e.addHandler("bounds-change",this._delegatedFigureSizes);e.addHandler("clip-change",this._delegatedFigureSizes);this.raiseEvent("add-item",{item:e})},getItemAt:function(e){g.console.assert(void 0!==e,"[World.getItemAt] index is required");return this._items[e]},getIndexOfItem:function(e){g.console.assert(e,"[World.getIndexOfItem] item is required");return g.indexOf(this._items,e)},getItemCount:function(){return this._items.length},setItemIndex:function(e,t){g.console.assert(e,"[World.setItemIndex] item is required");g.console.assert(void 0!==t,"[World.setItemIndex] index is required");var i=this.getIndexOfItem(e);if(t>=this._items.length)throw new Error("Index bigger than number of layers.");if(t!==i&&-1!==i){this._items.splice(i,1);this._items.splice(t,0,e);this._needsDraw=!0;this.raiseEvent("item-index-change",{item:e,previousIndex:i,newIndex:t})}},removeItem:function(e){g.console.assert(e,"[World.removeItem] item is required");var t=g.indexOf(this._items,e);if(-1!==t){e.removeHandler("bounds-change",this._delegatedFigureSizes);e.removeHandler("clip-change",this._delegatedFigureSizes);e.destroy();this._items.splice(t,1);this._figureSizes();this._needsDraw=!0;this._raiseRemoveItem(e)}},removeAll:function(){this.viewer._cancelPendingImages();var e;var t;for(t=0;t<this._items.length;t++){(e=this._items[t]).removeHandler("bounds-change",this._delegatedFigureSizes);e.removeHandler("clip-change",this._delegatedFigureSizes);e.destroy()}var i=this._items;this._items=[];this._figureSizes();this._needsDraw=!0;for(t=0;t<i.length;t++){e=i[t];this._raiseRemoveItem(e)}},requestInvalidate:function(e=!0,t=g.now()){g.__updated=t;return this.requestTileInvalidateEvent(this.viewer.tileCache.getLoadedTilesFor(null),t,e)},requestTileInvalidateEvent:function(e,a,l=!0,t=!1){if(!this.viewer.isOpen())return g.Promise.resolve();const i=[],r=[];for(const n of e)if(n&&(t||n.loaded)){const o=n.getCache(n.originalCacheKey);if(!(o.__invStamp&&o.__invStamp>=a)){for(let t of o._tiles){t.processing=a;t.processingPromise=new g.Promise(e=>{r.push(()=>{t.processing=!1;e(t)})})}o.__invStamp=a;i.push(n)}}if(!i.length)return g.Promise.resolve();const h=this.viewer.viewer||this.viewer;const c=this.viewer.drawer;e=i.map(r=>{const t=r.tiledImage;const n=r.getCache(r.originalCacheKey);let o=null;const s=()=>{if(o){var e=r.buildDistinctMainCacheKey();t._tileCache.injectCache({tile:r,cache:o,targetKey:e,setAsMainCache:!0,tileAllowNotLoaded:r.loading})}else l&&t._tileCache.restoreTilesThatShareOriginalCache(r,r.getCache(r.originalCacheKey),!0)};return h.raiseEventAwaiting("tile-invalidated",{tile:r,tiledImage:t,outdated:()=>n.__invStamp!==a||!r.loaded&&!r.loading,getData:t=>{if(o)return o.getDataAs(t,!1);var e=l?r.originalCacheKey:r.cacheKey;const i=r.getCache(e);if(!i){g.console.error("[Tile::getData] There is no cache available for tile with key %s",e);return g.Promise.reject()}t=t||i.type;o=(new g.CacheRecord).withTileReference(r);return i.getDataAs(t,!0).then(e=>{o.addTile(r,e,t);return o.data})},setData:(e,t)=>{if(o)return o.setDataAs(e,t);o=(new g.CacheRecord).withTileReference(r);o.addTile(r,e,t);return g.Promise.resolve()},resetData:()=>{if(o){o.destroy();o=null}}}).then(e=>{if(n.__invStamp===a&&(r.loaded||r.loading)){if(o)return o.prepareForRendering(c).then(e=>{if(e&&n.__invStamp===a){s();n.__invStamp=null}});if(l){const i=r.getCache(r.originalCacheKey);return i.prepareForRendering(c).then(e=>{if(e&&n.__invStamp===a){s();n.__invStamp=null}})}const t=r.getCache();return t.prepareForRendering(c).then(()=>{s();n.__invStamp=null})}if(o){o.destroy();o=null}return null}).catch(e=>{g.console.error("Update routine error:",e)})});return g.Promise.all(e).then(()=>{for(var e of r)e();this.draw()})},resetItems:function(){for(var e=0;e<this._items.length;e++)this._items[e].reset()},update:function(e){var t=!1;for(var i=0;i<this._items.length;i++)t=this._items[i].update(e)||t;return t},draw:function(){this.viewer.drawer.draw(this._items);this._needsDraw=!1;for(var e of this._items)this._needsDraw=e.setDrawn()||this._needsDraw},needsDraw:function(){for(var e=0;e<this._items.length;e++)if(this._items[e].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(e){if((this._autoRefigureSizes=e)&this._needsSizesFigured){this._figureSizes();this._needsSizesFigured=!1}},arrange:function(e){var t=(e=e||{}).immediately||!1;var i=e.layout||g.DEFAULT_SETTINGS.collectionLayout;var r=e.rows||g.DEFAULT_SETTINGS.collectionRows;var n=e.columns||g.DEFAULT_SETTINGS.collectionColumns;var o=e.tileSize||g.DEFAULT_SETTINGS.collectionTileSize;var s=o+(e.tileMargin||g.DEFAULT_SETTINGS.collectionTileMargin);var a;a=!e.rows&&n?n:Math.ceil(this._items.length/r);var l=0;var h=0;var c,u,d;this.setAutoRefigureSizes(!1);for(var p=0;p<this._items.length;p++){if(p&&p%a==0)if("horizontal"===i){h+=s;l=0}else{l+=s;h=0}d=(u=(d=(c=this._items[p]).getBoundsNoRotate()).width>d.height?o:o*(d.width/d.height))*(d.height/d.width);d=new g.Point(l+(o-u)/2,h+(o-d)/2);c.setPosition(d,t);c.setWidth(u,t);"horizontal"===i?l+=s:h+=s}this.setAutoRefigureSizes(!0)},_figureSizes:function(){var e=this._homeBounds?this._homeBounds.clone():null;var t=this._contentSize?this._contentSize.clone():null;var i=this._contentFactor||0;if(this._items.length){var r=this._items[0];var n=r.getBounds();this._contentFactor=r.getContentSize().x/n.width;var o=r.getClippedBounds().getBoundingBox();var s=o.x;var a=o.y;var l=o.x+o.width;var h=o.y+o.height;for(var c=1;c<this._items.length;c++){n=(r=this._items[c]).getBounds();this._contentFactor=Math.max(this._contentFactor,r.getContentSize().x/n.width);o=r.getClippedBounds().getBoundingBox();s=Math.min(s,o.x);a=Math.min(a,o.y);l=Math.max(l,o.x+o.width);h=Math.max(h,o.y+o.height)}this._homeBounds=new g.Rect(s,a,l-s,h-a);this._contentSize=new g.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}else{this._homeBounds=new g.Rect(0,0,1,1);this._contentSize=new g.Point(1,1);this._contentFactor=1}this._contentFactor===i&&this._homeBounds.equals(e)&&this._contentSize.equals(t)||this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(e){this.raiseEvent("remove-item",{item:e})}})}(OpenSeadragon);!function(o){o.WebGLModule=class extends o.EventSource{constructor(e){super();if(!this.constructor.idPattern.test(e.uniqueId))throw new Error("$.WebGLModule::constructor: invalid ID! Id can contain only letters, numbers and underscore. ID: "+e.uniqueId);this.uniqueId=e.uniqueId;this.webGLPreferredVersion=e.webGLPreferredVersion;this.ready=e.ready;this.resetCallback=e.resetCallback;this.refetchCallback=e.refetchCallback;this.debug=e.debug;this.interactive=!!e.interactive;this.running=!1;this._program=null;this._shaders={};this._shadersOrder=[];this._programImplementations={};this.canvasContextOptions=e.canvasOptions;var t=document.createElement("canvas");const i=this.constructor.determineContext(this.webGLPreferredVersion);e=o.WebGLModule.WebGLImplementation.createWebglContext(t,this.webGLPreferredVersion,this.canvasContextOptions);if(!e)throw new Error("$.WebGLModule::constructor: Could not create WebGLRenderingContext!");this.gl=e;this.webglContext=new i(this,e);this.canvas=t;this.webglContext.init()}static determineContext(e){var t=o.WebGLModule;for(var i in t){const r=t[i],n=r.prototype;if(n&&n instanceof t.WebGLImplementation&&o.isFunction(n.getVersion)&&n.getVersion.call(r)===e)return r}throw new Error("$.WebGLModule::determineContext: Could not find WebGLImplementation with version "+e)}get webglVersion(){return this.webglContext.webGLVersion}setDimensions(e,t,i,r,n){this.canvas.width=i;this.canvas.height=r;this.gl.viewport(e,t,i,r);this.webglContext.setDimensions(e,t,i,r,n)}firstPassProcessData(e){const t=this._programImplementations[this.webglContext.firstPassProgramKey];this.useProgram(t,"first-pass")&&t.load();return t.use(e)}secondPassProcessData(e,t){const i=this._programImplementations[this.webglContext.secondPassProgramKey];this.useProgram(i,"second-pass")&&i.load(t);return i.use(e,t)}registerProgram(e,t=void 0){t=t||String(Date.now());e=e||this._programImplementations[t];this._programImplementations[t]&&this.deleteProgram(t);var i=this.gl.createProgram();e._webGLProgram=i;e.build(this._shaders,this._shadersOrder||Object.keys(this._shaders));e.requiresLoad=!0;if(!e.vertexShader||!e.fragmentShader){this.gl.deleteProgram(i);e._webGLProgram=null;throw Error("Program does not define vertexShader or fragmentShader shader property!")}this._programImplementations[t]=e;if(o.WebGLModule.WebGLImplementation._compileProgram(i,this.gl,e,o.console.error,this.debug)){e.created(i,this.canvas.width,this.canvas.height);return t}}useProgram(e,t){e instanceof o.WebGLModule.Program||(e=this.getProgram(e));if(this.running&&this._program===e)return!1;this._program&&this._program.unload();this._program=e;this.gl.useProgram(e.webGLProgram);var i=this._program.requiresLoad;this._program.requiresLoad=!1;if(i){this.raiseEvent("program-used",{name:t,program:e,shaderLayers:this._shaders});if("second-pass"===t)for(const r of Object.values(this._shaders))r.init()}if(!this.running){setTimeout(()=>this.ready());this.running=!0}return i}requireLoad(){}getProgram(e){return this._programImplementations[e]}deleteProgram(e){const t=this._programImplementations[e];if(t){t.destroy();this.gl.deleteProgram(t._webGLProgram);this._programImplementations[e]=null}}createShaderLayer(e,t){const i=o.WebGLModule.ShaderMediator.getClass(t.type);if(!i)throw new Error(`$.WebGLModule::createShaderLayer: Unknown shader type '${t.type}'!`);void 0===t.visible&&(t.visible=1);const r=new i(e,{shaderConfig:t,webglContext:this.webglContext,controls:t._controls,cache:t._cache,params:t.params,interactive:this.interactive,invalidate:this.resetCallback,rebuild:()=>{this.registerProgram(null,this.webglContext.secondPassProgramKey)},refetch:this.refetchCallback});r.construct();this._shaders[e]=r;return r}getAllShaders(){return this._shaders}setShaderLayerOrder(e){this._shadersOrder=e}getShaderLayerOrder(){return this._shadersOrder}removeShader(e){const t=this._shaders[e];if(t){t.destroy();delete this._shaders[e]}}deleteShaders(){for(var e in this._shaders)this.removeShader(e)}setDataBlendingEnabled(e){if(e){this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)}else this.gl.disable(this.gl.BLEND)}destroy(){for(var e in this._programImplementations)this.deleteProgram(e);this.webglContext.destroy();this._programImplementations={}}};o.WebGLModule.idPattern=/^(?!_)(?:(?!__)[0-9a-zA-Z_])*$/;o.WebGLModule.BLEND_MODE=["mask","source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighten","darken","copy","xor","multiply","screen","overlay","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"];o.WebGLModule.jsonReplacer=function(e,t){return e.startsWith("_")||["eventSource"].includes(e)?void 0:t}}(OpenSeadragon);!function(o){o.WebGLModule.ShaderMediator=class{static registerLayer(e){if(this._acceptsShaders){this._layers[e.type()]&&console.warn(`OpenSeadragon.WebGLModule.ShaderMediator::registerLayer: ShaderLayer ${e.type()} already registered, overwriting the content!`);this._layers[e.type()]=e}else console.warn("OpenSeadragon.WebGLModule.ShaderMediator::registerLayer: ShaderMediator is set to not accept new ShaderLayers!")}static setAcceptsRegistrations(e){!0===e||!1===e?this._acceptsShaders=e:console.warn("OpenSeadragon.WebGLModule.ShaderMediator::setAcceptsRegistrations: Accepts parameter must be either true or false!")}static getClass(e){return this._layers[e]}static availableShaders(){return Object.values(this._layers)}static availableTypes(){return Object.keys(this._layers)}};o.WebGLModule.ShaderMediator._acceptsShaders=!0;o.WebGLModule.ShaderMediator._layers={};o.WebGLModule.ShaderLayer=class{constructor(e,t){this.id=e;this.uid=this.constructor.type().replaceAll("-","_")+"_"+e;o.WebGLModule.idPattern.test(this.uid)||console.error(`Invalid ID for the shader: ${e} does not match to the pattern`,o.WebGLModule.idPattern);this.__shaderConfig=t.shaderConfig;this.webglContext=t.webglContext;this._interactive=t.interactive;this._cache=t.cache||{};this._customControls=t.params||{};this.invalidate=t.invalidate;this._rebuild=t.rebuild;this._refetch=t.refetch;this.__channels=null;this._mode=null;this.__scalePrefix=null;this.__scaleSuffix=null}construct(){this.resetChannel(this._customControls);this.resetMode(this._customControls);this.resetFilters(this._customControls)}static toShaderFloatString(e,t,i=5){(!Number.isInteger(i)||i<0||9<i)&&(i=5);try{return e.toFixed(i)}catch(e){return t.toFixed(i)}}static type(){throw"ShaderLayer::type() must be implemented!"}static name(){throw"ShaderLayer::name() must be implemented!"}static description(){return"No description of the ShaderLayer."}static sources(){throw"ShaderLayer::sources() must be implemented!"}static get defaultControls(){return{}}getFragmentShaderExecution(){throw"ShaderLayer::getFragmentShaderExecution must be implemented!"}getFragmentShaderDefinition(){return[].join("\n    ")}init(){}glLoaded(e,t){}glDrawing(e,t){}includeGlobalCode(e,t){const i=this.constructor.__globalIncludes;i[e]&&console.warn("$.WebGLModule.ShaderLayer::includeGlobalCode: Global code with key",e,"already exists in this.__globalIncludes. Overwriting the content!");i[e]=t}destroy(){}loadProperty(e,t){e=this._cache[e];return void 0!==e?e:t}storeProperty(e,t){this._cache[e]=t}resetChannel(o={}){0===Object.keys(o)&&(o=this._customControls);const s=new RegExp("[rgba]{1,4}");const i=(t,i,r)=>{var n=this.constructor.defaultControls[t];if(o[t]||n){let e=n?n.required||n.default:void 0;e=e||this.loadProperty(t,o[t]);if(!e||"string"!=typeof e||null===s.exec(e)){console.warn(`Invalid channel '${t}'. Will use channel '${i}'.`,e,o);this.storeProperty(t,i);e=i}if(!r.acceptsChannelCount(e.length))throw`${this.constructor.name()} does not support channel length ${e.length} for channel: `+e;e!==o[t]&&this.storeProperty(t,e);return e}return i};this.__channels=this.constructor.sources().map((e,t)=>i("use_channel"+t,"r",e))}sampleChannel(e,t=0,i=!1){var r=this.__channels[t];r=this.webglContext.sampleTexture(t,e)+"."+r;return i?r:this.filter(r)}getTextureSize(e=0){return this.webglContext.getTextureSize(e)}resetMode(e={}){this._mode=this._resetOption("use_mode",this.webglContext.supportedUseModes,e);this._blend=this._resetOption("use_blend",OpenSeadragon.WebGLModule.BLEND_MODE,e)}_resetOption(e,t,i={}){let r;i=i||this._customControls;var n=this.constructor.defaultControls[e];r=n&&n.required;if(!r)if(i[e]){r=this.loadProperty(e,i[e]);r===i[e]&&this.storeProperty(e,r)}else r=n&&n.default||t[0];if(t.includes(r))return r;o.console.warn(`Invalid ${e}: ${r}. Using default`,t[0]);return t[0]}getCustomBlendFunction(e){let t=this.webglContext.getBlendingFunction(this._blend);if(!t){o.console.warn("Invalid blending - using default",this._blend,this);this._blend="mask";t=this.webglContext.getBlendingFunction(this._blend)}return`vec4 ${e}(vec4 fg, vec4 bg) {
${t}
}`}getConfig(){return this.__shaderConfig}resetFilters(t={}){0===Object.keys(t)&&(t=this._customControls);this.__scalePrefix=[];this.__scaleSuffix=[];for(var i in this.constructor.filters){var r=this.constructor.defaultControls[i];let e=r?r.required:void 0;void 0===e&&(e=t[i]?this.loadProperty(i,t[i]):r?r.default:void 0);if(void 0!==e){i=this.constructor.filters[i](e);this.__scalePrefix.push(i[0]);this.__scaleSuffix.push(i[1])}}this.__scalePrefix=this.__scalePrefix.join("");this.__scaleSuffix=this.__scaleSuffix.reverse().join("")}filter(e){return""+this.__scalePrefix+e+this.__scaleSuffix}setFilterValue(e,t){this.constructor.filterNames[e]?this.storeProperty(e,t):console.error("Invalid filter name",e)}getFilterValue(e,t){return this.loadProperty(e,t)}isFlag(e){return"1"===e||!0===e||"true"===e}isFlagOrMissing(e){return void 0===e||this.isFlag(e)}toShaderFloatString(e,t,i=5){return this.constructor.toShaderFloatString(e,t,i)}get mode(){return this._mode}};o.WebGLModule.ShaderLayer.customParams={};o.WebGLModule.ShaderLayer.__globalIncludes={};o.WebGLModule.ShaderLayer.filters={};o.WebGLModule.ShaderLayer.filters.use_gamma=e=>["exp(log(",`) / ${o.WebGLModule.ShaderLayer.toShaderFloatString(e,1)})`];o.WebGLModule.ShaderLayer.filters.use_exposure=e=>["(1.0 - exp(-(",`)* ${o.WebGLModule.ShaderLayer.toShaderFloatString(e,1)}))`];o.WebGLModule.ShaderLayer.filters.use_logscale=e=>[`((log(${e=o.WebGLModule.ShaderLayer.toShaderFloatString(e,1)} + (`,`)) - log(${e})) / (log(${e}+1.0)-log(${e})))`];o.WebGLModule.ShaderLayer.filterNames={};o.WebGLModule.ShaderLayer.filterNames.use_gamma="Gamma";o.WebGLModule.ShaderLayer.filterNames.use_exposure="Exposure";o.WebGLModule.ShaderLayer.filterNames.use_logscale="Logarithmic scale"}(OpenSeadragon);!function(u){u.WebGLModule.WebGLImplementation=class{constructor(e,t,i){this.renderer=e;this.gl=t;this.webGLVersion=i}static createWebglContext(e,t,i){i.alpha=!0;i.premultipliedAlpha=!0;return"1.0"===t?e.getContext("webgl",i):e.getContext("webgl2",i)}get firstPassProgramKey(){throw"$.WebGLModule.WebGLImplementation::firstPassProgram must be implemented!"}get secondPassProgramKey(){throw"$.WebGLModule.WebGLImplementation::secondPassProgram must be implemented!"}init(){}static _compileProgram(e,n,t,i,r=!1){function o(e,t,i,r){if(n["get"+e+"Parameter"](i,n[t+"_STATUS"]))return!0;u.console.error((r||"LINK")+":\n"+n["get"+e+"InfoLog"](i));return!1}function s(e,t,i,r){var n=e.createShader(e[r]);e.shaderSource(n,i);e.compileShader(n);e.attachShader(t,n);return o("Shader","COMPILE",t[r]=n,r)}function a(e){return e.split("\n").map((e,t)=>t+1+" "+e).join("\n")}if(s(n,e,t.vertexShader,"VERTEX_SHADER")&&s(n,e,t.fragmentShader,"FRAGMENT_SHADER")){n.linkProgram(e);if(!o("Program","LINK",e)){i("Unable to correctly build WebGL program.","Linking of WebGLProgram failed. For more information, see logs in the $.console.");u.console.warn("VERTEX SHADER\n",a(t.vertexShader));u.console.warn("FRAGMENT SHADER\n",a(t.fragmentShader));return!1}if(r){u.console.info("VERTEX SHADER\n",a(t.vertexShader));u.console.info("FRAGMENT SHADER\n",a(t.fragmentShader))}return!0}i("Unable to correctly build WebGL shaders.","Attaching of shaders to WebGLProgram failed. For more information, see logs in the $.console.");u.console.warn("VERTEX SHADER\n",a(t.vertexShader));u.console.warn("FRAGMENT SHADER\n",a(t.fragmentShader));return!1}getVersion(){throw"$.WebGLModule.WebGLImplementation::getVersion() must be implemented!"}sampleTexture(){throw"$.WebGLModule.WebGLImplementation::sampleTexture() must be implemented!"}getTextureSize(){throw"$.WebGLModule.WebGLImplementation::getTextureSize() must be implemented!"}getShaderLayerGLSLIndex(){throw"$.WebGLModule.WebGLImplementation::getShaderLayerGLSLIndex() must be implemented!"}createProgram(){throw"$.WebGLModule.WebGLImplementation::createProgram() must be implemented!"}loadProgram(){throw"$.WebGLModule.WebGLImplementation::loadProgram() must be implemented!"}useProgram(){throw"$.WebGLModule.WebGLImplementation::useProgram() must be implemented!"}setDimensions(e,t,i,r,n){}destroy(){}get supportedUseModes(){return["show","mask","mask_clip"]}getBlendingFunction(e){throw"$.WebGLModule.WebGLImplementation::blendingFunction must be implemented!"}};u.WebGLModule.Program=class{constructor(e,t){this.gl=t;this.context=e;this._webGLProgram=null;this.requiresLoad=!0;this.fragmentShader="";this.vertexShader=""}get webGLProgram(){if(!this._webGLProgram)throw Error("Program accessed without registration - did you call this.renderer.registerProgram()?");return this._webGLProgram}build(e,t){}created(e,t){}requireLoad(){this.requiresLoad=!0}load(){}use(){}unload(){}destroy(){}setDimensions(e,t,i,r,n){}printN(t,i,r=""){const n=new Array(i);for(let e=0;e<i;e++)n[e]=r+t(e);return n.join("\n")}};u.WebGLModule.WebGL10=class extends u.WebGLModule.WebGLImplementation{constructor(e,t){super(e,t,"1.0");u.console.info("WebGl 1.0 renderer.");this._viewport=new Float32Array([0,1,1,0,0,1,1,1,1,1,0,1]);this._locationPosition=null;this._bufferPosition=null;this._locationTransformMatrix=null;this._shadersMapping={};this._locationShaderLayerIndex=null;this._locationTextures=null;this._locationTextureCoords=null;this._bufferTextureCoords=null;this._locationPixelSize=null;this._locationZoomLevel=null;this._locationGlobalAlpha=null}getVersion(){return"1.0"}sampleTexture(e,t){return`osd_texture(${e}, ${t})`}getTextureSize(e){return`osd_texture_size(${e})`}getShaderLayerGLSLIndex(e){return this._shadersMapping[e]}createProgram(e){const t=this.gl;var i=t.createProgram();let r="",n="";let o=1;for(const h in e){const c=e[h];var s=o++;this._shadersMapping[c.uid]=s;r+=`
    // Definition of ${c.constructor.type()} shader:
`;r+=c.getFragmentShaderDefinition();r+="\n";r+=`
 ${this.getModeFunction()}
    vec4 ${c.uid}_execution() {${c.getFragmentShaderExecution()}
    }`;r+="\n\n";n+=` else if (u_shaderLayerIndex == ${s}) {
            vec4 ${c.uid}_out = ${c.uid}_execution();`;n+=`
            ${c.uid}_blend_mode(${c.uid}_out);
        }`}var a=this._getVertexShaderSource();var l=this._getFragmentShaderSource(r,n,"",u.WebGLModule.ShaderLayer.__globalIncludes);if(!this.constructor._compileProgram(i,t,{vertexShader:a,fragmentShader:l},u.console.error,this.renderer.debug))throw new Error("$.WebGLModule.WebGL10::createProgram: WebGLProgram could not be built!");return i}loadProgram(e,t){const i=this.gl;for(const r of Object.values(t))r.glLoaded(e,i);this._locationTransformMatrix=i.getUniformLocation(e,"u_transform_matrix");this._locationPosition=i.getAttribLocation(e,"a_position");this._bufferPosition=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,this._bufferPosition);i.bufferData(i.ARRAY_BUFFER,new Float32Array([0,0,0]),i.STATIC_DRAW);i.enableVertexAttribArray(this._locationPosition);i.vertexAttribPointer(this._locationPosition,3,i.FLOAT,!1,0,0);this._locationTextureCoords=i.getAttribLocation(e,"a_texture_coords");this._bufferTextureCoords=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,this._bufferTextureCoords);i.bufferData(i.ARRAY_BUFFER,new Float32Array([0,0]),i.STATIC_DRAW);i.enableVertexAttribArray(this._locationTextureCoords);i.vertexAttribPointer(this._locationTextureCoords,2,i.FLOAT,!1,0,0);this._locationPixelSize=i.getUniformLocation(e,"u_pixel_size");this._locationZoomLevel=i.getUniformLocation(e,"u_zoom_level");this._locationGlobalAlpha=i.getUniformLocation(e,"u_global_alpha");this._locationShaderLayerIndex=i.getUniformLocation(e,"u_shaderLayerIndex");this._locationTextures=i.getUniformLocation(e,"u_textures");i.uniform1i(this._locationTextures,0);i.activeTexture(i.TEXTURE0)}useProgram(e,t,i,r){const n=this.gl;i.glDrawing(e,n);i=this.getShaderLayerGLSLIndex(i.uid);n.uniform1i(this._locationShaderLayerIndex,i);n.uniform1f(this._locationPixelSize,t.pixelSize);n.uniform1f(this._locationZoomLevel,t.zoom);n.uniform1f(this._locationGlobalAlpha,t.globalOpacity);n.bindBuffer(n.ARRAY_BUFFER,this._bufferPosition);n.bufferData(n.ARRAY_BUFFER,this._viewport,n.STATIC_DRAW);n.bindBuffer(n.ARRAY_BUFFER,this._bufferTextureCoords);n.bufferData(n.ARRAY_BUFFER,t.textureCoords,n.STATIC_DRAW);n.uniformMatrix3fv(this._locationTransformMatrix,!1,t.transform);n.bindTexture(n.TEXTURE_2D,r);n.drawArrays(n.TRIANGLE_STRIP,0,4)}drawJoinTilesForViewport(e,t,i){const r=this.gl;r.uniform1i(this._locationShaderLayerIndex,0);r.bindBuffer(r.ARRAY_BUFFER,this._bufferPosition);r.bufferData(r.ARRAY_BUFFER,this._viewport,r.STATIC_DRAW);r.bindBuffer(r.ARRAY_BUFFER,this._bufferTextureCoords);r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW);r.uniformMatrix3fv(this._locationTransformMatrix,!1,e);r.bindTexture(r.TEXTURE_2D,i);r.drawArrays(r.TRIANGLE_STRIP,0,4)}_getTextureDefinition(i=1){return`
    uniform sampler2D u_textures[${i}];
    vec4 osd_texture(int index, vec2 coords) {
        ${function(){let t=`if (index == 0) {
            return texture2D(u_textures[0], coords);
        }`;if(1===i)return t;for(let e=1;e<i;e++)t+=` else if (index == ${e}) {
            return texture2D(u_textures[${e}], coords);
        }`;return t}()}
    }

    // TODO: WebGL1 needs an uniform (here array probably)
    ivec2 osd_texture_size(int index) {
        return ivec2(1, 1);
    }
    `}_getVertexShaderSource(){return`
    precision mediump int;
    precision mediump float;
    /* This program is used for single-pass rendering and for second-pass during two-pass rendering. */

    attribute vec2 a_texture_coords;
    varying vec2 v_texture_coords;

    attribute vec3 a_position;
    uniform mat3 u_transform_matrix;

    void main() {
        v_texture_coords = a_texture_coords;
        gl_Position = vec4(u_transform_matrix * a_position, 1.0);
}`}_getFragmentShaderSource(e,t,i,r){return`
    precision mediump int;
    precision mediump float;
    precision mediump sampler2D;

    uniform float u_pixel_size;
    uniform float u_zoom_level;
    uniform float u_global_alpha;
    uniform int u_shaderLayerIndex;


    // TEXTURES
    varying vec2 v_texture_coords;
    ${this._getTextureDefinition()}

    // UTILITY function
    bool close(float value, float target) {
        return abs(target - value) < 0.001;
    }

    // BLEND attributes
    vec4 overall_color = vec4(.0);
    vec4 last_color = vec4(.0);
    vec4 current_color = vec4(.0);
    int last_blend_func_id = -1000;
    void deffered_blend();


    // GLOBAL SCOPE CODE:${0!==Object.keys(r).length?Object.values(r).join("\n"):"\n    // No global scope code here..."}

    // DEFINITIONS OF SHADERLAYERS:${""!==e?e:"\n    // Any non-default shaderLayer here to define..."}


    // DEFFERED BLENDING mechanism:
    void deffered_blend() {
        // predefined "additive blending":
        if (last_blend_func_id == -1) {
            overall_color = last_color + overall_color;

        // predefined "premultiplied alpha blending":
        } else if (last_blend_func_id == -2) {
            vec4 pre_fg = vec4(last_color.rgb * last_color.a, last_color.a);
            overall_color = pre_fg + overall_color * (1.0 - pre_fg.a);


        // non-predefined, custom blending functions:
        }${""===i?"\n            // No custom blending function here...":i}
    }


    void main() {
        // EXECUTIONS OF SHADERLAYERS:
        ${t}

        // default case; should not happen
        else {
            if (osd_texture(0, v_texture_coords).rgba == vec4(.0)) {
                gl_FragColor = vec4(.0);
            } else { // render only where there's data in the texture
                gl_FragColor = vec4(1, 0, 0, 0.5);
            }
            return;
        }

        // blend last level
        deffered_blend();
        gl_FragColor = overall_color * u_global_alpha;
    }`}getModeFunction(e){let t=`void ${e.uid}_blend_mode(vec4 color) {`;"show"===e._mode?t+=`
        // blend last_color with overall_color using blend_func of the last shader using deffered blending
        deffered_blend();
        last_color = color;
        // switch case -2 = predefined "premultiplied alpha blending"
        last_blend_func_id = -2;
    }`:"mask"===e._mode?t+=`
        // blend last_color with overall_color using blend_func of the last shader using deffered blending
        deffered_blend();
        last_color = color;
        // switch case pointing to this.getCustomBlendFunction() code
        last_blend_func_id = ${this.getShaderLayerGLSLIndex(e.uid)};
    }`:"mask_clip"===e._mode&&(t+=`
        last_color = ${e.uid}_blend_func(color, last_color);
    }`);return t}}}(OpenSeadragon);!function(c){c.WebGLModule.WebGL20=class extends c.WebGLModule.WebGLImplementation{constructor(e,t){super(e,t,"2.0");c.console.info("WebGl 2.0 renderer.")}get firstPassProgramKey(){return"firstPass"}get secondPassProgramKey(){return"secondPass"}init(){this.renderer.registerProgram(new c.WebGLModule.WebGL20.FirstPassProgram(this,this.gl),"firstPass");this.renderer.registerProgram(new c.WebGLModule.WebGL20.SecondPassProgram(this,this.gl),"secondPass")}getVersion(){return"2.0"}sampleTexture(e,t){return`osd_texture(${e}, ${t})`}getTextureSize(e){return`osd_texture_size(${e})`}setDimensions(e,t,i,r,n){this.renderer.getProgram(this.firstPassProgramKey).setDimensions(e,t,i,r,n);this.renderer.getProgram(this.secondPassProgramKey).setDimensions(e,t,i,r,n)}getBlendingFunction(e){return{mask:`
if (close(fg.a, 0.0))  return vec4(.0);
return bg;`,"source-over":`
if (!stencilPasses) return bg;
vec4 pre_fg = vec4(fg.rgb * fg.a, fg.a);
return pre_fg + bg * (1.0 - pre_fg.a);`,"source-in":`
if (!stencilPasses) return bg;
return vec4(fg.rgb * bg.a, fg.a * bg.a);`,"source-out":`
if (!stencilPasses) return bg;
return vec4(fg.rgb * (1.0 - bg.a), fg.a * (1.0 - bg.a));`,"source-atop":`
if (!stencilPasses) return bg;
vec3 rgb = fg.rgb * bg.a + bg.rgb * (1.0 - fg.a);
float a = fg.a * bg.a + bg.a * (1.0 - fg.a);
return vec4(rgb, a);`,"destination-over":`
if (!stencilPasses) return bg;
vec4 pre_bg = vec4(bg.rgb * bg.a, bg.a);
return pre_bg + fg * (1.0 - pre_bg.a);`,"destination-in":`
if (!stencilPasses) return bg;
return vec4(bg.rgb * fg.a, fg.a * bg.a);`,"destination-out":`
if (!stencilPasses) return bg;
return vec4(bg.rgb * (1.0 - fg.a), bg.a * (1.0 - fg.a));`,"destination-atop":`
if (!stencilPasses) return bg;
vec3 rgb = bg.rgb * fg.a + fg.rgb * (1.0 - bg.a);
float a = bg.a * fg.a + fg.a * (1.0 - bg.a);
return vec4(rgb, a);`,lighten:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, max(fg.rgb, bg.rgb));`,darken:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, min(fg.rgb, bg.rgb));`,copy:`
if (!stencilPasses) return bg;
return fg;`,xor:`
if (!stencilPasses) return bg;
vec3 rgb = fg.rgb * (1.0 - bg.a) + bg.rgb * (1.0 - fg.a);
float a = fg.a + bg.a - 2.0 * fg.a * bg.a;
return vec4(rgb, a);`,multiply:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, fg.rgb * bg.rgb);`,screen:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, 1.0 - (1.0 - fg.rgb) * (1.0 - bg.rgb));`,overlay:`
if (!stencilPasses) return bg;
vec3 rgb = mix(2.0 * fg.rgb * bg.rgb, 1.0 - 2.0 * (1.0 - fg.rgb) * (1.0 - bg.rgb), step(0.5, bg.rgb));
return blendAlpha(fg, bg, rgb);`,"color-dodge":`
if (!stencilPasses) return bg;
vec3 rgb = bg.rgb / (1.0 - fg.rgb + 1e-5);
return blendAlpha(fg, bg, min(rgb, 1.0));`,"color-burn":`
if (!stencilPasses) return bg;
vec3 rgb = 1.0 - ((1.0 - bg.rgb) / (fg.rgb + 1e-5));
return blendAlpha(fg, bg, clamp(rgb, 0.0, 1.0));`,"hard-light":`
if (!stencilPasses) return bg;
vec3 rgb = mix(2.0 * fg.rgb * bg.rgb, 1.0 - 2.0 * (1.0 - fg.rgb) * (1.0 - bg.rgb), step(0.5, fg.rgb));
return blendAlpha(fg, bg, rgb);`,"soft-light":`
if (!stencilPasses) return bg;
vec3 rgb = (bg.rgb < 0.5)
    ? (2.0 * fg.rgb * bg.rgb + fg.rgb * fg.rgb * (1.0 - 2.0 * bg.rgb))
    : (sqrt(fg.rgb) * (2.0 * bg.rgb - 1.0) + 2.0 * fg.rgb * (1.0 - bg.rgb));
return blendAlpha(fg, bg, clamp(rgb, 0.0, 1.0));`,difference:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, abs(bg.rgb - fg.rgb));`,exclusion:`
if (!stencilPasses) return bg;
return blendAlpha(fg, bg, bg.rgb + fg.rgb - 2.0 * bg.rgb * fg.rgb);`}[e]}};c.WebGLModule.WebGL20.SecondPassProgram=class extends c.WebGLModule.Program{constructor(e,t){super(e,t);this._maxTextures=Math.min(t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),32);this.textureMappingsUniformSize=64}get webGLProgram(){if(!this._webGLProgram)throw Error("Program accessed without registration - did you call this.renderer.registerProgram()?");return this._webGLProgram}build(n,o){if(o.length){let e="",t=`
vec4 intermediate_color = vec4(.0);
vec4 clip_color = vec4(.0);
`;let i="";var s=()=>{if(i){var e=o.indexOf(i);var t=n[i];return`
    stencilPasses = texture(u_stencilTextures, vec3(v_texture_coords, float(${e}))).r > 0.95;
    overall_color = ${"show"===t.mode?"blend_source_over":t.uid+"_blend_func"}(intermediate_color, overall_color);
`}return""};let r=0;for(;r<o.length;r++){var a=o[r];const h=n[a];var l=h.getConfig();if("none"!==l.type&&!l.error&&l.visible){l=h,e+=`
// ${l.constructor.type()} - Definition
${l.getFragmentShaderDefinition()}
// ${l.constructor.type()} - Custom blending function for a given shader
${l.getCustomBlendFunction(l.uid+"_blend_func")}
// ${l.constructor.type()} - Shader code execution
vec4 ${l.uid}_execution() {
${l.getFragmentShaderExecution()}
}
`;t+=`
    stencilPasses = texture(u_stencilTextures, vec3(v_texture_coords, float(${r}))).r > 0.95;
    instance_id = ${r};
    vec3 attrs_${r} = u_shaderVariables[${r}];
    opacity = attrs_${r}.x;
    pixelSize = attrs_${r}.y;
    zoom = attrs_${r}.z;`;if("mask_clip"!==h._mode){t+=`${s()}
// ${h.constructor.type()} - Blending
intermediate_color = ${h.uid}_execution();
intermediate_color.a = intermediate_color.a * opacity;`;i=a}else t+=`
// ${h.constructor.type()} - Clipmask
clip_color = ${h.uid}_execution();
clip_color.a = clip_color.a * opacity;
intermediate_color = ${h.uid}_blend_func(clip_color, intermediate_color);`}else if("mask_clip"!==h._mode){t+=`${s()}
// ${h.constructor.type()} - Disabled (error or visible = false)
intermediate_color = vec4(.0);`;i=a}else t+=`
// ${h.constructor.type()} - Disabled with Clipmask (error or visible = false)
intermediate_color = ${h.uid}_blend_func(vec4(.0), intermediate_color);`}i&&(t+=s());this.vertexShader=this._getVertexShaderSource();this.fragmentShader=this._getFragmentShaderSource(e,t,"",c.WebGLModule.ShaderLayer.__globalIncludes)}else{this.vertexShader=this._getVertexShaderSource();this.fragmentShader=this._getFragmentShaderSource("","","",c.WebGLModule.ShaderLayer.__globalIncludes)}}created(e,t){const i=this.gl;var r=this.webGLProgram;this._instanceOffsets=i.getUniformLocation(r,"u_instanceOffsets");this._instanceTextureIndexes=i.getUniformLocation(r,"u_instanceTextureIndexes");this._shaderVariables=i.getUniformLocation(r,"u_shaderVariables");this._texturesLocation=i.getUniformLocation(r,"u_inputTextures");this._stencilLocation=i.getUniformLocation(r,"u_stencilTextures");this.vao=i.createVertexArray()}load(e){var t=this.gl;for(const i of e)i.shader.glLoaded(this.webGLProgram,t)}use(e,t){const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,null);i.bindVertexArray(this.vao);const r=[];const n=[];const o=[];for(const s of t){s.shader.glDrawing(this.webGLProgram,i);r.push(s.opacity,s.pixelSize,s.zoom);n.push(o.length);o.push(...s.shader.getConfig().tiledImages)}i.uniform1iv(this._instanceOffsets,n);i.uniform1iv(this._instanceTextureIndexes,o);i.uniform3fv(this._shaderVariables,r);i.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D_ARRAY,e.texture);i.uniform1i(this._texturesLocation,0);i.activeTexture(i.TEXTURE1);i.bindTexture(i.TEXTURE_2D_ARRAY,e.stencil);i.uniform1i(this._stencilLocation,1);i.drawArrays(i.TRIANGLE_STRIP,0,4);i.bindVertexArray(null)}destroy(){this.gl.deleteVertexArray(this.vao)}setDimensions(e,t,i,r,n){}_getVertexShaderSource(){return`#version 300 es
precision mediump int;
precision mediump float;

out vec2 v_texture_coords;

const vec3 viewport[4] = vec3[4] (
    vec3(-1.0, 1.0, 1.0),
    vec3(-1.0, -1.0, 1.0),
    vec3(1.0, 1.0, 1.0),
    vec3(1.0, -1.0, 1.0)
);

void main() {
    v_texture_coords = vec2(viewport[gl_VertexID]) / 2.0 + 0.5;
    gl_Position = vec4(viewport[gl_VertexID], 1.0);
}
`}_getFragmentShaderSource(e,t,i){return`#version 300 es
precision mediump int;
precision mediump float;
precision mediump sampler2DArray;

uniform int u_instanceTextureIndexes[${this.textureMappingsUniformSize}];
uniform int u_instanceOffsets[${this.textureMappingsUniformSize}];
uniform vec3 u_shaderVariables[${this.textureMappingsUniformSize}];

in vec2 v_texture_coords;

bool stencilPasses;
int instance_id;
float opacity;
float pixelSize;
float zoom;

uniform sampler2DArray u_inputTextures;
uniform sampler2DArray u_stencilTextures;

vec4 osd_texture(int index, vec2 coords) {
    int offset = u_instanceOffsets[instance_id];
    index = u_instanceTextureIndexes[offset + index];
    return texture(u_inputTextures, vec3(coords, float(index)));
}

ivec2 osd_texture_size(int index) {
    int offset = u_instanceOffsets[instance_id];
    index = u_instanceTextureIndexes[offset + index];
    return textureSize(u_inputTextures, index).xy;
}

// UTILITY function
bool close(float value, float target) {
    return abs(target - value) < 0.001;
}

// BLEND attributes
out vec4 overall_color;
vec4 blendAlpha(vec4 fg, vec4 bg, vec3 rgb) {
    float a = fg.a + bg.a * (1.0 - fg.a);
    return vec4(rgb, a);
}
vec4 blend_source_over(vec4 fg, vec4 bg) {
    if (!stencilPasses) return bg;
    vec4 pre_fg = vec4(fg.rgb * fg.a, fg.a);
    return pre_fg + bg * (1.0 - pre_fg.a);
}

// GLOBAL SCOPE CODE:${0!==Object.keys(i).length?Object.values(i).join("\n"):"\n    // No global scope code here..."}

// DEFINITIONS OF SHADERLAYERS:${""!==e?e:"\n    // Any non-default shaderLayer here to define..."}

void main() {
    ${t}
}`}};c.WebGLModule.WebGL20.FirstPassProgram=class extends c.WebGLModule.Program{constructor(e,t){super(e,t);this._maxTextures=Math.min(t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),32);this._textureIndexes=[...Array(this._maxTextures).keys()];this._maxAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS)}build(e,t){this.vertexShader=`#version 300 es
precision mediump int;
precision mediump float;

layout(location = 0) in mat3 a_transform_matrix;
layout(location = 4) in vec2 a_texture_coords;

uniform vec2 u_renderClippingParams;

out vec2 v_texture_coords;
flat out int instance_id;

const vec3 viewport[4] = vec3[4] (
    vec3(0.0, 1.0, 1.0),
    vec3(0.0, 0.0, 1.0),
    vec3(1.0, 1.0, 1.0),
    vec3(1.0, 0.0, 1.0)
);

in vec2 a_positions;

void main() {
    v_texture_coords = a_texture_coords;

    vec3 space_2d = u_renderClippingParams.x > 0.5 ?
        a_transform_matrix * vec3(a_positions, 1.0) :
        a_transform_matrix * viewport[gl_VertexID];

    gl_Position = vec4(space_2d.xy, 1.0, space_2d.z);
    instance_id = gl_InstanceID;
}
`;this.fragmentShader=`#version 300 es
precision mediump int;
precision mediump float;
precision mediump sampler2D;

uniform vec2 u_renderClippingParams;

flat in int instance_id;
in vec2 v_texture_coords;
uniform sampler2D u_textures[${this._maxTextures}];

layout(location=0) out vec4 outputColor;
layout(location=1) out float outputStencil;

void main() {
    if (u_renderClippingParams.x < 0.5) {
        // Iterate over tiles - textures for each tile (a texture array)
        for (int i = 0; i < ${this._maxTextures}; i++) {
            // Iterate over data in each tile if the index matches our tile
            if (i == instance_id) {
                 switch (i) {
    ${this.printN(e=>`case ${e}: outputColor = texture(u_textures[${e}], v_texture_coords); break;`,this._maxTextures,"                ")}
                 }
                 break;
            }
        }
        outputStencil = 1.0;
    }
}
`}created(e,t){const i=this.gl;var r=this.webGLProgram;let n=this.firstPassVao;if(!n){this.offScreenBuffer=i.createFramebuffer();this.firstPassVao=n=i.createVertexArray();this.matrixBuffer=i.createBuffer();this.texCoordsBuffer=i.createBuffer();this.matrixBufferClip=i.createBuffer();this.firstPassVaoClip=i.createVertexArray();this.positionsBufferClip=i.createBuffer()}this._inputTexturesLoc=i.getUniformLocation(r,"u_textures");this._renderClipping=i.getUniformLocation(r,"u_renderClippingParams");i.bindVertexArray(n);this._texCoordsBuffer=i.getAttribLocation(r,"a_texture_coords");i.bindBuffer(i.ARRAY_BUFFER,this.texCoordsBuffer);i.enableVertexAttribArray(this._texCoordsBuffer);i.vertexAttribPointer(this._texCoordsBuffer,2,i.FLOAT,!1,0,0);i.vertexAttribDivisor(this._texCoordsBuffer,0);var o=8*this._maxTextures*Float32Array.BYTES_PER_ELEMENT;i.bindBuffer(i.ARRAY_BUFFER,this.texCoordsBuffer);i.bufferData(i.ARRAY_BUFFER,o,i.DYNAMIC_DRAW);this._positionsBuffer=i.getAttribLocation(r,"a_positions");this._matrixBuffer=i.getAttribLocation(r,"a_transform_matrix");o=this._matrixBuffer;i.bindBuffer(i.ARRAY_BUFFER,this.matrixBuffer);i.enableVertexAttribArray(o);i.enableVertexAttribArray(o+1);i.enableVertexAttribArray(o+2);i.vertexAttribPointer(o,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,0);i.vertexAttribPointer(o+1,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,3*Float32Array.BYTES_PER_ELEMENT);i.vertexAttribPointer(o+2,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,6*Float32Array.BYTES_PER_ELEMENT);i.vertexAttribDivisor(o,1);i.vertexAttribDivisor(o+1,1);i.vertexAttribDivisor(o+2,1);r=9*this._maxTextures*Float32Array.BYTES_PER_ELEMENT;i.bufferData(i.ARRAY_BUFFER,r,i.STREAM_DRAW);n=this.firstPassVaoClip;i.bindVertexArray(n);i.bindBuffer(i.ARRAY_BUFFER,this.positionsBufferClip);i.enableVertexAttribArray(this._texCoordsBuffer);i.vertexAttribPointer(this._texCoordsBuffer,2,i.FLOAT,!1,0,0);i.bindBuffer(i.ARRAY_BUFFER,this.positionsBufferClip);i.enableVertexAttribArray(this._positionsBuffer);i.vertexAttribPointer(this._positionsBuffer,2,i.FLOAT,!1,0,0);i.bindBuffer(i.ARRAY_BUFFER,this.matrixBufferClip);i.enableVertexAttribArray(o);i.enableVertexAttribArray(o+1);i.enableVertexAttribArray(o+2);i.vertexAttribPointer(o,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,0);i.vertexAttribPointer(o+1,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,3*Float32Array.BYTES_PER_ELEMENT);i.vertexAttribPointer(o+2,3,i.FLOAT,!1,9*Float32Array.BYTES_PER_ELEMENT,6*Float32Array.BYTES_PER_ELEMENT);i.vertexAttribDivisor(o,1);i.vertexAttribDivisor(o+1,1);i.vertexAttribDivisor(o+2,1);i.bufferData(i.ARRAY_BUFFER,r,i.STREAM_DRAW);i.bindVertexArray(null)}load(){this.gl.uniform1iv(this._inputTexturesLoc,this._textureIndexes);this.gl.disable(this.gl.BLEND)}use(e){const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.offScreenBuffer);i.enable(i.STENCIL_TEST);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,this.stencilClipBuffer);this.fpTexture=this.colorTextureA;this.fpTextureClip=this.stencilTextureA;this._renderOffset=0;if(!this._tempMatrixData){this._tempMatrixData=new Float32Array(9*this._maxTextures);this._tempTexCoords=new Float32Array(8*this._maxTextures)}let r=!0;for(const l of e){var n=l.tiles;const h=[];i.framebufferTextureLayer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,this.fpTexture,0,this._renderOffset);h.push(i.COLOR_ATTACHMENT0);i.framebufferTextureLayer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+1,this.fpTextureClip,0,this._renderOffset);h.push(i.COLOR_ATTACHMENT0+1);i.drawBuffers(h);i.clear(i.COLOR_BUFFER_BIT|i.STENCIL_BUFFER_BIT);if(l.polygons.length){i.stencilFunc(i.ALWAYS,1,255);i.stencilOp(i.KEEP,i.KEEP,i.INCR);i.uniform2f(this._renderClipping,1,0);i.bindVertexArray(this.firstPassVaoClip);i.bindBuffer(i.ARRAY_BUFFER,this.matrixBufferClip);i.bufferSubData(i.ARRAY_BUFFER,0,new Float32Array(l._temp.values));for(const c of l.polygons){i.bindBuffer(i.ARRAY_BUFFER,this.positionsBufferClip);i.bufferData(i.ARRAY_BUFFER,new Float32Array(c),i.STATIC_DRAW);i.drawArrays(i.TRIANGLE_FAN,0,c.length/2)}i.stencilFunc(i.EQUAL,l.polygons.length,255);i.stencilOp(i.KEEP,i.KEEP,i.KEEP);i.uniform2f(this._renderClipping,0,0);r=!0}else if(r){i.uniform2f(this._renderClipping,0,0);i.stencilFunc(i.EQUAL,0,255);r=!1}i.bindVertexArray(this.firstPassVao);var o=n.length;let t=0;for(;t<o;){var s=Math.min(this._maxTextures,o-t);for(let e=0;e<s;e++){var a=n[t+e];i.activeTexture(i.TEXTURE0+e);i.bindTexture(i.TEXTURE_2D,a.texture);this._tempMatrixData.set(a.transformMatrix,9*e);this._tempTexCoords.set(a.position,8*e)}i.bindBuffer(i.ARRAY_BUFFER,this.texCoordsBuffer);i.bufferSubData(i.ARRAY_BUFFER,0,this._tempTexCoords.subarray(0,8*s));i.bindBuffer(i.ARRAY_BUFFER,this.matrixBuffer);i.bufferSubData(i.ARRAY_BUFFER,0,this._tempMatrixData.subarray(0,9*s));i.drawArraysInstanced(i.TRIANGLE_STRIP,0,4,s);t+=s}this._renderOffset++}i.disable(i.STENCIL_TEST);i.bindVertexArray(null);return{texture:this.fpTexture,stencil:this.fpTextureClip}}unload(){}setDimensions(e,t,i,r,n){this._createOffscreenTexture("colorTextureA",i,r,n,this.gl.LINEAR);this._createOffscreenTexture("colorTextureB",i,r,n,this.gl.LINEAR);this._createOffscreenTexture("stencilTextureA",i,r,n,this.gl.LINEAR);this._createOffscreenTexture("stencilTextureB",i,r,n,this.gl.LINEAR);const o=this.gl;this.stencilClipBuffer&&o.deleteRenderbuffer(this.stencilClipBuffer);this.stencilClipBuffer=o.createRenderbuffer();o.bindRenderbuffer(o.RENDERBUFFER,this.stencilClipBuffer);o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH24_STENCIL8,i,r)}destroy(){const e=this.gl;e.deleteFramebuffer(this.offScreenBuffer);this.offScreenBuffer=null;e.deleteTexture(this.colorTextureA);this.colorTextureA=null;e.deleteTexture(this.stencilTextureA);this.stencilTextureA=null;e.deleteTexture(this.colorTextureB);this.colorTextureB=null;e.deleteTexture(this.stencilTextureB);this.stencilTextureB=null;e.deleteBuffer(e.createRenderbuffer());this.stencilClipBuffer=null;e.deleteVertexArray(this.firstPassVao);e.deleteBuffer(this.matrixBuffer);e.deleteBuffer(this.texCoordsBuffer);this.matrixBuffer=null;this.firstPassVao=null;this.texCoordsBuffer=null;this.firstPassVaoClip=e.createVertexArray();e.deleteVertexArray(this.firstPassVaoClip);e.deleteBuffer(this.matrixBufferClip);this.matrixBufferClip=null;e.deleteBuffer(this.positionsBufferClip);this.positionsBufferClip=null}_createOffscreenTexture(e,t,i,r,n){r=Math.max(r,1);const o=this.gl;let s=this[e];s&&o.deleteTexture(s);this[e]=s=o.createTexture();o.bindTexture(o.TEXTURE_2D_ARRAY,s);o.texStorage3D(o.TEXTURE_2D_ARRAY,1,o.RGBA8,t,i,r);o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MIN_FILTER,n);o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MAG_FILTER,n);o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)}}}(OpenSeadragon);!function(_){const o=_;o.WebGLDrawerModular=class extends o.DrawerBase{constructor(e){super(e);this._destroyed=!1;this._backupCanvasDrawer=null;this._imageSmoothingEnabled=!1;this._configuredExternally=!1;this._supportedFormats=["blob","context2d","image"];if(0===this._id&&this.debug){const t=document.createElement("canvas");t.id="download-off-screen-textures";t.href="#";t.textContent="Download off-screen textures";const i=document.getElementById(this.options.debugInfoContainer);if(i)i.appendChild(t);else{console.warn('Element with id "panel-shaders" not found, appending download link for off-screen textures to body.');document.body.appendChild(t);t.style.position="absolute";t.style.top="0px"}t.style.width="250px";t.style.height="250px";this._debugCanvas=t;this._extractionFB=this.renderer.gl.createFramebuffer();this._debugIntermediate=document.createElement("canvas")}this.viewer.rejectEventHandler("tile-drawn","The WebGLDrawer does not raise the tile-drawn event");this.viewer.rejectEventHandler("tile-drawing","The WebGLDrawer does not raise the tile-drawing event");this.viewer.world.addHandler("remove-item",e=>{const t=e.item;if(t.__shaderConfig){this.renderer.removeShader(t.__shaderConfig.id);delete t.__shaderConfig;t.__wglCompositeHandler&&t.removeHandler("composite-operation-change",t.__wglCompositeHandler)}this._configuredExternally||this._requestRebuild()})}getType(){return"modular-webgl"}getSupportedDataFormats(){return this._supportedFormats}getRequiredDataFormats(){return this._supportedFormats}get defaultOptions(){return{usePrivateCache:!0,preloadCache:!0,copyShaderConfig:!1,debugInfoContainer:void 0}}setRenderingConfig(e,t=void 0){if(!!e){this._configuredExternally=!0;this.renderer.deleteShaders();for(var i in e){var r=e[i];this.setRenderingConfigShader(i,r)}t=t||Object.keys(e);this.renderer.setShaderLayerOrder(t);this._requestRebuild()}else if(this._configuredExternally){this._configuredExternally=!1;this.renderer.deleteShaders();this.viewer.world._items.map(e=>this.tiledImageCreated(e).id)}}configureTiledImage(e,t){t.id=t.id||this.constructor.idGenerator;e.__shaderConfig=t;e.__wglCompositeHandler&&this.tiledImageCreated(e);return t}getRenderingConfig(e){const t=this.renderer.getAllShaders()[e];return t?t.getConfig():void 0}setRenderingConfigShader(e,t){var i={id:this.constructor.idGenerator,name:"Layer",type:"identity",visible:1,fixed:!1,tiledImages:[0],params:{},cache:{}};if(this.options.copyShaderConfig)t=_.extend(!0,i,t);else for(var r in i)void 0===t[r]&&(t[r]=i[r]);t._renderContext=this.renderer.createShaderLayer(e,t)}tiledImageCreated(i){i.__wglCompositeHandler&&i.removeHandler("composite-operation-change",i.__wglCompositeHandler);if(this._configuredExternally){delete i.__shaderConfig;this._requestRebuild();return null}let e=i.__shaderConfig;e=e||(i.__shaderConfig={name:"Identity shader",type:"identity",visible:1,fixed:!1,params:{},cache:{}});e.id||(e.id=this.constructor.idGenerator);var t=e.id;var r=Object.getOwnPropertyDescriptor(e,"tiledImages");if(!r||r.configurable){delete e.tiledImages;Object.defineProperty(e,"tiledImages",{get:()=>[this.viewer.world.getIndexOfItem(i)]})}if(!e.params.use_blend&&i.compositeOperation){e.params.use_mode="mask";e.params.use_blend=i.compositeOperation}const n=this.renderer.createShaderLayer(t,e);e._renderContext=n;i.__wglCompositeHandler=e=>{const t=n.getConfig();t.params.use_blend=i.compositeOperation;t.params.use_mode="mask";n.resetMode(t.params,!1);this._requestRebuild(0)};i.addHandler("composite-operation-change",i.__wglCompositeHandler);this._requestRebuild();return e}destroy(){if(!this._destroyed){const i=this._gl;var t=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<t;++e){i.activeTexture(i.TEXTURE0+e);i.bindTexture(i.TEXTURE_2D,null);"2.0"===this.webGLVersion&&i.bindTexture(i.TEXTURE_2D_ARRAY,null)}i.bindBuffer(i.ARRAY_BUFFER,null);i.bindFramebuffer(i.FRAMEBUFFER,null);let e=i.getExtension("WEBGL_lose_context");e&&e.loseContext();this._gl=null;i.deleteFramebuffer(this._extractionFB);this.viewer.removeHandler("resize",this._resizeHandler);if(this._backupCanvasDrawer){this._backupCanvasDrawer.destroy();this._backupCanvasDrawer=null}this.container.removeChild(this.canvas);this.viewer.drawer===this&&(this.viewer.drawer=null);this._destroyed=!0}}_hasInvalidBuildState(){return this._requestBuildStamp>this._buildStamp}_requestRebuild(e=30,t=!1){this._requestBuildStamp=Date.now();if(this._rebuildHandle){if(!t)return;clearTimeout(this._rebuildHandle)}this._rebuildHandle=setTimeout(()=>{this._configuredExternally||this.renderer.setShaderLayerOrder(this.viewer.world._items.map(e=>e.__shaderConfig.id));this._buildStamp=Date.now();this.renderer.setDimensions(0,0,this.canvas.width,this.canvas.height,this.viewer.world.getItemCount());this.renderer.registerProgram(null,this.renderer.webglContext.secondPassProgramKey);this._rebuildHandle=null;setTimeout(()=>{this.viewer.world.needsDraw()})},e)}_setupCanvases(){this._resizeHandler=()=>{var e=this._calculateCanvasSize();this.debug&&console.info("Resize event, newWidth, newHeight:",e.x,e.y);this.renderer.setDimensions(0,0,e.x,e.y,this.viewer.world.getItemCount());this._size=e};this.viewer.addHandler("resize",this._resizeHandler)}draw(t){if(this._hasInvalidBuildState())this.viewer.world.needsDraw();else{var i=this._gl;if(t.every(e=>0===e.getOpacity()||0===e.getTilesToDraw().length))this.renderer.gl.clear(i.COLOR_BUFFER_BIT);else{var r=this.viewport.getBoundsNoRotateWithMargins(!0);var n={bounds:r,center:new o.Point(r.x+r.width/2,r.y+r.height/2),rotation:this.viewport.getRotation(!0)*Math.PI/180,zoom:this.viewport.getZoom(!0)};i=this.viewport.flipped?-1:1;r=_.Mat3.makeTranslation(-n.center.x,-n.center.y);let e=_.Mat3.makeScaling(2/n.bounds.width*i,-2/n.bounds.height);i=_.Mat3.makeRotation(-n.rotation);r=e.multiply(i).multiply(r);this._drawTwoPass(t,n,r)}}}_drawTwoPass(r,e,n){const t=this._gl;var i;const o=[];for(let i=0;i<r.length;i++){const g=r[i];const m=[];var s=g.getTilesToDraw();g.placeholderFillStyle&&!1===g._hasOpaqueTile&&this._drawPlaceholder(g);let t=n;var a=g.getRotation(!0);if(a%360!=0){var l=_.Mat3.makeRotation(-a*Math.PI/180);a=g.getBoundsNoRotate(!0).getCenter();let e=_.Mat3.makeTranslation(a.x,a.y);a=_.Mat3.makeTranslation(-a.x,-a.y);a=e.multiply(l).multiply(a);t=n.multiply(a)}for(let e=0;e<s.length;++e){var h=s[e].tile;var c=this.getDataToDraw(h);c&&m.push({transformMatrix:this._updateTileMatrix(c,h,g,t),dataIndex:i,texture:c.texture,position:c.position,tile:h})}let e;e=g._croppingPolygons?g._croppingPolygons.map(e=>e.flatMap(e=>{e=g.imageToViewportCoordinates(e.x,e.y,!0);return[e.x,e.y]})):[];if(g._clip){const f=[{x:g._clip.x,y:g._clip.y},{x:g._clip.x+g._clip.width,y:g._clip.y},{x:g._clip.x+g._clip.width,y:g._clip.y+g._clip.height},{x:g._clip.x,y:g._clip.y+g._clip.height}];e.push(f.flatMap(e=>{e=g.imageToViewportCoordinates(e.x,e.y,!0);return[e.x,e.y]}))}o.push({tiles:m,polygons:e,dataIndex:i,_temp:t})}i=this.renderer.firstPassProcessData(o);const u=[];var d=this.renderer.getAllShaders();for(var p of this.renderer.getShaderLayerOrder()){const v=d[p];p=v.getConfig();const y=this.viewer.world.getItemAt(p.tiledImages[0]);u.push({zoom:e.zoom,pixelSize:this._tiledImageViewportToImageZoom(y,e.zoom),opacity:y.getOpacity(),shader:v})}if(u.length){this.renderer.secondPassProcessData(i,u);this._renderingCanvasHasImageData=!0;t.finish()}else this.viewer.world.needsDraw()}_getTileRenderMeta(e,t){let i=e._renderStruct;if(i)return i;var r=t.source.tileOverlap;if(0<r){var n=e.sourceBounds.width;var o=e.sourceBounds.height;var s=(0===e.x?0:r)+(e.isRightMost?0:r);t=(0===e.y?0:r)+(e.isBottomMost?0:r);e._renderStruct=i={overlapX:r/(n+s),overlapY:r/(o+t)}}else e._renderStruct=i={overlapX:0,overlapY:0};return i}_updateTileMatrix(e,t,i,r){var n=this._getTileRenderMeta(t,i);var o=t.positionedBounds.width*n.overlapX;var s=t.positionedBounds.height*n.overlapY;i=t.positionedBounds.x+(0===t.x?0:o);n=t.positionedBounds.y+(0===t.y?0:s);o=t.positionedBounds.x+t.positionedBounds.width-(t.isRightMost?0:o);s=t.positionedBounds.y+t.positionedBounds.height-(t.isBottomMost?0:s);const a=new _.Mat3([o-i,0,0,0,s-n,0,i,n,1]);t.flipped&&a.scaleAndTranslateSelf(-1,1,1,0);a.scaleAndTranslateOtherSetSelf(r);return a.values}_tiledImageViewportToImageZoom(e,t){return e._scaleSpring.current.value*e.viewport._containerInnerSize.x/e.source.dimensions.x*t}_extractOffScreenTexture(t,i){let r=0;if(this._debugCanvas){const a=this._gl;var n=this._size.x;var o=this._size.y;a.bindFramebuffer(a.FRAMEBUFFER,this._extractionFB);this._debugCanvas.width=n;this._debugCanvas.height=o;this._debugIntermediate.width=n;this._debugIntermediate.height=o;const l=this._debugCanvas.getContext("2d");const h=this._debugIntermediate.getContext("2d");for(let e=0;e<2*i;e++){"1.0"===this.webGLVersion||a.framebufferTextureLayer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,t.texture,0,e);if(a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE){console.error("Framebuffer is not complete, could not extract offScreenTexture index "+e);return}var s=new Uint8ClampedArray(n*o*4);a.readPixels(0,0,n,o,a.RGBA,a.UNSIGNED_BYTE,s);s=new ImageData(s,n,o);h.putImageData(s,0,0);e%2==1?l.drawImage(this._debugIntermediate,r+25,r+25):l.drawImage(this._debugIntermediate,r,r);r+=7}a.bindFramebuffer(a.FRAMEBUFFER,null)}}canRotate(){return!0}static isSupported(){let e=document.createElement("canvas");let t=_.isFunction(e.getContext)&&e.getContext("webgl");let i=t&&t.getExtension("WEBGL_lose_context");i&&i.loseContext();return!!t}minimumOverlapRequired(e){return e.isTainted()}_createDrawingElement(){this._id=this.constructor.idGenerator;var e=_.extend({ready:()=>{},resetCallback:()=>{this.viewer.world.draw()},refetchCallback:()=>{this.viewer.world.resetItems()},debug:!1,webGLPreferredVersion:"2.0"},this.options,{uniqueId:"osd_"+this._id,canvasOptions:{stencil:!0}});this.renderer=new _.WebGLModule(e);this.renderer.setDataBlendingEnabled(!0);this.webGLVersion=this.renderer.webglVersion;this.debug=e.debug;const t=this.renderer.canvas;e=this._calculateCanvasSize();this._size=new _.Point(e.x,e.y);this._gl=this.renderer.gl;this._setupCanvases();t.width=e.x;t.height=e.y;return t}_getBackupCanvasDrawer(){if(!this._backupCanvasDrawer){this._backupCanvasDrawer=this.viewer.requestDrawer("canvas",{mainDrawer:!1});this._backupCanvasDrawer.canvas.style.setProperty("visibility","hidden");this._backupCanvasDrawer.getSupportedDataFormats=()=>this._supportedFormats;this._backupCanvasDrawer.getDataToDraw=this.getDataToDraw.bind(this)}return this._backupCanvasDrawer}setImageSmoothingEnabled(e){if(this._imageSmoothingEnabled!==e){this._imageSmoothingEnabled=e;this.setInternalCacheNeedsRefresh();this.viewer.requestInvalidate(!1)}}internalCacheCreate(e,h){let c=h.tiledImage;let u=this._gl;let d;let t=e.data;t instanceof CanvasRenderingContext2D&&(t=t.canvas);return createImageBitmap(t).then(e=>{let t,i;if(h.sourceBounds){t=Math.min(h.sourceBounds.width,e.width)/e.width;i=Math.min(h.sourceBounds.height,e.height)/e.height}else{t=1;i=1}if(0<c.source.tileOverlap){var r=this._getTileRenderMeta(h,c);var n=(0===h.x?0:r.overlapX)*t;var o=(0===h.y?0:r.overlapY)*i;var s=(h.isRightMost?1:1-r.overlapX)*t;r=(h.isBottomMost?1:1-r.overlapY)*i;d=new Float32Array([n,r,n,o,s,r,s,o])}else d=new Float32Array([0,i,0,0,t,i,t,0]);const a={position:d,texture:null};if(this.debug){a.debugTiledImage=c;a.debugCanvas=e}try{var l=u.createTexture();u.bindTexture(u.TEXTURE_2D,l);u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE);u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE);u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST);u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,this._imageSmoothingEnabled?this._gl.LINEAR:this._gl.NEAREST);u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e);a.texture=l;return a}catch(e){c.setTainted(!0);_.console.error("Error uploading image data to WebGL. Falling back to canvas renderer.",e);this._raiseDrawerErrorEvent(c,"Unknown error when uploading texture. Falling back to CanvasDrawer for this TiledImage.");this.setInternalCacheNeedsRefresh()}_.console.error("Unsupported data used for WebGL Drawer - probably a bug!");return{}}).catch(e=>{_.console.error("Unsupported data type! "+t,e)})}internalCacheFree(e){if(e&&e.texture){this._gl.deleteTexture(e.texture);e.texture=null}}drawDebuggingRect(e){let t=this._outputContext;t.save();t.lineWidth=2*_.pixelDensityRatio;t.strokeStyle=this.debugGridColor[0];t.fillStyle=this.debugGridColor[0];t.strokeRect(e.x*_.pixelDensityRatio,e.y*_.pixelDensityRatio,e.width*_.pixelDensityRatio,e.height*_.pixelDensityRatio);t.restore()}_drawPlaceholder(e){var t=e.getBounds(!0);var i=this.viewportToDrawerRectangle(e.getBounds(!0));const r=this._outputContext;let n;n="function"==typeof e.placeholderFillStyle?e.placeholderFillStyle(e,r):e.placeholderFillStyle;this._offsetForRotation({degrees:this.viewer.viewport.getRotation(!0)});r.fillStyle=n;r.translate(i.x,i.y);r.rotate(Math.PI/180*t.degrees);r.translate(-i.x,-i.y);r.fillRect(i.x,i.y,i.width,i.height);this._restoreRotationChanges()}_applyContext2dPipeline(e,t,i){this._outputContext.save();this._outputContext.globalCompositeOperation=0===i?null:e.compositeOperation||this.viewer.compositeOperation;this._outputContext.drawImage(this._renderingCanvas,0,0);this._outputContext.restore();if(e.debugMode){i=this.viewer.viewport.getFlip();i&&this._flip();this._drawDebugInfo(t,e,i);i&&this._flip()}}_setClip(){}_setRotations(e){var t=!1;if(this.viewport.getRotation(!0)%360!=0){this._offsetForRotation({degrees:this.viewport.getRotation(!0),saveContext:t});t=!1}e.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:e.getRotation(!0),point:this.viewport.pixelFromPointNoRotate(e._getRotationPoint(!0),!0),saveContext:t})}_offsetForRotation(e){var t=e.point?e.point.times(_.pixelDensityRatio):this._getCanvasCenter();var i=this._outputContext;i.save();i.translate(t.x,t.y);i.rotate(Math.PI/180*e.degrees);i.translate(-t.x,-t.y)}_flip(e){var t=(e=e||{}).point?e.point.times(_.pixelDensityRatio):this._getCanvasCenter();e=this._outputContext;e.translate(t.x,0);e.scale(-1,1);e.translate(-t.x,0)}_drawDebugInfo(e,t,i){for(var r=e.length-1;0<=r;r--){var n=e[r].tile;try{this._drawDebugInfoOnTile(n,e.length,r,t,i)}catch(e){_.console.error(e)}}}_drawDebugInfoOnTile(e,t,i,r,n){var o=this.viewer.world.getIndexOfItem(r)%this.debugGridColor.length;var s=this.context;s.save();s.lineWidth=2*_.pixelDensityRatio;s.font="small-caps bold "+13*_.pixelDensityRatio+"px arial";s.strokeStyle=this.debugGridColor[o];s.fillStyle=this.debugGridColor[o];this._setRotations(r);n&&this._flip({point:e.position.plus(e.size.divide(2))});s.strokeRect(e.position.x*_.pixelDensityRatio,e.position.y*_.pixelDensityRatio,e.size.x*_.pixelDensityRatio,e.size.y*_.pixelDensityRatio);var a=(e.position.x+e.size.x/2)*_.pixelDensityRatio;o=(e.position.y+e.size.y/2)*_.pixelDensityRatio;s.translate(a,o);n=this.viewport.getRotation(!0);s.rotate(Math.PI/180*-n);s.translate(-a,-o);if(0===e.x&&0===e.y){s.fillText("Zoom: "+this.viewport.getZoom(),e.position.x*_.pixelDensityRatio,(e.position.y-30)*_.pixelDensityRatio);s.fillText("Pan: "+this.viewport.getBounds().toString(),e.position.x*_.pixelDensityRatio,(e.position.y-20)*_.pixelDensityRatio)}s.fillText("Level: "+e.level,(e.position.x+10)*_.pixelDensityRatio,(e.position.y+20)*_.pixelDensityRatio);s.fillText("Column: "+e.x,(e.position.x+10)*_.pixelDensityRatio,(e.position.y+30)*_.pixelDensityRatio);s.fillText("Row: "+e.y,(e.position.x+10)*_.pixelDensityRatio,(e.position.y+40)*_.pixelDensityRatio);s.fillText("Order: "+i+" of "+t,(e.position.x+10)*_.pixelDensityRatio,(e.position.y+50)*_.pixelDensityRatio);s.fillText("Size: "+e.size.toString(),(e.position.x+10)*_.pixelDensityRatio,(e.position.y+60)*_.pixelDensityRatio);s.fillText("Position: "+e.position.toString(),(e.position.x+10)*_.pixelDensityRatio,(e.position.y+70)*_.pixelDensityRatio);this.viewport.getRotation(!0)%360!=0&&this._restoreRotationChanges();r.getRotation(!0)%360!=0&&this._restoreRotationChanges();s.restore()}_restoreRotationChanges(){this._outputContext.restore()}_getCanvasCenter(){return new _.Point(this.canvas.width/2,this.canvas.height/2)}};o.WebGLDrawerModular._idGenerator=0;Object.defineProperty(o.WebGLDrawerModular,"idGenerator",{get:function(){return this._idGenerator++}})}(OpenSeadragon);!function(e){e.WebGLModule.SobelShader=class extends e.WebGLModule.ShaderLayer{static type(){return"sobel"}static name(){return"Sobel"}static description(){return"sobel edge detector"}static sources(){return[{acceptsChannelCount:e=>3===e,description:"Data to detect edges on"}]}static get defaultControls(){return{use_channel0:{required:"rgb"}}}getFragmentShaderExecution(){return`
            // Sobel kernel for edge detection
            float kernelX[9] = float[9](-1.0,  0.0,  1.0,
                                        -2.0,  0.0,  2.0,
                                        -1.0,  0.0,  1.0);

            float kernelY[9] = float[9](-1.0, -2.0, -1.0,
                                         0.0,  0.0,  0.0,
                                         1.0,  2.0,  1.0);

            vec3 sumX = vec3(0.0);
            vec3 sumY = vec3(0.0);
            vec2 texelSize = vec2(1.0) / vec2(float(${this.getTextureSize()}.x), float(${this.getTextureSize()}.y));

            // Sampling 3x3 neighborhood
            int idx = 0;
            for (int y = -1; y <= 1; y++) {
                for (int x = -1; x <= 1; x++) {
                    vec3 sampleColor = ${this.sampleChannel("v_texture_coords + vec2(float(x), float(y)) * texelSize")};
                    sumX += sampleColor * kernelX[idx];
                    sumY += sampleColor * kernelY[idx];
                    idx++;
                }
            }

            float edgeStrength = length(sumX) + length(sumY);
            return vec4(vec3(edgeStrength), 1.0);
    `}};e.WebGLModule.ShaderMediator.registerLayer(e.WebGLModule.SobelShader)}(OpenSeadragon);!function(e){e.WebGLModule.IdentityLayer=class extends e.WebGLModule.ShaderLayer{static get defaultControls(){return{use_channel0:{required:"rgba"}}}static type(){return"identity"}static name(){return"Identity"}static description(){return"shows the data AS-IS"}static sources(){return[{acceptsChannelCount:e=>4===e,description:"4d texture to render AS-IS"}]}getFragmentShaderExecution(){return`
        return ${this.sampleChannel("v_texture_coords")};`}};e.WebGLModule.ShaderMediator.registerLayer(e.WebGLModule.IdentityLayer)}(OpenSeadragon);
//# sourceMappingURL=openseadragon.min.js.map